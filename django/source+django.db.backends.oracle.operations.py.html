<!DOCTYPE html><html><head><meta charset=utf-8><title>django.db.backends.oracle.operations</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./assets/purecss/pure-min.css><link rel=stylesheet href=./assets/purecss/grids-responsive-min.css><link rel=stylesheet href=./assets/style.css><link rel=stylesheet href=./assets/pygments/default.css><link rel=stylesheet href=./assets/jquery/jquery-ui.min.css><script src=./assets/jquery/jquery-3.0.0.min.js></script><script src=./assets/jquery/jquery-ui.min.js></script><script src=nedoc.js></script></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-1-4"><div class=header><h1 class=brand-title>Django</h1> 1.0 </div><div id=sbox><input id=search style="color: black;" placeholder="search ..."></div><div class=tree><ul><li><a href=django.html>&#9662; django</a> </li><li><ul><li><a href=django.__main__.html>&#9656; __main__</a> </li><li><a href=django.apps.html>&#9656; apps</a> </li><li><a href=django.bin.html>&#9656; bin</a> </li><li><a href=django.conf.html>&#9656; conf</a> </li><li><a href=django.contrib.html>&#9656; contrib</a> </li><li><a href=django.core.html>&#9656; core</a> </li><li><a href=django.db.html>&#9662; db</a> </li><li><ul><li><a href=django.db.backends.html>&#9662; backends</a> </li><li><ul><li><a href=django.db.backends.base.html>&#9656; base</a> </li><li><a href=django.db.backends.ddl_references.html>&#9656; ddl_references</a> </li><li><a href=django.db.backends.dummy.html>&#9656; dummy</a> </li><li><a href=django.db.backends.mysql.html>&#9656; mysql</a> </li><li><a href=django.db.backends.oracle.html>&#9662; oracle</a> </li><li><ul><li><a href=django.db.backends.oracle.base.html>&#9656; base</a> </li><li><a href=django.db.backends.oracle.client.html>&#9656; client</a> </li><li><a href=django.db.backends.oracle.creation.html>&#9656; creation</a> </li><li><a href=django.db.backends.oracle.features.html>&#9656; features</a> </li><li><a href=django.db.backends.oracle.functions.html>&#9656; functions</a> </li><li><a href=django.db.backends.oracle.introspection.html>&#9656; introspection</a> </li><li><div class=select><a href=django.db.backends.oracle.operations.html>&#9662; operations</a> </div></li><li><ul><li><a href=django.db.backends.oracle.operations.DatabaseOperations.html> <i>class</i> DatabaseOperations</a> </li></ul></li><li><a href=django.db.backends.oracle.schema.html>&#9656; schema</a> </li><li><a href=django.db.backends.oracle.utils.html>&#9656; utils</a> </li><li><a href=django.db.backends.oracle.validation.html>&#9656; validation</a> </li></ul></li><li><a href=django.db.backends.postgresql.html>&#9656; postgresql</a> </li><li><a href=django.db.backends.signals.html>&#9656; signals</a> </li><li><a href=django.db.backends.sqlite3.html>&#9656; sqlite3</a> </li><li><a href=django.db.backends.utils.html>&#9656; utils</a> </li></ul></li><li><a href=django.db.migrations.html>&#9656; migrations</a> </li><li><a href=django.db.models.html>&#9656; models</a> </li><li><a href=django.db.transaction.html>&#9656; transaction</a> </li><li><a href=django.db.utils.html>&#9656; utils</a> </li><li><a href=django.db.DefaultConnectionProxy.html> <i>class</i> DefaultConnectionProxy</a> </li></ul></li><li><a href=django.dispatch.html>&#9656; dispatch</a> </li><li><a href=django.forms.html>&#9656; forms</a> </li><li><a href=django.http.html>&#9656; http</a> </li><li><a href=django.middleware.html>&#9656; middleware</a> </li><li><a href=django.shortcuts.html>&#9656; shortcuts</a> </li><li><a href=django.template.html>&#9656; template</a> </li><li><a href=django.templatetags.html>&#9656; templatetags</a> </li><li><a href=django.test.html>&#9656; test</a> </li><li><a href=django.urls.html>&#9656; urls</a> </li><li><a href=django.utils.html>&#9656; utils</a> </li><li><a href=django.views.html>&#9656; views</a> </li></ul></ul></div></div><div class="content pure-u-1 pure-u-md-3-4"><h1>Source code django/db/backends/oracle/operations.py</h1><div id=path><a class=symbol href=django.html>django</a>.<a class=symbol href=django.db.html>db</a>.<a class=symbol href=django.db.backends.html>backends</a>.<a class=symbol href=django.db.backends.oracle.html>oracle</a>.<a class=symbol href=django.db.backends.oracle.operations.html>operations</a></div><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644</pre></div></td><td class=code><div class=highlight><pre><span></span><a name=line-1></a><span class=kn>import</span> <span class=nn>datetime</span>
<a name=line-2></a><span class=kn>import</span> <span class=nn>uuid</span>
<a name=line-3></a><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
<a name=line-4></a>
<a name=line-5></a><span class=kn>from</span> <span class=nn>django.conf</span> <span class=kn>import</span> <span class=n>settings</span>
<a name=line-6></a><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>DatabaseError</span><span class=p>,</span> <span class=n>NotSupportedError</span>
<a name=line-7></a><span class=kn>from</span> <span class=nn>django.db.backends.base.operations</span> <span class=kn>import</span> <span class=n>BaseDatabaseOperations</span>
<a name=line-8></a><span class=kn>from</span> <span class=nn>django.db.backends.utils</span> <span class=kn>import</span> <span class=n>strip_quotes</span><span class=p>,</span> <span class=n>truncate_name</span>
<a name=line-9></a><span class=kn>from</span> <span class=nn>django.db.models</span> <span class=kn>import</span> <span class=n>AutoField</span><span class=p>,</span> <span class=n>Exists</span><span class=p>,</span> <span class=n>ExpressionWrapper</span>
<a name=line-10></a><span class=kn>from</span> <span class=nn>django.db.models.expressions</span> <span class=kn>import</span> <span class=n>RawSQL</span>
<a name=line-11></a><span class=kn>from</span> <span class=nn>django.db.models.sql.where</span> <span class=kn>import</span> <span class=n>WhereNode</span>
<a name=line-12></a><span class=kn>from</span> <span class=nn>django.utils</span> <span class=kn>import</span> <span class=n>timezone</span>
<a name=line-13></a><span class=kn>from</span> <span class=nn>django.utils.encoding</span> <span class=kn>import</span> <span class=n>force_bytes</span><span class=p>,</span> <span class=n>force_str</span>
<a name=line-14></a><span class=kn>from</span> <span class=nn>django.utils.functional</span> <span class=kn>import</span> <span class=n>cached_property</span>
<a name=line-15></a><span class=kn>from</span> <span class=nn>django.utils.regex_helper</span> <span class=kn>import</span> <span class=n>_lazy_re_compile</span>
<a name=line-16></a>
<a name=line-17></a><span class=kn>from</span> <span class=nn>.base</span> <span class=kn>import</span> <span class=n>Database</span>
<a name=line-18></a><span class=kn>from</span> <span class=nn>.utils</span> <span class=kn>import</span> <span class=n>BulkInsertMapper</span><span class=p>,</span> <span class=n>InsertVar</span><span class=p>,</span> <span class=n>Oracle_datetime</span>
<a name=line-19></a>
<a name=line-20></a>
<a name=line-21></a><span class=k>class</span> <span class=nc>DatabaseOperations</span><span class=p>(</span><span class=n>BaseDatabaseOperations</span><span class=p>):</span>
<a name=line-22></a>    <span class=c1># Oracle uses NUMBER(5), NUMBER(11), and NUMBER(19) for integer fields.</span>
<a name=line-23></a>    <span class=c1># SmallIntegerField uses NUMBER(11) instead of NUMBER(5), which is used by</span>
<a name=line-24></a>    <span class=c1># SmallAutoField, to preserve backward compatibility.</span>
<a name=line-25></a>    <span class=n>integer_field_ranges</span> <span class=o>=</span> <span class=p>{</span>
<a name=line-26></a>        <span class=s1>&#39;SmallIntegerField&#39;</span><span class=p>:</span> <span class=p>(</span><span class=o>-</span><span class=mi>99999999999</span><span class=p>,</span> <span class=mi>99999999999</span><span class=p>),</span>
<a name=line-27></a>        <span class=s1>&#39;IntegerField&#39;</span><span class=p>:</span> <span class=p>(</span><span class=o>-</span><span class=mi>99999999999</span><span class=p>,</span> <span class=mi>99999999999</span><span class=p>),</span>
<a name=line-28></a>        <span class=s1>&#39;BigIntegerField&#39;</span><span class=p>:</span> <span class=p>(</span><span class=o>-</span><span class=mi>9999999999999999999</span><span class=p>,</span> <span class=mi>9999999999999999999</span><span class=p>),</span>
<a name=line-29></a>        <span class=s1>&#39;PositiveBigIntegerField&#39;</span><span class=p>:</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>9999999999999999999</span><span class=p>),</span>
<a name=line-30></a>        <span class=s1>&#39;PositiveSmallIntegerField&#39;</span><span class=p>:</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>99999999999</span><span class=p>),</span>
<a name=line-31></a>        <span class=s1>&#39;PositiveIntegerField&#39;</span><span class=p>:</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>99999999999</span><span class=p>),</span>
<a name=line-32></a>        <span class=s1>&#39;SmallAutoField&#39;</span><span class=p>:</span> <span class=p>(</span><span class=o>-</span><span class=mi>99999</span><span class=p>,</span> <span class=mi>99999</span><span class=p>),</span>
<a name=line-33></a>        <span class=s1>&#39;AutoField&#39;</span><span class=p>:</span> <span class=p>(</span><span class=o>-</span><span class=mi>99999999999</span><span class=p>,</span> <span class=mi>99999999999</span><span class=p>),</span>
<a name=line-34></a>        <span class=s1>&#39;BigAutoField&#39;</span><span class=p>:</span> <span class=p>(</span><span class=o>-</span><span class=mi>9999999999999999999</span><span class=p>,</span> <span class=mi>9999999999999999999</span><span class=p>),</span>
<a name=line-35></a>    <span class=p>}</span>
<a name=line-36></a>    <span class=n>set_operators</span> <span class=o>=</span> <span class=p>{</span><span class=o>**</span><span class=n>BaseDatabaseOperations</span><span class=o>.</span><span class=n>set_operators</span><span class=p>,</span> <span class=s1>&#39;difference&#39;</span><span class=p>:</span> <span class=s1>&#39;MINUS&#39;</span><span class=p>}</span>
<a name=line-37></a>
<a name=line-38></a>    <span class=c1># TODO: colorize this SQL code with style.SQL_KEYWORD(), etc.</span>
<a name=line-39></a>    <span class=n>_sequence_reset_sql</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
<a name=line-40></a><span class=s2>DECLARE</span>
<a name=line-41></a><span class=s2>    table_value integer;</span>
<a name=line-42></a><span class=s2>    seq_value integer;</span>
<a name=line-43></a><span class=s2>    seq_name user_tab_identity_cols.sequence_name</span><span class=si>%%</span><span class=s2>TYPE;</span>
<a name=line-44></a><span class=s2>BEGIN</span>
<a name=line-45></a><span class=s2>    BEGIN</span>
<a name=line-46></a><span class=s2>        SELECT sequence_name INTO seq_name FROM user_tab_identity_cols</span>
<a name=line-47></a><span class=s2>        WHERE  table_name = &#39;</span><span class=si>%(table_name)s</span><span class=s2>&#39; AND</span>
<a name=line-48></a><span class=s2>               column_name = &#39;</span><span class=si>%(column_name)s</span><span class=s2>&#39;;</span>
<a name=line-49></a><span class=s2>        EXCEPTION WHEN NO_DATA_FOUND THEN</span>
<a name=line-50></a><span class=s2>            seq_name := &#39;</span><span class=si>%(no_autofield_sequence_name)s</span><span class=s2>&#39;;</span>
<a name=line-51></a><span class=s2>    END;</span>
<a name=line-52></a>
<a name=line-53></a><span class=s2>    SELECT NVL(MAX(</span><span class=si>%(column)s</span><span class=s2>), 0) INTO table_value FROM </span><span class=si>%(table)s</span><span class=s2>;</span>
<a name=line-54></a><span class=s2>    SELECT NVL(last_number - cache_size, 0) INTO seq_value FROM user_sequences</span>
<a name=line-55></a><span class=s2>           WHERE sequence_name = seq_name;</span>
<a name=line-56></a><span class=s2>    WHILE table_value &gt; seq_value LOOP</span>
<a name=line-57></a><span class=s2>        EXECUTE IMMEDIATE &#39;SELECT &quot;&#39;||seq_name||&#39;&quot;.nextval FROM DUAL&#39;</span>
<a name=line-58></a><span class=s2>        INTO seq_value;</span>
<a name=line-59></a><span class=s2>    END LOOP;</span>
<a name=line-60></a><span class=s2>END;</span>
<a name=line-61></a><span class=s2>/&quot;&quot;&quot;</span>
<a name=line-62></a>
<a name=line-63></a>    <span class=c1># Oracle doesn&#39;t support string without precision; use the max string size.</span>
<a name=line-64></a>    <span class=n>cast_char_field_without_max_length</span> <span class=o>=</span> <span class=s1>&#39;NVARCHAR2(2000)&#39;</span>
<a name=line-65></a>    <span class=n>cast_data_types</span> <span class=o>=</span> <span class=p>{</span>
<a name=line-66></a>        <span class=s1>&#39;AutoField&#39;</span><span class=p>:</span> <span class=s1>&#39;NUMBER(11)&#39;</span><span class=p>,</span>
<a name=line-67></a>        <span class=s1>&#39;BigAutoField&#39;</span><span class=p>:</span> <span class=s1>&#39;NUMBER(19)&#39;</span><span class=p>,</span>
<a name=line-68></a>        <span class=s1>&#39;SmallAutoField&#39;</span><span class=p>:</span> <span class=s1>&#39;NUMBER(5)&#39;</span><span class=p>,</span>
<a name=line-69></a>        <span class=s1>&#39;TextField&#39;</span><span class=p>:</span> <span class=n>cast_char_field_without_max_length</span><span class=p>,</span>
<a name=line-70></a>    <span class=p>}</span>
<a name=line-71></a>
<a name=line-72></a>    <span class=k>def</span> <span class=nf>cache_key_culling_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-73></a>        <span class=k>return</span> <span class=s1>&#39;SELECT cache_key FROM </span><span class=si>%s</span><span class=s1> ORDER BY cache_key OFFSET </span><span class=si>%%</span><span class=s1>s ROWS FETCH FIRST 1 ROWS ONLY&#39;</span>
<a name=line-74></a>
<a name=line-75></a>    <span class=k>def</span> <span class=nf>date_extract_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lookup_type</span><span class=p>,</span> <span class=n>field_name</span><span class=p>):</span>
<a name=line-76></a>        <span class=k>if</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;week_day&#39;</span><span class=p>:</span>
<a name=line-77></a>            <span class=c1># TO_CHAR(field, &#39;D&#39;) returns an integer from 1-7, where 1=Sunday.</span>
<a name=line-78></a>            <span class=k>return</span> <span class=s2>&quot;TO_CHAR(</span><span class=si>%s</span><span class=s2>, &#39;D&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-79></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;iso_week_day&#39;</span><span class=p>:</span>
<a name=line-80></a>            <span class=k>return</span> <span class=s2>&quot;TO_CHAR(</span><span class=si>%s</span><span class=s2> - 1, &#39;D&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-81></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;week&#39;</span><span class=p>:</span>
<a name=line-82></a>            <span class=c1># IW = ISO week number</span>
<a name=line-83></a>            <span class=k>return</span> <span class=s2>&quot;TO_CHAR(</span><span class=si>%s</span><span class=s2>, &#39;IW&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-84></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;quarter&#39;</span><span class=p>:</span>
<a name=line-85></a>            <span class=k>return</span> <span class=s2>&quot;TO_CHAR(</span><span class=si>%s</span><span class=s2>, &#39;Q&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-86></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;iso_year&#39;</span><span class=p>:</span>
<a name=line-87></a>            <span class=k>return</span> <span class=s2>&quot;TO_CHAR(</span><span class=si>%s</span><span class=s2>, &#39;IYYY&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-88></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-89></a>            <span class=c1># https://docs.oracle.com/en/database/oracle/oracle-database/18/sqlrf/EXTRACT-datetime.html</span>
<a name=line-90></a>            <span class=k>return</span> <span class=s2>&quot;EXTRACT(</span><span class=si>%s</span><span class=s2> FROM </span><span class=si>%s</span><span class=s2>)&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>lookup_type</span><span class=o>.</span><span class=n>upper</span><span class=p>(),</span> <span class=n>field_name</span><span class=p>)</span>
<a name=line-91></a>
<a name=line-92></a>    <span class=k>def</span> <span class=nf>date_trunc_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lookup_type</span><span class=p>,</span> <span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-93></a>        <span class=n>field_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_convert_field_to_tz</span><span class=p>(</span><span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>)</span>
<a name=line-94></a>        <span class=c1># https://docs.oracle.com/en/database/oracle/oracle-database/18/sqlrf/ROUND-and-TRUNC-Date-Functions.html</span>
<a name=line-95></a>        <span class=k>if</span> <span class=n>lookup_type</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;year&#39;</span><span class=p>,</span> <span class=s1>&#39;month&#39;</span><span class=p>):</span>
<a name=line-96></a>            <span class=k>return</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>, &#39;</span><span class=si>%s</span><span class=s2>&#39;)&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>field_name</span><span class=p>,</span> <span class=n>lookup_type</span><span class=o>.</span><span class=n>upper</span><span class=p>())</span>
<a name=line-97></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;quarter&#39;</span><span class=p>:</span>
<a name=line-98></a>            <span class=k>return</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>, &#39;Q&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-99></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;week&#39;</span><span class=p>:</span>
<a name=line-100></a>            <span class=k>return</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>, &#39;IW&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-101></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-102></a>            <span class=k>return</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-103></a>
<a name=line-104></a>    <span class=c1># Oracle crashes with &quot;ORA-03113: end-of-file on communication channel&quot;</span>
<a name=line-105></a>    <span class=c1># if the time zone name is passed in parameter. Use interpolation instead.</span>
<a name=line-106></a>    <span class=c1># https://groups.google.com/forum/#!msg/django-developers/zwQju7hbG78/9l934yelwfsJ</span>
<a name=line-107></a>    <span class=c1># This regexp matches all time zone names from the zoneinfo database.</span>
<a name=line-108></a>    <span class=n>_tzname_re</span> <span class=o>=</span> <span class=n>_lazy_re_compile</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;^[\w/:+-]+$&#39;</span><span class=p>)</span>
<a name=line-109></a>
<a name=line-110></a>    <span class=k>def</span> <span class=nf>_prepare_tzname_delta</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tzname</span><span class=p>):</span>
<a name=line-111></a>        <span class=k>if</span> <span class=s1>&#39;+&#39;</span> <span class=ow>in</span> <span class=n>tzname</span><span class=p>:</span>
<a name=line-112></a>            <span class=k>return</span> <span class=n>tzname</span><span class=p>[</span><span class=n>tzname</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;+&#39;</span><span class=p>):]</span>
<a name=line-113></a>        <span class=k>elif</span> <span class=s1>&#39;-&#39;</span> <span class=ow>in</span> <span class=n>tzname</span><span class=p>:</span>
<a name=line-114></a>            <span class=k>return</span> <span class=n>tzname</span><span class=p>[</span><span class=n>tzname</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=p>):]</span>
<a name=line-115></a>        <span class=k>return</span> <span class=n>tzname</span>
<a name=line-116></a>
<a name=line-117></a>    <span class=k>def</span> <span class=nf>_convert_field_to_tz</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>):</span>
<a name=line-118></a>        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>USE_TZ</span> <span class=ow>and</span> <span class=n>tzname</span><span class=p>):</span>
<a name=line-119></a>            <span class=k>return</span> <span class=n>field_name</span>
<a name=line-120></a>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tzname_re</span><span class=o>.</span><span class=n>match</span><span class=p>(</span><span class=n>tzname</span><span class=p>):</span>
<a name=line-121></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Invalid time zone name: </span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=n>tzname</span><span class=p>)</span>
<a name=line-122></a>        <span class=c1># Convert from connection timezone to the local time, returning</span>
<a name=line-123></a>        <span class=c1># TIMESTAMP WITH TIME ZONE and cast it back to TIMESTAMP to strip the</span>
<a name=line-124></a>        <span class=c1># TIME ZONE details.</span>
<a name=line-125></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>timezone_name</span> <span class=o>!=</span> <span class=n>tzname</span><span class=p>:</span>
<a name=line-126></a>            <span class=k>return</span> <span class=s2>&quot;CAST((FROM_TZ(</span><span class=si>%s</span><span class=s2>, &#39;</span><span class=si>%s</span><span class=s2>&#39;) AT TIME ZONE &#39;</span><span class=si>%s</span><span class=s2>&#39;) AS TIMESTAMP)&quot;</span> <span class=o>%</span> <span class=p>(</span>
<a name=line-127></a>                <span class=n>field_name</span><span class=p>,</span>
<a name=line-128></a>                <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>timezone_name</span><span class=p>,</span>
<a name=line-129></a>                <span class=bp>self</span><span class=o>.</span><span class=n>_prepare_tzname_delta</span><span class=p>(</span><span class=n>tzname</span><span class=p>),</span>
<a name=line-130></a>            <span class=p>)</span>
<a name=line-131></a>        <span class=k>return</span> <span class=n>field_name</span>
<a name=line-132></a>
<a name=line-133></a>    <span class=k>def</span> <span class=nf>datetime_cast_date_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>):</span>
<a name=line-134></a>        <span class=n>field_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_convert_field_to_tz</span><span class=p>(</span><span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>)</span>
<a name=line-135></a>        <span class=k>return</span> <span class=s1>&#39;TRUNC(</span><span class=si>%s</span><span class=s1>)&#39;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-136></a>
<a name=line-137></a>    <span class=k>def</span> <span class=nf>datetime_cast_time_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>):</span>
<a name=line-138></a>        <span class=c1># Since `TimeField` values are stored as TIMESTAMP where only the date</span>
<a name=line-139></a>        <span class=c1># part is ignored, convert the field to the specified timezone.</span>
<a name=line-140></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_convert_field_to_tz</span><span class=p>(</span><span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>)</span>
<a name=line-141></a>
<a name=line-142></a>    <span class=k>def</span> <span class=nf>datetime_extract_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lookup_type</span><span class=p>,</span> <span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>):</span>
<a name=line-143></a>        <span class=n>field_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_convert_field_to_tz</span><span class=p>(</span><span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>)</span>
<a name=line-144></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>date_extract_sql</span><span class=p>(</span><span class=n>lookup_type</span><span class=p>,</span> <span class=n>field_name</span><span class=p>)</span>
<a name=line-145></a>
<a name=line-146></a>    <span class=k>def</span> <span class=nf>datetime_trunc_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lookup_type</span><span class=p>,</span> <span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>):</span>
<a name=line-147></a>        <span class=n>field_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_convert_field_to_tz</span><span class=p>(</span><span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>)</span>
<a name=line-148></a>        <span class=c1># https://docs.oracle.com/en/database/oracle/oracle-database/18/sqlrf/ROUND-and-TRUNC-Date-Functions.html</span>
<a name=line-149></a>        <span class=k>if</span> <span class=n>lookup_type</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;year&#39;</span><span class=p>,</span> <span class=s1>&#39;month&#39;</span><span class=p>):</span>
<a name=line-150></a>            <span class=n>sql</span> <span class=o>=</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>, &#39;</span><span class=si>%s</span><span class=s2>&#39;)&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>field_name</span><span class=p>,</span> <span class=n>lookup_type</span><span class=o>.</span><span class=n>upper</span><span class=p>())</span>
<a name=line-151></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;quarter&#39;</span><span class=p>:</span>
<a name=line-152></a>            <span class=n>sql</span> <span class=o>=</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>, &#39;Q&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-153></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;week&#39;</span><span class=p>:</span>
<a name=line-154></a>            <span class=n>sql</span> <span class=o>=</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>, &#39;IW&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-155></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;day&#39;</span><span class=p>:</span>
<a name=line-156></a>            <span class=n>sql</span> <span class=o>=</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-157></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;hour&#39;</span><span class=p>:</span>
<a name=line-158></a>            <span class=n>sql</span> <span class=o>=</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>, &#39;HH24&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-159></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;minute&#39;</span><span class=p>:</span>
<a name=line-160></a>            <span class=n>sql</span> <span class=o>=</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>, &#39;MI&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-161></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-162></a>            <span class=n>sql</span> <span class=o>=</span> <span class=s2>&quot;CAST(</span><span class=si>%s</span><span class=s2> AS DATE)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>  <span class=c1># Cast to DATE removes sub-second precision.</span>
<a name=line-163></a>        <span class=k>return</span> <span class=n>sql</span>
<a name=line-164></a>
<a name=line-165></a>    <span class=k>def</span> <span class=nf>time_trunc_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lookup_type</span><span class=p>,</span> <span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-166></a>        <span class=c1># The implementation is similar to `datetime_trunc_sql` as both</span>
<a name=line-167></a>        <span class=c1># `DateTimeField` and `TimeField` are stored as TIMESTAMP where</span>
<a name=line-168></a>        <span class=c1># the date part of the later is ignored.</span>
<a name=line-169></a>        <span class=n>field_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_convert_field_to_tz</span><span class=p>(</span><span class=n>field_name</span><span class=p>,</span> <span class=n>tzname</span><span class=p>)</span>
<a name=line-170></a>        <span class=k>if</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;hour&#39;</span><span class=p>:</span>
<a name=line-171></a>            <span class=n>sql</span> <span class=o>=</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>, &#39;HH24&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-172></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;minute&#39;</span><span class=p>:</span>
<a name=line-173></a>            <span class=n>sql</span> <span class=o>=</span> <span class=s2>&quot;TRUNC(</span><span class=si>%s</span><span class=s2>, &#39;MI&#39;)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>
<a name=line-174></a>        <span class=k>elif</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;second&#39;</span><span class=p>:</span>
<a name=line-175></a>            <span class=n>sql</span> <span class=o>=</span> <span class=s2>&quot;CAST(</span><span class=si>%s</span><span class=s2> AS DATE)&quot;</span> <span class=o>%</span> <span class=n>field_name</span>  <span class=c1># Cast to DATE removes sub-second precision.</span>
<a name=line-176></a>        <span class=k>return</span> <span class=n>sql</span>
<a name=line-177></a>
<a name=line-178></a>    <span class=k>def</span> <span class=nf>get_db_converters</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>expression</span><span class=p>):</span>
<a name=line-179></a>        <span class=n>converters</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>get_db_converters</span><span class=p>(</span><span class=n>expression</span><span class=p>)</span>
<a name=line-180></a>        <span class=n>internal_type</span> <span class=o>=</span> <span class=n>expression</span><span class=o>.</span><span class=n>output_field</span><span class=o>.</span><span class=n>get_internal_type</span><span class=p>()</span>
<a name=line-181></a>        <span class=k>if</span> <span class=n>internal_type</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;JSONField&#39;</span><span class=p>,</span> <span class=s1>&#39;TextField&#39;</span><span class=p>]:</span>
<a name=line-182></a>            <span class=n>converters</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>convert_textfield_value</span><span class=p>)</span>
<a name=line-183></a>        <span class=k>elif</span> <span class=n>internal_type</span> <span class=o>==</span> <span class=s1>&#39;BinaryField&#39;</span><span class=p>:</span>
<a name=line-184></a>            <span class=n>converters</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>convert_binaryfield_value</span><span class=p>)</span>
<a name=line-185></a>        <span class=k>elif</span> <span class=n>internal_type</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;BooleanField&#39;</span><span class=p>,</span> <span class=s1>&#39;NullBooleanField&#39;</span><span class=p>]:</span>
<a name=line-186></a>            <span class=n>converters</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>convert_booleanfield_value</span><span class=p>)</span>
<a name=line-187></a>        <span class=k>elif</span> <span class=n>internal_type</span> <span class=o>==</span> <span class=s1>&#39;DateTimeField&#39;</span><span class=p>:</span>
<a name=line-188></a>            <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>USE_TZ</span><span class=p>:</span>
<a name=line-189></a>                <span class=n>converters</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>convert_datetimefield_value</span><span class=p>)</span>
<a name=line-190></a>        <span class=k>elif</span> <span class=n>internal_type</span> <span class=o>==</span> <span class=s1>&#39;DateField&#39;</span><span class=p>:</span>
<a name=line-191></a>            <span class=n>converters</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>convert_datefield_value</span><span class=p>)</span>
<a name=line-192></a>        <span class=k>elif</span> <span class=n>internal_type</span> <span class=o>==</span> <span class=s1>&#39;TimeField&#39;</span><span class=p>:</span>
<a name=line-193></a>            <span class=n>converters</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>convert_timefield_value</span><span class=p>)</span>
<a name=line-194></a>        <span class=k>elif</span> <span class=n>internal_type</span> <span class=o>==</span> <span class=s1>&#39;UUIDField&#39;</span><span class=p>:</span>
<a name=line-195></a>            <span class=n>converters</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>convert_uuidfield_value</span><span class=p>)</span>
<a name=line-196></a>        <span class=c1># Oracle stores empty strings as null. If the field accepts the empty</span>
<a name=line-197></a>        <span class=c1># string, undo this to adhere to the Django convention of using</span>
<a name=line-198></a>        <span class=c1># the empty string instead of null.</span>
<a name=line-199></a>        <span class=k>if</span> <span class=n>expression</span><span class=o>.</span><span class=n>field</span><span class=o>.</span><span class=n>empty_strings_allowed</span><span class=p>:</span>
<a name=line-200></a>            <span class=n>converters</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
<a name=line-201></a>                <span class=bp>self</span><span class=o>.</span><span class=n>convert_empty_bytes</span>
<a name=line-202></a>                <span class=k>if</span> <span class=n>internal_type</span> <span class=o>==</span> <span class=s1>&#39;BinaryField&#39;</span> <span class=k>else</span>
<a name=line-203></a>                <span class=bp>self</span><span class=o>.</span><span class=n>convert_empty_string</span>
<a name=line-204></a>            <span class=p>)</span>
<a name=line-205></a>        <span class=k>return</span> <span class=n>converters</span>
<a name=line-206></a>
<a name=line-207></a>    <span class=k>def</span> <span class=nf>convert_textfield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>expression</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
<a name=line-208></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>Database</span><span class=o>.</span><span class=n>LOB</span><span class=p>):</span>
<a name=line-209></a>            <span class=n>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
<a name=line-210></a>        <span class=k>return</span> <span class=n>value</span>
<a name=line-211></a>
<a name=line-212></a>    <span class=k>def</span> <span class=nf>convert_binaryfield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>expression</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
<a name=line-213></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>Database</span><span class=o>.</span><span class=n>LOB</span><span class=p>):</span>
<a name=line-214></a>            <span class=n>value</span> <span class=o>=</span> <span class=n>force_bytes</span><span class=p>(</span><span class=n>value</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
<a name=line-215></a>        <span class=k>return</span> <span class=n>value</span>
<a name=line-216></a>
<a name=line-217></a>    <span class=k>def</span> <span class=nf>convert_booleanfield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>expression</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
<a name=line-218></a>        <span class=k>if</span> <span class=n>value</span> <span class=ow>in</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
<a name=line-219></a>            <span class=n>value</span> <span class=o>=</span> <span class=nb>bool</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<a name=line-220></a>        <span class=k>return</span> <span class=n>value</span>
<a name=line-221></a>
<a name=line-222></a>    <span class=c1># cx_Oracle always returns datetime.datetime objects for</span>
<a name=line-223></a>    <span class=c1># DATE and TIMESTAMP columns, but Django wants to see a</span>
<a name=line-224></a>    <span class=c1># python datetime.date, .time, or .datetime.</span>
<a name=line-225></a>
<a name=line-226></a>    <span class=k>def</span> <span class=nf>convert_datetimefield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>expression</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
<a name=line-227></a>        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-228></a>            <span class=n>value</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>make_aware</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>timezone</span><span class=p>)</span>
<a name=line-229></a>        <span class=k>return</span> <span class=n>value</span>
<a name=line-230></a>
<a name=line-231></a>    <span class=k>def</span> <span class=nf>convert_datefield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>expression</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
<a name=line-232></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>Database</span><span class=o>.</span><span class=n>Timestamp</span><span class=p>):</span>
<a name=line-233></a>            <span class=n>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>date</span><span class=p>()</span>
<a name=line-234></a>        <span class=k>return</span> <span class=n>value</span>
<a name=line-235></a>
<a name=line-236></a>    <span class=k>def</span> <span class=nf>convert_timefield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>expression</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
<a name=line-237></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>Database</span><span class=o>.</span><span class=n>Timestamp</span><span class=p>):</span>
<a name=line-238></a>            <span class=n>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
<a name=line-239></a>        <span class=k>return</span> <span class=n>value</span>
<a name=line-240></a>
<a name=line-241></a>    <span class=k>def</span> <span class=nf>convert_uuidfield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>expression</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
<a name=line-242></a>        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-243></a>            <span class=n>value</span> <span class=o>=</span> <span class=n>uuid</span><span class=o>.</span><span class=n>UUID</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<a name=line-244></a>        <span class=k>return</span> <span class=n>value</span>
<a name=line-245></a>
<a name=line-246></a>    <span class=nd>@staticmethod</span>
<a name=line-247></a>    <span class=k>def</span> <span class=nf>convert_empty_string</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>expression</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
<a name=line-248></a>        <span class=k>return</span> <span class=s1>&#39;&#39;</span> <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=n>value</span>
<a name=line-249></a>
<a name=line-250></a>    <span class=nd>@staticmethod</span>
<a name=line-251></a>    <span class=k>def</span> <span class=nf>convert_empty_bytes</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>expression</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
<a name=line-252></a>        <span class=k>return</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span> <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=n>value</span>
<a name=line-253></a>
<a name=line-254></a>    <span class=k>def</span> <span class=nf>deferrable_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-255></a>        <span class=k>return</span> <span class=s2>&quot; DEFERRABLE INITIALLY DEFERRED&quot;</span>
<a name=line-256></a>
<a name=line-257></a>    <span class=k>def</span> <span class=nf>fetch_returned_insert_columns</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cursor</span><span class=p>,</span> <span class=n>returning_params</span><span class=p>):</span>
<a name=line-258></a>        <span class=n>columns</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-259></a>        <span class=k>for</span> <span class=n>param</span> <span class=ow>in</span> <span class=n>returning_params</span><span class=p>:</span>
<a name=line-260></a>            <span class=n>value</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>get_value</span><span class=p>()</span>
<a name=line-261></a>            <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=n>value</span> <span class=o>==</span> <span class=p>[]:</span>
<a name=line-262></a>                <span class=c1># cx_Oracle &lt; 6.3 returns None, &gt;= 6.3 returns empty list.</span>
<a name=line-263></a>                <span class=k>raise</span> <span class=n>DatabaseError</span><span class=p>(</span>
<a name=line-264></a>                    <span class=s1>&#39;The database did not return a new row id. Probably &#39;</span>
<a name=line-265></a>                    <span class=s1>&#39;&quot;ORA-1403: no data found&quot; was raised internally but was &#39;</span>
<a name=line-266></a>                    <span class=s1>&#39;hidden by the Oracle OCI library (see &#39;</span>
<a name=line-267></a>                    <span class=s1>&#39;https://code.djangoproject.com/ticket/28859).&#39;</span>
<a name=line-268></a>                <span class=p>)</span>
<a name=line-269></a>            <span class=c1># cx_Oracle &lt; 7 returns value, &gt;= 7 returns list with single value.</span>
<a name=line-270></a>            <span class=n>columns</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>value</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>list</span><span class=p>)</span> <span class=k>else</span> <span class=n>value</span><span class=p>)</span>
<a name=line-271></a>        <span class=k>return</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>columns</span><span class=p>)</span>
<a name=line-272></a>
<a name=line-273></a>    <span class=k>def</span> <span class=nf>field_cast_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db_type</span><span class=p>,</span> <span class=n>internal_type</span><span class=p>):</span>
<a name=line-274></a>        <span class=k>if</span> <span class=n>db_type</span> <span class=ow>and</span> <span class=n>db_type</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;LOB&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>internal_type</span> <span class=o>!=</span> <span class=s1>&#39;JSONField&#39;</span><span class=p>:</span>
<a name=line-275></a>            <span class=k>return</span> <span class=s2>&quot;DBMS_LOB.SUBSTR(</span><span class=si>%s</span><span class=s2>)&quot;</span>
<a name=line-276></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-277></a>            <span class=k>return</span> <span class=s2>&quot;</span><span class=si>%s</span><span class=s2>&quot;</span>
<a name=line-278></a>
<a name=line-279></a>    <span class=k>def</span> <span class=nf>no_limit_value</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-280></a>        <span class=k>return</span> <span class=kc>None</span>
<a name=line-281></a>
<a name=line-282></a>    <span class=k>def</span> <span class=nf>limit_offset_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>low_mark</span><span class=p>,</span> <span class=n>high_mark</span><span class=p>):</span>
<a name=line-283></a>        <span class=n>fetch</span><span class=p>,</span> <span class=n>offset</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_limit_offset_params</span><span class=p>(</span><span class=n>low_mark</span><span class=p>,</span> <span class=n>high_mark</span><span class=p>)</span>
<a name=line-284></a>        <span class=k>return</span> <span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>sql</span> <span class=k>for</span> <span class=n>sql</span> <span class=ow>in</span> <span class=p>(</span>
<a name=line-285></a>            <span class=p>(</span><span class=s1>&#39;OFFSET </span><span class=si>%d</span><span class=s1> ROWS&#39;</span> <span class=o>%</span> <span class=n>offset</span><span class=p>)</span> <span class=k>if</span> <span class=n>offset</span> <span class=k>else</span> <span class=kc>None</span><span class=p>,</span>
<a name=line-286></a>            <span class=p>(</span><span class=s1>&#39;FETCH FIRST </span><span class=si>%d</span><span class=s1> ROWS ONLY&#39;</span> <span class=o>%</span> <span class=n>fetch</span><span class=p>)</span> <span class=k>if</span> <span class=n>fetch</span> <span class=k>else</span> <span class=kc>None</span><span class=p>,</span>
<a name=line-287></a>        <span class=p>)</span> <span class=k>if</span> <span class=n>sql</span><span class=p>)</span>
<a name=line-288></a>
<a name=line-289></a>    <span class=k>def</span> <span class=nf>last_executed_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cursor</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=p>):</span>
<a name=line-290></a>        <span class=c1># https://cx-oracle.readthedocs.io/en/latest/cursor.html#Cursor.statement</span>
<a name=line-291></a>        <span class=c1># The DB API definition does not define this attribute.</span>
<a name=line-292></a>        <span class=n>statement</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>statement</span>
<a name=line-293></a>        <span class=c1># Unlike Psycopg&#39;s `query` and MySQLdb`&#39;s `_executed`, cx_Oracle&#39;s</span>
<a name=line-294></a>        <span class=c1># `statement` doesn&#39;t contain the query parameters. Substitute</span>
<a name=line-295></a>        <span class=c1># parameters manually.</span>
<a name=line-296></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=p>(</span><span class=nb>tuple</span><span class=p>,</span> <span class=nb>list</span><span class=p>)):</span>
<a name=line-297></a>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>param</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>params</span><span class=p>):</span>
<a name=line-298></a>                <span class=n>statement</span> <span class=o>=</span> <span class=n>statement</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;:arg</span><span class=si>%d</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>i</span><span class=p>,</span> <span class=n>force_str</span><span class=p>(</span><span class=n>param</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;replace&#39;</span><span class=p>))</span>
<a name=line-299></a>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>params</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
<a name=line-300></a>            <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>param</span> <span class=ow>in</span> <span class=n>params</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<a name=line-301></a>                <span class=n>statement</span> <span class=o>=</span> <span class=n>statement</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;:</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>key</span><span class=p>,</span> <span class=n>force_str</span><span class=p>(</span><span class=n>param</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;replace&#39;</span><span class=p>))</span>
<a name=line-302></a>        <span class=k>return</span> <span class=n>statement</span>
<a name=line-303></a>
<a name=line-304></a>    <span class=k>def</span> <span class=nf>last_insert_id</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cursor</span><span class=p>,</span> <span class=n>table_name</span><span class=p>,</span> <span class=n>pk_name</span><span class=p>):</span>
<a name=line-305></a>        <span class=n>sq_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_sequence_name</span><span class=p>(</span><span class=n>cursor</span><span class=p>,</span> <span class=n>strip_quotes</span><span class=p>(</span><span class=n>table_name</span><span class=p>),</span> <span class=n>pk_name</span><span class=p>)</span>
<a name=line-306></a>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s1>&#39;&quot;</span><span class=si>%s</span><span class=s1>&quot;.currval&#39;</span> <span class=o>%</span> <span class=n>sq_name</span><span class=p>)</span>
<a name=line-307></a>        <span class=k>return</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
<a name=line-308></a>
<a name=line-309></a>    <span class=k>def</span> <span class=nf>lookup_cast</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lookup_type</span><span class=p>,</span> <span class=n>internal_type</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-310></a>        <span class=k>if</span> <span class=n>lookup_type</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;iexact&#39;</span><span class=p>,</span> <span class=s1>&#39;icontains&#39;</span><span class=p>,</span> <span class=s1>&#39;istartswith&#39;</span><span class=p>,</span> <span class=s1>&#39;iendswith&#39;</span><span class=p>):</span>
<a name=line-311></a>            <span class=k>return</span> <span class=s2>&quot;UPPER(</span><span class=si>%s</span><span class=s2>)&quot;</span>
<a name=line-312></a>        <span class=k>if</span> <span class=n>internal_type</span> <span class=o>==</span> <span class=s1>&#39;JSONField&#39;</span> <span class=ow>and</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;exact&#39;</span><span class=p>:</span>
<a name=line-313></a>            <span class=k>return</span> <span class=s1>&#39;DBMS_LOB.SUBSTR(</span><span class=si>%s</span><span class=s1>)&#39;</span>
<a name=line-314></a>        <span class=k>return</span> <span class=s2>&quot;</span><span class=si>%s</span><span class=s2>&quot;</span>
<a name=line-315></a>
<a name=line-316></a>    <span class=k>def</span> <span class=nf>max_in_list_size</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-317></a>        <span class=k>return</span> <span class=mi>1000</span>
<a name=line-318></a>
<a name=line-319></a>    <span class=k>def</span> <span class=nf>max_name_length</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-320></a>        <span class=k>return</span> <span class=mi>30</span>
<a name=line-321></a>
<a name=line-322></a>    <span class=k>def</span> <span class=nf>pk_default_value</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-323></a>        <span class=k>return</span> <span class=s2>&quot;NULL&quot;</span>
<a name=line-324></a>
<a name=line-325></a>    <span class=k>def</span> <span class=nf>prep_for_iexact_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
<a name=line-326></a>        <span class=k>return</span> <span class=n>x</span>
<a name=line-327></a>
<a name=line-328></a>    <span class=k>def</span> <span class=nf>process_clob</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
<a name=line-329></a>        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-330></a>            <span class=k>return</span> <span class=s1>&#39;&#39;</span>
<a name=line-331></a>        <span class=k>return</span> <span class=n>value</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
<a name=line-332></a>
<a name=line-333></a>    <span class=k>def</span> <span class=nf>quote_name</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-334></a>        <span class=c1># SQL92 requires delimited (quoted) names to be case-sensitive.  When</span>
<a name=line-335></a>        <span class=c1># not quoted, Oracle has case-insensitive behavior for identifiers, but</span>
<a name=line-336></a>        <span class=c1># always defaults to uppercase.</span>
<a name=line-337></a>        <span class=c1># We simplify things by making Oracle identifiers always uppercase.</span>
<a name=line-338></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>name</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>):</span>
<a name=line-339></a>            <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;&quot;</span><span class=si>%s</span><span class=s1>&quot;&#39;</span> <span class=o>%</span> <span class=n>truncate_name</span><span class=p>(</span><span class=n>name</span><span class=o>.</span><span class=n>upper</span><span class=p>(),</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_name_length</span><span class=p>())</span>
<a name=line-340></a>        <span class=c1># Oracle puts the query text into a (query % args) construct, so % signs</span>
<a name=line-341></a>        <span class=c1># in names need to be escaped. The &#39;%%&#39; will be collapsed back to &#39;%&#39; at</span>
<a name=line-342></a>        <span class=c1># that stage so we aren&#39;t really making the name longer here.</span>
<a name=line-343></a>        <span class=n>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;%&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=si>%%</span><span class=s1>&#39;</span><span class=p>)</span>
<a name=line-344></a>        <span class=k>return</span> <span class=n>name</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
<a name=line-345></a>
<a name=line-346></a>    <span class=k>def</span> <span class=nf>regex_lookup</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>lookup_type</span><span class=p>):</span>
<a name=line-347></a>        <span class=k>if</span> <span class=n>lookup_type</span> <span class=o>==</span> <span class=s1>&#39;regex&#39;</span><span class=p>:</span>
<a name=line-348></a>            <span class=n>match_option</span> <span class=o>=</span> <span class=s2>&quot;&#39;c&#39;&quot;</span>
<a name=line-349></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-350></a>            <span class=n>match_option</span> <span class=o>=</span> <span class=s2>&quot;&#39;i&#39;&quot;</span>
<a name=line-351></a>        <span class=k>return</span> <span class=s1>&#39;REGEXP_LIKE(</span><span class=si>%%</span><span class=s1>s, </span><span class=si>%%</span><span class=s1>s, </span><span class=si>%s</span><span class=s1>)&#39;</span> <span class=o>%</span> <span class=n>match_option</span>
<a name=line-352></a>
<a name=line-353></a>    <span class=k>def</span> <span class=nf>return_insert_columns</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fields</span><span class=p>):</span>
<a name=line-354></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>fields</span><span class=p>:</span>
<a name=line-355></a>            <span class=k>return</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=p>()</span>
<a name=line-356></a>        <span class=n>field_names</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-357></a>        <span class=n>params</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-358></a>        <span class=k>for</span> <span class=n>field</span> <span class=ow>in</span> <span class=n>fields</span><span class=p>:</span>
<a name=line-359></a>            <span class=n>field_names</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%s</span><span class=s1>.</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span>
<a name=line-360></a>                <span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>field</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>_meta</span><span class=o>.</span><span class=n>db_table</span><span class=p>),</span>
<a name=line-361></a>                <span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>field</span><span class=o>.</span><span class=n>column</span><span class=p>),</span>
<a name=line-362></a>            <span class=p>))</span>
<a name=line-363></a>            <span class=n>params</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>InsertVar</span><span class=p>(</span><span class=n>field</span><span class=p>))</span>
<a name=line-364></a>        <span class=k>return</span> <span class=s1>&#39;RETURNING </span><span class=si>%s</span><span class=s1> INTO </span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span>
<a name=line-365></a>            <span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>field_names</span><span class=p>),</span>
<a name=line-366></a>            <span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s1>&#39;</span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>params</span><span class=p>)),</span>
<a name=line-367></a>        <span class=p>),</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
<a name=line-368></a>
<a name=line-369></a>    <span class=k>def</span> <span class=nf>__foreign_key_constraints</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>table_name</span><span class=p>,</span> <span class=n>recursive</span><span class=p>):</span>
<a name=line-370></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span> <span class=k>as</span> <span class=n>cursor</span><span class=p>:</span>
<a name=line-371></a>            <span class=k>if</span> <span class=n>recursive</span><span class=p>:</span>
<a name=line-372></a>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
<a name=line-373></a><span class=s2>                    SELECT</span>
<a name=line-374></a><span class=s2>                        user_tables.table_name, rcons.constraint_name</span>
<a name=line-375></a><span class=s2>                    FROM</span>
<a name=line-376></a><span class=s2>                        user_tables</span>
<a name=line-377></a><span class=s2>                    JOIN</span>
<a name=line-378></a><span class=s2>                        user_constraints cons</span>
<a name=line-379></a><span class=s2>                        ON (user_tables.table_name = cons.table_name AND cons.constraint_type = ANY(&#39;P&#39;, &#39;U&#39;))</span>
<a name=line-380></a><span class=s2>                    LEFT JOIN</span>
<a name=line-381></a><span class=s2>                        user_constraints rcons</span>
<a name=line-382></a><span class=s2>                        ON (user_tables.table_name = rcons.table_name AND rcons.constraint_type = &#39;R&#39;)</span>
<a name=line-383></a><span class=s2>                    START WITH user_tables.table_name = UPPER(</span><span class=si>%s</span><span class=s2>)</span>
<a name=line-384></a><span class=s2>                    CONNECT BY NOCYCLE PRIOR cons.constraint_name = rcons.r_constraint_name</span>
<a name=line-385></a><span class=s2>                    GROUP BY</span>
<a name=line-386></a><span class=s2>                        user_tables.table_name, rcons.constraint_name</span>
<a name=line-387></a><span class=s2>                    HAVING user_tables.table_name != UPPER(</span><span class=si>%s</span><span class=s2>)</span>
<a name=line-388></a><span class=s2>                    ORDER BY MAX(level) DESC</span>
<a name=line-389></a><span class=s2>                &quot;&quot;&quot;</span><span class=p>,</span> <span class=p>(</span><span class=n>table_name</span><span class=p>,</span> <span class=n>table_name</span><span class=p>))</span>
<a name=line-390></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-391></a>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
<a name=line-392></a><span class=s2>                    SELECT</span>
<a name=line-393></a><span class=s2>                        cons.table_name, cons.constraint_name</span>
<a name=line-394></a><span class=s2>                    FROM</span>
<a name=line-395></a><span class=s2>                        user_constraints cons</span>
<a name=line-396></a><span class=s2>                    WHERE</span>
<a name=line-397></a><span class=s2>                        cons.constraint_type = &#39;R&#39;</span>
<a name=line-398></a><span class=s2>                        AND cons.table_name = UPPER(</span><span class=si>%s</span><span class=s2>)</span>
<a name=line-399></a><span class=s2>                &quot;&quot;&quot;</span><span class=p>,</span> <span class=p>(</span><span class=n>table_name</span><span class=p>,))</span>
<a name=line-400></a>            <span class=k>return</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
<a name=line-401></a>
<a name=line-402></a>    <span class=nd>@cached_property</span>
<a name=line-403></a>    <span class=k>def</span> <span class=nf>_foreign_key_constraints</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-404></a>        <span class=c1># 512 is large enough to fit the ~330 tables (as of this writing) in</span>
<a name=line-405></a>        <span class=c1># Django&#39;s test suite.</span>
<a name=line-406></a>        <span class=k>return</span> <span class=n>lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>512</span><span class=p>)(</span><span class=bp>self</span><span class=o>.</span><span class=n>__foreign_key_constraints</span><span class=p>)</span>
<a name=line-407></a>
<a name=line-408></a>    <span class=k>def</span> <span class=nf>sql_flush</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>style</span><span class=p>,</span> <span class=n>tables</span><span class=p>,</span> <span class=o>*</span><span class=p>,</span> <span class=n>reset_sequences</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>allow_cascade</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
<a name=line-409></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>tables</span><span class=p>:</span>
<a name=line-410></a>            <span class=k>return</span> <span class=p>[]</span>
<a name=line-411></a>
<a name=line-412></a>        <span class=n>truncated_tables</span> <span class=o>=</span> <span class=p>{</span><span class=n>table</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span> <span class=k>for</span> <span class=n>table</span> <span class=ow>in</span> <span class=n>tables</span><span class=p>}</span>
<a name=line-413></a>        <span class=n>constraints</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<a name=line-414></a>        <span class=c1># Oracle&#39;s TRUNCATE CASCADE only works with ON DELETE CASCADE foreign</span>
<a name=line-415></a>        <span class=c1># keys which Django doesn&#39;t define. Emulate the PostgreSQL behavior</span>
<a name=line-416></a>        <span class=c1># which truncates all dependent tables by manually retrieving all</span>
<a name=line-417></a>        <span class=c1># foreign key constraints and resolving dependencies.</span>
<a name=line-418></a>        <span class=k>for</span> <span class=n>table</span> <span class=ow>in</span> <span class=n>tables</span><span class=p>:</span>
<a name=line-419></a>            <span class=k>for</span> <span class=n>foreign_table</span><span class=p>,</span> <span class=n>constraint</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_foreign_key_constraints</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>recursive</span><span class=o>=</span><span class=n>allow_cascade</span><span class=p>):</span>
<a name=line-420></a>                <span class=k>if</span> <span class=n>allow_cascade</span><span class=p>:</span>
<a name=line-421></a>                    <span class=n>truncated_tables</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>foreign_table</span><span class=p>)</span>
<a name=line-422></a>                <span class=n>constraints</span><span class=o>.</span><span class=n>add</span><span class=p>((</span><span class=n>foreign_table</span><span class=p>,</span> <span class=n>constraint</span><span class=p>))</span>
<a name=line-423></a>        <span class=n>sql</span> <span class=o>=</span> <span class=p>[</span>
<a name=line-424></a>            <span class=s1>&#39;</span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1>;&#39;</span> <span class=o>%</span> <span class=p>(</span>
<a name=line-425></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;ALTER&#39;</span><span class=p>),</span>
<a name=line-426></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;TABLE&#39;</span><span class=p>),</span>
<a name=line-427></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_FIELD</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>table</span><span class=p>)),</span>
<a name=line-428></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;DISABLE&#39;</span><span class=p>),</span>
<a name=line-429></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;CONSTRAINT&#39;</span><span class=p>),</span>
<a name=line-430></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_FIELD</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>constraint</span><span class=p>)),</span>
<a name=line-431></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;KEEP&#39;</span><span class=p>),</span>
<a name=line-432></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;INDEX&#39;</span><span class=p>),</span>
<a name=line-433></a>            <span class=p>)</span> <span class=k>for</span> <span class=n>table</span><span class=p>,</span> <span class=n>constraint</span> <span class=ow>in</span> <span class=n>constraints</span>
<a name=line-434></a>        <span class=p>]</span> <span class=o>+</span> <span class=p>[</span>
<a name=line-435></a>            <span class=s1>&#39;</span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1>;&#39;</span> <span class=o>%</span> <span class=p>(</span>
<a name=line-436></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;TRUNCATE&#39;</span><span class=p>),</span>
<a name=line-437></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;TABLE&#39;</span><span class=p>),</span>
<a name=line-438></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_FIELD</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>table</span><span class=p>)),</span>
<a name=line-439></a>            <span class=p>)</span> <span class=k>for</span> <span class=n>table</span> <span class=ow>in</span> <span class=n>truncated_tables</span>
<a name=line-440></a>        <span class=p>]</span> <span class=o>+</span> <span class=p>[</span>
<a name=line-441></a>            <span class=s1>&#39;</span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1> </span><span class=si>%s</span><span class=s1>;&#39;</span> <span class=o>%</span> <span class=p>(</span>
<a name=line-442></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;ALTER&#39;</span><span class=p>),</span>
<a name=line-443></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;TABLE&#39;</span><span class=p>),</span>
<a name=line-444></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_FIELD</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>table</span><span class=p>)),</span>
<a name=line-445></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;ENABLE&#39;</span><span class=p>),</span>
<a name=line-446></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_KEYWORD</span><span class=p>(</span><span class=s1>&#39;CONSTRAINT&#39;</span><span class=p>),</span>
<a name=line-447></a>                <span class=n>style</span><span class=o>.</span><span class=n>SQL_FIELD</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>constraint</span><span class=p>)),</span>
<a name=line-448></a>            <span class=p>)</span> <span class=k>for</span> <span class=n>table</span><span class=p>,</span> <span class=n>constraint</span> <span class=ow>in</span> <span class=n>constraints</span>
<a name=line-449></a>        <span class=p>]</span>
<a name=line-450></a>        <span class=k>if</span> <span class=n>reset_sequences</span><span class=p>:</span>
<a name=line-451></a>            <span class=n>sequences</span> <span class=o>=</span> <span class=p>[</span>
<a name=line-452></a>                <span class=n>sequence</span>
<a name=line-453></a>                <span class=k>for</span> <span class=n>sequence</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>introspection</span><span class=o>.</span><span class=n>sequence_list</span><span class=p>()</span>
<a name=line-454></a>                <span class=k>if</span> <span class=n>sequence</span><span class=p>[</span><span class=s1>&#39;table&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span> <span class=ow>in</span> <span class=n>truncated_tables</span>
<a name=line-455></a>            <span class=p>]</span>
<a name=line-456></a>            <span class=c1># Since we&#39;ve just deleted all the rows, running our sequence ALTER</span>
<a name=line-457></a>            <span class=c1># code will reset the sequence to 0.</span>
<a name=line-458></a>            <span class=n>sql</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>sequence_reset_by_name_sql</span><span class=p>(</span><span class=n>style</span><span class=p>,</span> <span class=n>sequences</span><span class=p>))</span>
<a name=line-459></a>        <span class=k>return</span> <span class=n>sql</span>
<a name=line-460></a>
<a name=line-461></a>    <span class=k>def</span> <span class=nf>sequence_reset_by_name_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>style</span><span class=p>,</span> <span class=n>sequences</span><span class=p>):</span>
<a name=line-462></a>        <span class=n>sql</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-463></a>        <span class=k>for</span> <span class=n>sequence_info</span> <span class=ow>in</span> <span class=n>sequences</span><span class=p>:</span>
<a name=line-464></a>            <span class=n>no_autofield_sequence_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_no_autofield_sequence_name</span><span class=p>(</span><span class=n>sequence_info</span><span class=p>[</span><span class=s1>&#39;table&#39;</span><span class=p>])</span>
<a name=line-465></a>            <span class=n>table</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>sequence_info</span><span class=p>[</span><span class=s1>&#39;table&#39;</span><span class=p>])</span>
<a name=line-466></a>            <span class=n>column</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>sequence_info</span><span class=p>[</span><span class=s1>&#39;column&#39;</span><span class=p>]</span> <span class=ow>or</span> <span class=s1>&#39;id&#39;</span><span class=p>)</span>
<a name=line-467></a>            <span class=n>query</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_sequence_reset_sql</span> <span class=o>%</span> <span class=p>{</span>
<a name=line-468></a>                <span class=s1>&#39;no_autofield_sequence_name&#39;</span><span class=p>:</span> <span class=n>no_autofield_sequence_name</span><span class=p>,</span>
<a name=line-469></a>                <span class=s1>&#39;table&#39;</span><span class=p>:</span> <span class=n>table</span><span class=p>,</span>
<a name=line-470></a>                <span class=s1>&#39;column&#39;</span><span class=p>:</span> <span class=n>column</span><span class=p>,</span>
<a name=line-471></a>                <span class=s1>&#39;table_name&#39;</span><span class=p>:</span> <span class=n>strip_quotes</span><span class=p>(</span><span class=n>table</span><span class=p>),</span>
<a name=line-472></a>                <span class=s1>&#39;column_name&#39;</span><span class=p>:</span> <span class=n>strip_quotes</span><span class=p>(</span><span class=n>column</span><span class=p>),</span>
<a name=line-473></a>            <span class=p>}</span>
<a name=line-474></a>            <span class=n>sql</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
<a name=line-475></a>        <span class=k>return</span> <span class=n>sql</span>
<a name=line-476></a>
<a name=line-477></a>    <span class=k>def</span> <span class=nf>sequence_reset_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>style</span><span class=p>,</span> <span class=n>model_list</span><span class=p>):</span>
<a name=line-478></a>        <span class=n>output</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-479></a>        <span class=n>query</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_sequence_reset_sql</span>
<a name=line-480></a>        <span class=k>for</span> <span class=n>model</span> <span class=ow>in</span> <span class=n>model_list</span><span class=p>:</span>
<a name=line-481></a>            <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>model</span><span class=o>.</span><span class=n>_meta</span><span class=o>.</span><span class=n>local_fields</span><span class=p>:</span>
<a name=line-482></a>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>AutoField</span><span class=p>):</span>
<a name=line-483></a>                    <span class=n>no_autofield_sequence_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_no_autofield_sequence_name</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>_meta</span><span class=o>.</span><span class=n>db_table</span><span class=p>)</span>
<a name=line-484></a>                    <span class=n>table</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>_meta</span><span class=o>.</span><span class=n>db_table</span><span class=p>)</span>
<a name=line-485></a>                    <span class=n>column</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>column</span><span class=p>)</span>
<a name=line-486></a>                    <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>query</span> <span class=o>%</span> <span class=p>{</span>
<a name=line-487></a>                        <span class=s1>&#39;no_autofield_sequence_name&#39;</span><span class=p>:</span> <span class=n>no_autofield_sequence_name</span><span class=p>,</span>
<a name=line-488></a>                        <span class=s1>&#39;table&#39;</span><span class=p>:</span> <span class=n>table</span><span class=p>,</span>
<a name=line-489></a>                        <span class=s1>&#39;column&#39;</span><span class=p>:</span> <span class=n>column</span><span class=p>,</span>
<a name=line-490></a>                        <span class=s1>&#39;table_name&#39;</span><span class=p>:</span> <span class=n>strip_quotes</span><span class=p>(</span><span class=n>table</span><span class=p>),</span>
<a name=line-491></a>                        <span class=s1>&#39;column_name&#39;</span><span class=p>:</span> <span class=n>strip_quotes</span><span class=p>(</span><span class=n>column</span><span class=p>),</span>
<a name=line-492></a>                    <span class=p>})</span>
<a name=line-493></a>                    <span class=c1># Only one AutoField is allowed per model, so don&#39;t</span>
<a name=line-494></a>                    <span class=c1># continue to loop</span>
<a name=line-495></a>                    <span class=k>break</span>
<a name=line-496></a>        <span class=k>return</span> <span class=n>output</span>
<a name=line-497></a>
<a name=line-498></a>    <span class=k>def</span> <span class=nf>start_transaction_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-499></a>        <span class=k>return</span> <span class=s1>&#39;&#39;</span>
<a name=line-500></a>
<a name=line-501></a>    <span class=k>def</span> <span class=nf>tablespace_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tablespace</span><span class=p>,</span> <span class=n>inline</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
<a name=line-502></a>        <span class=k>if</span> <span class=n>inline</span><span class=p>:</span>
<a name=line-503></a>            <span class=k>return</span> <span class=s2>&quot;USING INDEX TABLESPACE </span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>tablespace</span><span class=p>)</span>
<a name=line-504></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-505></a>            <span class=k>return</span> <span class=s2>&quot;TABLESPACE </span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>quote_name</span><span class=p>(</span><span class=n>tablespace</span><span class=p>)</span>
<a name=line-506></a>
<a name=line-507></a>    <span class=k>def</span> <span class=nf>adapt_datefield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
<a name=line-508></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-509></a><span class=sd>        Transform a date value to an object compatible with what is expected</span>
<a name=line-510></a><span class=sd>        by the backend driver for date columns.</span>
<a name=line-511></a><span class=sd>        The default implementation transforms the date to text, but that is not</span>
<a name=line-512></a><span class=sd>        necessary for Oracle.</span>
<a name=line-513></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-514></a>        <span class=k>return</span> <span class=n>value</span>
<a name=line-515></a>
<a name=line-516></a>    <span class=k>def</span> <span class=nf>adapt_datetimefield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
<a name=line-517></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-518></a><span class=sd>        Transform a datetime value to an object compatible with what is expected</span>
<a name=line-519></a><span class=sd>        by the backend driver for datetime columns.</span>
<a name=line-520></a>
<a name=line-521></a><span class=sd>        If naive datetime is passed assumes that is in UTC. Normally Django</span>
<a name=line-522></a><span class=sd>        models.DateTimeField makes sure that if USE_TZ is True passed datetime</span>
<a name=line-523></a><span class=sd>        is timezone aware.</span>
<a name=line-524></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-525></a>
<a name=line-526></a>        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-527></a>            <span class=k>return</span> <span class=kc>None</span>
<a name=line-528></a>
<a name=line-529></a>        <span class=c1># Expression values are adapted by the database.</span>
<a name=line-530></a>        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=s1>&#39;resolve_expression&#39;</span><span class=p>):</span>
<a name=line-531></a>            <span class=k>return</span> <span class=n>value</span>
<a name=line-532></a>
<a name=line-533></a>        <span class=c1># cx_Oracle doesn&#39;t support tz-aware datetimes</span>
<a name=line-534></a>        <span class=k>if</span> <span class=n>timezone</span><span class=o>.</span><span class=n>is_aware</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
<a name=line-535></a>            <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>USE_TZ</span><span class=p>:</span>
<a name=line-536></a>                <span class=n>value</span> <span class=o>=</span> <span class=n>timezone</span><span class=o>.</span><span class=n>make_naive</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>timezone</span><span class=p>)</span>
<a name=line-537></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-538></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Oracle backend does not support timezone-aware datetimes when USE_TZ is False.&quot;</span><span class=p>)</span>
<a name=line-539></a>
<a name=line-540></a>        <span class=k>return</span> <span class=n>Oracle_datetime</span><span class=o>.</span><span class=n>from_datetime</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<a name=line-541></a>
<a name=line-542></a>    <span class=k>def</span> <span class=nf>adapt_timefield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
<a name=line-543></a>        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-544></a>            <span class=k>return</span> <span class=kc>None</span>
<a name=line-545></a>
<a name=line-546></a>        <span class=c1># Expression values are adapted by the database.</span>
<a name=line-547></a>        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=s1>&#39;resolve_expression&#39;</span><span class=p>):</span>
<a name=line-548></a>            <span class=k>return</span> <span class=n>value</span>
<a name=line-549></a>
<a name=line-550></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<a name=line-551></a>            <span class=k>return</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=o>.</span><span class=n>strptime</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=s1>&#39;%H:%M:%S&#39;</span><span class=p>)</span>
<a name=line-552></a>
<a name=line-553></a>        <span class=c1># Oracle doesn&#39;t support tz-aware times</span>
<a name=line-554></a>        <span class=k>if</span> <span class=n>timezone</span><span class=o>.</span><span class=n>is_aware</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
<a name=line-555></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Oracle backend does not support timezone-aware times.&quot;</span><span class=p>)</span>
<a name=line-556></a>
<a name=line-557></a>        <span class=k>return</span> <span class=n>Oracle_datetime</span><span class=p>(</span><span class=mi>1900</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>value</span><span class=o>.</span><span class=n>hour</span><span class=p>,</span> <span class=n>value</span><span class=o>.</span><span class=n>minute</span><span class=p>,</span>
<a name=line-558></a>                               <span class=n>value</span><span class=o>.</span><span class=n>second</span><span class=p>,</span> <span class=n>value</span><span class=o>.</span><span class=n>microsecond</span><span class=p>)</span>
<a name=line-559></a>
<a name=line-560></a>    <span class=k>def</span> <span class=nf>adapt_decimalfield_value</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>max_digits</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>decimal_places</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-561></a>        <span class=k>return</span> <span class=n>value</span>
<a name=line-562></a>
<a name=line-563></a>    <span class=k>def</span> <span class=nf>combine_expression</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>connector</span><span class=p>,</span> <span class=n>sub_expressions</span><span class=p>):</span>
<a name=line-564></a>        <span class=n>lhs</span><span class=p>,</span> <span class=n>rhs</span> <span class=o>=</span> <span class=n>sub_expressions</span>
<a name=line-565></a>        <span class=k>if</span> <span class=n>connector</span> <span class=o>==</span> <span class=s1>&#39;</span><span class=si>%%</span><span class=s1>&#39;</span><span class=p>:</span>
<a name=line-566></a>            <span class=k>return</span> <span class=s1>&#39;MOD(</span><span class=si>%s</span><span class=s1>)&#39;</span> <span class=o>%</span> <span class=s1>&#39;,&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>sub_expressions</span><span class=p>)</span>
<a name=line-567></a>        <span class=k>elif</span> <span class=n>connector</span> <span class=o>==</span> <span class=s1>&#39;&amp;&#39;</span><span class=p>:</span>
<a name=line-568></a>            <span class=k>return</span> <span class=s1>&#39;BITAND(</span><span class=si>%s</span><span class=s1>)&#39;</span> <span class=o>%</span> <span class=s1>&#39;,&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>sub_expressions</span><span class=p>)</span>
<a name=line-569></a>        <span class=k>elif</span> <span class=n>connector</span> <span class=o>==</span> <span class=s1>&#39;|&#39;</span><span class=p>:</span>
<a name=line-570></a>            <span class=k>return</span> <span class=s1>&#39;BITAND(-</span><span class=si>%(lhs)s</span><span class=s1>-1,</span><span class=si>%(rhs)s</span><span class=s1>)+</span><span class=si>%(lhs)s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>{</span><span class=s1>&#39;lhs&#39;</span><span class=p>:</span> <span class=n>lhs</span><span class=p>,</span> <span class=s1>&#39;rhs&#39;</span><span class=p>:</span> <span class=n>rhs</span><span class=p>}</span>
<a name=line-571></a>        <span class=k>elif</span> <span class=n>connector</span> <span class=o>==</span> <span class=s1>&#39;&lt;&lt;&#39;</span><span class=p>:</span>
<a name=line-572></a>            <span class=k>return</span> <span class=s1>&#39;(</span><span class=si>%(lhs)s</span><span class=s1> * POWER(2, </span><span class=si>%(rhs)s</span><span class=s1>))&#39;</span> <span class=o>%</span> <span class=p>{</span><span class=s1>&#39;lhs&#39;</span><span class=p>:</span> <span class=n>lhs</span><span class=p>,</span> <span class=s1>&#39;rhs&#39;</span><span class=p>:</span> <span class=n>rhs</span><span class=p>}</span>
<a name=line-573></a>        <span class=k>elif</span> <span class=n>connector</span> <span class=o>==</span> <span class=s1>&#39;&gt;&gt;&#39;</span><span class=p>:</span>
<a name=line-574></a>            <span class=k>return</span> <span class=s1>&#39;FLOOR(</span><span class=si>%(lhs)s</span><span class=s1> / POWER(2, </span><span class=si>%(rhs)s</span><span class=s1>))&#39;</span> <span class=o>%</span> <span class=p>{</span><span class=s1>&#39;lhs&#39;</span><span class=p>:</span> <span class=n>lhs</span><span class=p>,</span> <span class=s1>&#39;rhs&#39;</span><span class=p>:</span> <span class=n>rhs</span><span class=p>}</span>
<a name=line-575></a>        <span class=k>elif</span> <span class=n>connector</span> <span class=o>==</span> <span class=s1>&#39;^&#39;</span><span class=p>:</span>
<a name=line-576></a>            <span class=k>return</span> <span class=s1>&#39;POWER(</span><span class=si>%s</span><span class=s1>)&#39;</span> <span class=o>%</span> <span class=s1>&#39;,&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>sub_expressions</span><span class=p>)</span>
<a name=line-577></a>        <span class=k>elif</span> <span class=n>connector</span> <span class=o>==</span> <span class=s1>&#39;#&#39;</span><span class=p>:</span>
<a name=line-578></a>            <span class=k>raise</span> <span class=n>NotSupportedError</span><span class=p>(</span><span class=s1>&#39;Bitwise XOR is not supported in Oracle.&#39;</span><span class=p>)</span>
<a name=line-579></a>        <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>combine_expression</span><span class=p>(</span><span class=n>connector</span><span class=p>,</span> <span class=n>sub_expressions</span><span class=p>)</span>
<a name=line-580></a>
<a name=line-581></a>    <span class=k>def</span> <span class=nf>_get_no_autofield_sequence_name</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>table</span><span class=p>):</span>
<a name=line-582></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-583></a><span class=sd>        Manually created sequence name to keep backward compatibility for</span>
<a name=line-584></a><span class=sd>        AutoFields that aren&#39;t Oracle identity columns.</span>
<a name=line-585></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-586></a>        <span class=n>name_length</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_name_length</span><span class=p>()</span> <span class=o>-</span> <span class=mi>3</span>
<a name=line-587></a>        <span class=k>return</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1>_SQ&#39;</span> <span class=o>%</span> <span class=n>truncate_name</span><span class=p>(</span><span class=n>strip_quotes</span><span class=p>(</span><span class=n>table</span><span class=p>),</span> <span class=n>name_length</span><span class=p>)</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
<a name=line-588></a>
<a name=line-589></a>    <span class=k>def</span> <span class=nf>_get_sequence_name</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cursor</span><span class=p>,</span> <span class=n>table</span><span class=p>,</span> <span class=n>pk_name</span><span class=p>):</span>
<a name=line-590></a>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&quot;&quot;&quot;</span>
<a name=line-591></a><span class=s2>            SELECT sequence_name</span>
<a name=line-592></a><span class=s2>            FROM user_tab_identity_cols</span>
<a name=line-593></a><span class=s2>            WHERE table_name = UPPER(</span><span class=si>%s</span><span class=s2>)</span>
<a name=line-594></a><span class=s2>            AND column_name = UPPER(</span><span class=si>%s</span><span class=s2>)&quot;&quot;&quot;</span><span class=p>,</span> <span class=p>[</span><span class=n>table</span><span class=p>,</span> <span class=n>pk_name</span><span class=p>])</span>
<a name=line-595></a>        <span class=n>row</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
<a name=line-596></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_no_autofield_sequence_name</span><span class=p>(</span><span class=n>table</span><span class=p>)</span> <span class=k>if</span> <span class=n>row</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=n>row</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<a name=line-597></a>
<a name=line-598></a>    <span class=k>def</span> <span class=nf>bulk_insert_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fields</span><span class=p>,</span> <span class=n>placeholder_rows</span><span class=p>):</span>
<a name=line-599></a>        <span class=n>query</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-600></a>        <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>placeholder_rows</span><span class=p>:</span>
<a name=line-601></a>            <span class=n>select</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-602></a>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>placeholder</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>row</span><span class=p>):</span>
<a name=line-603></a>                <span class=c1># A model without any fields has fields=[None].</span>
<a name=line-604></a>                <span class=k>if</span> <span class=n>fields</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
<a name=line-605></a>                    <span class=n>internal_type</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>fields</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=s1>&#39;target_field&#39;</span><span class=p>,</span> <span class=n>fields</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=o>.</span><span class=n>get_internal_type</span><span class=p>()</span>
<a name=line-606></a>                    <span class=n>placeholder</span> <span class=o>=</span> <span class=n>BulkInsertMapper</span><span class=o>.</span><span class=n>types</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>internal_type</span><span class=p>,</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>%</span> <span class=n>placeholder</span>
<a name=line-607></a>                <span class=c1># Add columns aliases to the first select to avoid &quot;ORA-00918:</span>
<a name=line-608></a>                <span class=c1># column ambiguously defined&quot; when two or more columns in the</span>
<a name=line-609></a>                <span class=c1># first select have the same value.</span>
<a name=line-610></a>                <span class=k>if</span> <span class=ow>not</span> <span class=n>query</span><span class=p>:</span>
<a name=line-611></a>                    <span class=n>placeholder</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1> col_</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>placeholder</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span>
<a name=line-612></a>                <span class=n>select</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>placeholder</span><span class=p>)</span>
<a name=line-613></a>            <span class=n>query</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;SELECT </span><span class=si>%s</span><span class=s1> FROM DUAL&#39;</span> <span class=o>%</span> <span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>select</span><span class=p>))</span>
<a name=line-614></a>        <span class=c1># Bulk insert to tables with Oracle identity columns causes Oracle to</span>
<a name=line-615></a>        <span class=c1># add sequence.nextval to it. Sequence.nextval cannot be used with the</span>
<a name=line-616></a>        <span class=c1># UNION operator. To prevent incorrect SQL, move UNION to a subquery.</span>
<a name=line-617></a>        <span class=k>return</span> <span class=s1>&#39;SELECT * FROM (</span><span class=si>%s</span><span class=s1>)&#39;</span> <span class=o>%</span> <span class=s1>&#39; UNION ALL &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
<a name=line-618></a>
<a name=line-619></a>    <span class=k>def</span> <span class=nf>subtract_temporals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>internal_type</span><span class=p>,</span> <span class=n>lhs</span><span class=p>,</span> <span class=n>rhs</span><span class=p>):</span>
<a name=line-620></a>        <span class=k>if</span> <span class=n>internal_type</span> <span class=o>==</span> <span class=s1>&#39;DateField&#39;</span><span class=p>:</span>
<a name=line-621></a>            <span class=n>lhs_sql</span><span class=p>,</span> <span class=n>lhs_params</span> <span class=o>=</span> <span class=n>lhs</span>
<a name=line-622></a>            <span class=n>rhs_sql</span><span class=p>,</span> <span class=n>rhs_params</span> <span class=o>=</span> <span class=n>rhs</span>
<a name=line-623></a>            <span class=n>params</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=n>lhs_params</span><span class=p>,</span> <span class=o>*</span><span class=n>rhs_params</span><span class=p>)</span>
<a name=line-624></a>            <span class=k>return</span> <span class=s2>&quot;NUMTODSINTERVAL(TO_NUMBER(</span><span class=si>%s</span><span class=s2> - </span><span class=si>%s</span><span class=s2>), &#39;DAY&#39;)&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>lhs_sql</span><span class=p>,</span> <span class=n>rhs_sql</span><span class=p>),</span> <span class=n>params</span>
<a name=line-625></a>        <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>subtract_temporals</span><span class=p>(</span><span class=n>internal_type</span><span class=p>,</span> <span class=n>lhs</span><span class=p>,</span> <span class=n>rhs</span><span class=p>)</span>
<a name=line-626></a>
<a name=line-627></a>    <span class=k>def</span> <span class=nf>bulk_batch_size</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fields</span><span class=p>,</span> <span class=n>objs</span><span class=p>):</span>
<a name=line-628></a>        <span class=sd>&quot;&quot;&quot;Oracle restricts the number of parameters in a query.&quot;&quot;&quot;</span>
<a name=line-629></a>        <span class=k>if</span> <span class=n>fields</span><span class=p>:</span>
<a name=line-630></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>features</span><span class=o>.</span><span class=n>max_query_params</span> <span class=o>//</span> <span class=nb>len</span><span class=p>(</span><span class=n>fields</span><span class=p>)</span>
<a name=line-631></a>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=n>objs</span><span class=p>)</span>
<a name=line-632></a>
<a name=line-633></a>    <span class=k>def</span> <span class=nf>conditional_expression_supported_in_where_clause</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>expression</span><span class=p>):</span>
<a name=line-634></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-635></a><span class=sd>        Oracle supports only EXISTS(...) or filters in the WHERE clause, others</span>
<a name=line-636></a><span class=sd>        must be compared with True.</span>
<a name=line-637></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-638></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>expression</span><span class=p>,</span> <span class=p>(</span><span class=n>Exists</span><span class=p>,</span> <span class=n>WhereNode</span><span class=p>)):</span>
<a name=line-639></a>            <span class=k>return</span> <span class=kc>True</span>
<a name=line-640></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>expression</span><span class=p>,</span> <span class=n>ExpressionWrapper</span><span class=p>)</span> <span class=ow>and</span> <span class=n>expression</span><span class=o>.</span><span class=n>conditional</span><span class=p>:</span>
<a name=line-641></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>conditional_expression_supported_in_where_clause</span><span class=p>(</span><span class=n>expression</span><span class=o>.</span><span class=n>expression</span><span class=p>)</span>
<a name=line-642></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>expression</span><span class=p>,</span> <span class=n>RawSQL</span><span class=p>)</span> <span class=ow>and</span> <span class=n>expression</span><span class=o>.</span><span class=n>conditional</span><span class=p>:</span>
<a name=line-643></a>            <span class=k>return</span> <span class=kc>True</span>
<a name=line-644></a>        <span class=k>return</span> <span class=kc>False</span>
</pre></div></td></tr></table><p class=footer> Generated by <a href=https://github.com/spirali/nedoc>nedoc</a> v0.9 at 2020-12-29 14:04 </p></div></div></body></html>
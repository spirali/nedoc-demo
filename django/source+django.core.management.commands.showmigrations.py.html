<!DOCTYPE html><html><head><meta charset=utf-8><title>django.core.management.commands.showmigrations</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./assets/purecss/pure-min.css><link rel=stylesheet href=./assets/purecss/grids-responsive-min.css><link rel=stylesheet href=./assets/style.css><link rel=stylesheet href=./assets/pygments/default.css><link rel=stylesheet href=./assets/jquery/jquery-ui.min.css><script src=./assets/jquery/jquery-3.0.0.min.js></script><script src=./assets/jquery/jquery-ui.min.js></script><script src=nedoc.js></script></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-1-4"><div class=header><h1 class=brand-title>Django</h1> 1.0 </div><div id=sbox><input id=search style="color: black;" placeholder="search ..."></div><div class=tree><ul><li><a href=django.html>&#9662; django</a> </li><li><ul><li><a href=django.__main__.html>&#9656; __main__</a> </li><li><a href=django.apps.html>&#9656; apps</a> </li><li><a href=django.bin.html>&#9656; bin</a> </li><li><a href=django.conf.html>&#9656; conf</a> </li><li><a href=django.contrib.html>&#9656; contrib</a> </li><li><a href=django.core.html>&#9662; core</a> </li><li><ul><li><a href=django.core.asgi.html>&#9656; asgi</a> </li><li><a href=django.core.cache.html>&#9656; cache</a> </li><li><a href=django.core.checks.html>&#9656; checks</a> </li><li><a href=django.core.exceptions.html>&#9656; exceptions</a> </li><li><a href=django.core.files.html>&#9656; files</a> </li><li><a href=django.core.handlers.html>&#9656; handlers</a> </li><li><a href=django.core.mail.html>&#9656; mail</a> </li><li><a href=django.core.management.html>&#9662; management</a> </li><li><ul><li><a href=django.core.management.base.html>&#9656; base</a> </li><li><a href=django.core.management.color.html>&#9656; color</a> </li><li><a href=django.core.management.commands.html>&#9662; commands</a> </li><li><ul><li><a href=django.core.management.commands.check.html>&#9656; check</a> </li><li><a href=django.core.management.commands.compilemessages.html>&#9656; compilemessages</a> </li><li><a href=django.core.management.commands.createcachetable.html>&#9656; createcachetable</a> </li><li><a href=django.core.management.commands.dbshell.html>&#9656; dbshell</a> </li><li><a href=django.core.management.commands.diffsettings.html>&#9656; diffsettings</a> </li><li><a href=django.core.management.commands.dumpdata.html>&#9656; dumpdata</a> </li><li><a href=django.core.management.commands.flush.html>&#9656; flush</a> </li><li><a href=django.core.management.commands.inspectdb.html>&#9656; inspectdb</a> </li><li><a href=django.core.management.commands.loaddata.html>&#9656; loaddata</a> </li><li><a href=django.core.management.commands.makemessages.html>&#9656; makemessages</a> </li><li><a href=django.core.management.commands.makemigrations.html>&#9656; makemigrations</a> </li><li><a href=django.core.management.commands.migrate.html>&#9656; migrate</a> </li><li><a href=django.core.management.commands.runserver.html>&#9656; runserver</a> </li><li><a href=django.core.management.commands.sendtestemail.html>&#9656; sendtestemail</a> </li><li><a href=django.core.management.commands.shell.html>&#9656; shell</a> </li><li><div class=select><a href=django.core.management.commands.showmigrations.html>&#9662; showmigrations</a> </div></li><li><ul><li><a href=django.core.management.commands.showmigrations.Command.html> <i>class</i> Command</a> </li></ul></li><li><a href=django.core.management.commands.sqlflush.html>&#9656; sqlflush</a> </li><li><a href=django.core.management.commands.sqlmigrate.html>&#9656; sqlmigrate</a> </li><li><a href=django.core.management.commands.sqlsequencereset.html>&#9656; sqlsequencereset</a> </li><li><a href=django.core.management.commands.squashmigrations.html>&#9656; squashmigrations</a> </li><li><a href=django.core.management.commands.startapp.html>&#9656; startapp</a> </li><li><a href=django.core.management.commands.startproject.html>&#9656; startproject</a> </li><li><a href=django.core.management.commands.test.html>&#9656; test</a> </li><li><a href=django.core.management.commands.testserver.html>&#9656; testserver</a> </li></ul></li><li><a href=django.core.management.sql.html>&#9656; sql</a> </li><li><a href=django.core.management.templates.html>&#9656; templates</a> </li><li><a href=django.core.management.utils.html>&#9656; utils</a> </li><li><a href=django.core.management.ManagementUtility.html> <i>class</i> ManagementUtility</a> </li></ul></li><li><a href=django.core.paginator.html>&#9656; paginator</a> </li><li><a href=django.core.serializers.html>&#9656; serializers</a> </li><li><a href=django.core.servers.html>&#9656; servers</a> </li><li><a href=django.core.signals.html>&#9656; signals</a> </li><li><a href=django.core.signing.html>&#9656; signing</a> </li><li><a href=django.core.validators.html>&#9656; validators</a> </li><li><a href=django.core.wsgi.html>&#9656; wsgi</a> </li></ul></li><li><a href=django.db.html>&#9656; db</a> </li><li><a href=django.dispatch.html>&#9656; dispatch</a> </li><li><a href=django.forms.html>&#9656; forms</a> </li><li><a href=django.http.html>&#9656; http</a> </li><li><a href=django.middleware.html>&#9656; middleware</a> </li><li><a href=django.shortcuts.html>&#9656; shortcuts</a> </li><li><a href=django.template.html>&#9656; template</a> </li><li><a href=django.templatetags.html>&#9656; templatetags</a> </li><li><a href=django.test.html>&#9656; test</a> </li><li><a href=django.urls.html>&#9656; urls</a> </li><li><a href=django.utils.html>&#9656; utils</a> </li><li><a href=django.views.html>&#9656; views</a> </li></ul></ul></div></div><div class="content pure-u-1 pure-u-md-3-4"><h1>Source code django/core/management/commands/showmigrations.py</h1><div id=path><a class=symbol href=django.html>django</a>.<a class=symbol href=django.core.html>core</a>.<a class=symbol href=django.core.management.html>management</a>.<a class=symbol href=django.core.management.commands.html>commands</a>.<a class=symbol href=django.core.management.commands.showmigrations.html>showmigrations</a></div><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147</pre></div></td><td class=code><div class=highlight><pre><span></span><a name=line-1></a><span class=kn>import</span> <span class=nn>sys</span>
<a name=line-2></a>
<a name=line-3></a><span class=kn>from</span> <span class=nn>django.apps</span> <span class=kn>import</span> <span class=n>apps</span>
<a name=line-4></a><span class=kn>from</span> <span class=nn>django.core.management.base</span> <span class=kn>import</span> <span class=n>BaseCommand</span>
<a name=line-5></a><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>DEFAULT_DB_ALIAS</span><span class=p>,</span> <span class=n>connections</span>
<a name=line-6></a><span class=kn>from</span> <span class=nn>django.db.migrations.loader</span> <span class=kn>import</span> <span class=n>MigrationLoader</span>
<a name=line-7></a>
<a name=line-8></a>
<a name=line-9></a><span class=k>class</span> <span class=nc>Command</span><span class=p>(</span><span class=n>BaseCommand</span><span class=p>):</span>
<a name=line-10></a>    <span class=n>help</span> <span class=o>=</span> <span class=s2>&quot;Shows all available migrations for the current project&quot;</span>
<a name=line-11></a>
<a name=line-12></a>    <span class=k>def</span> <span class=nf>add_arguments</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parser</span><span class=p>):</span>
<a name=line-13></a>        <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
<a name=line-14></a>            <span class=s1>&#39;app_label&#39;</span><span class=p>,</span> <span class=n>nargs</span><span class=o>=</span><span class=s1>&#39;*&#39;</span><span class=p>,</span>
<a name=line-15></a>            <span class=n>help</span><span class=o>=</span><span class=s1>&#39;App labels of applications to limit the output to.&#39;</span><span class=p>,</span>
<a name=line-16></a>        <span class=p>)</span>
<a name=line-17></a>        <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
<a name=line-18></a>            <span class=s1>&#39;--database&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=n>DEFAULT_DB_ALIAS</span><span class=p>,</span>
<a name=line-19></a>            <span class=n>help</span><span class=o>=</span><span class=s1>&#39;Nominates a database to synchronize. Defaults to the &quot;default&quot; database.&#39;</span><span class=p>,</span>
<a name=line-20></a>        <span class=p>)</span>
<a name=line-21></a>
<a name=line-22></a>        <span class=n>formats</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>add_mutually_exclusive_group</span><span class=p>()</span>
<a name=line-23></a>        <span class=n>formats</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
<a name=line-24></a>            <span class=s1>&#39;--list&#39;</span><span class=p>,</span> <span class=s1>&#39;-l&#39;</span><span class=p>,</span> <span class=n>action</span><span class=o>=</span><span class=s1>&#39;store_const&#39;</span><span class=p>,</span> <span class=n>dest</span><span class=o>=</span><span class=s1>&#39;format&#39;</span><span class=p>,</span> <span class=n>const</span><span class=o>=</span><span class=s1>&#39;list&#39;</span><span class=p>,</span>
<a name=line-25></a>            <span class=n>help</span><span class=o>=</span><span class=p>(</span>
<a name=line-26></a>                <span class=s1>&#39;Shows a list of all migrations and which are applied. &#39;</span>
<a name=line-27></a>                <span class=s1>&#39;With a verbosity level of 2 or above, the applied datetimes &#39;</span>
<a name=line-28></a>                <span class=s1>&#39;will be included.&#39;</span>
<a name=line-29></a>            <span class=p>),</span>
<a name=line-30></a>        <span class=p>)</span>
<a name=line-31></a>        <span class=n>formats</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
<a name=line-32></a>            <span class=s1>&#39;--plan&#39;</span><span class=p>,</span> <span class=s1>&#39;-p&#39;</span><span class=p>,</span> <span class=n>action</span><span class=o>=</span><span class=s1>&#39;store_const&#39;</span><span class=p>,</span> <span class=n>dest</span><span class=o>=</span><span class=s1>&#39;format&#39;</span><span class=p>,</span> <span class=n>const</span><span class=o>=</span><span class=s1>&#39;plan&#39;</span><span class=p>,</span>
<a name=line-33></a>            <span class=n>help</span><span class=o>=</span><span class=p>(</span>
<a name=line-34></a>                <span class=s1>&#39;Shows all migrations in the order they will be applied. &#39;</span>
<a name=line-35></a>                <span class=s1>&#39;With a verbosity level of 2 or above all direct migration dependencies &#39;</span>
<a name=line-36></a>                <span class=s1>&#39;and reverse dependencies (run_before) will be included.&#39;</span>
<a name=line-37></a>            <span class=p>)</span>
<a name=line-38></a>        <span class=p>)</span>
<a name=line-39></a>
<a name=line-40></a>        <span class=n>parser</span><span class=o>.</span><span class=n>set_defaults</span><span class=p>(</span><span class=nb>format</span><span class=o>=</span><span class=s1>&#39;list&#39;</span><span class=p>)</span>
<a name=line-41></a>
<a name=line-42></a>    <span class=k>def</span> <span class=nf>handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>options</span><span class=p>):</span>
<a name=line-43></a>        <span class=bp>self</span><span class=o>.</span><span class=n>verbosity</span> <span class=o>=</span> <span class=n>options</span><span class=p>[</span><span class=s1>&#39;verbosity&#39;</span><span class=p>]</span>
<a name=line-44></a>
<a name=line-45></a>        <span class=c1># Get the database we&#39;re operating from</span>
<a name=line-46></a>        <span class=n>db</span> <span class=o>=</span> <span class=n>options</span><span class=p>[</span><span class=s1>&#39;database&#39;</span><span class=p>]</span>
<a name=line-47></a>        <span class=n>connection</span> <span class=o>=</span> <span class=n>connections</span><span class=p>[</span><span class=n>db</span><span class=p>]</span>
<a name=line-48></a>
<a name=line-49></a>        <span class=k>if</span> <span class=n>options</span><span class=p>[</span><span class=s1>&#39;format&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;plan&quot;</span><span class=p>:</span>
<a name=line-50></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>show_plan</span><span class=p>(</span><span class=n>connection</span><span class=p>,</span> <span class=n>options</span><span class=p>[</span><span class=s1>&#39;app_label&#39;</span><span class=p>])</span>
<a name=line-51></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-52></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>show_list</span><span class=p>(</span><span class=n>connection</span><span class=p>,</span> <span class=n>options</span><span class=p>[</span><span class=s1>&#39;app_label&#39;</span><span class=p>])</span>
<a name=line-53></a>
<a name=line-54></a>    <span class=k>def</span> <span class=nf>_validate_app_names</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>loader</span><span class=p>,</span> <span class=n>app_names</span><span class=p>):</span>
<a name=line-55></a>        <span class=n>has_bad_names</span> <span class=o>=</span> <span class=kc>False</span>
<a name=line-56></a>        <span class=k>for</span> <span class=n>app_name</span> <span class=ow>in</span> <span class=n>app_names</span><span class=p>:</span>
<a name=line-57></a>            <span class=k>try</span><span class=p>:</span>
<a name=line-58></a>                <span class=n>apps</span><span class=o>.</span><span class=n>get_app_config</span><span class=p>(</span><span class=n>app_name</span><span class=p>)</span>
<a name=line-59></a>            <span class=k>except</span> <span class=ne>LookupError</span> <span class=k>as</span> <span class=n>err</span><span class=p>:</span>
<a name=line-60></a>                <span class=bp>self</span><span class=o>.</span><span class=n>stderr</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>err</span><span class=p>))</span>
<a name=line-61></a>                <span class=n>has_bad_names</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-62></a>        <span class=k>if</span> <span class=n>has_bad_names</span><span class=p>:</span>
<a name=line-63></a>            <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
<a name=line-64></a>
<a name=line-65></a>    <span class=k>def</span> <span class=nf>show_list</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>connection</span><span class=p>,</span> <span class=n>app_names</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-66></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-67></a><span class=sd>        Show a list of all migrations on the system, or only those of</span>
<a name=line-68></a><span class=sd>        some named apps.</span>
<a name=line-69></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-70></a>        <span class=c1># Load migrations from disk/DB</span>
<a name=line-71></a>        <span class=n>loader</span> <span class=o>=</span> <span class=n>MigrationLoader</span><span class=p>(</span><span class=n>connection</span><span class=p>,</span> <span class=n>ignore_no_migrations</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a name=line-72></a>        <span class=n>graph</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>graph</span>
<a name=line-73></a>        <span class=c1># If we were passed a list of apps, validate it</span>
<a name=line-74></a>        <span class=k>if</span> <span class=n>app_names</span><span class=p>:</span>
<a name=line-75></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_validate_app_names</span><span class=p>(</span><span class=n>loader</span><span class=p>,</span> <span class=n>app_names</span><span class=p>)</span>
<a name=line-76></a>        <span class=c1># Otherwise, show all apps in alphabetic order</span>
<a name=line-77></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-78></a>            <span class=n>app_names</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>loader</span><span class=o>.</span><span class=n>migrated_apps</span><span class=p>)</span>
<a name=line-79></a>        <span class=c1># For each app, print its migrations in order from oldest (roots) to</span>
<a name=line-80></a>        <span class=c1># newest (leaves).</span>
<a name=line-81></a>        <span class=k>for</span> <span class=n>app_name</span> <span class=ow>in</span> <span class=n>app_names</span><span class=p>:</span>
<a name=line-82></a>            <span class=bp>self</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>app_name</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>style</span><span class=o>.</span><span class=n>MIGRATE_LABEL</span><span class=p>)</span>
<a name=line-83></a>            <span class=n>shown</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<a name=line-84></a>            <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>graph</span><span class=o>.</span><span class=n>leaf_nodes</span><span class=p>(</span><span class=n>app_name</span><span class=p>):</span>
<a name=line-85></a>                <span class=k>for</span> <span class=n>plan_node</span> <span class=ow>in</span> <span class=n>graph</span><span class=o>.</span><span class=n>forwards_plan</span><span class=p>(</span><span class=n>node</span><span class=p>):</span>
<a name=line-86></a>                    <span class=k>if</span> <span class=n>plan_node</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>shown</span> <span class=ow>and</span> <span class=n>plan_node</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=n>app_name</span><span class=p>:</span>
<a name=line-87></a>                        <span class=c1># Give it a nice title if it&#39;s a squashed one</span>
<a name=line-88></a>                        <span class=n>title</span> <span class=o>=</span> <span class=n>plan_node</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
<a name=line-89></a>                        <span class=k>if</span> <span class=n>graph</span><span class=o>.</span><span class=n>nodes</span><span class=p>[</span><span class=n>plan_node</span><span class=p>]</span><span class=o>.</span><span class=n>replaces</span><span class=p>:</span>
<a name=line-90></a>                            <span class=n>title</span> <span class=o>+=</span> <span class=s2>&quot; (</span><span class=si>%s</span><span class=s2> squashed migrations)&quot;</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>graph</span><span class=o>.</span><span class=n>nodes</span><span class=p>[</span><span class=n>plan_node</span><span class=p>]</span><span class=o>.</span><span class=n>replaces</span><span class=p>)</span>
<a name=line-91></a>                        <span class=n>applied_migration</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>applied_migrations</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>plan_node</span><span class=p>)</span>
<a name=line-92></a>                        <span class=c1># Mark it as applied/unapplied</span>
<a name=line-93></a>                        <span class=k>if</span> <span class=n>applied_migration</span><span class=p>:</span>
<a name=line-94></a>                            <span class=n>output</span> <span class=o>=</span> <span class=s1>&#39; [X] </span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>title</span>
<a name=line-95></a>                            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbosity</span> <span class=o>&gt;=</span> <span class=mi>2</span><span class=p>:</span>
<a name=line-96></a>                                <span class=n>output</span> <span class=o>+=</span> <span class=s1>&#39; (applied at </span><span class=si>%s</span><span class=s1>)&#39;</span> <span class=o>%</span> <span class=n>applied_migration</span><span class=o>.</span><span class=n>applied</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>)</span>
<a name=line-97></a>                            <span class=bp>self</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>output</span><span class=p>)</span>
<a name=line-98></a>                        <span class=k>else</span><span class=p>:</span>
<a name=line-99></a>                            <span class=bp>self</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&quot; [ ] </span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=n>title</span><span class=p>)</span>
<a name=line-100></a>                        <span class=n>shown</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>plan_node</span><span class=p>)</span>
<a name=line-101></a>            <span class=c1># If we didn&#39;t print anything, then a small message</span>
<a name=line-102></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>shown</span><span class=p>:</span>
<a name=line-103></a>                <span class=bp>self</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&quot; (no migrations)&quot;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>style</span><span class=o>.</span><span class=n>ERROR</span><span class=p>)</span>
<a name=line-104></a>
<a name=line-105></a>    <span class=k>def</span> <span class=nf>show_plan</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>connection</span><span class=p>,</span> <span class=n>app_names</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-106></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-107></a><span class=sd>        Show all known migrations (or only those of the specified app_names)</span>
<a name=line-108></a><span class=sd>        in the order they will be applied.</span>
<a name=line-109></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-110></a>        <span class=c1># Load migrations from disk/DB</span>
<a name=line-111></a>        <span class=n>loader</span> <span class=o>=</span> <span class=n>MigrationLoader</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span>
<a name=line-112></a>        <span class=n>graph</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>graph</span>
<a name=line-113></a>        <span class=k>if</span> <span class=n>app_names</span><span class=p>:</span>
<a name=line-114></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_validate_app_names</span><span class=p>(</span><span class=n>loader</span><span class=p>,</span> <span class=n>app_names</span><span class=p>)</span>
<a name=line-115></a>            <span class=n>targets</span> <span class=o>=</span> <span class=p>[</span><span class=n>key</span> <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>graph</span><span class=o>.</span><span class=n>leaf_nodes</span><span class=p>()</span> <span class=k>if</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=ow>in</span> <span class=n>app_names</span><span class=p>]</span>
<a name=line-116></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-117></a>            <span class=n>targets</span> <span class=o>=</span> <span class=n>graph</span><span class=o>.</span><span class=n>leaf_nodes</span><span class=p>()</span>
<a name=line-118></a>        <span class=n>plan</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-119></a>        <span class=n>seen</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<a name=line-120></a>
<a name=line-121></a>        <span class=c1># Generate the plan</span>
<a name=line-122></a>        <span class=k>for</span> <span class=n>target</span> <span class=ow>in</span> <span class=n>targets</span><span class=p>:</span>
<a name=line-123></a>            <span class=k>for</span> <span class=n>migration</span> <span class=ow>in</span> <span class=n>graph</span><span class=o>.</span><span class=n>forwards_plan</span><span class=p>(</span><span class=n>target</span><span class=p>):</span>
<a name=line-124></a>                <span class=k>if</span> <span class=n>migration</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>seen</span><span class=p>:</span>
<a name=line-125></a>                    <span class=n>node</span> <span class=o>=</span> <span class=n>graph</span><span class=o>.</span><span class=n>node_map</span><span class=p>[</span><span class=n>migration</span><span class=p>]</span>
<a name=line-126></a>                    <span class=n>plan</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>node</span><span class=p>)</span>
<a name=line-127></a>                    <span class=n>seen</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>migration</span><span class=p>)</span>
<a name=line-128></a>
<a name=line-129></a>        <span class=c1># Output</span>
<a name=line-130></a>        <span class=k>def</span> <span class=nf>print_deps</span><span class=p>(</span><span class=n>node</span><span class=p>):</span>
<a name=line-131></a>            <span class=n>out</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-132></a>            <span class=k>for</span> <span class=n>parent</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>node</span><span class=o>.</span><span class=n>parents</span><span class=p>):</span>
<a name=line-133></a>                <span class=n>out</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>%s</span><span class=s2>.</span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=n>parent</span><span class=o>.</span><span class=n>key</span><span class=p>)</span>
<a name=line-134></a>            <span class=k>if</span> <span class=n>out</span><span class=p>:</span>
<a name=line-135></a>                <span class=k>return</span> <span class=s2>&quot; ... (</span><span class=si>%s</span><span class=s2>)&quot;</span> <span class=o>%</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
<a name=line-136></a>            <span class=k>return</span> <span class=s2>&quot;&quot;</span>
<a name=line-137></a>
<a name=line-138></a>        <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>plan</span><span class=p>:</span>
<a name=line-139></a>            <span class=n>deps</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>
<a name=line-140></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbosity</span> <span class=o>&gt;=</span> <span class=mi>2</span><span class=p>:</span>
<a name=line-141></a>                <span class=n>deps</span> <span class=o>=</span> <span class=n>print_deps</span><span class=p>(</span><span class=n>node</span><span class=p>)</span>
<a name=line-142></a>            <span class=k>if</span> <span class=n>node</span><span class=o>.</span><span class=n>key</span> <span class=ow>in</span> <span class=n>loader</span><span class=o>.</span><span class=n>applied_migrations</span><span class=p>:</span>
<a name=line-143></a>                <span class=bp>self</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&quot;[X]  </span><span class=si>%s</span><span class=s2>.</span><span class=si>%s%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>node</span><span class=o>.</span><span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>node</span><span class=o>.</span><span class=n>key</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>deps</span><span class=p>))</span>
<a name=line-144></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-145></a>                <span class=bp>self</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&quot;[ ]  </span><span class=si>%s</span><span class=s2>.</span><span class=si>%s%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>node</span><span class=o>.</span><span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>node</span><span class=o>.</span><span class=n>key</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>deps</span><span class=p>))</span>
<a name=line-146></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>plan</span><span class=p>:</span>
<a name=line-147></a>            <span class=bp>self</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;(no migrations)&#39;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>style</span><span class=o>.</span><span class=n>ERROR</span><span class=p>)</span>
</pre></div></td></tr></table><p class=footer> Generated by <a href=https://github.com/spirali/nedoc>nedoc</a> v0.9 at 2020-12-29 14:04 </p></div></div></body></html>
<!DOCTYPE html><html><head><meta charset=utf-8><title>django.utils.html</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./assets/purecss/pure-min.css><link rel=stylesheet href=./assets/purecss/grids-responsive-min.css><link rel=stylesheet href=./assets/style.css><link rel=stylesheet href=./assets/pygments/default.css><link rel=stylesheet href=./assets/jquery/jquery-ui.min.css><script src=./assets/jquery/jquery-3.0.0.min.js></script><script src=./assets/jquery/jquery-ui.min.js></script><script src=nedoc.js></script></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-1-4"><div class=header><h1 class=brand-title>Django</h1> 1.0 </div><div id=sbox><input id=search style="color: black;" placeholder="search ..."></div><div class=tree><ul><li><a href=django.html>&#9662; django</a> </li><li><ul><li><a href=django.__main__.html>&#9656; __main__</a> </li><li><a href=django.apps.html>&#9656; apps</a> </li><li><a href=django.bin.html>&#9656; bin</a> </li><li><a href=django.conf.html>&#9656; conf</a> </li><li><a href=django.contrib.html>&#9656; contrib</a> </li><li><a href=django.core.html>&#9656; core</a> </li><li><a href=django.db.html>&#9656; db</a> </li><li><a href=django.dispatch.html>&#9656; dispatch</a> </li><li><a href=django.forms.html>&#9656; forms</a> </li><li><a href=django.http.html>&#9656; http</a> </li><li><a href=django.middleware.html>&#9656; middleware</a> </li><li><a href=django.shortcuts.html>&#9656; shortcuts</a> </li><li><a href=django.template.html>&#9656; template</a> </li><li><a href=django.templatetags.html>&#9656; templatetags</a> </li><li><a href=django.test.html>&#9656; test</a> </li><li><a href=django.urls.html>&#9656; urls</a> </li><li><a href=django.utils.html>&#9662; utils</a> </li><li><ul><li><a href=django.utils.archive.html>&#9656; archive</a> </li><li><a href=django.utils.asyncio.html>&#9656; asyncio</a> </li><li><a href=django.utils.autoreload.html>&#9656; autoreload</a> </li><li><a href=django.utils.baseconv.html>&#9656; baseconv</a> </li><li><a href=django.utils.cache.html>&#9656; cache</a> </li><li><a href=django.utils.crypto.html>&#9656; crypto</a> </li><li><a href=django.utils.datastructures.html>&#9656; datastructures</a> </li><li><a href=django.utils.dateformat.html>&#9656; dateformat</a> </li><li><a href=django.utils.dateparse.html>&#9656; dateparse</a> </li><li><a href=django.utils.dates.html>&#9656; dates</a> </li><li><a href=django.utils.datetime_safe.html>&#9656; datetime_safe</a> </li><li><a href=django.utils.deconstruct.html>&#9656; deconstruct</a> </li><li><a href=django.utils.decorators.html>&#9656; decorators</a> </li><li><a href=django.utils.deprecation.html>&#9656; deprecation</a> </li><li><a href=django.utils.duration.html>&#9656; duration</a> </li><li><a href=django.utils.encoding.html>&#9656; encoding</a> </li><li><a href=django.utils.feedgenerator.html>&#9656; feedgenerator</a> </li><li><a href=django.utils.formats.html>&#9656; formats</a> </li><li><a href=django.utils.functional.html>&#9656; functional</a> </li><li><a href=django.utils.hashable.html>&#9656; hashable</a> </li><li><div class=select><a href=django.utils.html.html>&#9662; html</a> </div></li><li><ul><li><a href=django.utils.html.MLStripper.html> <i>class</i> MLStripper</a> </li></ul></li><li><a href=django.utils.http.html>&#9656; http</a> </li><li><a href=django.utils.inspect.html>&#9656; inspect</a> </li><li><a href=django.utils.ipv6.html>&#9656; ipv6</a> </li><li><a href=django.utils.itercompat.html>&#9656; itercompat</a> </li><li><a href=django.utils.jslex.html>&#9656; jslex</a> </li><li><a href=django.utils.log.html>&#9656; log</a> </li><li><a href=django.utils.lorem_ipsum.html>&#9656; lorem_ipsum</a> </li><li><a href=django.utils.module_loading.html>&#9656; module_loading</a> </li><li><a href=django.utils.numberformat.html>&#9656; numberformat</a> </li><li><a href=django.utils.regex_helper.html>&#9656; regex_helper</a> </li><li><a href=django.utils.safestring.html>&#9656; safestring</a> </li><li><a href=django.utils.termcolors.html>&#9656; termcolors</a> </li><li><a href=django.utils.text.html>&#9656; text</a> </li><li><a href=django.utils.timesince.html>&#9656; timesince</a> </li><li><a href=django.utils.timezone.html>&#9656; timezone</a> </li><li><a href=django.utils.topological_sort.html>&#9656; topological_sort</a> </li><li><a href=django.utils.translation.html>&#9656; translation</a> </li><li><a href=django.utils.tree.html>&#9656; tree</a> </li><li><a href=django.utils.version.html>&#9656; version</a> </li><li><a href=django.utils.xmlutils.html>&#9656; xmlutils</a> </li></ul></li><li><a href=django.views.html>&#9656; views</a> </li></ul></ul></div></div><div class="content pure-u-1 pure-u-md-3-4"><h1>Source code django/utils/html.py</h1><div id=path><a class=symbol href=django.html>django</a>.<a class=symbol href=django.utils.html>utils</a>.<a class=symbol href=django.utils.html.html>html</a></div><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378</pre></div></td><td class=code><div class=highlight><pre><span></span><a name=line-1></a><span class=sd>&quot;&quot;&quot;HTML utilities suitable for global use.&quot;&quot;&quot;</span>
<a name=line-2></a>
<a name=line-3></a><span class=kn>import</span> <span class=nn>html</span>
<a name=line-4></a><span class=kn>import</span> <span class=nn>json</span>
<a name=line-5></a><span class=kn>import</span> <span class=nn>re</span>
<a name=line-6></a><span class=kn>from</span> <span class=nn>html.parser</span> <span class=kn>import</span> <span class=n>HTMLParser</span>
<a name=line-7></a><span class=kn>from</span> <span class=nn>urllib.parse</span> <span class=kn>import</span> <span class=p>(</span>
<a name=line-8></a>    <span class=n>parse_qsl</span><span class=p>,</span> <span class=n>quote</span><span class=p>,</span> <span class=n>unquote</span><span class=p>,</span> <span class=n>urlencode</span><span class=p>,</span> <span class=n>urlsplit</span><span class=p>,</span> <span class=n>urlunsplit</span><span class=p>,</span>
<a name=line-9></a><span class=p>)</span>
<a name=line-10></a>
<a name=line-11></a><span class=kn>from</span> <span class=nn>django.utils.encoding</span> <span class=kn>import</span> <span class=n>punycode</span>
<a name=line-12></a><span class=kn>from</span> <span class=nn>django.utils.functional</span> <span class=kn>import</span> <span class=n>Promise</span><span class=p>,</span> <span class=n>keep_lazy</span><span class=p>,</span> <span class=n>keep_lazy_text</span>
<a name=line-13></a><span class=kn>from</span> <span class=nn>django.utils.http</span> <span class=kn>import</span> <span class=n>RFC3986_GENDELIMS</span><span class=p>,</span> <span class=n>RFC3986_SUBDELIMS</span>
<a name=line-14></a><span class=kn>from</span> <span class=nn>django.utils.regex_helper</span> <span class=kn>import</span> <span class=n>_lazy_re_compile</span>
<a name=line-15></a><span class=kn>from</span> <span class=nn>django.utils.safestring</span> <span class=kn>import</span> <span class=n>SafeData</span><span class=p>,</span> <span class=n>SafeString</span><span class=p>,</span> <span class=n>mark_safe</span>
<a name=line-16></a><span class=kn>from</span> <span class=nn>django.utils.text</span> <span class=kn>import</span> <span class=n>normalize_newlines</span>
<a name=line-17></a>
<a name=line-18></a><span class=c1># Configuration for urlize() function.</span>
<a name=line-19></a><span class=n>TRAILING_PUNCTUATION_CHARS</span> <span class=o>=</span> <span class=s1>&#39;.,:;!&#39;</span>
<a name=line-20></a><span class=n>WRAPPING_PUNCTUATION</span> <span class=o>=</span> <span class=p>[(</span><span class=s1>&#39;(&#39;</span><span class=p>,</span> <span class=s1>&#39;)&#39;</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;[&#39;</span><span class=p>,</span> <span class=s1>&#39;]&#39;</span><span class=p>)]</span>
<a name=line-21></a>
<a name=line-22></a><span class=c1># List of possible strings used for bullets in bulleted lists.</span>
<a name=line-23></a><span class=n>DOTS</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;&amp;middot;&#39;</span><span class=p>,</span> <span class=s1>&#39;*&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\u2022</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;&amp;#149;&#39;</span><span class=p>,</span> <span class=s1>&#39;&amp;bull;&#39;</span><span class=p>,</span> <span class=s1>&#39;&amp;#8226;&#39;</span><span class=p>]</span>
<a name=line-24></a>
<a name=line-25></a><span class=n>word_split_re</span> <span class=o>=</span> <span class=n>_lazy_re_compile</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;&#39;&#39;([\s&lt;&gt;&quot;&#39;]+)&#39;&#39;&#39;</span><span class=p>)</span>
<a name=line-26></a><span class=n>simple_url_re</span> <span class=o>=</span> <span class=n>_lazy_re_compile</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;^https?://\[?\w&#39;</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span><span class=p>)</span>
<a name=line-27></a><span class=n>simple_url_2_re</span> <span class=o>=</span> <span class=n>_lazy_re_compile</span><span class=p>(</span>
<a name=line-28></a>    <span class=sa>r</span><span class=s1>&#39;^www\.|^(?!http)\w[^@]+\.(com|edu|gov|int|mil|net|org)($|/.*)$&#39;</span><span class=p>,</span>
<a name=line-29></a>    <span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span>
<a name=line-30></a><span class=p>)</span>
<a name=line-31></a>
<a name=line-32></a>
<a name=line-33></a><span class=nd>@keep_lazy</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>SafeString</span><span class=p>)</span>
<a name=line-34></a><span class=k>def</span> <span class=nf>escape</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
<a name=line-35></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-36></a><span class=sd>    Return the given text with ampersands, quotes and angle brackets encoded</span>
<a name=line-37></a><span class=sd>    for use in HTML.</span>
<a name=line-38></a>
<a name=line-39></a><span class=sd>    Always escape input, even if it&#39;s already escaped and marked as such.</span>
<a name=line-40></a><span class=sd>    This may result in double-escaping. If this is a concern, use</span>
<a name=line-41></a><span class=sd>    conditional_escape() instead.</span>
<a name=line-42></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-43></a>    <span class=k>return</span> <span class=n>mark_safe</span><span class=p>(</span><span class=n>html</span><span class=o>.</span><span class=n>escape</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>text</span><span class=p>)))</span>
<a name=line-44></a>
<a name=line-45></a>
<a name=line-46></a><span class=n>_js_escapes</span> <span class=o>=</span> <span class=p>{</span>
<a name=line-47></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\\</span><span class=s1>&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u005C&#39;</span><span class=p>,</span>
<a name=line-48></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\&#39;</span><span class=s1>&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u0027&#39;</span><span class=p>,</span>
<a name=line-49></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u0022&#39;</span><span class=p>,</span>
<a name=line-50></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;&gt;&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u003E&#39;</span><span class=p>,</span>
<a name=line-51></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;&lt;&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u003C&#39;</span><span class=p>,</span>
<a name=line-52></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;&amp;&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u0026&#39;</span><span class=p>,</span>
<a name=line-53></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u003D&#39;</span><span class=p>,</span>
<a name=line-54></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u002D&#39;</span><span class=p>,</span>
<a name=line-55></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;;&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u003B&#39;</span><span class=p>,</span>
<a name=line-56></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;`&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u0060&#39;</span><span class=p>,</span>
<a name=line-57></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\u2028</span><span class=s1>&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u2028&#39;</span><span class=p>,</span>
<a name=line-58></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\u2029</span><span class=s1>&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u2029&#39;</span>
<a name=line-59></a><span class=p>}</span>
<a name=line-60></a>
<a name=line-61></a><span class=c1># Escape every ASCII character with a value less than 32.</span>
<a name=line-62></a><span class=n>_js_escapes</span><span class=o>.</span><span class=n>update</span><span class=p>((</span><span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%c</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>z</span><span class=p>),</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u</span><span class=si>%04X</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>z</span><span class=p>)</span> <span class=k>for</span> <span class=n>z</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>32</span><span class=p>))</span>
<a name=line-63></a>
<a name=line-64></a>
<a name=line-65></a><span class=nd>@keep_lazy</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>SafeString</span><span class=p>)</span>
<a name=line-66></a><span class=k>def</span> <span class=nf>escapejs</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
<a name=line-67></a>    <span class=sd>&quot;&quot;&quot;Hex encode characters for use in JavaScript strings.&quot;&quot;&quot;</span>
<a name=line-68></a>    <span class=k>return</span> <span class=n>mark_safe</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>value</span><span class=p>)</span><span class=o>.</span><span class=n>translate</span><span class=p>(</span><span class=n>_js_escapes</span><span class=p>))</span>
<a name=line-69></a>
<a name=line-70></a>
<a name=line-71></a><span class=n>_json_script_escapes</span> <span class=o>=</span> <span class=p>{</span>
<a name=line-72></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;&gt;&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u003E&#39;</span><span class=p>,</span>
<a name=line-73></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;&lt;&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u003C&#39;</span><span class=p>,</span>
<a name=line-74></a>    <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39;&amp;&#39;</span><span class=p>):</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>u0026&#39;</span><span class=p>,</span>
<a name=line-75></a><span class=p>}</span>
<a name=line-76></a>
<a name=line-77></a>
<a name=line-78></a><span class=k>def</span> <span class=nf>json_script</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>element_id</span><span class=p>):</span>
<a name=line-79></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-80></a><span class=sd>    Escape all the HTML/XML special characters with their unicode escapes, so</span>
<a name=line-81></a><span class=sd>    value is safe to be output anywhere except for inside a tag attribute. Wrap</span>
<a name=line-82></a><span class=sd>    the escaped JSON in a script tag.</span>
<a name=line-83></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-84></a>    <span class=kn>from</span> <span class=nn>django.core.serializers.json</span> <span class=kn>import</span> <span class=n>DjangoJSONEncoder</span>
<a name=line-85></a>    <span class=n>json_str</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=bp>cls</span><span class=o>=</span><span class=n>DjangoJSONEncoder</span><span class=p>)</span><span class=o>.</span><span class=n>translate</span><span class=p>(</span><span class=n>_json_script_escapes</span><span class=p>)</span>
<a name=line-86></a>    <span class=k>return</span> <span class=n>format_html</span><span class=p>(</span>
<a name=line-87></a>        <span class=s1>&#39;&lt;script id=&quot;</span><span class=si>{}</span><span class=s1>&quot; type=&quot;application/json&quot;&gt;</span><span class=si>{}</span><span class=s1>&lt;/script&gt;&#39;</span><span class=p>,</span>
<a name=line-88></a>        <span class=n>element_id</span><span class=p>,</span> <span class=n>mark_safe</span><span class=p>(</span><span class=n>json_str</span><span class=p>)</span>
<a name=line-89></a>    <span class=p>)</span>
<a name=line-90></a>
<a name=line-91></a>
<a name=line-92></a><span class=k>def</span> <span class=nf>conditional_escape</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
<a name=line-93></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-94></a><span class=sd>    Similar to escape(), except that it doesn&#39;t operate on pre-escaped strings.</span>
<a name=line-95></a>
<a name=line-96></a><span class=sd>    This function relies on the __html__ convention used both by Django&#39;s</span>
<a name=line-97></a><span class=sd>    SafeData class and by third-party libraries like markupsafe.</span>
<a name=line-98></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-99></a>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>Promise</span><span class=p>):</span>
<a name=line-100></a>        <span class=n>text</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
<a name=line-101></a>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=s1>&#39;__html__&#39;</span><span class=p>):</span>
<a name=line-102></a>        <span class=k>return</span> <span class=n>text</span><span class=o>.</span><span class=n>__html__</span><span class=p>()</span>
<a name=line-103></a>    <span class=k>else</span><span class=p>:</span>
<a name=line-104></a>        <span class=k>return</span> <span class=n>escape</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
<a name=line-105></a>
<a name=line-106></a>
<a name=line-107></a><span class=k>def</span> <span class=nf>format_html</span><span class=p>(</span><span class=n>format_string</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<a name=line-108></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-109></a><span class=sd>    Similar to str.format, but pass all arguments through conditional_escape(),</span>
<a name=line-110></a><span class=sd>    and call mark_safe() on the result. This function should be used instead</span>
<a name=line-111></a><span class=sd>    of str.format or % interpolation to build up small HTML fragments.</span>
<a name=line-112></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-113></a>    <span class=n>args_safe</span> <span class=o>=</span> <span class=nb>map</span><span class=p>(</span><span class=n>conditional_escape</span><span class=p>,</span> <span class=n>args</span><span class=p>)</span>
<a name=line-114></a>    <span class=n>kwargs_safe</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>conditional_escape</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=k>for</span> <span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=n>v</span><span class=p>)</span> <span class=ow>in</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
<a name=line-115></a>    <span class=k>return</span> <span class=n>mark_safe</span><span class=p>(</span><span class=n>format_string</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=o>*</span><span class=n>args_safe</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs_safe</span><span class=p>))</span>
<a name=line-116></a>
<a name=line-117></a>
<a name=line-118></a><span class=k>def</span> <span class=nf>format_html_join</span><span class=p>(</span><span class=n>sep</span><span class=p>,</span> <span class=n>format_string</span><span class=p>,</span> <span class=n>args_generator</span><span class=p>):</span>
<a name=line-119></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-120></a><span class=sd>    A wrapper of format_html, for the common case of a group of arguments that</span>
<a name=line-121></a><span class=sd>    need to be formatted using the same format string, and then joined using</span>
<a name=line-122></a><span class=sd>    &#39;sep&#39;. &#39;sep&#39; is also passed through conditional_escape.</span>
<a name=line-123></a>
<a name=line-124></a><span class=sd>    &#39;args_generator&#39; should be an iterator that returns the sequence of &#39;args&#39;</span>
<a name=line-125></a><span class=sd>    that will be passed to format_html.</span>
<a name=line-126></a>
<a name=line-127></a><span class=sd>    Example:</span>
<a name=line-128></a>
<a name=line-129></a><span class=sd>      format_html_join(&#39;\n&#39;, &quot;&lt;li&gt;{} {}&lt;/li&gt;&quot;, ((u.first_name, u.last_name)</span>
<a name=line-130></a><span class=sd>                                                  for u in users))</span>
<a name=line-131></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-132></a>    <span class=k>return</span> <span class=n>mark_safe</span><span class=p>(</span><span class=n>conditional_escape</span><span class=p>(</span><span class=n>sep</span><span class=p>)</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
<a name=line-133></a>        <span class=n>format_html</span><span class=p>(</span><span class=n>format_string</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>)</span>
<a name=line-134></a>        <span class=k>for</span> <span class=n>args</span> <span class=ow>in</span> <span class=n>args_generator</span>
<a name=line-135></a>    <span class=p>))</span>
<a name=line-136></a>
<a name=line-137></a>
<a name=line-138></a><span class=nd>@keep_lazy_text</span>
<a name=line-139></a><span class=k>def</span> <span class=nf>linebreaks</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>autoescape</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
<a name=line-140></a>    <span class=sd>&quot;&quot;&quot;Convert newlines into &lt;p&gt; and &lt;br&gt;s.&quot;&quot;&quot;</span>
<a name=line-141></a>    <span class=n>value</span> <span class=o>=</span> <span class=n>normalize_newlines</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<a name=line-142></a>    <span class=n>paras</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>{2,}&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>value</span><span class=p>))</span>
<a name=line-143></a>    <span class=k>if</span> <span class=n>autoescape</span><span class=p>:</span>
<a name=line-144></a>        <span class=n>paras</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;&lt;p&gt;</span><span class=si>%s</span><span class=s1>&lt;/p&gt;&#39;</span> <span class=o>%</span> <span class=n>escape</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;br&gt;&#39;</span><span class=p>)</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>paras</span><span class=p>]</span>
<a name=line-145></a>    <span class=k>else</span><span class=p>:</span>
<a name=line-146></a>        <span class=n>paras</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;&lt;p&gt;</span><span class=si>%s</span><span class=s1>&lt;/p&gt;&#39;</span> <span class=o>%</span> <span class=n>p</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;br&gt;&#39;</span><span class=p>)</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>paras</span><span class=p>]</span>
<a name=line-147></a>    <span class=k>return</span> <span class=s1>&#39;</span><span class=se>\n\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>paras</span><span class=p>)</span>
<a name=line-148></a>
<a name=line-149></a>
<a name=line-150></a><span class=k>class</span> <span class=nc>MLStripper</span><span class=p>(</span><span class=n>HTMLParser</span><span class=p>):</span>
<a name=line-151></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-152></a>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>convert_charrefs</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<a name=line-153></a>        <span class=bp>self</span><span class=o>.</span><span class=n>reset</span><span class=p>()</span>
<a name=line-154></a>        <span class=bp>self</span><span class=o>.</span><span class=n>fed</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-155></a>
<a name=line-156></a>    <span class=k>def</span> <span class=nf>handle_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>d</span><span class=p>):</span>
<a name=line-157></a>        <span class=bp>self</span><span class=o>.</span><span class=n>fed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
<a name=line-158></a>
<a name=line-159></a>    <span class=k>def</span> <span class=nf>handle_entityref</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-160></a>        <span class=bp>self</span><span class=o>.</span><span class=n>fed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;&amp;</span><span class=si>%s</span><span class=s1>;&#39;</span> <span class=o>%</span> <span class=n>name</span><span class=p>)</span>
<a name=line-161></a>
<a name=line-162></a>    <span class=k>def</span> <span class=nf>handle_charref</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-163></a>        <span class=bp>self</span><span class=o>.</span><span class=n>fed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s1>&#39;&amp;#</span><span class=si>%s</span><span class=s1>;&#39;</span> <span class=o>%</span> <span class=n>name</span><span class=p>)</span>
<a name=line-164></a>
<a name=line-165></a>    <span class=k>def</span> <span class=nf>get_data</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-166></a>        <span class=k>return</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fed</span><span class=p>)</span>
<a name=line-167></a>
<a name=line-168></a>
<a name=line-169></a><span class=k>def</span> <span class=nf>_strip_once</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
<a name=line-170></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-171></a><span class=sd>    Internal tag stripping utility used by strip_tags.</span>
<a name=line-172></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-173></a>    <span class=n>s</span> <span class=o>=</span> <span class=n>MLStripper</span><span class=p>()</span>
<a name=line-174></a>    <span class=n>s</span><span class=o>.</span><span class=n>feed</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<a name=line-175></a>    <span class=n>s</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-176></a>    <span class=k>return</span> <span class=n>s</span><span class=o>.</span><span class=n>get_data</span><span class=p>()</span>
<a name=line-177></a>
<a name=line-178></a>
<a name=line-179></a><span class=nd>@keep_lazy_text</span>
<a name=line-180></a><span class=k>def</span> <span class=nf>strip_tags</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
<a name=line-181></a>    <span class=sd>&quot;&quot;&quot;Return the given HTML with all tags stripped.&quot;&quot;&quot;</span>
<a name=line-182></a>    <span class=c1># Note: in typical case this loop executes _strip_once once. Loop condition</span>
<a name=line-183></a>    <span class=c1># is redundant, but helps to reduce number of executions of _strip_once.</span>
<a name=line-184></a>    <span class=n>value</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<a name=line-185></a>    <span class=k>while</span> <span class=s1>&#39;&lt;&#39;</span> <span class=ow>in</span> <span class=n>value</span> <span class=ow>and</span> <span class=s1>&#39;&gt;&#39;</span> <span class=ow>in</span> <span class=n>value</span><span class=p>:</span>
<a name=line-186></a>        <span class=n>new_value</span> <span class=o>=</span> <span class=n>_strip_once</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<a name=line-187></a>        <span class=k>if</span> <span class=n>value</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s1>&#39;&lt;&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=n>new_value</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s1>&#39;&lt;&#39;</span><span class=p>):</span>
<a name=line-188></a>            <span class=c1># _strip_once wasn&#39;t able to detect more tags.</span>
<a name=line-189></a>            <span class=k>break</span>
<a name=line-190></a>        <span class=n>value</span> <span class=o>=</span> <span class=n>new_value</span>
<a name=line-191></a>    <span class=k>return</span> <span class=n>value</span>
<a name=line-192></a>
<a name=line-193></a>
<a name=line-194></a><span class=nd>@keep_lazy_text</span>
<a name=line-195></a><span class=k>def</span> <span class=nf>strip_spaces_between_tags</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
<a name=line-196></a>    <span class=sd>&quot;&quot;&quot;Return the given HTML with spaces between tags removed.&quot;&quot;&quot;</span>
<a name=line-197></a>    <span class=k>return</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;&gt;\s+&lt;&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;&lt;&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>value</span><span class=p>))</span>
<a name=line-198></a>
<a name=line-199></a>
<a name=line-200></a><span class=k>def</span> <span class=nf>smart_urlquote</span><span class=p>(</span><span class=n>url</span><span class=p>):</span>
<a name=line-201></a>    <span class=sd>&quot;&quot;&quot;Quote a URL if it isn&#39;t already quoted.&quot;&quot;&quot;</span>
<a name=line-202></a>    <span class=k>def</span> <span class=nf>unquote_quote</span><span class=p>(</span><span class=n>segment</span><span class=p>):</span>
<a name=line-203></a>        <span class=n>segment</span> <span class=o>=</span> <span class=n>unquote</span><span class=p>(</span><span class=n>segment</span><span class=p>)</span>
<a name=line-204></a>        <span class=c1># Tilde is part of RFC3986 Unreserved Characters</span>
<a name=line-205></a>        <span class=c1># https://tools.ietf.org/html/rfc3986#section-2.3</span>
<a name=line-206></a>        <span class=c1># See also https://bugs.python.org/issue16285</span>
<a name=line-207></a>        <span class=k>return</span> <span class=n>quote</span><span class=p>(</span><span class=n>segment</span><span class=p>,</span> <span class=n>safe</span><span class=o>=</span><span class=n>RFC3986_SUBDELIMS</span> <span class=o>+</span> <span class=n>RFC3986_GENDELIMS</span> <span class=o>+</span> <span class=s1>&#39;~&#39;</span><span class=p>)</span>
<a name=line-208></a>
<a name=line-209></a>    <span class=c1># Handle IDN before quoting.</span>
<a name=line-210></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-211></a>        <span class=n>scheme</span><span class=p>,</span> <span class=n>netloc</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=n>fragment</span> <span class=o>=</span> <span class=n>urlsplit</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
<a name=line-212></a>    <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
<a name=line-213></a>        <span class=c1># invalid IPv6 URL (normally square brackets in hostname part).</span>
<a name=line-214></a>        <span class=k>return</span> <span class=n>unquote_quote</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
<a name=line-215></a>
<a name=line-216></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-217></a>        <span class=n>netloc</span> <span class=o>=</span> <span class=n>punycode</span><span class=p>(</span><span class=n>netloc</span><span class=p>)</span>  <span class=c1># IDN -&gt; ACE</span>
<a name=line-218></a>    <span class=k>except</span> <span class=ne>UnicodeError</span><span class=p>:</span>  <span class=c1># invalid domain part</span>
<a name=line-219></a>        <span class=k>return</span> <span class=n>unquote_quote</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
<a name=line-220></a>
<a name=line-221></a>    <span class=k>if</span> <span class=n>query</span><span class=p>:</span>
<a name=line-222></a>        <span class=c1># Separately unquoting key/value, so as to not mix querystring separators</span>
<a name=line-223></a>        <span class=c1># included in query values. See #22267.</span>
<a name=line-224></a>        <span class=n>query_parts</span> <span class=o>=</span> <span class=p>[(</span><span class=n>unquote</span><span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=n>unquote</span><span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
<a name=line-225></a>                       <span class=k>for</span> <span class=n>q</span> <span class=ow>in</span> <span class=n>parse_qsl</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>keep_blank_values</span><span class=o>=</span><span class=kc>True</span><span class=p>)]</span>
<a name=line-226></a>        <span class=c1># urlencode will take care of quoting</span>
<a name=line-227></a>        <span class=n>query</span> <span class=o>=</span> <span class=n>urlencode</span><span class=p>(</span><span class=n>query_parts</span><span class=p>)</span>
<a name=line-228></a>
<a name=line-229></a>    <span class=n>path</span> <span class=o>=</span> <span class=n>unquote_quote</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
<a name=line-230></a>    <span class=n>fragment</span> <span class=o>=</span> <span class=n>unquote_quote</span><span class=p>(</span><span class=n>fragment</span><span class=p>)</span>
<a name=line-231></a>
<a name=line-232></a>    <span class=k>return</span> <span class=n>urlunsplit</span><span class=p>((</span><span class=n>scheme</span><span class=p>,</span> <span class=n>netloc</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=n>fragment</span><span class=p>))</span>
<a name=line-233></a>
<a name=line-234></a>
<a name=line-235></a><span class=nd>@keep_lazy_text</span>
<a name=line-236></a><span class=k>def</span> <span class=nf>urlize</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>trim_url_limit</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>nofollow</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>autoescape</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
<a name=line-237></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-238></a><span class=sd>    Convert any URLs in text into clickable links.</span>
<a name=line-239></a>
<a name=line-240></a><span class=sd>    Works on http://, https://, www. links, and also on links ending in one of</span>
<a name=line-241></a><span class=sd>    the original seven gTLDs (.com, .edu, .gov, .int, .mil, .net, and .org).</span>
<a name=line-242></a><span class=sd>    Links can have trailing punctuation (periods, commas, close-parens) and</span>
<a name=line-243></a><span class=sd>    leading punctuation (opening parens) and it&#39;ll still do the right thing.</span>
<a name=line-244></a>
<a name=line-245></a><span class=sd>    If trim_url_limit is not None, truncate the URLs in the link text longer</span>
<a name=line-246></a><span class=sd>    than this limit to trim_url_limit - 1 characters and append an ellipsis.</span>
<a name=line-247></a>
<a name=line-248></a><span class=sd>    If nofollow is True, give the links a rel=&quot;nofollow&quot; attribute.</span>
<a name=line-249></a>
<a name=line-250></a><span class=sd>    If autoescape is True, autoescape the link text and URLs.</span>
<a name=line-251></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-252></a>    <span class=n>safe_input</span> <span class=o>=</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>SafeData</span><span class=p>)</span>
<a name=line-253></a>
<a name=line-254></a>    <span class=k>def</span> <span class=nf>trim_url</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>limit</span><span class=o>=</span><span class=n>trim_url_limit</span><span class=p>):</span>
<a name=line-255></a>        <span class=k>if</span> <span class=n>limit</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>limit</span><span class=p>:</span>
<a name=line-256></a>            <span class=k>return</span> <span class=n>x</span>
<a name=line-257></a>        <span class=k>return</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1>â€¦&#39;</span> <span class=o>%</span> <span class=n>x</span><span class=p>[:</span><span class=nb>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>limit</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)]</span>
<a name=line-258></a>
<a name=line-259></a>    <span class=k>def</span> <span class=nf>trim_punctuation</span><span class=p>(</span><span class=n>lead</span><span class=p>,</span> <span class=n>middle</span><span class=p>,</span> <span class=n>trail</span><span class=p>):</span>
<a name=line-260></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-261></a><span class=sd>        Trim trailing and wrapping punctuation from `middle`. Return the items</span>
<a name=line-262></a><span class=sd>        of the new state.</span>
<a name=line-263></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-264></a>        <span class=c1># Continue trimming until middle remains unchanged.</span>
<a name=line-265></a>        <span class=n>trimmed_something</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-266></a>        <span class=k>while</span> <span class=n>trimmed_something</span><span class=p>:</span>
<a name=line-267></a>            <span class=n>trimmed_something</span> <span class=o>=</span> <span class=kc>False</span>
<a name=line-268></a>            <span class=c1># Trim wrapping punctuation.</span>
<a name=line-269></a>            <span class=k>for</span> <span class=n>opening</span><span class=p>,</span> <span class=n>closing</span> <span class=ow>in</span> <span class=n>WRAPPING_PUNCTUATION</span><span class=p>:</span>
<a name=line-270></a>                <span class=k>if</span> <span class=n>middle</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>opening</span><span class=p>):</span>
<a name=line-271></a>                    <span class=n>middle</span> <span class=o>=</span> <span class=n>middle</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>opening</span><span class=p>):]</span>
<a name=line-272></a>                    <span class=n>lead</span> <span class=o>+=</span> <span class=n>opening</span>
<a name=line-273></a>                    <span class=n>trimmed_something</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-274></a>                <span class=c1># Keep parentheses at the end only if they&#39;re balanced.</span>
<a name=line-275></a>                <span class=k>if</span> <span class=p>(</span><span class=n>middle</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=n>closing</span><span class=p>)</span> <span class=ow>and</span>
<a name=line-276></a>                        <span class=n>middle</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=n>closing</span><span class=p>)</span> <span class=o>==</span> <span class=n>middle</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=n>opening</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
<a name=line-277></a>                    <span class=n>middle</span> <span class=o>=</span> <span class=n>middle</span><span class=p>[:</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>closing</span><span class=p>)]</span>
<a name=line-278></a>                    <span class=n>trail</span> <span class=o>=</span> <span class=n>closing</span> <span class=o>+</span> <span class=n>trail</span>
<a name=line-279></a>                    <span class=n>trimmed_something</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-280></a>            <span class=c1># Trim trailing punctuation (after trimming wrapping punctuation,</span>
<a name=line-281></a>            <span class=c1># as encoded entities contain &#39;;&#39;). Unescape entities to avoid</span>
<a name=line-282></a>            <span class=c1># breaking them by removing &#39;;&#39;.</span>
<a name=line-283></a>            <span class=n>middle_unescaped</span> <span class=o>=</span> <span class=n>html</span><span class=o>.</span><span class=n>unescape</span><span class=p>(</span><span class=n>middle</span><span class=p>)</span>
<a name=line-284></a>            <span class=n>stripped</span> <span class=o>=</span> <span class=n>middle_unescaped</span><span class=o>.</span><span class=n>rstrip</span><span class=p>(</span><span class=n>TRAILING_PUNCTUATION_CHARS</span><span class=p>)</span>
<a name=line-285></a>            <span class=k>if</span> <span class=n>middle_unescaped</span> <span class=o>!=</span> <span class=n>stripped</span><span class=p>:</span>
<a name=line-286></a>                <span class=n>trail</span> <span class=o>=</span> <span class=n>middle</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>stripped</span><span class=p>):]</span> <span class=o>+</span> <span class=n>trail</span>
<a name=line-287></a>                <span class=n>middle</span> <span class=o>=</span> <span class=n>middle</span><span class=p>[:</span><span class=nb>len</span><span class=p>(</span><span class=n>stripped</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>middle_unescaped</span><span class=p>)]</span>
<a name=line-288></a>                <span class=n>trimmed_something</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-289></a>        <span class=k>return</span> <span class=n>lead</span><span class=p>,</span> <span class=n>middle</span><span class=p>,</span> <span class=n>trail</span>
<a name=line-290></a>
<a name=line-291></a>    <span class=k>def</span> <span class=nf>is_email_simple</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
<a name=line-292></a>        <span class=sd>&quot;&quot;&quot;Return True if value looks like an email address.&quot;&quot;&quot;</span>
<a name=line-293></a>        <span class=c1># An @ must be in the middle of the value.</span>
<a name=line-294></a>        <span class=k>if</span> <span class=s1>&#39;@&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>value</span> <span class=ow>or</span> <span class=n>value</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;@&#39;</span><span class=p>)</span> <span class=ow>or</span> <span class=n>value</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;@&#39;</span><span class=p>):</span>
<a name=line-295></a>            <span class=k>return</span> <span class=kc>False</span>
<a name=line-296></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-297></a>            <span class=n>p1</span><span class=p>,</span> <span class=n>p2</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;@&#39;</span><span class=p>)</span>
<a name=line-298></a>        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
<a name=line-299></a>            <span class=c1># value contains more than one @.</span>
<a name=line-300></a>            <span class=k>return</span> <span class=kc>False</span>
<a name=line-301></a>        <span class=c1># Dot must be in p2 (e.g. example.com)</span>
<a name=line-302></a>        <span class=k>if</span> <span class=s1>&#39;.&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>p2</span> <span class=ow>or</span> <span class=n>p2</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>):</span>
<a name=line-303></a>            <span class=k>return</span> <span class=kc>False</span>
<a name=line-304></a>        <span class=k>return</span> <span class=kc>True</span>
<a name=line-305></a>
<a name=line-306></a>    <span class=n>words</span> <span class=o>=</span> <span class=n>word_split_re</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>text</span><span class=p>))</span>
<a name=line-307></a>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>word</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>words</span><span class=p>):</span>
<a name=line-308></a>        <span class=k>if</span> <span class=s1>&#39;.&#39;</span> <span class=ow>in</span> <span class=n>word</span> <span class=ow>or</span> <span class=s1>&#39;@&#39;</span> <span class=ow>in</span> <span class=n>word</span> <span class=ow>or</span> <span class=s1>&#39;:&#39;</span> <span class=ow>in</span> <span class=n>word</span><span class=p>:</span>
<a name=line-309></a>            <span class=c1># lead: Current punctuation trimmed from the beginning of the word.</span>
<a name=line-310></a>            <span class=c1># middle: Current state of the word.</span>
<a name=line-311></a>            <span class=c1># trail: Current punctuation trimmed from the end of the word.</span>
<a name=line-312></a>            <span class=n>lead</span><span class=p>,</span> <span class=n>middle</span><span class=p>,</span> <span class=n>trail</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>word</span><span class=p>,</span> <span class=s1>&#39;&#39;</span>
<a name=line-313></a>            <span class=c1># Deal with punctuation.</span>
<a name=line-314></a>            <span class=n>lead</span><span class=p>,</span> <span class=n>middle</span><span class=p>,</span> <span class=n>trail</span> <span class=o>=</span> <span class=n>trim_punctuation</span><span class=p>(</span><span class=n>lead</span><span class=p>,</span> <span class=n>middle</span><span class=p>,</span> <span class=n>trail</span><span class=p>)</span>
<a name=line-315></a>
<a name=line-316></a>            <span class=c1># Make URL we want to point to.</span>
<a name=line-317></a>            <span class=n>url</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-318></a>            <span class=n>nofollow_attr</span> <span class=o>=</span> <span class=s1>&#39; rel=&quot;nofollow&quot;&#39;</span> <span class=k>if</span> <span class=n>nofollow</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
<a name=line-319></a>            <span class=k>if</span> <span class=n>simple_url_re</span><span class=o>.</span><span class=n>match</span><span class=p>(</span><span class=n>middle</span><span class=p>):</span>
<a name=line-320></a>                <span class=n>url</span> <span class=o>=</span> <span class=n>smart_urlquote</span><span class=p>(</span><span class=n>html</span><span class=o>.</span><span class=n>unescape</span><span class=p>(</span><span class=n>middle</span><span class=p>))</span>
<a name=line-321></a>            <span class=k>elif</span> <span class=n>simple_url_2_re</span><span class=o>.</span><span class=n>match</span><span class=p>(</span><span class=n>middle</span><span class=p>):</span>
<a name=line-322></a>                <span class=n>url</span> <span class=o>=</span> <span class=n>smart_urlquote</span><span class=p>(</span><span class=s1>&#39;http://</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>html</span><span class=o>.</span><span class=n>unescape</span><span class=p>(</span><span class=n>middle</span><span class=p>))</span>
<a name=line-323></a>            <span class=k>elif</span> <span class=s1>&#39;:&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>middle</span> <span class=ow>and</span> <span class=n>is_email_simple</span><span class=p>(</span><span class=n>middle</span><span class=p>):</span>
<a name=line-324></a>                <span class=n>local</span><span class=p>,</span> <span class=n>domain</span> <span class=o>=</span> <span class=n>middle</span><span class=o>.</span><span class=n>rsplit</span><span class=p>(</span><span class=s1>&#39;@&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
<a name=line-325></a>                <span class=k>try</span><span class=p>:</span>
<a name=line-326></a>                    <span class=n>domain</span> <span class=o>=</span> <span class=n>punycode</span><span class=p>(</span><span class=n>domain</span><span class=p>)</span>
<a name=line-327></a>                <span class=k>except</span> <span class=ne>UnicodeError</span><span class=p>:</span>
<a name=line-328></a>                    <span class=k>continue</span>
<a name=line-329></a>                <span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;mailto:</span><span class=si>%s</span><span class=s1>@</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>local</span><span class=p>,</span> <span class=n>domain</span><span class=p>)</span>
<a name=line-330></a>                <span class=n>nofollow_attr</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
<a name=line-331></a>
<a name=line-332></a>            <span class=c1># Make link.</span>
<a name=line-333></a>            <span class=k>if</span> <span class=n>url</span><span class=p>:</span>
<a name=line-334></a>                <span class=n>trimmed</span> <span class=o>=</span> <span class=n>trim_url</span><span class=p>(</span><span class=n>middle</span><span class=p>)</span>
<a name=line-335></a>                <span class=k>if</span> <span class=n>autoescape</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>safe_input</span><span class=p>:</span>
<a name=line-336></a>                    <span class=n>lead</span><span class=p>,</span> <span class=n>trail</span> <span class=o>=</span> <span class=n>escape</span><span class=p>(</span><span class=n>lead</span><span class=p>),</span> <span class=n>escape</span><span class=p>(</span><span class=n>trail</span><span class=p>)</span>
<a name=line-337></a>                    <span class=n>trimmed</span> <span class=o>=</span> <span class=n>escape</span><span class=p>(</span><span class=n>trimmed</span><span class=p>)</span>
<a name=line-338></a>                <span class=n>middle</span> <span class=o>=</span> <span class=s1>&#39;&lt;a href=&quot;</span><span class=si>%s</span><span class=s1>&quot;</span><span class=si>%s</span><span class=s1>&gt;</span><span class=si>%s</span><span class=s1>&lt;/a&gt;&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>escape</span><span class=p>(</span><span class=n>url</span><span class=p>),</span> <span class=n>nofollow_attr</span><span class=p>,</span> <span class=n>trimmed</span><span class=p>)</span>
<a name=line-339></a>                <span class=n>words</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>mark_safe</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%s%s%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>lead</span><span class=p>,</span> <span class=n>middle</span><span class=p>,</span> <span class=n>trail</span><span class=p>))</span>
<a name=line-340></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-341></a>                <span class=k>if</span> <span class=n>safe_input</span><span class=p>:</span>
<a name=line-342></a>                    <span class=n>words</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>mark_safe</span><span class=p>(</span><span class=n>word</span><span class=p>)</span>
<a name=line-343></a>                <span class=k>elif</span> <span class=n>autoescape</span><span class=p>:</span>
<a name=line-344></a>                    <span class=n>words</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>escape</span><span class=p>(</span><span class=n>word</span><span class=p>)</span>
<a name=line-345></a>        <span class=k>elif</span> <span class=n>safe_input</span><span class=p>:</span>
<a name=line-346></a>            <span class=n>words</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>mark_safe</span><span class=p>(</span><span class=n>word</span><span class=p>)</span>
<a name=line-347></a>        <span class=k>elif</span> <span class=n>autoescape</span><span class=p>:</span>
<a name=line-348></a>            <span class=n>words</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>escape</span><span class=p>(</span><span class=n>word</span><span class=p>)</span>
<a name=line-349></a>    <span class=k>return</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>words</span><span class=p>)</span>
<a name=line-350></a>
<a name=line-351></a>
<a name=line-352></a><span class=k>def</span> <span class=nf>avoid_wrapping</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
<a name=line-353></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-354></a><span class=sd>    Avoid text wrapping in the middle of a phrase by adding non-breaking</span>
<a name=line-355></a><span class=sd>    spaces where there previously were normal spaces.</span>
<a name=line-356></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-357></a>    <span class=k>return</span> <span class=n>value</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>,</span> <span class=s2>&quot;</span><span class=se>\xa0</span><span class=s2>&quot;</span><span class=p>)</span>
<a name=line-358></a>
<a name=line-359></a>
<a name=line-360></a><span class=k>def</span> <span class=nf>html_safe</span><span class=p>(</span><span class=n>klass</span><span class=p>):</span>
<a name=line-361></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-362></a><span class=sd>    A decorator that defines the __html__ method. This helps non-Django</span>
<a name=line-363></a><span class=sd>    templates to detect classes whose __str__ methods return SafeString.</span>
<a name=line-364></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-365></a>    <span class=k>if</span> <span class=s1>&#39;__html__&#39;</span> <span class=ow>in</span> <span class=n>klass</span><span class=o>.</span><span class=vm>__dict__</span><span class=p>:</span>
<a name=line-366></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
<a name=line-367></a>            <span class=s2>&quot;can&#39;t apply @html_safe to </span><span class=si>%s</span><span class=s2> because it defines &quot;</span>
<a name=line-368></a>            <span class=s2>&quot;__html__().&quot;</span> <span class=o>%</span> <span class=n>klass</span><span class=o>.</span><span class=vm>__name__</span>
<a name=line-369></a>        <span class=p>)</span>
<a name=line-370></a>    <span class=k>if</span> <span class=s1>&#39;__str__&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>klass</span><span class=o>.</span><span class=vm>__dict__</span><span class=p>:</span>
<a name=line-371></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
<a name=line-372></a>            <span class=s2>&quot;can&#39;t apply @html_safe to </span><span class=si>%s</span><span class=s2> because it doesn&#39;t &quot;</span>
<a name=line-373></a>            <span class=s2>&quot;define __str__().&quot;</span> <span class=o>%</span> <span class=n>klass</span><span class=o>.</span><span class=vm>__name__</span>
<a name=line-374></a>        <span class=p>)</span>
<a name=line-375></a>    <span class=n>klass_str</span> <span class=o>=</span> <span class=n>klass</span><span class=o>.</span><span class=fm>__str__</span>
<a name=line-376></a>    <span class=n>klass</span><span class=o>.</span><span class=fm>__str__</span> <span class=o>=</span> <span class=k>lambda</span> <span class=bp>self</span><span class=p>:</span> <span class=n>mark_safe</span><span class=p>(</span><span class=n>klass_str</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span>
<a name=line-377></a>    <span class=n>klass</span><span class=o>.</span><span class=n>__html__</span> <span class=o>=</span> <span class=k>lambda</span> <span class=bp>self</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
<a name=line-378></a>    <span class=k>return</span> <span class=n>klass</span>
</pre></div></td></tr></table><p class=footer> Generated by <a href=https://github.com/spirali/nedoc>nedoc</a> v0.9 at 2020-12-29 14:05 </p></div></div></body></html>
<!DOCTYPE html><html><head><meta charset=utf-8><title>django.template.loader_tags</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./assets/purecss/pure-min.css><link rel=stylesheet href=./assets/purecss/grids-responsive-min.css><link rel=stylesheet href=./assets/style.css><link rel=stylesheet href=./assets/pygments/default.css><link rel=stylesheet href=./assets/jquery/jquery-ui.min.css><script src=./assets/jquery/jquery-3.0.0.min.js></script><script src=./assets/jquery/jquery-ui.min.js></script><script src=nedoc.js></script></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-1-4"><div class=header><h1 class=brand-title>Django</h1> 1.0 </div><div id=sbox><input id=search style="color: black;" placeholder="search ..."></div><div class=tree><ul><li><a href=django.html>&#9662; django</a> </li><li><ul><li><a href=django.__main__.html>&#9656; __main__</a> </li><li><a href=django.apps.html>&#9656; apps</a> </li><li><a href=django.bin.html>&#9656; bin</a> </li><li><a href=django.conf.html>&#9656; conf</a> </li><li><a href=django.contrib.html>&#9656; contrib</a> </li><li><a href=django.core.html>&#9656; core</a> </li><li><a href=django.db.html>&#9656; db</a> </li><li><a href=django.dispatch.html>&#9656; dispatch</a> </li><li><a href=django.forms.html>&#9656; forms</a> </li><li><a href=django.http.html>&#9656; http</a> </li><li><a href=django.middleware.html>&#9656; middleware</a> </li><li><a href=django.shortcuts.html>&#9656; shortcuts</a> </li><li><a href=django.template.html>&#9662; template</a> </li><li><ul><li><a href=django.template.autoreload.html>&#9656; autoreload</a> </li><li><a href=django.template.backends.html>&#9656; backends</a> </li><li><a href=django.template.base.html>&#9656; base</a> </li><li><a href=django.template.context.html>&#9656; context</a> </li><li><a href=django.template.context_processors.html>&#9656; context_processors</a> </li><li><a href=django.template.defaultfilters.html>&#9656; defaultfilters</a> </li><li><a href=django.template.defaulttags.html>&#9656; defaulttags</a> </li><li><a href=django.template.engine.html>&#9656; engine</a> </li><li><a href=django.template.exceptions.html>&#9656; exceptions</a> </li><li><a href=django.template.library.html>&#9656; library</a> </li><li><a href=django.template.loader.html>&#9656; loader</a> </li><li><div class=select><a href=django.template.loader_tags.html>&#9662; loader_tags</a> </div></li><li><ul><li><a href=django.template.loader_tags.BlockContext.html> <i>class</i> BlockContext</a> </li><li><a href=django.template.loader_tags.BlockNode.html> <i>class</i> BlockNode</a> </li><li><a href=django.template.loader_tags.ExtendsNode.html> <i>class</i> ExtendsNode</a> </li><li><a href=django.template.loader_tags.IncludeNode.html> <i>class</i> IncludeNode</a> </li></ul></li><li><a href=django.template.loaders.html>&#9656; loaders</a> </li><li><a href=django.template.response.html>&#9656; response</a> </li><li><a href=django.template.smartif.html>&#9656; smartif</a> </li><li><a href=django.template.utils.html>&#9656; utils</a> </li></ul></li><li><a href=django.templatetags.html>&#9656; templatetags</a> </li><li><a href=django.test.html>&#9656; test</a> </li><li><a href=django.urls.html>&#9656; urls</a> </li><li><a href=django.utils.html>&#9656; utils</a> </li><li><a href=django.views.html>&#9656; views</a> </li></ul></ul></div></div><div class="content pure-u-1 pure-u-md-3-4"><h1>Source code django/template/loader_tags.py</h1><div id=path><a class=symbol href=django.html>django</a>.<a class=symbol href=django.template.html>template</a>.<a class=symbol href=django.template.loader_tags.html>loader_tags</a></div><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321</pre></div></td><td class=code><div class=highlight><pre><span></span><a name=line-1></a><span class=kn>import</span> <span class=nn>posixpath</span>
<a name=line-2></a><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span>
<a name=line-3></a>
<a name=line-4></a><span class=kn>from</span> <span class=nn>django.utils.safestring</span> <span class=kn>import</span> <span class=n>mark_safe</span>
<a name=line-5></a>
<a name=line-6></a><span class=kn>from</span> <span class=nn>.base</span> <span class=kn>import</span> <span class=p>(</span>
<a name=line-7></a>    <span class=n>Node</span><span class=p>,</span> <span class=n>Template</span><span class=p>,</span> <span class=n>TemplateSyntaxError</span><span class=p>,</span> <span class=n>TextNode</span><span class=p>,</span> <span class=n>Variable</span><span class=p>,</span> <span class=n>token_kwargs</span><span class=p>,</span>
<a name=line-8></a><span class=p>)</span>
<a name=line-9></a><span class=kn>from</span> <span class=nn>.library</span> <span class=kn>import</span> <span class=n>Library</span>
<a name=line-10></a>
<a name=line-11></a><span class=n>register</span> <span class=o>=</span> <span class=n>Library</span><span class=p>()</span>
<a name=line-12></a>
<a name=line-13></a><span class=n>BLOCK_CONTEXT_KEY</span> <span class=o>=</span> <span class=s1>&#39;block_context&#39;</span>
<a name=line-14></a>
<a name=line-15></a>
<a name=line-16></a><span class=k>class</span> <span class=nc>BlockContext</span><span class=p>:</span>
<a name=line-17></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-18></a>        <span class=c1># Dictionary of FIFO queues.</span>
<a name=line-19></a>        <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
<a name=line-20></a>
<a name=line-21></a>    <span class=k>def</span> <span class=nf>add_blocks</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>blocks</span><span class=p>):</span>
<a name=line-22></a>        <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>block</span> <span class=ow>in</span> <span class=n>blocks</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<a name=line-23></a>            <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span><span class=p>[</span><span class=n>name</span><span class=p>]</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>block</span><span class=p>)</span>
<a name=line-24></a>
<a name=line-25></a>    <span class=k>def</span> <span class=nf>pop</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-26></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-27></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span><span class=p>[</span><span class=n>name</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span>
<a name=line-28></a>        <span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
<a name=line-29></a>            <span class=k>return</span> <span class=kc>None</span>
<a name=line-30></a>
<a name=line-31></a>    <span class=k>def</span> <span class=nf>push</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>block</span><span class=p>):</span>
<a name=line-32></a>        <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span><span class=p>[</span><span class=n>name</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>block</span><span class=p>)</span>
<a name=line-33></a>
<a name=line-34></a>    <span class=k>def</span> <span class=nf>get_block</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-35></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-36></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span><span class=p>[</span><span class=n>name</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
<a name=line-37></a>        <span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
<a name=line-38></a>            <span class=k>return</span> <span class=kc>None</span>
<a name=line-39></a>
<a name=line-40></a>
<a name=line-41></a><span class=k>class</span> <span class=nc>BlockNode</span><span class=p>(</span><span class=n>Node</span><span class=p>):</span>
<a name=line-42></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>nodelist</span><span class=p>,</span> <span class=n>parent</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-43></a>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>nodelist</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>parent</span> <span class=o>=</span> <span class=n>name</span><span class=p>,</span> <span class=n>nodelist</span><span class=p>,</span> <span class=n>parent</span>
<a name=line-44></a>
<a name=line-45></a>    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-46></a>        <span class=k>return</span> <span class=s2>&quot;&lt;Block Node: </span><span class=si>%s</span><span class=s2>. Contents: </span><span class=si>%r</span><span class=s2>&gt;&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>nodelist</span><span class=p>)</span>
<a name=line-47></a>
<a name=line-48></a>    <span class=k>def</span> <span class=nf>render</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
<a name=line-49></a>        <span class=n>block_context</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>render_context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>BLOCK_CONTEXT_KEY</span><span class=p>)</span>
<a name=line-50></a>        <span class=k>with</span> <span class=n>context</span><span class=o>.</span><span class=n>push</span><span class=p>():</span>
<a name=line-51></a>            <span class=k>if</span> <span class=n>block_context</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-52></a>                <span class=n>context</span><span class=p>[</span><span class=s1>&#39;block&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span>
<a name=line-53></a>                <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>nodelist</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
<a name=line-54></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-55></a>                <span class=n>push</span> <span class=o>=</span> <span class=n>block</span> <span class=o>=</span> <span class=n>block_context</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
<a name=line-56></a>                <span class=k>if</span> <span class=n>block</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-57></a>                    <span class=n>block</span> <span class=o>=</span> <span class=bp>self</span>
<a name=line-58></a>                <span class=c1># Create new block so we can store context without thread-safety issues.</span>
<a name=line-59></a>                <span class=n>block</span> <span class=o>=</span> <span class=nb>type</span><span class=p>(</span><span class=bp>self</span><span class=p>)(</span><span class=n>block</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>block</span><span class=o>.</span><span class=n>nodelist</span><span class=p>)</span>
<a name=line-60></a>                <span class=n>block</span><span class=o>.</span><span class=n>context</span> <span class=o>=</span> <span class=n>context</span>
<a name=line-61></a>                <span class=n>context</span><span class=p>[</span><span class=s1>&#39;block&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>block</span>
<a name=line-62></a>                <span class=n>result</span> <span class=o>=</span> <span class=n>block</span><span class=o>.</span><span class=n>nodelist</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
<a name=line-63></a>                <span class=k>if</span> <span class=n>push</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-64></a>                    <span class=n>block_context</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>push</span><span class=p>)</span>
<a name=line-65></a>        <span class=k>return</span> <span class=n>result</span>
<a name=line-66></a>
<a name=line-67></a>    <span class=k>def</span> <span class=nf>super</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-68></a>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;context&#39;</span><span class=p>):</span>
<a name=line-69></a>            <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span>
<a name=line-70></a>                <span class=s2>&quot;&#39;</span><span class=si>%s</span><span class=s2>&#39; object has no attribute &#39;context&#39;. Did you use &quot;</span>
<a name=line-71></a>                <span class=s2>&quot;{{ block.super }} in a base template?&quot;</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span>
<a name=line-72></a>            <span class=p>)</span>
<a name=line-73></a>        <span class=n>render_context</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>render_context</span>
<a name=line-74></a>        <span class=k>if</span> <span class=p>(</span><span class=n>BLOCK_CONTEXT_KEY</span> <span class=ow>in</span> <span class=n>render_context</span> <span class=ow>and</span>
<a name=line-75></a>                <span class=n>render_context</span><span class=p>[</span><span class=n>BLOCK_CONTEXT_KEY</span><span class=p>]</span><span class=o>.</span><span class=n>get_block</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>)</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
<a name=line-76></a>            <span class=k>return</span> <span class=n>mark_safe</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>context</span><span class=p>))</span>
<a name=line-77></a>        <span class=k>return</span> <span class=s1>&#39;&#39;</span>
<a name=line-78></a>
<a name=line-79></a>
<a name=line-80></a><span class=k>class</span> <span class=nc>ExtendsNode</span><span class=p>(</span><span class=n>Node</span><span class=p>):</span>
<a name=line-81></a>    <span class=n>must_be_first</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-82></a>    <span class=n>context_key</span> <span class=o>=</span> <span class=s1>&#39;extends_context&#39;</span>
<a name=line-83></a>
<a name=line-84></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>nodelist</span><span class=p>,</span> <span class=n>parent_name</span><span class=p>,</span> <span class=n>template_dirs</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-85></a>        <span class=bp>self</span><span class=o>.</span><span class=n>nodelist</span> <span class=o>=</span> <span class=n>nodelist</span>
<a name=line-86></a>        <span class=bp>self</span><span class=o>.</span><span class=n>parent_name</span> <span class=o>=</span> <span class=n>parent_name</span>
<a name=line-87></a>        <span class=bp>self</span><span class=o>.</span><span class=n>template_dirs</span> <span class=o>=</span> <span class=n>template_dirs</span>
<a name=line-88></a>        <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span> <span class=o>=</span> <span class=p>{</span><span class=n>n</span><span class=o>.</span><span class=n>name</span><span class=p>:</span> <span class=n>n</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>nodelist</span><span class=o>.</span><span class=n>get_nodes_by_type</span><span class=p>(</span><span class=n>BlockNode</span><span class=p>)}</span>
<a name=line-89></a>
<a name=line-90></a>    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-91></a>        <span class=k>return</span> <span class=s1>&#39;&lt;</span><span class=si>%s</span><span class=s1>: extends </span><span class=si>%s</span><span class=s1>&gt;&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>parent_name</span><span class=o>.</span><span class=n>token</span><span class=p>)</span>
<a name=line-92></a>
<a name=line-93></a>    <span class=k>def</span> <span class=nf>find_template</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>template_name</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
<a name=line-94></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-95></a><span class=sd>        This is a wrapper around engine.find_template(). A history is kept in</span>
<a name=line-96></a><span class=sd>        the render_context attribute between successive extends calls and</span>
<a name=line-97></a><span class=sd>        passed as the skip argument. This enables extends to work recursively</span>
<a name=line-98></a><span class=sd>        without extending the same template twice.</span>
<a name=line-99></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-100></a>        <span class=n>history</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>render_context</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span>
<a name=line-101></a>            <span class=bp>self</span><span class=o>.</span><span class=n>context_key</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>origin</span><span class=p>],</span>
<a name=line-102></a>        <span class=p>)</span>
<a name=line-103></a>        <span class=n>template</span><span class=p>,</span> <span class=n>origin</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>template</span><span class=o>.</span><span class=n>engine</span><span class=o>.</span><span class=n>find_template</span><span class=p>(</span>
<a name=line-104></a>            <span class=n>template_name</span><span class=p>,</span> <span class=n>skip</span><span class=o>=</span><span class=n>history</span><span class=p>,</span>
<a name=line-105></a>        <span class=p>)</span>
<a name=line-106></a>        <span class=n>history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>origin</span><span class=p>)</span>
<a name=line-107></a>        <span class=k>return</span> <span class=n>template</span>
<a name=line-108></a>
<a name=line-109></a>    <span class=k>def</span> <span class=nf>get_parent</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
<a name=line-110></a>        <span class=n>parent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>parent_name</span><span class=o>.</span><span class=n>resolve</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
<a name=line-111></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>parent</span><span class=p>:</span>
<a name=line-112></a>            <span class=n>error_msg</span> <span class=o>=</span> <span class=s2>&quot;Invalid template name in &#39;extends&#39; tag: </span><span class=si>%r</span><span class=s2>.&quot;</span> <span class=o>%</span> <span class=n>parent</span>
<a name=line-113></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>parent_name</span><span class=o>.</span><span class=n>filters</span> <span class=ow>or</span>\
<a name=line-114></a>                    <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>parent_name</span><span class=o>.</span><span class=n>var</span><span class=p>,</span> <span class=n>Variable</span><span class=p>):</span>
<a name=line-115></a>                <span class=n>error_msg</span> <span class=o>+=</span> <span class=s2>&quot; Got this from the &#39;</span><span class=si>%s</span><span class=s2>&#39; variable.&quot;</span> <span class=o>%</span>\
<a name=line-116></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>parent_name</span><span class=o>.</span><span class=n>token</span>
<a name=line-117></a>            <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
<a name=line-118></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>parent</span><span class=p>,</span> <span class=n>Template</span><span class=p>):</span>
<a name=line-119></a>            <span class=c1># parent is a django.template.Template</span>
<a name=line-120></a>            <span class=k>return</span> <span class=n>parent</span>
<a name=line-121></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>getattr</span><span class=p>(</span><span class=n>parent</span><span class=p>,</span> <span class=s1>&#39;template&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>),</span> <span class=n>Template</span><span class=p>):</span>
<a name=line-122></a>            <span class=c1># parent is a django.template.backends.django.Template</span>
<a name=line-123></a>            <span class=k>return</span> <span class=n>parent</span><span class=o>.</span><span class=n>template</span>
<a name=line-124></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>find_template</span><span class=p>(</span><span class=n>parent</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
<a name=line-125></a>
<a name=line-126></a>    <span class=k>def</span> <span class=nf>render</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
<a name=line-127></a>        <span class=n>compiled_parent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_parent</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
<a name=line-128></a>
<a name=line-129></a>        <span class=k>if</span> <span class=n>BLOCK_CONTEXT_KEY</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>render_context</span><span class=p>:</span>
<a name=line-130></a>            <span class=n>context</span><span class=o>.</span><span class=n>render_context</span><span class=p>[</span><span class=n>BLOCK_CONTEXT_KEY</span><span class=p>]</span> <span class=o>=</span> <span class=n>BlockContext</span><span class=p>()</span>
<a name=line-131></a>        <span class=n>block_context</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>render_context</span><span class=p>[</span><span class=n>BLOCK_CONTEXT_KEY</span><span class=p>]</span>
<a name=line-132></a>
<a name=line-133></a>        <span class=c1># Add the block nodes from this node to the block context</span>
<a name=line-134></a>        <span class=n>block_context</span><span class=o>.</span><span class=n>add_blocks</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>blocks</span><span class=p>)</span>
<a name=line-135></a>
<a name=line-136></a>        <span class=c1># If this block&#39;s parent doesn&#39;t have an extends node it is the root,</span>
<a name=line-137></a>        <span class=c1># and its block nodes also need to be added to the block context.</span>
<a name=line-138></a>        <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>compiled_parent</span><span class=o>.</span><span class=n>nodelist</span><span class=p>:</span>
<a name=line-139></a>            <span class=c1># The ExtendsNode has to be the first non-text node.</span>
<a name=line-140></a>            <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>node</span><span class=p>,</span> <span class=n>TextNode</span><span class=p>):</span>
<a name=line-141></a>                <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>node</span><span class=p>,</span> <span class=n>ExtendsNode</span><span class=p>):</span>
<a name=line-142></a>                    <span class=n>blocks</span> <span class=o>=</span> <span class=p>{</span><span class=n>n</span><span class=o>.</span><span class=n>name</span><span class=p>:</span> <span class=n>n</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span>
<a name=line-143></a>                              <span class=n>compiled_parent</span><span class=o>.</span><span class=n>nodelist</span><span class=o>.</span><span class=n>get_nodes_by_type</span><span class=p>(</span><span class=n>BlockNode</span><span class=p>)}</span>
<a name=line-144></a>                    <span class=n>block_context</span><span class=o>.</span><span class=n>add_blocks</span><span class=p>(</span><span class=n>blocks</span><span class=p>)</span>
<a name=line-145></a>                <span class=k>break</span>
<a name=line-146></a>
<a name=line-147></a>        <span class=c1># Call Template._render explicitly so the parser context stays</span>
<a name=line-148></a>        <span class=c1># the same.</span>
<a name=line-149></a>        <span class=k>with</span> <span class=n>context</span><span class=o>.</span><span class=n>render_context</span><span class=o>.</span><span class=n>push_state</span><span class=p>(</span><span class=n>compiled_parent</span><span class=p>,</span> <span class=n>isolated_context</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
<a name=line-150></a>            <span class=k>return</span> <span class=n>compiled_parent</span><span class=o>.</span><span class=n>_render</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
<a name=line-151></a>
<a name=line-152></a>
<a name=line-153></a><span class=k>class</span> <span class=nc>IncludeNode</span><span class=p>(</span><span class=n>Node</span><span class=p>):</span>
<a name=line-154></a>    <span class=n>context_key</span> <span class=o>=</span> <span class=s1>&#39;__include_context&#39;</span>
<a name=line-155></a>
<a name=line-156></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>template</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=n>extra_context</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>isolated_context</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<a name=line-157></a>        <span class=bp>self</span><span class=o>.</span><span class=n>template</span> <span class=o>=</span> <span class=n>template</span>
<a name=line-158></a>        <span class=bp>self</span><span class=o>.</span><span class=n>extra_context</span> <span class=o>=</span> <span class=n>extra_context</span> <span class=ow>or</span> <span class=p>{}</span>
<a name=line-159></a>        <span class=bp>self</span><span class=o>.</span><span class=n>isolated_context</span> <span class=o>=</span> <span class=n>isolated_context</span>
<a name=line-160></a>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<a name=line-161></a>
<a name=line-162></a>    <span class=k>def</span> <span class=nf>render</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
<a name=line-163></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-164></a><span class=sd>        Render the specified template and context. Cache the template object</span>
<a name=line-165></a><span class=sd>        in render_context to avoid reparsing and loading when used in a for</span>
<a name=line-166></a><span class=sd>        loop.</span>
<a name=line-167></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-168></a>        <span class=n>template</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>template</span><span class=o>.</span><span class=n>resolve</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
<a name=line-169></a>        <span class=c1># Does this quack like a Template?</span>
<a name=line-170></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>callable</span><span class=p>(</span><span class=nb>getattr</span><span class=p>(</span><span class=n>template</span><span class=p>,</span> <span class=s1>&#39;render&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)):</span>
<a name=line-171></a>            <span class=c1># If not, try the cache and select_template().</span>
<a name=line-172></a>            <span class=n>template_name</span> <span class=o>=</span> <span class=n>template</span> <span class=ow>or</span> <span class=p>()</span>
<a name=line-173></a>            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>template_name</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<a name=line-174></a>                <span class=n>template_name</span> <span class=o>=</span> <span class=p>(</span><span class=n>template_name</span><span class=p>,)</span>
<a name=line-175></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-176></a>                <span class=n>template_name</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>template_name</span><span class=p>)</span>
<a name=line-177></a>            <span class=n>cache</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>render_context</span><span class=o>.</span><span class=n>dicts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=p>{})</span>
<a name=line-178></a>            <span class=n>template</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>template_name</span><span class=p>)</span>
<a name=line-179></a>            <span class=k>if</span> <span class=n>template</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-180></a>                <span class=n>template</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>template</span><span class=o>.</span><span class=n>engine</span><span class=o>.</span><span class=n>select_template</span><span class=p>(</span><span class=n>template_name</span><span class=p>)</span>
<a name=line-181></a>                <span class=n>cache</span><span class=p>[</span><span class=n>template_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>template</span>
<a name=line-182></a>        <span class=c1># Use the base.Template of a backends.django.Template.</span>
<a name=line-183></a>        <span class=k>elif</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>template</span><span class=p>,</span> <span class=s1>&#39;template&#39;</span><span class=p>):</span>
<a name=line-184></a>            <span class=n>template</span> <span class=o>=</span> <span class=n>template</span><span class=o>.</span><span class=n>template</span>
<a name=line-185></a>        <span class=n>values</span> <span class=o>=</span> <span class=p>{</span>
<a name=line-186></a>            <span class=n>name</span><span class=p>:</span> <span class=n>var</span><span class=o>.</span><span class=n>resolve</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
<a name=line-187></a>            <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>var</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>extra_context</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
<a name=line-188></a>        <span class=p>}</span>
<a name=line-189></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>isolated_context</span><span class=p>:</span>
<a name=line-190></a>            <span class=k>return</span> <span class=n>template</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>values</span><span class=p>))</span>
<a name=line-191></a>        <span class=k>with</span> <span class=n>context</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=o>**</span><span class=n>values</span><span class=p>):</span>
<a name=line-192></a>            <span class=k>return</span> <span class=n>template</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
<a name=line-193></a>
<a name=line-194></a>
<a name=line-195></a><span class=nd>@register</span><span class=o>.</span><span class=n>tag</span><span class=p>(</span><span class=s1>&#39;block&#39;</span><span class=p>)</span>
<a name=line-196></a><span class=k>def</span> <span class=nf>do_block</span><span class=p>(</span><span class=n>parser</span><span class=p>,</span> <span class=n>token</span><span class=p>):</span>
<a name=line-197></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-198></a><span class=sd>    Define a block that can be overridden by child templates.</span>
<a name=line-199></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-200></a>    <span class=c1># token.split_contents() isn&#39;t useful here because this tag doesn&#39;t accept variable as arguments</span>
<a name=line-201></a>    <span class=n>bits</span> <span class=o>=</span> <span class=n>token</span><span class=o>.</span><span class=n>contents</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
<a name=line-202></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>bits</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
<a name=line-203></a>        <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span><span class=s2>&quot;&#39;</span><span class=si>%s</span><span class=s2>&#39; tag takes only one argument&quot;</span> <span class=o>%</span> <span class=n>bits</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
<a name=line-204></a>    <span class=n>block_name</span> <span class=o>=</span> <span class=n>bits</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
<a name=line-205></a>    <span class=c1># Keep track of the names of BlockNodes found in this template, so we can</span>
<a name=line-206></a>    <span class=c1># check for duplication.</span>
<a name=line-207></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-208></a>        <span class=k>if</span> <span class=n>block_name</span> <span class=ow>in</span> <span class=n>parser</span><span class=o>.</span><span class=n>__loaded_blocks</span><span class=p>:</span>
<a name=line-209></a>            <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span><span class=s2>&quot;&#39;</span><span class=si>%s</span><span class=s2>&#39; tag with name &#39;</span><span class=si>%s</span><span class=s2>&#39; appears more than once&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>bits</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>block_name</span><span class=p>))</span>
<a name=line-210></a>        <span class=n>parser</span><span class=o>.</span><span class=n>__loaded_blocks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>block_name</span><span class=p>)</span>
<a name=line-211></a>    <span class=k>except</span> <span class=ne>AttributeError</span><span class=p>:</span>  <span class=c1># parser.__loaded_blocks isn&#39;t a list yet</span>
<a name=line-212></a>        <span class=n>parser</span><span class=o>.</span><span class=n>__loaded_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=n>block_name</span><span class=p>]</span>
<a name=line-213></a>    <span class=n>nodelist</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse</span><span class=p>((</span><span class=s1>&#39;endblock&#39;</span><span class=p>,))</span>
<a name=line-214></a>
<a name=line-215></a>    <span class=c1># This check is kept for backwards-compatibility. See #3100.</span>
<a name=line-216></a>    <span class=n>endblock</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>next_token</span><span class=p>()</span>
<a name=line-217></a>    <span class=n>acceptable_endblocks</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;endblock&#39;</span><span class=p>,</span> <span class=s1>&#39;endblock </span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>block_name</span><span class=p>)</span>
<a name=line-218></a>    <span class=k>if</span> <span class=n>endblock</span><span class=o>.</span><span class=n>contents</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>acceptable_endblocks</span><span class=p>:</span>
<a name=line-219></a>        <span class=n>parser</span><span class=o>.</span><span class=n>invalid_block_tag</span><span class=p>(</span><span class=n>endblock</span><span class=p>,</span> <span class=s1>&#39;endblock&#39;</span><span class=p>,</span> <span class=n>acceptable_endblocks</span><span class=p>)</span>
<a name=line-220></a>
<a name=line-221></a>    <span class=k>return</span> <span class=n>BlockNode</span><span class=p>(</span><span class=n>block_name</span><span class=p>,</span> <span class=n>nodelist</span><span class=p>)</span>
<a name=line-222></a>
<a name=line-223></a>
<a name=line-224></a><span class=k>def</span> <span class=nf>construct_relative_path</span><span class=p>(</span><span class=n>current_template_name</span><span class=p>,</span> <span class=n>relative_name</span><span class=p>):</span>
<a name=line-225></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-226></a><span class=sd>    Convert a relative path (starting with &#39;./&#39; or &#39;../&#39;) to the full template</span>
<a name=line-227></a><span class=sd>    name based on the current_template_name.</span>
<a name=line-228></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-229></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>relative_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>((</span><span class=s2>&quot;&#39;./&quot;</span><span class=p>,</span> <span class=s2>&quot;&#39;../&quot;</span><span class=p>,</span> <span class=s1>&#39;&quot;./&#39;</span><span class=p>,</span> <span class=s1>&#39;&quot;../&#39;</span><span class=p>)):</span>
<a name=line-230></a>        <span class=c1># relative_name is a variable or a literal that doesn&#39;t contain a</span>
<a name=line-231></a>        <span class=c1># relative path.</span>
<a name=line-232></a>        <span class=k>return</span> <span class=n>relative_name</span>
<a name=line-233></a>
<a name=line-234></a>    <span class=n>new_name</span> <span class=o>=</span> <span class=n>posixpath</span><span class=o>.</span><span class=n>normpath</span><span class=p>(</span>
<a name=line-235></a>        <span class=n>posixpath</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
<a name=line-236></a>            <span class=n>posixpath</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>current_template_name</span><span class=o>.</span><span class=n>lstrip</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)),</span>
<a name=line-237></a>            <span class=n>relative_name</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\&#39;</span><span class=s1>&quot;&#39;</span><span class=p>)</span>
<a name=line-238></a>        <span class=p>)</span>
<a name=line-239></a>    <span class=p>)</span>
<a name=line-240></a>    <span class=k>if</span> <span class=n>new_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;../&#39;</span><span class=p>):</span>
<a name=line-241></a>        <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span>
<a name=line-242></a>            <span class=s2>&quot;The relative path &#39;</span><span class=si>%s</span><span class=s2>&#39; points outside the file hierarchy that &quot;</span>
<a name=line-243></a>            <span class=s2>&quot;template &#39;</span><span class=si>%s</span><span class=s2>&#39; is in.&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>relative_name</span><span class=p>,</span> <span class=n>current_template_name</span><span class=p>)</span>
<a name=line-244></a>        <span class=p>)</span>
<a name=line-245></a>    <span class=k>if</span> <span class=n>current_template_name</span><span class=o>.</span><span class=n>lstrip</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=n>new_name</span><span class=p>:</span>
<a name=line-246></a>        <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span>
<a name=line-247></a>            <span class=s2>&quot;The relative path &#39;</span><span class=si>%s</span><span class=s2>&#39; was translated to template name &#39;</span><span class=si>%s</span><span class=s2>&#39;, the &quot;</span>
<a name=line-248></a>            <span class=s2>&quot;same template in which the tag appears.&quot;</span>
<a name=line-249></a>            <span class=o>%</span> <span class=p>(</span><span class=n>relative_name</span><span class=p>,</span> <span class=n>current_template_name</span><span class=p>)</span>
<a name=line-250></a>        <span class=p>)</span>
<a name=line-251></a>    <span class=k>return</span> <span class=s1>&#39;&quot;</span><span class=si>%s</span><span class=s1>&quot;&#39;</span> <span class=o>%</span> <span class=n>new_name</span>
<a name=line-252></a>
<a name=line-253></a>
<a name=line-254></a><span class=nd>@register</span><span class=o>.</span><span class=n>tag</span><span class=p>(</span><span class=s1>&#39;extends&#39;</span><span class=p>)</span>
<a name=line-255></a><span class=k>def</span> <span class=nf>do_extends</span><span class=p>(</span><span class=n>parser</span><span class=p>,</span> <span class=n>token</span><span class=p>):</span>
<a name=line-256></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-257></a><span class=sd>    Signal that this template extends a parent template.</span>
<a name=line-258></a>
<a name=line-259></a><span class=sd>    This tag may be used in two ways: ``{% extends &quot;base&quot; %}`` (with quotes)</span>
<a name=line-260></a><span class=sd>    uses the literal value &quot;base&quot; as the name of the parent template to extend,</span>
<a name=line-261></a><span class=sd>    or ``{% extends variable %}`` uses the value of ``variable`` as either the</span>
<a name=line-262></a><span class=sd>    name of the parent template to extend (if it evaluates to a string) or as</span>
<a name=line-263></a><span class=sd>    the parent template itself (if it evaluates to a Template object).</span>
<a name=line-264></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-265></a>    <span class=n>bits</span> <span class=o>=</span> <span class=n>token</span><span class=o>.</span><span class=n>split_contents</span><span class=p>()</span>
<a name=line-266></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>bits</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
<a name=line-267></a>        <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span><span class=s2>&quot;&#39;</span><span class=si>%s</span><span class=s2>&#39; takes one argument&quot;</span> <span class=o>%</span> <span class=n>bits</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
<a name=line-268></a>    <span class=n>bits</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>construct_relative_path</span><span class=p>(</span><span class=n>parser</span><span class=o>.</span><span class=n>origin</span><span class=o>.</span><span class=n>template_name</span><span class=p>,</span> <span class=n>bits</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
<a name=line-269></a>    <span class=n>parent_name</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>compile_filter</span><span class=p>(</span><span class=n>bits</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
<a name=line-270></a>    <span class=n>nodelist</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse</span><span class=p>()</span>
<a name=line-271></a>    <span class=k>if</span> <span class=n>nodelist</span><span class=o>.</span><span class=n>get_nodes_by_type</span><span class=p>(</span><span class=n>ExtendsNode</span><span class=p>):</span>
<a name=line-272></a>        <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span><span class=s2>&quot;&#39;</span><span class=si>%s</span><span class=s2>&#39; cannot appear more than once in the same template&quot;</span> <span class=o>%</span> <span class=n>bits</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
<a name=line-273></a>    <span class=k>return</span> <span class=n>ExtendsNode</span><span class=p>(</span><span class=n>nodelist</span><span class=p>,</span> <span class=n>parent_name</span><span class=p>)</span>
<a name=line-274></a>
<a name=line-275></a>
<a name=line-276></a><span class=nd>@register</span><span class=o>.</span><span class=n>tag</span><span class=p>(</span><span class=s1>&#39;include&#39;</span><span class=p>)</span>
<a name=line-277></a><span class=k>def</span> <span class=nf>do_include</span><span class=p>(</span><span class=n>parser</span><span class=p>,</span> <span class=n>token</span><span class=p>):</span>
<a name=line-278></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-279></a><span class=sd>    Load a template and render it with the current context. You can pass</span>
<a name=line-280></a><span class=sd>    additional context using keyword arguments.</span>
<a name=line-281></a>
<a name=line-282></a><span class=sd>    Example::</span>
<a name=line-283></a>
<a name=line-284></a><span class=sd>        {% include &quot;foo/some_include&quot; %}</span>
<a name=line-285></a><span class=sd>        {% include &quot;foo/some_include&quot; with bar=&quot;BAZZ!&quot; baz=&quot;BING!&quot; %}</span>
<a name=line-286></a>
<a name=line-287></a><span class=sd>    Use the ``only`` argument to exclude the current context when rendering</span>
<a name=line-288></a><span class=sd>    the included template::</span>
<a name=line-289></a>
<a name=line-290></a><span class=sd>        {% include &quot;foo/some_include&quot; only %}</span>
<a name=line-291></a><span class=sd>        {% include &quot;foo/some_include&quot; with bar=&quot;1&quot; only %}</span>
<a name=line-292></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-293></a>    <span class=n>bits</span> <span class=o>=</span> <span class=n>token</span><span class=o>.</span><span class=n>split_contents</span><span class=p>()</span>
<a name=line-294></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>bits</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
<a name=line-295></a>        <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span>
<a name=line-296></a>            <span class=s2>&quot;</span><span class=si>%r</span><span class=s2> tag takes at least one argument: the name of the template to &quot;</span>
<a name=line-297></a>            <span class=s2>&quot;be included.&quot;</span> <span class=o>%</span> <span class=n>bits</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<a name=line-298></a>        <span class=p>)</span>
<a name=line-299></a>    <span class=n>options</span> <span class=o>=</span> <span class=p>{}</span>
<a name=line-300></a>    <span class=n>remaining_bits</span> <span class=o>=</span> <span class=n>bits</span><span class=p>[</span><span class=mi>2</span><span class=p>:]</span>
<a name=line-301></a>    <span class=k>while</span> <span class=n>remaining_bits</span><span class=p>:</span>
<a name=line-302></a>        <span class=n>option</span> <span class=o>=</span> <span class=n>remaining_bits</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<a name=line-303></a>        <span class=k>if</span> <span class=n>option</span> <span class=ow>in</span> <span class=n>options</span><span class=p>:</span>
<a name=line-304></a>            <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span><span class=s1>&#39;The </span><span class=si>%r</span><span class=s1> option was specified more &#39;</span>
<a name=line-305></a>                                      <span class=s1>&#39;than once.&#39;</span> <span class=o>%</span> <span class=n>option</span><span class=p>)</span>
<a name=line-306></a>        <span class=k>if</span> <span class=n>option</span> <span class=o>==</span> <span class=s1>&#39;with&#39;</span><span class=p>:</span>
<a name=line-307></a>            <span class=n>value</span> <span class=o>=</span> <span class=n>token_kwargs</span><span class=p>(</span><span class=n>remaining_bits</span><span class=p>,</span> <span class=n>parser</span><span class=p>,</span> <span class=n>support_legacy</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<a name=line-308></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>value</span><span class=p>:</span>
<a name=line-309></a>                <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span><span class=s1>&#39;&quot;with&quot; in </span><span class=si>%r</span><span class=s1> tag needs at least &#39;</span>
<a name=line-310></a>                                          <span class=s1>&#39;one keyword argument.&#39;</span> <span class=o>%</span> <span class=n>bits</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
<a name=line-311></a>        <span class=k>elif</span> <span class=n>option</span> <span class=o>==</span> <span class=s1>&#39;only&#39;</span><span class=p>:</span>
<a name=line-312></a>            <span class=n>value</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-313></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-314></a>            <span class=k>raise</span> <span class=n>TemplateSyntaxError</span><span class=p>(</span><span class=s1>&#39;Unknown argument for </span><span class=si>%r</span><span class=s1> tag: </span><span class=si>%r</span><span class=s1>.&#39;</span> <span class=o>%</span>
<a name=line-315></a>                                      <span class=p>(</span><span class=n>bits</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>option</span><span class=p>))</span>
<a name=line-316></a>        <span class=n>options</span><span class=p>[</span><span class=n>option</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
<a name=line-317></a>    <span class=n>isolated_context</span> <span class=o>=</span> <span class=n>options</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;only&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
<a name=line-318></a>    <span class=n>namemap</span> <span class=o>=</span> <span class=n>options</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;with&#39;</span><span class=p>,</span> <span class=p>{})</span>
<a name=line-319></a>    <span class=n>bits</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>construct_relative_path</span><span class=p>(</span><span class=n>parser</span><span class=o>.</span><span class=n>origin</span><span class=o>.</span><span class=n>template_name</span><span class=p>,</span> <span class=n>bits</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
<a name=line-320></a>    <span class=k>return</span> <span class=n>IncludeNode</span><span class=p>(</span><span class=n>parser</span><span class=o>.</span><span class=n>compile_filter</span><span class=p>(</span><span class=n>bits</span><span class=p>[</span><span class=mi>1</span><span class=p>]),</span> <span class=n>extra_context</span><span class=o>=</span><span class=n>namemap</span><span class=p>,</span>
<a name=line-321></a>                       <span class=n>isolated_context</span><span class=o>=</span><span class=n>isolated_context</span><span class=p>)</span>
</pre></div></td></tr></table><p class=footer> Generated by <a href=https://github.com/spirali/nedoc>nedoc</a> v0.9 at 2020-12-29 14:05 </p></div></div></body></html>
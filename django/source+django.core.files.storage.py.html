<!DOCTYPE html><html><head><meta charset=utf-8><title>django.core.files.storage</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./assets/purecss/pure-min.css><link rel=stylesheet href=./assets/purecss/grids-responsive-min.css><link rel=stylesheet href=./assets/style.css><link rel=stylesheet href=./assets/pygments/default.css><link rel=stylesheet href=./assets/jquery/jquery-ui.min.css><script src=./assets/jquery/jquery-3.0.0.min.js></script><script src=./assets/jquery/jquery-ui.min.js></script><script src=nedoc.js></script></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-1-4"><div class=header><h1 class=brand-title>Django</h1> 1.0 </div><div id=sbox><input id=search style="color: black;" placeholder="search ..."></div><div class=tree><ul><li><a href=django.html>&#9662; django</a> </li><li><ul><li><a href=django.__main__.html>&#9656; __main__</a> </li><li><a href=django.apps.html>&#9656; apps</a> </li><li><a href=django.bin.html>&#9656; bin</a> </li><li><a href=django.conf.html>&#9656; conf</a> </li><li><a href=django.contrib.html>&#9656; contrib</a> </li><li><a href=django.core.html>&#9662; core</a> </li><li><ul><li><a href=django.core.asgi.html>&#9656; asgi</a> </li><li><a href=django.core.cache.html>&#9656; cache</a> </li><li><a href=django.core.checks.html>&#9656; checks</a> </li><li><a href=django.core.exceptions.html>&#9656; exceptions</a> </li><li><a href=django.core.files.html>&#9662; files</a> </li><li><ul><li><a href=django.core.files.base.html>&#9656; base</a> </li><li><a href=django.core.files.images.html>&#9656; images</a> </li><li><a href=django.core.files.locks.html>&#9656; locks</a> </li><li><a href=django.core.files.move.html>&#9656; move</a> </li><li><div class=select><a href=django.core.files.storage.html>&#9662; storage</a> </div></li><li><ul><li><a href=django.core.files.storage.DefaultStorage.html> <i>class</i> DefaultStorage</a> </li><li><a href=django.core.files.storage.FileSystemStorage.html> <i>class</i> FileSystemStorage</a> </li><li><a href=django.core.files.storage.Storage.html> <i>class</i> Storage</a> </li></ul></li><li><a href=django.core.files.temp.html>&#9656; temp</a> </li><li><a href=django.core.files.uploadedfile.html>&#9656; uploadedfile</a> </li><li><a href=django.core.files.uploadhandler.html>&#9656; uploadhandler</a> </li><li><a href=django.core.files.utils.html>&#9656; utils</a> </li></ul></li><li><a href=django.core.handlers.html>&#9656; handlers</a> </li><li><a href=django.core.mail.html>&#9656; mail</a> </li><li><a href=django.core.management.html>&#9656; management</a> </li><li><a href=django.core.paginator.html>&#9656; paginator</a> </li><li><a href=django.core.serializers.html>&#9656; serializers</a> </li><li><a href=django.core.servers.html>&#9656; servers</a> </li><li><a href=django.core.signals.html>&#9656; signals</a> </li><li><a href=django.core.signing.html>&#9656; signing</a> </li><li><a href=django.core.validators.html>&#9656; validators</a> </li><li><a href=django.core.wsgi.html>&#9656; wsgi</a> </li></ul></li><li><a href=django.db.html>&#9656; db</a> </li><li><a href=django.dispatch.html>&#9656; dispatch</a> </li><li><a href=django.forms.html>&#9656; forms</a> </li><li><a href=django.http.html>&#9656; http</a> </li><li><a href=django.middleware.html>&#9656; middleware</a> </li><li><a href=django.shortcuts.html>&#9656; shortcuts</a> </li><li><a href=django.template.html>&#9656; template</a> </li><li><a href=django.templatetags.html>&#9656; templatetags</a> </li><li><a href=django.test.html>&#9656; test</a> </li><li><a href=django.urls.html>&#9656; urls</a> </li><li><a href=django.utils.html>&#9656; utils</a> </li><li><a href=django.views.html>&#9656; views</a> </li></ul></ul></div></div><div class="content pure-u-1 pure-u-md-3-4"><h1>Source code django/core/files/storage.py</h1><div id=path><a class=symbol href=django.html>django</a>.<a class=symbol href=django.core.html>core</a>.<a class=symbol href=django.core.files.html>files</a>.<a class=symbol href=django.core.files.storage.html>storage</a></div><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367</pre></div></td><td class=code><div class=highlight><pre><span></span><a name=line-1></a><span class=kn>import</span> <span class=nn>os</span>
<a name=line-2></a><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
<a name=line-3></a><span class=kn>from</span> <span class=nn>urllib.parse</span> <span class=kn>import</span> <span class=n>urljoin</span>
<a name=line-4></a>
<a name=line-5></a><span class=kn>from</span> <span class=nn>django.conf</span> <span class=kn>import</span> <span class=n>settings</span>
<a name=line-6></a><span class=kn>from</span> <span class=nn>django.core.exceptions</span> <span class=kn>import</span> <span class=n>SuspiciousFileOperation</span>
<a name=line-7></a><span class=kn>from</span> <span class=nn>django.core.files</span> <span class=kn>import</span> <span class=n>File</span><span class=p>,</span> <span class=n>locks</span>
<a name=line-8></a><span class=kn>from</span> <span class=nn>django.core.files.move</span> <span class=kn>import</span> <span class=n>file_move_safe</span>
<a name=line-9></a><span class=kn>from</span> <span class=nn>django.core.signals</span> <span class=kn>import</span> <span class=n>setting_changed</span>
<a name=line-10></a><span class=kn>from</span> <span class=nn>django.utils</span> <span class=kn>import</span> <span class=n>timezone</span>
<a name=line-11></a><span class=kn>from</span> <span class=nn>django.utils._os</span> <span class=kn>import</span> <span class=n>safe_join</span>
<a name=line-12></a><span class=kn>from</span> <span class=nn>django.utils.crypto</span> <span class=kn>import</span> <span class=n>get_random_string</span>
<a name=line-13></a><span class=kn>from</span> <span class=nn>django.utils.deconstruct</span> <span class=kn>import</span> <span class=n>deconstructible</span>
<a name=line-14></a><span class=kn>from</span> <span class=nn>django.utils.encoding</span> <span class=kn>import</span> <span class=n>filepath_to_uri</span>
<a name=line-15></a><span class=kn>from</span> <span class=nn>django.utils.functional</span> <span class=kn>import</span> <span class=n>LazyObject</span><span class=p>,</span> <span class=n>cached_property</span>
<a name=line-16></a><span class=kn>from</span> <span class=nn>django.utils.module_loading</span> <span class=kn>import</span> <span class=n>import_string</span>
<a name=line-17></a><span class=kn>from</span> <span class=nn>django.utils.text</span> <span class=kn>import</span> <span class=n>get_valid_filename</span>
<a name=line-18></a>
<a name=line-19></a><span class=n>__all__</span> <span class=o>=</span> <span class=p>(</span>
<a name=line-20></a>    <span class=s1>&#39;Storage&#39;</span><span class=p>,</span> <span class=s1>&#39;FileSystemStorage&#39;</span><span class=p>,</span> <span class=s1>&#39;DefaultStorage&#39;</span><span class=p>,</span> <span class=s1>&#39;default_storage&#39;</span><span class=p>,</span>
<a name=line-21></a>    <span class=s1>&#39;get_storage_class&#39;</span><span class=p>,</span>
<a name=line-22></a><span class=p>)</span>
<a name=line-23></a>
<a name=line-24></a>
<a name=line-25></a><span class=k>class</span> <span class=nc>Storage</span><span class=p>:</span>
<a name=line-26></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-27></a><span class=sd>    A base storage class, providing some default behaviors that all other</span>
<a name=line-28></a><span class=sd>    storage systems can inherit or override, as necessary.</span>
<a name=line-29></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-30></a>
<a name=line-31></a>    <span class=c1># The following methods represent a public interface to private methods.</span>
<a name=line-32></a>    <span class=c1># These shouldn&#39;t be overridden by subclasses unless absolutely necessary.</span>
<a name=line-33></a>
<a name=line-34></a>    <span class=k>def</span> <span class=nf>open</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;rb&#39;</span><span class=p>):</span>
<a name=line-35></a>        <span class=sd>&quot;&quot;&quot;Retrieve the specified file from storage.&quot;&quot;&quot;</span>
<a name=line-36></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_open</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>mode</span><span class=p>)</span>
<a name=line-37></a>
<a name=line-38></a>    <span class=k>def</span> <span class=nf>save</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-39></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-40></a><span class=sd>        Save new content to the file specified by name. The content should be</span>
<a name=line-41></a><span class=sd>        a proper File object or any Python file-like object, ready to be read</span>
<a name=line-42></a><span class=sd>        from the beginning.</span>
<a name=line-43></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-44></a>        <span class=c1># Get the proper name for the file, as it will actually be saved.</span>
<a name=line-45></a>        <span class=k>if</span> <span class=n>name</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-46></a>            <span class=n>name</span> <span class=o>=</span> <span class=n>content</span><span class=o>.</span><span class=n>name</span>
<a name=line-47></a>
<a name=line-48></a>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=s1>&#39;chunks&#39;</span><span class=p>):</span>
<a name=line-49></a>            <span class=n>content</span> <span class=o>=</span> <span class=n>File</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span>
<a name=line-50></a>
<a name=line-51></a>        <span class=n>name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_available_name</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=n>max_length</span><span class=p>)</span>
<a name=line-52></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_save</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>)</span>
<a name=line-53></a>
<a name=line-54></a>    <span class=c1># These methods are part of the public API, with default implementations.</span>
<a name=line-55></a>
<a name=line-56></a>    <span class=k>def</span> <span class=nf>get_valid_name</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-57></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-58></a><span class=sd>        Return a filename, based on the provided filename, that&#39;s suitable for</span>
<a name=line-59></a><span class=sd>        use in the target storage system.</span>
<a name=line-60></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-61></a>        <span class=k>return</span> <span class=n>get_valid_filename</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<a name=line-62></a>
<a name=line-63></a>    <span class=k>def</span> <span class=nf>get_alternative_name</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_root</span><span class=p>,</span> <span class=n>file_ext</span><span class=p>):</span>
<a name=line-64></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-65></a><span class=sd>        Return an alternative filename, by adding an underscore and a random 7</span>
<a name=line-66></a><span class=sd>        character alphanumeric string (before the file extension, if one</span>
<a name=line-67></a><span class=sd>        exists) to the filename.</span>
<a name=line-68></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-69></a>        <span class=k>return</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1>_</span><span class=si>%s%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>file_root</span><span class=p>,</span> <span class=n>get_random_string</span><span class=p>(</span><span class=mi>7</span><span class=p>),</span> <span class=n>file_ext</span><span class=p>)</span>
<a name=line-70></a>
<a name=line-71></a>    <span class=k>def</span> <span class=nf>get_available_name</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-72></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-73></a><span class=sd>        Return a filename that&#39;s free on the target storage system and</span>
<a name=line-74></a><span class=sd>        available for new content to be written to.</span>
<a name=line-75></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-76></a>        <span class=n>dir_name</span><span class=p>,</span> <span class=n>file_name</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<a name=line-77></a>        <span class=n>file_root</span><span class=p>,</span> <span class=n>file_ext</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>file_name</span><span class=p>)</span>
<a name=line-78></a>        <span class=c1># If the filename already exists, generate an alternative filename</span>
<a name=line-79></a>        <span class=c1># until it doesn&#39;t exist.</span>
<a name=line-80></a>        <span class=c1># Truncate original name if required, so the new filename does not</span>
<a name=line-81></a>        <span class=c1># exceed the max_length.</span>
<a name=line-82></a>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>max_length</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>max_length</span><span class=p>):</span>
<a name=line-83></a>            <span class=c1># file_ext includes the dot.</span>
<a name=line-84></a>            <span class=n>name</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>dir_name</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_alternative_name</span><span class=p>(</span><span class=n>file_root</span><span class=p>,</span> <span class=n>file_ext</span><span class=p>))</span>
<a name=line-85></a>            <span class=k>if</span> <span class=n>max_length</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-86></a>                <span class=k>continue</span>
<a name=line-87></a>            <span class=c1># Truncate file_root if max_length exceeded.</span>
<a name=line-88></a>            <span class=n>truncation</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>-</span> <span class=n>max_length</span>
<a name=line-89></a>            <span class=k>if</span> <span class=n>truncation</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
<a name=line-90></a>                <span class=n>file_root</span> <span class=o>=</span> <span class=n>file_root</span><span class=p>[:</span><span class=o>-</span><span class=n>truncation</span><span class=p>]</span>
<a name=line-91></a>                <span class=c1># Entire file_root was truncated in attempt to find an available filename.</span>
<a name=line-92></a>                <span class=k>if</span> <span class=ow>not</span> <span class=n>file_root</span><span class=p>:</span>
<a name=line-93></a>                    <span class=k>raise</span> <span class=n>SuspiciousFileOperation</span><span class=p>(</span>
<a name=line-94></a>                        <span class=s1>&#39;Storage can not find an available filename for &quot;</span><span class=si>%s</span><span class=s1>&quot;. &#39;</span>
<a name=line-95></a>                        <span class=s1>&#39;Please make sure that the corresponding file field &#39;</span>
<a name=line-96></a>                        <span class=s1>&#39;allows sufficient &quot;max_length&quot;.&#39;</span> <span class=o>%</span> <span class=n>name</span>
<a name=line-97></a>                    <span class=p>)</span>
<a name=line-98></a>                <span class=n>name</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>dir_name</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_alternative_name</span><span class=p>(</span><span class=n>file_root</span><span class=p>,</span> <span class=n>file_ext</span><span class=p>))</span>
<a name=line-99></a>        <span class=k>return</span> <span class=n>name</span>
<a name=line-100></a>
<a name=line-101></a>    <span class=k>def</span> <span class=nf>generate_filename</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>filename</span><span class=p>):</span>
<a name=line-102></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-103></a><span class=sd>        Validate the filename by calling get_valid_name() and return a filename</span>
<a name=line-104></a><span class=sd>        to be passed to the save() method.</span>
<a name=line-105></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-106></a>        <span class=c1># `filename` may include a path as returned by FileField.upload_to.</span>
<a name=line-107></a>        <span class=n>dirname</span><span class=p>,</span> <span class=n>filename</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
<a name=line-108></a>        <span class=k>return</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>normpath</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>dirname</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_valid_name</span><span class=p>(</span><span class=n>filename</span><span class=p>)))</span>
<a name=line-109></a>
<a name=line-110></a>    <span class=k>def</span> <span class=nf>path</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-111></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-112></a><span class=sd>        Return a local filesystem path where the file can be retrieved using</span>
<a name=line-113></a><span class=sd>        Python&#39;s built-in open() function. Storage systems that can&#39;t be</span>
<a name=line-114></a><span class=sd>        accessed using open() should *not* implement this method.</span>
<a name=line-115></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-116></a>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s2>&quot;This backend doesn&#39;t support absolute paths.&quot;</span><span class=p>)</span>
<a name=line-117></a>
<a name=line-118></a>    <span class=c1># The following methods form the public API for storage systems, but with</span>
<a name=line-119></a>    <span class=c1># no default implementations. Subclasses must implement *all* of these.</span>
<a name=line-120></a>
<a name=line-121></a>    <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-122></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-123></a><span class=sd>        Delete the specified file from the storage system.</span>
<a name=line-124></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-125></a>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s1>&#39;subclasses of Storage must provide a delete() method&#39;</span><span class=p>)</span>
<a name=line-126></a>
<a name=line-127></a>    <span class=k>def</span> <span class=nf>exists</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-128></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-129></a><span class=sd>        Return True if a file referenced by the given name already exists in the</span>
<a name=line-130></a><span class=sd>        storage system, or False if the name is available for a new file.</span>
<a name=line-131></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-132></a>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s1>&#39;subclasses of Storage must provide an exists() method&#39;</span><span class=p>)</span>
<a name=line-133></a>
<a name=line-134></a>    <span class=k>def</span> <span class=nf>listdir</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
<a name=line-135></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-136></a><span class=sd>        List the contents of the specified path. Return a 2-tuple of lists:</span>
<a name=line-137></a><span class=sd>        the first item being directories, the second item being files.</span>
<a name=line-138></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-139></a>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s1>&#39;subclasses of Storage must provide a listdir() method&#39;</span><span class=p>)</span>
<a name=line-140></a>
<a name=line-141></a>    <span class=k>def</span> <span class=nf>size</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-142></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-143></a><span class=sd>        Return the total size, in bytes, of the file specified by name.</span>
<a name=line-144></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-145></a>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s1>&#39;subclasses of Storage must provide a size() method&#39;</span><span class=p>)</span>
<a name=line-146></a>
<a name=line-147></a>    <span class=k>def</span> <span class=nf>url</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-148></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-149></a><span class=sd>        Return an absolute URL where the file&#39;s contents can be accessed</span>
<a name=line-150></a><span class=sd>        directly by a Web browser.</span>
<a name=line-151></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-152></a>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s1>&#39;subclasses of Storage must provide a url() method&#39;</span><span class=p>)</span>
<a name=line-153></a>
<a name=line-154></a>    <span class=k>def</span> <span class=nf>get_accessed_time</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-155></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-156></a><span class=sd>        Return the last accessed time (as a datetime) of the file specified by</span>
<a name=line-157></a><span class=sd>        name. The datetime will be timezone-aware if USE_TZ=True.</span>
<a name=line-158></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-159></a>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s1>&#39;subclasses of Storage must provide a get_accessed_time() method&#39;</span><span class=p>)</span>
<a name=line-160></a>
<a name=line-161></a>    <span class=k>def</span> <span class=nf>get_created_time</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-162></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-163></a><span class=sd>        Return the creation time (as a datetime) of the file specified by name.</span>
<a name=line-164></a><span class=sd>        The datetime will be timezone-aware if USE_TZ=True.</span>
<a name=line-165></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-166></a>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s1>&#39;subclasses of Storage must provide a get_created_time() method&#39;</span><span class=p>)</span>
<a name=line-167></a>
<a name=line-168></a>    <span class=k>def</span> <span class=nf>get_modified_time</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-169></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-170></a><span class=sd>        Return the last modified time (as a datetime) of the file specified by</span>
<a name=line-171></a><span class=sd>        name. The datetime will be timezone-aware if USE_TZ=True.</span>
<a name=line-172></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-173></a>        <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s1>&#39;subclasses of Storage must provide a get_modified_time() method&#39;</span><span class=p>)</span>
<a name=line-174></a>
<a name=line-175></a>
<a name=line-176></a><span class=nd>@deconstructible</span>
<a name=line-177></a><span class=k>class</span> <span class=nc>FileSystemStorage</span><span class=p>(</span><span class=n>Storage</span><span class=p>):</span>
<a name=line-178></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-179></a><span class=sd>    Standard filesystem storage</span>
<a name=line-180></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-181></a>    <span class=c1># The combination of O_CREAT and O_EXCL makes os.open() raise OSError if</span>
<a name=line-182></a>    <span class=c1># the file already exists before it&#39;s opened.</span>
<a name=line-183></a>    <span class=n>OS_OPEN_FLAGS</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>O_WRONLY</span> <span class=o>|</span> <span class=n>os</span><span class=o>.</span><span class=n>O_CREAT</span> <span class=o>|</span> <span class=n>os</span><span class=o>.</span><span class=n>O_EXCL</span> <span class=o>|</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>os</span><span class=p>,</span> <span class=s1>&#39;O_BINARY&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
<a name=line-184></a>
<a name=line-185></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>location</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>base_url</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>file_permissions_mode</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
<a name=line-186></a>                 <span class=n>directory_permissions_mode</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-187></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_location</span> <span class=o>=</span> <span class=n>location</span>
<a name=line-188></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_base_url</span> <span class=o>=</span> <span class=n>base_url</span>
<a name=line-189></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_file_permissions_mode</span> <span class=o>=</span> <span class=n>file_permissions_mode</span>
<a name=line-190></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_directory_permissions_mode</span> <span class=o>=</span> <span class=n>directory_permissions_mode</span>
<a name=line-191></a>        <span class=n>setting_changed</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_clear_cached_properties</span><span class=p>)</span>
<a name=line-192></a>
<a name=line-193></a>    <span class=k>def</span> <span class=nf>_clear_cached_properties</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>setting</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<a name=line-194></a>        <span class=sd>&quot;&quot;&quot;Reset setting based property values.&quot;&quot;&quot;</span>
<a name=line-195></a>        <span class=k>if</span> <span class=n>setting</span> <span class=o>==</span> <span class=s1>&#39;MEDIA_ROOT&#39;</span><span class=p>:</span>
<a name=line-196></a>            <span class=bp>self</span><span class=o>.</span><span class=vm>__dict__</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;base_location&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<a name=line-197></a>            <span class=bp>self</span><span class=o>.</span><span class=vm>__dict__</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;location&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<a name=line-198></a>        <span class=k>elif</span> <span class=n>setting</span> <span class=o>==</span> <span class=s1>&#39;MEDIA_URL&#39;</span><span class=p>:</span>
<a name=line-199></a>            <span class=bp>self</span><span class=o>.</span><span class=vm>__dict__</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;base_url&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<a name=line-200></a>        <span class=k>elif</span> <span class=n>setting</span> <span class=o>==</span> <span class=s1>&#39;FILE_UPLOAD_PERMISSIONS&#39;</span><span class=p>:</span>
<a name=line-201></a>            <span class=bp>self</span><span class=o>.</span><span class=vm>__dict__</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;file_permissions_mode&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<a name=line-202></a>        <span class=k>elif</span> <span class=n>setting</span> <span class=o>==</span> <span class=s1>&#39;FILE_UPLOAD_DIRECTORY_PERMISSIONS&#39;</span><span class=p>:</span>
<a name=line-203></a>            <span class=bp>self</span><span class=o>.</span><span class=vm>__dict__</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;directory_permissions_mode&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<a name=line-204></a>
<a name=line-205></a>    <span class=k>def</span> <span class=nf>_value_or_setting</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>setting</span><span class=p>):</span>
<a name=line-206></a>        <span class=k>return</span> <span class=n>setting</span> <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=n>value</span>
<a name=line-207></a>
<a name=line-208></a>    <span class=nd>@cached_property</span>
<a name=line-209></a>    <span class=k>def</span> <span class=nf>base_location</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-210></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_value_or_setting</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_location</span><span class=p>,</span> <span class=n>settings</span><span class=o>.</span><span class=n>MEDIA_ROOT</span><span class=p>)</span>
<a name=line-211></a>
<a name=line-212></a>    <span class=nd>@cached_property</span>
<a name=line-213></a>    <span class=k>def</span> <span class=nf>location</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-214></a>        <span class=k>return</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base_location</span><span class=p>)</span>
<a name=line-215></a>
<a name=line-216></a>    <span class=nd>@cached_property</span>
<a name=line-217></a>    <span class=k>def</span> <span class=nf>base_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-218></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_base_url</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_base_url</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>):</span>
<a name=line-219></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_base_url</span> <span class=o>+=</span> <span class=s1>&#39;/&#39;</span>
<a name=line-220></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_value_or_setting</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_base_url</span><span class=p>,</span> <span class=n>settings</span><span class=o>.</span><span class=n>MEDIA_URL</span><span class=p>)</span>
<a name=line-221></a>
<a name=line-222></a>    <span class=nd>@cached_property</span>
<a name=line-223></a>    <span class=k>def</span> <span class=nf>file_permissions_mode</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-224></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_value_or_setting</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_file_permissions_mode</span><span class=p>,</span> <span class=n>settings</span><span class=o>.</span><span class=n>FILE_UPLOAD_PERMISSIONS</span><span class=p>)</span>
<a name=line-225></a>
<a name=line-226></a>    <span class=nd>@cached_property</span>
<a name=line-227></a>    <span class=k>def</span> <span class=nf>directory_permissions_mode</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-228></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_value_or_setting</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_directory_permissions_mode</span><span class=p>,</span> <span class=n>settings</span><span class=o>.</span><span class=n>FILE_UPLOAD_DIRECTORY_PERMISSIONS</span><span class=p>)</span>
<a name=line-229></a>
<a name=line-230></a>    <span class=k>def</span> <span class=nf>_open</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;rb&#39;</span><span class=p>):</span>
<a name=line-231></a>        <span class=k>return</span> <span class=n>File</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>(</span><span class=n>name</span><span class=p>),</span> <span class=n>mode</span><span class=p>))</span>
<a name=line-232></a>
<a name=line-233></a>    <span class=k>def</span> <span class=nf>_save</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
<a name=line-234></a>        <span class=n>full_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<a name=line-235></a>
<a name=line-236></a>        <span class=c1># Create any intermediate directories that do not exist.</span>
<a name=line-237></a>        <span class=n>directory</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>full_path</span><span class=p>)</span>
<a name=line-238></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-239></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>directory_permissions_mode</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-240></a>                <span class=c1># Set the umask because os.makedirs() doesn&#39;t apply the &quot;mode&quot;</span>
<a name=line-241></a>                <span class=c1># argument to intermediate-level directories.</span>
<a name=line-242></a>                <span class=n>old_umask</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>umask</span><span class=p>(</span><span class=mo>0o777</span> <span class=o>&amp;</span> <span class=o>~</span><span class=bp>self</span><span class=o>.</span><span class=n>directory_permissions_mode</span><span class=p>)</span>
<a name=line-243></a>                <span class=k>try</span><span class=p>:</span>
<a name=line-244></a>                    <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>directory_permissions_mode</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a name=line-245></a>                <span class=k>finally</span><span class=p>:</span>
<a name=line-246></a>                    <span class=n>os</span><span class=o>.</span><span class=n>umask</span><span class=p>(</span><span class=n>old_umask</span><span class=p>)</span>
<a name=line-247></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-248></a>                <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a name=line-249></a>        <span class=k>except</span> <span class=ne>FileExistsError</span><span class=p>:</span>
<a name=line-250></a>            <span class=k>raise</span> <span class=ne>FileExistsError</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%s</span><span class=s1> exists and is not a directory.&#39;</span> <span class=o>%</span> <span class=n>directory</span><span class=p>)</span>
<a name=line-251></a>
<a name=line-252></a>        <span class=c1># There&#39;s a potential race condition between get_available_name and</span>
<a name=line-253></a>        <span class=c1># saving the file; it&#39;s possible that two threads might return the</span>
<a name=line-254></a>        <span class=c1># same name, at which point all sorts of fun happens. So we need to</span>
<a name=line-255></a>        <span class=c1># try to create the file, but if it already exists we have to go back</span>
<a name=line-256></a>        <span class=c1># to get_available_name() and try again.</span>
<a name=line-257></a>
<a name=line-258></a>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
<a name=line-259></a>            <span class=k>try</span><span class=p>:</span>
<a name=line-260></a>                <span class=c1># This file has a file path that we can move.</span>
<a name=line-261></a>                <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=s1>&#39;temporary_file_path&#39;</span><span class=p>):</span>
<a name=line-262></a>                    <span class=n>file_move_safe</span><span class=p>(</span><span class=n>content</span><span class=o>.</span><span class=n>temporary_file_path</span><span class=p>(),</span> <span class=n>full_path</span><span class=p>)</span>
<a name=line-263></a>
<a name=line-264></a>                <span class=c1># This is a normal uploadedfile that we can stream.</span>
<a name=line-265></a>                <span class=k>else</span><span class=p>:</span>
<a name=line-266></a>                    <span class=c1># The current umask value is masked out by os.open!</span>
<a name=line-267></a>                    <span class=n>fd</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>full_path</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>OS_OPEN_FLAGS</span><span class=p>,</span> <span class=mo>0o666</span><span class=p>)</span>
<a name=line-268></a>                    <span class=n>_file</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-269></a>                    <span class=k>try</span><span class=p>:</span>
<a name=line-270></a>                        <span class=n>locks</span><span class=o>.</span><span class=n>lock</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>locks</span><span class=o>.</span><span class=n>LOCK_EX</span><span class=p>)</span>
<a name=line-271></a>                        <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>content</span><span class=o>.</span><span class=n>chunks</span><span class=p>():</span>
<a name=line-272></a>                            <span class=k>if</span> <span class=n>_file</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-273></a>                                <span class=n>mode</span> <span class=o>=</span> <span class=s1>&#39;wb&#39;</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>)</span> <span class=k>else</span> <span class=s1>&#39;wt&#39;</span>
<a name=line-274></a>                                <span class=n>_file</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>fdopen</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>mode</span><span class=p>)</span>
<a name=line-275></a>                            <span class=n>_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>chunk</span><span class=p>)</span>
<a name=line-276></a>                    <span class=k>finally</span><span class=p>:</span>
<a name=line-277></a>                        <span class=n>locks</span><span class=o>.</span><span class=n>unlock</span><span class=p>(</span><span class=n>fd</span><span class=p>)</span>
<a name=line-278></a>                        <span class=k>if</span> <span class=n>_file</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-279></a>                            <span class=n>_file</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-280></a>                        <span class=k>else</span><span class=p>:</span>
<a name=line-281></a>                            <span class=n>os</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>)</span>
<a name=line-282></a>            <span class=k>except</span> <span class=ne>FileExistsError</span><span class=p>:</span>
<a name=line-283></a>                <span class=c1># A new name is needed if the file exists.</span>
<a name=line-284></a>                <span class=n>name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_available_name</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<a name=line-285></a>                <span class=n>full_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<a name=line-286></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-287></a>                <span class=c1># OK, the file save worked. Break out of the loop.</span>
<a name=line-288></a>                <span class=k>break</span>
<a name=line-289></a>
<a name=line-290></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>file_permissions_mode</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-291></a>            <span class=n>os</span><span class=o>.</span><span class=n>chmod</span><span class=p>(</span><span class=n>full_path</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>file_permissions_mode</span><span class=p>)</span>
<a name=line-292></a>
<a name=line-293></a>        <span class=c1># Store filenames with forward slashes, even on Windows.</span>
<a name=line-294></a>        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\\</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;/&#39;</span><span class=p>)</span>
<a name=line-295></a>
<a name=line-296></a>    <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-297></a>        <span class=k>assert</span> <span class=n>name</span><span class=p>,</span> <span class=s2>&quot;The name argument is not allowed to be empty.&quot;</span>
<a name=line-298></a>        <span class=n>name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<a name=line-299></a>        <span class=c1># If the file or directory exists, delete it from the filesystem.</span>
<a name=line-300></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-301></a>            <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isdir</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
<a name=line-302></a>                <span class=n>os</span><span class=o>.</span><span class=n>rmdir</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<a name=line-303></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-304></a>                <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<a name=line-305></a>        <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
<a name=line-306></a>            <span class=c1># FileNotFoundError is raised if the file or directory was removed</span>
<a name=line-307></a>            <span class=c1># concurrently.</span>
<a name=line-308></a>            <span class=k>pass</span>
<a name=line-309></a>
<a name=line-310></a>    <span class=k>def</span> <span class=nf>exists</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-311></a>        <span class=k>return</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>(</span><span class=n>name</span><span class=p>))</span>
<a name=line-312></a>
<a name=line-313></a>    <span class=k>def</span> <span class=nf>listdir</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
<a name=line-314></a>        <span class=n>path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
<a name=line-315></a>        <span class=n>directories</span><span class=p>,</span> <span class=n>files</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[]</span>
<a name=line-316></a>        <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>scandir</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
<a name=line-317></a>            <span class=k>if</span> <span class=n>entry</span><span class=o>.</span><span class=n>is_dir</span><span class=p>():</span>
<a name=line-318></a>                <span class=n>directories</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entry</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
<a name=line-319></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-320></a>                <span class=n>files</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entry</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
<a name=line-321></a>        <span class=k>return</span> <span class=n>directories</span><span class=p>,</span> <span class=n>files</span>
<a name=line-322></a>
<a name=line-323></a>    <span class=k>def</span> <span class=nf>path</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-324></a>        <span class=k>return</span> <span class=n>safe_join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>location</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span>
<a name=line-325></a>
<a name=line-326></a>    <span class=k>def</span> <span class=nf>size</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-327></a>        <span class=k>return</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getsize</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>(</span><span class=n>name</span><span class=p>))</span>
<a name=line-328></a>
<a name=line-329></a>    <span class=k>def</span> <span class=nf>url</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-330></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_url</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-331></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;This file is not accessible via a URL.&quot;</span><span class=p>)</span>
<a name=line-332></a>        <span class=n>url</span> <span class=o>=</span> <span class=n>filepath_to_uri</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<a name=line-333></a>        <span class=k>if</span> <span class=n>url</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-334></a>            <span class=n>url</span> <span class=o>=</span> <span class=n>url</span><span class=o>.</span><span class=n>lstrip</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
<a name=line-335></a>        <span class=k>return</span> <span class=n>urljoin</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>base_url</span><span class=p>,</span> <span class=n>url</span><span class=p>)</span>
<a name=line-336></a>
<a name=line-337></a>    <span class=k>def</span> <span class=nf>_datetime_from_timestamp</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ts</span><span class=p>):</span>
<a name=line-338></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-339></a><span class=sd>        If timezone support is enabled, make an aware datetime object in UTC;</span>
<a name=line-340></a><span class=sd>        otherwise make a naive one in the local timezone.</span>
<a name=line-341></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-342></a>        <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>USE_TZ</span><span class=p>:</span>
<a name=line-343></a>            <span class=c1># Safe to use .replace() because UTC doesn&#39;t have DST</span>
<a name=line-344></a>            <span class=k>return</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcfromtimestamp</span><span class=p>(</span><span class=n>ts</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>tzinfo</span><span class=o>=</span><span class=n>timezone</span><span class=o>.</span><span class=n>utc</span><span class=p>)</span>
<a name=line-345></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-346></a>            <span class=k>return</span> <span class=n>datetime</span><span class=o>.</span><span class=n>fromtimestamp</span><span class=p>(</span><span class=n>ts</span><span class=p>)</span>
<a name=line-347></a>
<a name=line-348></a>    <span class=k>def</span> <span class=nf>get_accessed_time</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-349></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datetime_from_timestamp</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getatime</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>(</span><span class=n>name</span><span class=p>)))</span>
<a name=line-350></a>
<a name=line-351></a>    <span class=k>def</span> <span class=nf>get_created_time</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-352></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datetime_from_timestamp</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getctime</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>(</span><span class=n>name</span><span class=p>)))</span>
<a name=line-353></a>
<a name=line-354></a>    <span class=k>def</span> <span class=nf>get_modified_time</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<a name=line-355></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datetime_from_timestamp</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getmtime</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>(</span><span class=n>name</span><span class=p>)))</span>
<a name=line-356></a>
<a name=line-357></a>
<a name=line-358></a><span class=k>def</span> <span class=nf>get_storage_class</span><span class=p>(</span><span class=n>import_path</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-359></a>    <span class=k>return</span> <span class=n>import_string</span><span class=p>(</span><span class=n>import_path</span> <span class=ow>or</span> <span class=n>settings</span><span class=o>.</span><span class=n>DEFAULT_FILE_STORAGE</span><span class=p>)</span>
<a name=line-360></a>
<a name=line-361></a>
<a name=line-362></a><span class=k>class</span> <span class=nc>DefaultStorage</span><span class=p>(</span><span class=n>LazyObject</span><span class=p>):</span>
<a name=line-363></a>    <span class=k>def</span> <span class=nf>_setup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-364></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_wrapped</span> <span class=o>=</span> <span class=n>get_storage_class</span><span class=p>()()</span>
<a name=line-365></a>
<a name=line-366></a>
<a name=line-367></a><span class=n>default_storage</span> <span class=o>=</span> <span class=n>DefaultStorage</span><span class=p>()</span>
</pre></div></td></tr></table><p class=footer> Generated by <a href=https://github.com/spirali/nedoc>nedoc</a> v0.9 at 2020-12-29 14:04 </p></div></div></body></html>
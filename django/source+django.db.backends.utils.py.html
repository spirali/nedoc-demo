<!DOCTYPE html><html><head><meta charset=utf-8><title>django.db.backends.utils</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./assets/purecss/pure-min.css><link rel=stylesheet href=./assets/purecss/grids-responsive-min.css><link rel=stylesheet href=./assets/style.css><link rel=stylesheet href=./assets/pygments/default.css><link rel=stylesheet href=./assets/jquery/jquery-ui.min.css><script src=./assets/jquery/jquery-3.0.0.min.js></script><script src=./assets/jquery/jquery-ui.min.js></script><script src=nedoc.js></script></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-1-4"><div class=header><h1 class=brand-title>Django</h1> 1.0 </div><div id=sbox><input id=search style="color: black;" placeholder="search ..."></div><div class=tree><ul><li><a href=django.html>&#9662; django</a> </li><li><ul><li><a href=django.__main__.html>&#9656; __main__</a> </li><li><a href=django.apps.html>&#9656; apps</a> </li><li><a href=django.bin.html>&#9656; bin</a> </li><li><a href=django.conf.html>&#9656; conf</a> </li><li><a href=django.contrib.html>&#9656; contrib</a> </li><li><a href=django.core.html>&#9656; core</a> </li><li><a href=django.db.html>&#9662; db</a> </li><li><ul><li><a href=django.db.backends.html>&#9662; backends</a> </li><li><ul><li><a href=django.db.backends.base.html>&#9656; base</a> </li><li><a href=django.db.backends.ddl_references.html>&#9656; ddl_references</a> </li><li><a href=django.db.backends.dummy.html>&#9656; dummy</a> </li><li><a href=django.db.backends.mysql.html>&#9656; mysql</a> </li><li><a href=django.db.backends.oracle.html>&#9656; oracle</a> </li><li><a href=django.db.backends.postgresql.html>&#9656; postgresql</a> </li><li><a href=django.db.backends.signals.html>&#9656; signals</a> </li><li><a href=django.db.backends.sqlite3.html>&#9656; sqlite3</a> </li><li><div class=select><a href=django.db.backends.utils.html>&#9662; utils</a> </div></li><li><ul><li><a href=django.db.backends.utils.CursorDebugWrapper.html> <i>class</i> CursorDebugWrapper</a> </li><li><a href=django.db.backends.utils.CursorWrapper.html> <i>class</i> CursorWrapper</a> </li></ul></li><li><a href=django.db.migrations.html>&#9656; migrations</a> </li><li><a href=django.db.models.html>&#9656; models</a> </li><li><a href=django.db.transaction.html>&#9656; transaction</a> </li><li><a href=django.db.utils.html>&#9656; utils</a> </li><li><a href=django.db.DefaultConnectionProxy.html> <i>class</i> DefaultConnectionProxy</a> </li></ul></li><li><a href=django.dispatch.html>&#9656; dispatch</a> </li><li><a href=django.forms.html>&#9656; forms</a> </li><li><a href=django.http.html>&#9656; http</a> </li><li><a href=django.middleware.html>&#9656; middleware</a> </li><li><a href=django.shortcuts.html>&#9656; shortcuts</a> </li><li><a href=django.template.html>&#9656; template</a> </li><li><a href=django.templatetags.html>&#9656; templatetags</a> </li><li><a href=django.test.html>&#9656; test</a> </li><li><a href=django.urls.html>&#9656; urls</a> </li><li><a href=django.utils.html>&#9656; utils</a> </li><li><a href=django.views.html>&#9656; views</a> </li></ul></ul></div></div><div class="content pure-u-1 pure-u-md-3-4"><h1>Source code django/db/backends/utils.py</h1><div id=path><a class=symbol href=django.html>django</a>.<a class=symbol href=django.db.html>db</a>.<a class=symbol href=django.db.backends.html>backends</a>.<a class=symbol href=django.db.backends.utils.html>utils</a></div><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249</pre></div></td><td class=code><div class=highlight><pre><span></span><a name=line-1></a><span class=kn>import</span> <span class=nn>datetime</span>
<a name=line-2></a><span class=kn>import</span> <span class=nn>decimal</span>
<a name=line-3></a><span class=kn>import</span> <span class=nn>functools</span>
<a name=line-4></a><span class=kn>import</span> <span class=nn>hashlib</span>
<a name=line-5></a><span class=kn>import</span> <span class=nn>logging</span>
<a name=line-6></a><span class=kn>import</span> <span class=nn>time</span>
<a name=line-7></a><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
<a name=line-8></a>
<a name=line-9></a><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>NotSupportedError</span>
<a name=line-10></a>
<a name=line-11></a><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s1>&#39;django.db.backends&#39;</span><span class=p>)</span>
<a name=line-12></a>
<a name=line-13></a>
<a name=line-14></a><span class=k>class</span> <span class=nc>CursorWrapper</span><span class=p>:</span>
<a name=line-15></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cursor</span><span class=p>,</span> <span class=n>db</span><span class=p>):</span>
<a name=line-16></a>        <span class=bp>self</span><span class=o>.</span><span class=n>cursor</span> <span class=o>=</span> <span class=n>cursor</span>
<a name=line-17></a>        <span class=bp>self</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=n>db</span>
<a name=line-18></a>
<a name=line-19></a>    <span class=n>WRAP_ERROR_ATTRS</span> <span class=o>=</span> <span class=nb>frozenset</span><span class=p>([</span><span class=s1>&#39;fetchone&#39;</span><span class=p>,</span> <span class=s1>&#39;fetchmany&#39;</span><span class=p>,</span> <span class=s1>&#39;fetchall&#39;</span><span class=p>,</span> <span class=s1>&#39;nextset&#39;</span><span class=p>])</span>
<a name=line-20></a>
<a name=line-21></a>    <span class=k>def</span> <span class=fm>__getattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>attr</span><span class=p>):</span>
<a name=line-22></a>        <span class=n>cursor_attr</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>cursor</span><span class=p>,</span> <span class=n>attr</span><span class=p>)</span>
<a name=line-23></a>        <span class=k>if</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>CursorWrapper</span><span class=o>.</span><span class=n>WRAP_ERROR_ATTRS</span><span class=p>:</span>
<a name=line-24></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>wrap_database_errors</span><span class=p>(</span><span class=n>cursor_attr</span><span class=p>)</span>
<a name=line-25></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-26></a>            <span class=k>return</span> <span class=n>cursor_attr</span>
<a name=line-27></a>
<a name=line-28></a>    <span class=k>def</span> <span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-29></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>wrap_database_errors</span><span class=p>:</span>
<a name=line-30></a>            <span class=k>yield from</span> <span class=bp>self</span><span class=o>.</span><span class=n>cursor</span>
<a name=line-31></a>
<a name=line-32></a>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-33></a>        <span class=k>return</span> <span class=bp>self</span>
<a name=line-34></a>
<a name=line-35></a>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=nb>type</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>traceback</span><span class=p>):</span>
<a name=line-36></a>        <span class=c1># Close instead of passing through to avoid backend-specific behavior</span>
<a name=line-37></a>        <span class=c1># (#17671). Catch errors liberally because errors in cleanup code</span>
<a name=line-38></a>        <span class=c1># aren&#39;t useful.</span>
<a name=line-39></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-40></a>            <span class=bp>self</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-41></a>        <span class=k>except</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>Database</span><span class=o>.</span><span class=n>Error</span><span class=p>:</span>
<a name=line-42></a>            <span class=k>pass</span>
<a name=line-43></a>
<a name=line-44></a>    <span class=c1># The following methods cannot be implemented in __getattr__, because the</span>
<a name=line-45></a>    <span class=c1># code must run when the method is invoked, not just when it is accessed.</span>
<a name=line-46></a>
<a name=line-47></a>    <span class=k>def</span> <span class=nf>callproc</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>procname</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>kparams</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-48></a>        <span class=c1># Keyword parameters for callproc aren&#39;t supported in PEP 249, but the</span>
<a name=line-49></a>        <span class=c1># database driver may support them (e.g. cx_Oracle).</span>
<a name=line-50></a>        <span class=k>if</span> <span class=n>kparams</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>features</span><span class=o>.</span><span class=n>supports_callproc_kwargs</span><span class=p>:</span>
<a name=line-51></a>            <span class=k>raise</span> <span class=n>NotSupportedError</span><span class=p>(</span>
<a name=line-52></a>                <span class=s1>&#39;Keyword parameters for callproc are not supported on this &#39;</span>
<a name=line-53></a>                <span class=s1>&#39;database backend.&#39;</span>
<a name=line-54></a>            <span class=p>)</span>
<a name=line-55></a>        <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>validate_no_broken_transaction</span><span class=p>()</span>
<a name=line-56></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>wrap_database_errors</span><span class=p>:</span>
<a name=line-57></a>            <span class=k>if</span> <span class=n>params</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>kparams</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-58></a>                <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cursor</span><span class=o>.</span><span class=n>callproc</span><span class=p>(</span><span class=n>procname</span><span class=p>)</span>
<a name=line-59></a>            <span class=k>elif</span> <span class=n>kparams</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-60></a>                <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cursor</span><span class=o>.</span><span class=n>callproc</span><span class=p>(</span><span class=n>procname</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
<a name=line-61></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-62></a>                <span class=n>params</span> <span class=o>=</span> <span class=n>params</span> <span class=ow>or</span> <span class=p>()</span>
<a name=line-63></a>                <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cursor</span><span class=o>.</span><span class=n>callproc</span><span class=p>(</span><span class=n>procname</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>kparams</span><span class=p>)</span>
<a name=line-64></a>
<a name=line-65></a>    <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-66></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_with_wrappers</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>many</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>executor</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_execute</span><span class=p>)</span>
<a name=line-67></a>
<a name=line-68></a>    <span class=k>def</span> <span class=nf>executemany</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>param_list</span><span class=p>):</span>
<a name=line-69></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_with_wrappers</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>param_list</span><span class=p>,</span> <span class=n>many</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>executor</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_executemany</span><span class=p>)</span>
<a name=line-70></a>
<a name=line-71></a>    <span class=k>def</span> <span class=nf>_execute_with_wrappers</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>many</span><span class=p>,</span> <span class=n>executor</span><span class=p>):</span>
<a name=line-72></a>        <span class=n>context</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;connection&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=p>,</span> <span class=s1>&#39;cursor&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=p>}</span>
<a name=line-73></a>        <span class=k>for</span> <span class=n>wrapper</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>execute_wrappers</span><span class=p>):</span>
<a name=line-74></a>            <span class=n>executor</span> <span class=o>=</span> <span class=n>functools</span><span class=o>.</span><span class=n>partial</span><span class=p>(</span><span class=n>wrapper</span><span class=p>,</span> <span class=n>executor</span><span class=p>)</span>
<a name=line-75></a>        <span class=k>return</span> <span class=n>executor</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>many</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
<a name=line-76></a>
<a name=line-77></a>    <span class=k>def</span> <span class=nf>_execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=o>*</span><span class=n>ignored_wrapper_args</span><span class=p>):</span>
<a name=line-78></a>        <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>validate_no_broken_transaction</span><span class=p>()</span>
<a name=line-79></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>wrap_database_errors</span><span class=p>:</span>
<a name=line-80></a>            <span class=k>if</span> <span class=n>params</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-81></a>                <span class=c1># params default might be backend specific.</span>
<a name=line-82></a>                <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span>
<a name=line-83></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-84></a>                <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
<a name=line-85></a>
<a name=line-86></a>    <span class=k>def</span> <span class=nf>_executemany</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>param_list</span><span class=p>,</span> <span class=o>*</span><span class=n>ignored_wrapper_args</span><span class=p>):</span>
<a name=line-87></a>        <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>validate_no_broken_transaction</span><span class=p>()</span>
<a name=line-88></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>wrap_database_errors</span><span class=p>:</span>
<a name=line-89></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cursor</span><span class=o>.</span><span class=n>executemany</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>param_list</span><span class=p>)</span>
<a name=line-90></a>
<a name=line-91></a>
<a name=line-92></a><span class=k>class</span> <span class=nc>CursorDebugWrapper</span><span class=p>(</span><span class=n>CursorWrapper</span><span class=p>):</span>
<a name=line-93></a>
<a name=line-94></a>    <span class=c1># XXX callproc isn&#39;t instrumented at this time.</span>
<a name=line-95></a>
<a name=line-96></a>    <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-97></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_sql</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=p>,</span> <span class=n>use_last_executed_query</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
<a name=line-98></a>            <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
<a name=line-99></a>
<a name=line-100></a>    <span class=k>def</span> <span class=nf>executemany</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>param_list</span><span class=p>):</span>
<a name=line-101></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_sql</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>param_list</span><span class=p>,</span> <span class=n>many</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
<a name=line-102></a>            <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>executemany</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>param_list</span><span class=p>)</span>
<a name=line-103></a>
<a name=line-104></a>    <span class=nd>@contextmanager</span>
<a name=line-105></a>    <span class=k>def</span> <span class=nf>debug_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>use_last_executed_query</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>many</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
<a name=line-106></a>        <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>monotonic</span><span class=p>()</span>
<a name=line-107></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-108></a>            <span class=k>yield</span>
<a name=line-109></a>        <span class=k>finally</span><span class=p>:</span>
<a name=line-110></a>            <span class=n>stop</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>monotonic</span><span class=p>()</span>
<a name=line-111></a>            <span class=n>duration</span> <span class=o>=</span> <span class=n>stop</span> <span class=o>-</span> <span class=n>start</span>
<a name=line-112></a>            <span class=k>if</span> <span class=n>use_last_executed_query</span><span class=p>:</span>
<a name=line-113></a>                <span class=n>sql</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>ops</span><span class=o>.</span><span class=n>last_executed_query</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>cursor</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
<a name=line-114></a>            <span class=k>try</span><span class=p>:</span>
<a name=line-115></a>                <span class=n>times</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>params</span><span class=p>)</span> <span class=k>if</span> <span class=n>many</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span>
<a name=line-116></a>            <span class=k>except</span> <span class=ne>TypeError</span><span class=p>:</span>
<a name=line-117></a>                <span class=c1># params could be an iterator.</span>
<a name=line-118></a>                <span class=n>times</span> <span class=o>=</span> <span class=s1>&#39;?&#39;</span>
<a name=line-119></a>            <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>queries_log</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
<a name=line-120></a>                <span class=s1>&#39;sql&#39;</span><span class=p>:</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1> times: </span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>times</span><span class=p>,</span> <span class=n>sql</span><span class=p>)</span> <span class=k>if</span> <span class=n>many</span> <span class=k>else</span> <span class=n>sql</span><span class=p>,</span>
<a name=line-121></a>                <span class=s1>&#39;time&#39;</span><span class=p>:</span> <span class=s1>&#39;</span><span class=si>%.3f</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>duration</span><span class=p>,</span>
<a name=line-122></a>            <span class=p>})</span>
<a name=line-123></a>            <span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
<a name=line-124></a>                <span class=s1>&#39;(</span><span class=si>%.3f</span><span class=s1>) </span><span class=si>%s</span><span class=s1>; args=</span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span>
<a name=line-125></a>                <span class=n>duration</span><span class=p>,</span>
<a name=line-126></a>                <span class=n>sql</span><span class=p>,</span>
<a name=line-127></a>                <span class=n>params</span><span class=p>,</span>
<a name=line-128></a>                <span class=n>extra</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;duration&#39;</span><span class=p>:</span> <span class=n>duration</span><span class=p>,</span> <span class=s1>&#39;sql&#39;</span><span class=p>:</span> <span class=n>sql</span><span class=p>,</span> <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=n>params</span><span class=p>},</span>
<a name=line-129></a>            <span class=p>)</span>
<a name=line-130></a>
<a name=line-131></a>
<a name=line-132></a><span class=c1>###############################################</span>
<a name=line-133></a><span class=c1># Converters from database (string) to Python #</span>
<a name=line-134></a><span class=c1>###############################################</span>
<a name=line-135></a>
<a name=line-136></a><span class=k>def</span> <span class=nf>typecast_date</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
<a name=line-137></a>    <span class=k>return</span> <span class=n>datetime</span><span class=o>.</span><span class=n>date</span><span class=p>(</span><span class=o>*</span><span class=nb>map</span><span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=n>s</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=p>)))</span> <span class=k>if</span> <span class=n>s</span> <span class=k>else</span> <span class=kc>None</span>  <span class=c1># return None if s is null</span>
<a name=line-138></a>
<a name=line-139></a>
<a name=line-140></a><span class=k>def</span> <span class=nf>typecast_time</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>  <span class=c1># does NOT store time zone information</span>
<a name=line-141></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>s</span><span class=p>:</span>
<a name=line-142></a>        <span class=k>return</span> <span class=kc>None</span>
<a name=line-143></a>    <span class=n>hour</span><span class=p>,</span> <span class=n>minutes</span><span class=p>,</span> <span class=n>seconds</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
<a name=line-144></a>    <span class=k>if</span> <span class=s1>&#39;.&#39;</span> <span class=ow>in</span> <span class=n>seconds</span><span class=p>:</span>  <span class=c1># check whether seconds have a fractional part</span>
<a name=line-145></a>        <span class=n>seconds</span><span class=p>,</span> <span class=n>microseconds</span> <span class=o>=</span> <span class=n>seconds</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>)</span>
<a name=line-146></a>    <span class=k>else</span><span class=p>:</span>
<a name=line-147></a>        <span class=n>microseconds</span> <span class=o>=</span> <span class=s1>&#39;0&#39;</span>
<a name=line-148></a>    <span class=k>return</span> <span class=n>datetime</span><span class=o>.</span><span class=n>time</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>hour</span><span class=p>),</span> <span class=nb>int</span><span class=p>(</span><span class=n>minutes</span><span class=p>),</span> <span class=nb>int</span><span class=p>(</span><span class=n>seconds</span><span class=p>),</span> <span class=nb>int</span><span class=p>((</span><span class=n>microseconds</span> <span class=o>+</span> <span class=s1>&#39;000000&#39;</span><span class=p>)[:</span><span class=mi>6</span><span class=p>]))</span>
<a name=line-149></a>
<a name=line-150></a>
<a name=line-151></a><span class=k>def</span> <span class=nf>typecast_timestamp</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>  <span class=c1># does NOT store time zone information</span>
<a name=line-152></a>    <span class=c1># &quot;2005-07-29 15:48:00.590358-05&quot;</span>
<a name=line-153></a>    <span class=c1># &quot;2005-07-29 09:56:00-05&quot;</span>
<a name=line-154></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>s</span><span class=p>:</span>
<a name=line-155></a>        <span class=k>return</span> <span class=kc>None</span>
<a name=line-156></a>    <span class=k>if</span> <span class=s1>&#39; &#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>s</span><span class=p>:</span>
<a name=line-157></a>        <span class=k>return</span> <span class=n>typecast_date</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
<a name=line-158></a>    <span class=n>d</span><span class=p>,</span> <span class=n>t</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
<a name=line-159></a>    <span class=c1># Remove timezone information.</span>
<a name=line-160></a>    <span class=k>if</span> <span class=s1>&#39;-&#39;</span> <span class=ow>in</span> <span class=n>t</span><span class=p>:</span>
<a name=line-161></a>        <span class=n>t</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>t</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
<a name=line-162></a>    <span class=k>elif</span> <span class=s1>&#39;+&#39;</span> <span class=ow>in</span> <span class=n>t</span><span class=p>:</span>
<a name=line-163></a>        <span class=n>t</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>t</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;+&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
<a name=line-164></a>    <span class=n>dates</span> <span class=o>=</span> <span class=n>d</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=p>)</span>
<a name=line-165></a>    <span class=n>times</span> <span class=o>=</span> <span class=n>t</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
<a name=line-166></a>    <span class=n>seconds</span> <span class=o>=</span> <span class=n>times</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
<a name=line-167></a>    <span class=k>if</span> <span class=s1>&#39;.&#39;</span> <span class=ow>in</span> <span class=n>seconds</span><span class=p>:</span>  <span class=c1># check whether seconds have a fractional part</span>
<a name=line-168></a>        <span class=n>seconds</span><span class=p>,</span> <span class=n>microseconds</span> <span class=o>=</span> <span class=n>seconds</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>)</span>
<a name=line-169></a>    <span class=k>else</span><span class=p>:</span>
<a name=line-170></a>        <span class=n>microseconds</span> <span class=o>=</span> <span class=s1>&#39;0&#39;</span>
<a name=line-171></a>    <span class=k>return</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=p>(</span>
<a name=line-172></a>        <span class=nb>int</span><span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=mi>1</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>dates</span><span class=p>[</span><span class=mi>2</span><span class=p>]),</span>
<a name=line-173></a>        <span class=nb>int</span><span class=p>(</span><span class=n>times</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>times</span><span class=p>[</span><span class=mi>1</span><span class=p>]),</span> <span class=nb>int</span><span class=p>(</span><span class=n>seconds</span><span class=p>),</span>
<a name=line-174></a>        <span class=nb>int</span><span class=p>((</span><span class=n>microseconds</span> <span class=o>+</span> <span class=s1>&#39;000000&#39;</span><span class=p>)[:</span><span class=mi>6</span><span class=p>])</span>
<a name=line-175></a>    <span class=p>)</span>
<a name=line-176></a>
<a name=line-177></a>
<a name=line-178></a><span class=c1>###############################################</span>
<a name=line-179></a><span class=c1># Converters from Python to database (string) #</span>
<a name=line-180></a><span class=c1>###############################################</span>
<a name=line-181></a>
<a name=line-182></a><span class=k>def</span> <span class=nf>split_identifier</span><span class=p>(</span><span class=n>identifier</span><span class=p>):</span>
<a name=line-183></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-184></a><span class=sd>    Split an SQL identifier into a two element tuple of (namespace, name).</span>
<a name=line-185></a>
<a name=line-186></a><span class=sd>    The identifier could be a table, column, or sequence name might be prefixed</span>
<a name=line-187></a><span class=sd>    by a namespace.</span>
<a name=line-188></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-189></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-190></a>        <span class=n>namespace</span><span class=p>,</span> <span class=n>name</span> <span class=o>=</span> <span class=n>identifier</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;&quot;.&quot;&#39;</span><span class=p>)</span>
<a name=line-191></a>    <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
<a name=line-192></a>        <span class=n>namespace</span><span class=p>,</span> <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>identifier</span>
<a name=line-193></a>    <span class=k>return</span> <span class=n>namespace</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>),</span> <span class=n>name</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span>
<a name=line-194></a>
<a name=line-195></a>
<a name=line-196></a><span class=k>def</span> <span class=nf>truncate_name</span><span class=p>(</span><span class=n>identifier</span><span class=p>,</span> <span class=n>length</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>hash_len</span><span class=o>=</span><span class=mi>4</span><span class=p>):</span>
<a name=line-197></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-198></a><span class=sd>    Shorten an SQL identifier to a repeatable mangled version with the given</span>
<a name=line-199></a><span class=sd>    length.</span>
<a name=line-200></a>
<a name=line-201></a><span class=sd>    If a quote stripped name contains a namespace, e.g. USERNAME&quot;.&quot;TABLE,</span>
<a name=line-202></a><span class=sd>    truncate the table portion only.</span>
<a name=line-203></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-204></a>    <span class=n>namespace</span><span class=p>,</span> <span class=n>name</span> <span class=o>=</span> <span class=n>split_identifier</span><span class=p>(</span><span class=n>identifier</span><span class=p>)</span>
<a name=line-205></a>
<a name=line-206></a>    <span class=k>if</span> <span class=n>length</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>length</span><span class=p>:</span>
<a name=line-207></a>        <span class=k>return</span> <span class=n>identifier</span>
<a name=line-208></a>
<a name=line-209></a>    <span class=n>digest</span> <span class=o>=</span> <span class=n>names_digest</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>length</span><span class=o>=</span><span class=n>hash_len</span><span class=p>)</span>
<a name=line-210></a>    <span class=k>return</span> <span class=s1>&#39;</span><span class=si>%s%s%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=s1>&#39;</span><span class=si>%s</span><span class=s1>&quot;.&quot;&#39;</span> <span class=o>%</span> <span class=n>namespace</span> <span class=k>if</span> <span class=n>namespace</span> <span class=k>else</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>name</span><span class=p>[:</span><span class=n>length</span> <span class=o>-</span> <span class=n>hash_len</span><span class=p>],</span> <span class=n>digest</span><span class=p>)</span>
<a name=line-211></a>
<a name=line-212></a>
<a name=line-213></a><span class=k>def</span> <span class=nf>names_digest</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=n>length</span><span class=p>):</span>
<a name=line-214></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-215></a><span class=sd>    Generate a 32-bit digest of a set of arguments that can be used to shorten</span>
<a name=line-216></a><span class=sd>    identifying names.</span>
<a name=line-217></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-218></a>    <span class=n>h</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>()</span>
<a name=line-219></a>    <span class=k>for</span> <span class=n>arg</span> <span class=ow>in</span> <span class=n>args</span><span class=p>:</span>
<a name=line-220></a>        <span class=n>h</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>arg</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
<a name=line-221></a>    <span class=k>return</span> <span class=n>h</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()[:</span><span class=n>length</span><span class=p>]</span>
<a name=line-222></a>
<a name=line-223></a>
<a name=line-224></a><span class=k>def</span> <span class=nf>format_number</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>max_digits</span><span class=p>,</span> <span class=n>decimal_places</span><span class=p>):</span>
<a name=line-225></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-226></a><span class=sd>    Format a number into a string with the requisite number of digits and</span>
<a name=line-227></a><span class=sd>    decimal places.</span>
<a name=line-228></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-229></a>    <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-230></a>        <span class=k>return</span> <span class=kc>None</span>
<a name=line-231></a>    <span class=n>context</span> <span class=o>=</span> <span class=n>decimal</span><span class=o>.</span><span class=n>getcontext</span><span class=p>()</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
<a name=line-232></a>    <span class=k>if</span> <span class=n>max_digits</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-233></a>        <span class=n>context</span><span class=o>.</span><span class=n>prec</span> <span class=o>=</span> <span class=n>max_digits</span>
<a name=line-234></a>    <span class=k>if</span> <span class=n>decimal_places</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-235></a>        <span class=n>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>quantize</span><span class=p>(</span><span class=n>decimal</span><span class=o>.</span><span class=n>Decimal</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>scaleb</span><span class=p>(</span><span class=o>-</span><span class=n>decimal_places</span><span class=p>),</span> <span class=n>context</span><span class=o>=</span><span class=n>context</span><span class=p>)</span>
<a name=line-236></a>    <span class=k>else</span><span class=p>:</span>
<a name=line-237></a>        <span class=n>context</span><span class=o>.</span><span class=n>traps</span><span class=p>[</span><span class=n>decimal</span><span class=o>.</span><span class=n>Rounded</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
<a name=line-238></a>        <span class=n>value</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>create_decimal</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<a name=line-239></a>    <span class=k>return</span> <span class=s2>&quot;</span><span class=si>{:f}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
<a name=line-240></a>
<a name=line-241></a>
<a name=line-242></a><span class=k>def</span> <span class=nf>strip_quotes</span><span class=p>(</span><span class=n>table_name</span><span class=p>):</span>
<a name=line-243></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-244></a><span class=sd>    Strip quotes off of quoted table names to make them safe for use in index</span>
<a name=line-245></a><span class=sd>    names, sequence names, etc. For example &#39;&quot;USER&quot;.&quot;TABLE&quot;&#39; (an Oracle naming</span>
<a name=line-246></a><span class=sd>    scheme) becomes &#39;USER&quot;.&quot;TABLE&#39;.</span>
<a name=line-247></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-248></a>    <span class=n>has_quotes</span> <span class=o>=</span> <span class=n>table_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>table_name</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>)</span>
<a name=line-249></a>    <span class=k>return</span> <span class=n>table_name</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=k>if</span> <span class=n>has_quotes</span> <span class=k>else</span> <span class=n>table_name</span>
</pre></div></td></tr></table><p class=footer> Generated by <a href=https://github.com/spirali/nedoc>nedoc</a> v0.9 at 2020-12-29 14:04 </p></div></div></body></html>
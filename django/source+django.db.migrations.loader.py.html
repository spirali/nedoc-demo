<!DOCTYPE html><html><head><meta charset=utf-8><title>django.db.migrations.loader</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./assets/purecss/pure-min.css><link rel=stylesheet href=./assets/purecss/grids-responsive-min.css><link rel=stylesheet href=./assets/style.css><link rel=stylesheet href=./assets/pygments/default.css><link rel=stylesheet href=./assets/jquery/jquery-ui.min.css><script src=./assets/jquery/jquery-3.0.0.min.js></script><script src=./assets/jquery/jquery-ui.min.js></script><script src=nedoc.js></script></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-1-4"><div class=header><h1 class=brand-title>Django</h1> 1.0 </div><div id=sbox><input id=search style="color: black;" placeholder="search ..."></div><div class=tree><ul><li><a href=django.html>&#9662; django</a> </li><li><ul><li><a href=django.__main__.html>&#9656; __main__</a> </li><li><a href=django.apps.html>&#9656; apps</a> </li><li><a href=django.bin.html>&#9656; bin</a> </li><li><a href=django.conf.html>&#9656; conf</a> </li><li><a href=django.contrib.html>&#9656; contrib</a> </li><li><a href=django.core.html>&#9656; core</a> </li><li><a href=django.db.html>&#9662; db</a> </li><li><ul><li><a href=django.db.backends.html>&#9656; backends</a> </li><li><a href=django.db.migrations.html>&#9662; migrations</a> </li><li><ul><li><a href=django.db.migrations.autodetector.html>&#9656; autodetector</a> </li><li><a href=django.db.migrations.exceptions.html>&#9656; exceptions</a> </li><li><a href=django.db.migrations.executor.html>&#9656; executor</a> </li><li><a href=django.db.migrations.graph.html>&#9656; graph</a> </li><li><div class=select><a href=django.db.migrations.loader.html>&#9662; loader</a> </div></li><li><ul><li><a href=django.db.migrations.loader.MigrationLoader.html> <i>class</i> MigrationLoader</a> </li></ul></li><li><a href=django.db.migrations.migration.html>&#9656; migration</a> </li><li><a href=django.db.migrations.operations.html>&#9656; operations</a> </li><li><a href=django.db.migrations.optimizer.html>&#9656; optimizer</a> </li><li><a href=django.db.migrations.questioner.html>&#9656; questioner</a> </li><li><a href=django.db.migrations.recorder.html>&#9656; recorder</a> </li><li><a href=django.db.migrations.serializer.html>&#9656; serializer</a> </li><li><a href=django.db.migrations.state.html>&#9656; state</a> </li><li><a href=django.db.migrations.utils.html>&#9656; utils</a> </li><li><a href=django.db.migrations.writer.html>&#9656; writer</a> </li></ul></li><li><a href=django.db.models.html>&#9656; models</a> </li><li><a href=django.db.transaction.html>&#9656; transaction</a> </li><li><a href=django.db.utils.html>&#9656; utils</a> </li><li><a href=django.db.DefaultConnectionProxy.html> <i>class</i> DefaultConnectionProxy</a> </li></ul></li><li><a href=django.dispatch.html>&#9656; dispatch</a> </li><li><a href=django.forms.html>&#9656; forms</a> </li><li><a href=django.http.html>&#9656; http</a> </li><li><a href=django.middleware.html>&#9656; middleware</a> </li><li><a href=django.shortcuts.html>&#9656; shortcuts</a> </li><li><a href=django.template.html>&#9656; template</a> </li><li><a href=django.templatetags.html>&#9656; templatetags</a> </li><li><a href=django.test.html>&#9656; test</a> </li><li><a href=django.urls.html>&#9656; urls</a> </li><li><a href=django.utils.html>&#9656; utils</a> </li><li><a href=django.views.html>&#9656; views</a> </li></ul></ul></div></div><div class="content pure-u-1 pure-u-md-3-4"><h1>Source code django/db/migrations/loader.py</h1><div id=path><a class=symbol href=django.html>django</a>.<a class=symbol href=django.db.html>db</a>.<a class=symbol href=django.db.migrations.html>migrations</a>.<a class=symbol href=django.db.migrations.loader.html>loader</a></div><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349</pre></div></td><td class=code><div class=highlight><pre><span></span><a name=line-1></a><span class=kn>import</span> <span class=nn>pkgutil</span>
<a name=line-2></a><span class=kn>import</span> <span class=nn>sys</span>
<a name=line-3></a><span class=kn>from</span> <span class=nn>importlib</span> <span class=kn>import</span> <span class=n>import_module</span><span class=p>,</span> <span class=n>reload</span>
<a name=line-4></a>
<a name=line-5></a><span class=kn>from</span> <span class=nn>django.apps</span> <span class=kn>import</span> <span class=n>apps</span>
<a name=line-6></a><span class=kn>from</span> <span class=nn>django.conf</span> <span class=kn>import</span> <span class=n>settings</span>
<a name=line-7></a><span class=kn>from</span> <span class=nn>django.db.migrations.graph</span> <span class=kn>import</span> <span class=n>MigrationGraph</span>
<a name=line-8></a><span class=kn>from</span> <span class=nn>django.db.migrations.recorder</span> <span class=kn>import</span> <span class=n>MigrationRecorder</span>
<a name=line-9></a>
<a name=line-10></a><span class=kn>from</span> <span class=nn>.exceptions</span> <span class=kn>import</span> <span class=p>(</span>
<a name=line-11></a>    <span class=n>AmbiguityError</span><span class=p>,</span> <span class=n>BadMigrationError</span><span class=p>,</span> <span class=n>InconsistentMigrationHistory</span><span class=p>,</span>
<a name=line-12></a>    <span class=n>NodeNotFoundError</span><span class=p>,</span>
<a name=line-13></a><span class=p>)</span>
<a name=line-14></a>
<a name=line-15></a><span class=n>MIGRATIONS_MODULE_NAME</span> <span class=o>=</span> <span class=s1>&#39;migrations&#39;</span>
<a name=line-16></a>
<a name=line-17></a>
<a name=line-18></a><span class=k>class</span> <span class=nc>MigrationLoader</span><span class=p>:</span>
<a name=line-19></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-20></a><span class=sd>    Load migration files from disk and their status from the database.</span>
<a name=line-21></a>
<a name=line-22></a><span class=sd>    Migration files are expected to live in the &quot;migrations&quot; directory of</span>
<a name=line-23></a><span class=sd>    an app. Their names are entirely unimportant from a code perspective,</span>
<a name=line-24></a><span class=sd>    but will probably follow the 1234_name.py convention.</span>
<a name=line-25></a>
<a name=line-26></a><span class=sd>    On initialization, this class will scan those directories, and open and</span>
<a name=line-27></a><span class=sd>    read the Python files, looking for a class called Migration, which should</span>
<a name=line-28></a><span class=sd>    inherit from django.db.migrations.Migration. See</span>
<a name=line-29></a><span class=sd>    django.db.migrations.migration for what that looks like.</span>
<a name=line-30></a>
<a name=line-31></a><span class=sd>    Some migrations will be marked as &quot;replacing&quot; another set of migrations.</span>
<a name=line-32></a><span class=sd>    These are loaded into a separate set of migrations away from the main ones.</span>
<a name=line-33></a><span class=sd>    If all the migrations they replace are either unapplied or missing from</span>
<a name=line-34></a><span class=sd>    disk, then they are injected into the main set, replacing the named migrations.</span>
<a name=line-35></a><span class=sd>    Any dependency pointers to the replaced migrations are re-pointed to the</span>
<a name=line-36></a><span class=sd>    new migration.</span>
<a name=line-37></a>
<a name=line-38></a><span class=sd>    This does mean that this class MUST also talk to the database as well as</span>
<a name=line-39></a><span class=sd>    to disk, but this is probably fine. We&#39;re already not just operating</span>
<a name=line-40></a><span class=sd>    in memory.</span>
<a name=line-41></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-42></a>
<a name=line-43></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
<a name=line-44></a>        <span class=bp>self</span><span class=p>,</span> <span class=n>connection</span><span class=p>,</span> <span class=n>load</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ignore_no_migrations</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
<a name=line-45></a>        <span class=n>replace_migrations</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a name=line-46></a>    <span class=p>):</span>
<a name=line-47></a>        <span class=bp>self</span><span class=o>.</span><span class=n>connection</span> <span class=o>=</span> <span class=n>connection</span>
<a name=line-48></a>        <span class=bp>self</span><span class=o>.</span><span class=n>disk_migrations</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-49></a>        <span class=bp>self</span><span class=o>.</span><span class=n>applied_migrations</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-50></a>        <span class=bp>self</span><span class=o>.</span><span class=n>ignore_no_migrations</span> <span class=o>=</span> <span class=n>ignore_no_migrations</span>
<a name=line-51></a>        <span class=bp>self</span><span class=o>.</span><span class=n>replace_migrations</span> <span class=o>=</span> <span class=n>replace_migrations</span>
<a name=line-52></a>        <span class=k>if</span> <span class=n>load</span><span class=p>:</span>
<a name=line-53></a>            <span class=bp>self</span><span class=o>.</span><span class=n>build_graph</span><span class=p>()</span>
<a name=line-54></a>
<a name=line-55></a>    <span class=nd>@classmethod</span>
<a name=line-56></a>    <span class=k>def</span> <span class=nf>migrations_module</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>app_label</span><span class=p>):</span>
<a name=line-57></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-58></a><span class=sd>        Return the path to the migrations module for the specified app_label</span>
<a name=line-59></a><span class=sd>        and a boolean indicating if the module is specified in</span>
<a name=line-60></a><span class=sd>        settings.MIGRATION_MODULE.</span>
<a name=line-61></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-62></a>        <span class=k>if</span> <span class=n>app_label</span> <span class=ow>in</span> <span class=n>settings</span><span class=o>.</span><span class=n>MIGRATION_MODULES</span><span class=p>:</span>
<a name=line-63></a>            <span class=k>return</span> <span class=n>settings</span><span class=o>.</span><span class=n>MIGRATION_MODULES</span><span class=p>[</span><span class=n>app_label</span><span class=p>],</span> <span class=kc>True</span>
<a name=line-64></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-65></a>            <span class=n>app_package_name</span> <span class=o>=</span> <span class=n>apps</span><span class=o>.</span><span class=n>get_app_config</span><span class=p>(</span><span class=n>app_label</span><span class=p>)</span><span class=o>.</span><span class=n>name</span>
<a name=line-66></a>            <span class=k>return</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1>.</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>app_package_name</span><span class=p>,</span> <span class=n>MIGRATIONS_MODULE_NAME</span><span class=p>),</span> <span class=kc>False</span>
<a name=line-67></a>
<a name=line-68></a>    <span class=k>def</span> <span class=nf>load_disk</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-69></a>        <span class=sd>&quot;&quot;&quot;Load the migrations from all INSTALLED_APPS from disk.&quot;&quot;&quot;</span>
<a name=line-70></a>        <span class=bp>self</span><span class=o>.</span><span class=n>disk_migrations</span> <span class=o>=</span> <span class=p>{}</span>
<a name=line-71></a>        <span class=bp>self</span><span class=o>.</span><span class=n>unmigrated_apps</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<a name=line-72></a>        <span class=bp>self</span><span class=o>.</span><span class=n>migrated_apps</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<a name=line-73></a>        <span class=k>for</span> <span class=n>app_config</span> <span class=ow>in</span> <span class=n>apps</span><span class=o>.</span><span class=n>get_app_configs</span><span class=p>():</span>
<a name=line-74></a>            <span class=c1># Get the migrations module directory</span>
<a name=line-75></a>            <span class=n>module_name</span><span class=p>,</span> <span class=n>explicit</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>migrations_module</span><span class=p>(</span><span class=n>app_config</span><span class=o>.</span><span class=n>label</span><span class=p>)</span>
<a name=line-76></a>            <span class=k>if</span> <span class=n>module_name</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-77></a>                <span class=bp>self</span><span class=o>.</span><span class=n>unmigrated_apps</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>app_config</span><span class=o>.</span><span class=n>label</span><span class=p>)</span>
<a name=line-78></a>                <span class=k>continue</span>
<a name=line-79></a>            <span class=n>was_loaded</span> <span class=o>=</span> <span class=n>module_name</span> <span class=ow>in</span> <span class=n>sys</span><span class=o>.</span><span class=n>modules</span>
<a name=line-80></a>            <span class=k>try</span><span class=p>:</span>
<a name=line-81></a>                <span class=n>module</span> <span class=o>=</span> <span class=n>import_module</span><span class=p>(</span><span class=n>module_name</span><span class=p>)</span>
<a name=line-82></a>            <span class=k>except</span> <span class=ne>ModuleNotFoundError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a name=line-83></a>                <span class=k>if</span> <span class=p>(</span>
<a name=line-84></a>                    <span class=p>(</span><span class=n>explicit</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>ignore_no_migrations</span><span class=p>)</span> <span class=ow>or</span>
<a name=line-85></a>                    <span class=p>(</span><span class=ow>not</span> <span class=n>explicit</span> <span class=ow>and</span> <span class=n>MIGRATIONS_MODULE_NAME</span> <span class=ow>in</span> <span class=n>e</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>))</span>
<a name=line-86></a>                <span class=p>):</span>
<a name=line-87></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>unmigrated_apps</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>app_config</span><span class=o>.</span><span class=n>label</span><span class=p>)</span>
<a name=line-88></a>                    <span class=k>continue</span>
<a name=line-89></a>                <span class=k>raise</span>
<a name=line-90></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-91></a>                <span class=c1># Empty directories are namespaces.</span>
<a name=line-92></a>                <span class=c1># getattr() needed on PY36 and older (replace w/attribute access).</span>
<a name=line-93></a>                <span class=k>if</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>module</span><span class=p>,</span> <span class=s1>&#39;__file__&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-94></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>unmigrated_apps</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>app_config</span><span class=o>.</span><span class=n>label</span><span class=p>)</span>
<a name=line-95></a>                    <span class=k>continue</span>
<a name=line-96></a>                <span class=c1># Module is not a package (e.g. migrations.py).</span>
<a name=line-97></a>                <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>module</span><span class=p>,</span> <span class=s1>&#39;__path__&#39;</span><span class=p>):</span>
<a name=line-98></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>unmigrated_apps</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>app_config</span><span class=o>.</span><span class=n>label</span><span class=p>)</span>
<a name=line-99></a>                    <span class=k>continue</span>
<a name=line-100></a>                <span class=c1># Force a reload if it&#39;s already loaded (tests need this)</span>
<a name=line-101></a>                <span class=k>if</span> <span class=n>was_loaded</span><span class=p>:</span>
<a name=line-102></a>                    <span class=n>reload</span><span class=p>(</span><span class=n>module</span><span class=p>)</span>
<a name=line-103></a>            <span class=bp>self</span><span class=o>.</span><span class=n>migrated_apps</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>app_config</span><span class=o>.</span><span class=n>label</span><span class=p>)</span>
<a name=line-104></a>            <span class=n>migration_names</span> <span class=o>=</span> <span class=p>{</span>
<a name=line-105></a>                <span class=n>name</span> <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>is_pkg</span> <span class=ow>in</span> <span class=n>pkgutil</span><span class=o>.</span><span class=n>iter_modules</span><span class=p>(</span><span class=n>module</span><span class=o>.</span><span class=n>__path__</span><span class=p>)</span>
<a name=line-106></a>                <span class=k>if</span> <span class=ow>not</span> <span class=n>is_pkg</span> <span class=ow>and</span> <span class=n>name</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=ow>not</span> <span class=ow>in</span> <span class=s1>&#39;_~&#39;</span>
<a name=line-107></a>            <span class=p>}</span>
<a name=line-108></a>            <span class=c1># Load migrations</span>
<a name=line-109></a>            <span class=k>for</span> <span class=n>migration_name</span> <span class=ow>in</span> <span class=n>migration_names</span><span class=p>:</span>
<a name=line-110></a>                <span class=n>migration_path</span> <span class=o>=</span> <span class=s1>&#39;</span><span class=si>%s</span><span class=s1>.</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=n>module_name</span><span class=p>,</span> <span class=n>migration_name</span><span class=p>)</span>
<a name=line-111></a>                <span class=k>try</span><span class=p>:</span>
<a name=line-112></a>                    <span class=n>migration_module</span> <span class=o>=</span> <span class=n>import_module</span><span class=p>(</span><span class=n>migration_path</span><span class=p>)</span>
<a name=line-113></a>                <span class=k>except</span> <span class=ne>ImportError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a name=line-114></a>                    <span class=k>if</span> <span class=s1>&#39;bad magic number&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>):</span>
<a name=line-115></a>                        <span class=k>raise</span> <span class=ne>ImportError</span><span class=p>(</span>
<a name=line-116></a>                            <span class=s2>&quot;Couldn&#39;t import </span><span class=si>%r</span><span class=s2> as it appears to be a stale &quot;</span>
<a name=line-117></a>                            <span class=s2>&quot;.pyc file.&quot;</span> <span class=o>%</span> <span class=n>migration_path</span>
<a name=line-118></a>                        <span class=p>)</span> <span class=kn>from</span> <span class=nn>e</span>
<a name=line-119></a>                    <span class=k>else</span><span class=p>:</span>
<a name=line-120></a>                        <span class=k>raise</span>
<a name=line-121></a>                <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>migration_module</span><span class=p>,</span> <span class=s2>&quot;Migration&quot;</span><span class=p>):</span>
<a name=line-122></a>                    <span class=k>raise</span> <span class=n>BadMigrationError</span><span class=p>(</span>
<a name=line-123></a>                        <span class=s2>&quot;Migration </span><span class=si>%s</span><span class=s2> in app </span><span class=si>%s</span><span class=s2> has no Migration class&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>migration_name</span><span class=p>,</span> <span class=n>app_config</span><span class=o>.</span><span class=n>label</span><span class=p>)</span>
<a name=line-124></a>                    <span class=p>)</span>
<a name=line-125></a>                <span class=bp>self</span><span class=o>.</span><span class=n>disk_migrations</span><span class=p>[</span><span class=n>app_config</span><span class=o>.</span><span class=n>label</span><span class=p>,</span> <span class=n>migration_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>migration_module</span><span class=o>.</span><span class=n>Migration</span><span class=p>(</span>
<a name=line-126></a>                    <span class=n>migration_name</span><span class=p>,</span>
<a name=line-127></a>                    <span class=n>app_config</span><span class=o>.</span><span class=n>label</span><span class=p>,</span>
<a name=line-128></a>                <span class=p>)</span>
<a name=line-129></a>
<a name=line-130></a>    <span class=k>def</span> <span class=nf>get_migration</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>app_label</span><span class=p>,</span> <span class=n>name_prefix</span><span class=p>):</span>
<a name=line-131></a>        <span class=sd>&quot;&quot;&quot;Return the named migration or raise NodeNotFoundError.&quot;&quot;&quot;</span>
<a name=line-132></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>nodes</span><span class=p>[</span><span class=n>app_label</span><span class=p>,</span> <span class=n>name_prefix</span><span class=p>]</span>
<a name=line-133></a>
<a name=line-134></a>    <span class=k>def</span> <span class=nf>get_migration_by_prefix</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>app_label</span><span class=p>,</span> <span class=n>name_prefix</span><span class=p>):</span>
<a name=line-135></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-136></a><span class=sd>        Return the migration(s) which match the given app label and name_prefix.</span>
<a name=line-137></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-138></a>        <span class=c1># Do the search</span>
<a name=line-139></a>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-140></a>        <span class=k>for</span> <span class=n>migration_app_label</span><span class=p>,</span> <span class=n>migration_name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>disk_migrations</span><span class=p>:</span>
<a name=line-141></a>            <span class=k>if</span> <span class=n>migration_app_label</span> <span class=o>==</span> <span class=n>app_label</span> <span class=ow>and</span> <span class=n>migration_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>name_prefix</span><span class=p>):</span>
<a name=line-142></a>                <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>migration_app_label</span><span class=p>,</span> <span class=n>migration_name</span><span class=p>))</span>
<a name=line-143></a>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
<a name=line-144></a>            <span class=k>raise</span> <span class=n>AmbiguityError</span><span class=p>(</span>
<a name=line-145></a>                <span class=s2>&quot;There is more than one migration for &#39;</span><span class=si>%s</span><span class=s2>&#39; with the prefix &#39;</span><span class=si>%s</span><span class=s2>&#39;&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>app_label</span><span class=p>,</span> <span class=n>name_prefix</span><span class=p>)</span>
<a name=line-146></a>            <span class=p>)</span>
<a name=line-147></a>        <span class=k>elif</span> <span class=ow>not</span> <span class=n>results</span><span class=p>:</span>
<a name=line-148></a>            <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;There no migrations for &#39;</span><span class=si>%s</span><span class=s2>&#39; with the prefix &#39;</span><span class=si>%s</span><span class=s2>&#39;&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>app_label</span><span class=p>,</span> <span class=n>name_prefix</span><span class=p>))</span>
<a name=line-149></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-150></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>disk_migrations</span><span class=p>[</span><span class=n>results</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span>
<a name=line-151></a>
<a name=line-152></a>    <span class=k>def</span> <span class=nf>check_key</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>current_app</span><span class=p>):</span>
<a name=line-153></a>        <span class=k>if</span> <span class=p>(</span><span class=n>key</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=s2>&quot;__first__&quot;</span> <span class=ow>and</span> <span class=n>key</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=s2>&quot;__latest__&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=n>key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=p>:</span>
<a name=line-154></a>            <span class=k>return</span> <span class=n>key</span>
<a name=line-155></a>        <span class=c1># Special-case __first__, which means &quot;the first migration&quot; for</span>
<a name=line-156></a>        <span class=c1># migrated apps, and is ignored for unmigrated apps. It allows</span>
<a name=line-157></a>        <span class=c1># makemigrations to declare dependencies on apps before they even have</span>
<a name=line-158></a>        <span class=c1># migrations.</span>
<a name=line-159></a>        <span class=k>if</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=n>current_app</span><span class=p>:</span>
<a name=line-160></a>            <span class=c1># Ignore __first__ references to the same app (#22325)</span>
<a name=line-161></a>            <span class=k>return</span>
<a name=line-162></a>        <span class=k>if</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>unmigrated_apps</span><span class=p>:</span>
<a name=line-163></a>            <span class=c1># This app isn&#39;t migrated, but something depends on it.</span>
<a name=line-164></a>            <span class=c1># The models will get auto-added into the state, though</span>
<a name=line-165></a>            <span class=c1># so we&#39;re fine.</span>
<a name=line-166></a>            <span class=k>return</span>
<a name=line-167></a>        <span class=k>if</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>migrated_apps</span><span class=p>:</span>
<a name=line-168></a>            <span class=k>try</span><span class=p>:</span>
<a name=line-169></a>                <span class=k>if</span> <span class=n>key</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;__first__&quot;</span><span class=p>:</span>
<a name=line-170></a>                    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>root_nodes</span><span class=p>(</span><span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
<a name=line-171></a>                <span class=k>else</span><span class=p>:</span>  <span class=c1># &quot;__latest__&quot;</span>
<a name=line-172></a>                    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>leaf_nodes</span><span class=p>(</span><span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
<a name=line-173></a>            <span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
<a name=line-174></a>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>ignore_no_migrations</span><span class=p>:</span>
<a name=line-175></a>                    <span class=k>return</span> <span class=kc>None</span>
<a name=line-176></a>                <span class=k>else</span><span class=p>:</span>
<a name=line-177></a>                    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Dependency on app with no migrations: </span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
<a name=line-178></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Dependency on unknown app: </span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
<a name=line-179></a>
<a name=line-180></a>    <span class=k>def</span> <span class=nf>add_internal_dependencies</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>migration</span><span class=p>):</span>
<a name=line-181></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-182></a><span class=sd>        Internal dependencies need to be added first to ensure `__first__`</span>
<a name=line-183></a><span class=sd>        dependencies find the correct root node.</span>
<a name=line-184></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-185></a>        <span class=k>for</span> <span class=n>parent</span> <span class=ow>in</span> <span class=n>migration</span><span class=o>.</span><span class=n>dependencies</span><span class=p>:</span>
<a name=line-186></a>            <span class=c1># Ignore __first__ references to the same app.</span>
<a name=line-187></a>            <span class=k>if</span> <span class=n>parent</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=ow>and</span> <span class=n>parent</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;__first__&#39;</span><span class=p>:</span>
<a name=line-188></a>                <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>add_dependency</span><span class=p>(</span><span class=n>migration</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>parent</span><span class=p>,</span> <span class=n>skip_validation</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a name=line-189></a>
<a name=line-190></a>    <span class=k>def</span> <span class=nf>add_external_dependencies</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>migration</span><span class=p>):</span>
<a name=line-191></a>        <span class=k>for</span> <span class=n>parent</span> <span class=ow>in</span> <span class=n>migration</span><span class=o>.</span><span class=n>dependencies</span><span class=p>:</span>
<a name=line-192></a>            <span class=c1># Skip internal dependencies</span>
<a name=line-193></a>            <span class=k>if</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=n>parent</span><span class=p>[</span><span class=mi>0</span><span class=p>]:</span>
<a name=line-194></a>                <span class=k>continue</span>
<a name=line-195></a>            <span class=n>parent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_key</span><span class=p>(</span><span class=n>parent</span><span class=p>,</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
<a name=line-196></a>            <span class=k>if</span> <span class=n>parent</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-197></a>                <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>add_dependency</span><span class=p>(</span><span class=n>migration</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>parent</span><span class=p>,</span> <span class=n>skip_validation</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a name=line-198></a>        <span class=k>for</span> <span class=n>child</span> <span class=ow>in</span> <span class=n>migration</span><span class=o>.</span><span class=n>run_before</span><span class=p>:</span>
<a name=line-199></a>            <span class=n>child</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_key</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=n>key</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
<a name=line-200></a>            <span class=k>if</span> <span class=n>child</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-201></a>                <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>add_dependency</span><span class=p>(</span><span class=n>migration</span><span class=p>,</span> <span class=n>child</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>skip_validation</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a name=line-202></a>
<a name=line-203></a>    <span class=k>def</span> <span class=nf>build_graph</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-204></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-205></a><span class=sd>        Build a migration dependency graph using both the disk and database.</span>
<a name=line-206></a><span class=sd>        You&#39;ll need to rebuild the graph if you apply migrations. This isn&#39;t</span>
<a name=line-207></a><span class=sd>        usually a problem as generally migration stuff runs in a one-shot process.</span>
<a name=line-208></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-209></a>        <span class=c1># Load disk data</span>
<a name=line-210></a>        <span class=bp>self</span><span class=o>.</span><span class=n>load_disk</span><span class=p>()</span>
<a name=line-211></a>        <span class=c1># Load database data</span>
<a name=line-212></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-213></a>            <span class=bp>self</span><span class=o>.</span><span class=n>applied_migrations</span> <span class=o>=</span> <span class=p>{}</span>
<a name=line-214></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-215></a>            <span class=n>recorder</span> <span class=o>=</span> <span class=n>MigrationRecorder</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=p>)</span>
<a name=line-216></a>            <span class=bp>self</span><span class=o>.</span><span class=n>applied_migrations</span> <span class=o>=</span> <span class=n>recorder</span><span class=o>.</span><span class=n>applied_migrations</span><span class=p>()</span>
<a name=line-217></a>        <span class=c1># To start, populate the migration graph with nodes for ALL migrations</span>
<a name=line-218></a>        <span class=c1># and their dependencies. Also make note of replacing migrations at this step.</span>
<a name=line-219></a>        <span class=bp>self</span><span class=o>.</span><span class=n>graph</span> <span class=o>=</span> <span class=n>MigrationGraph</span><span class=p>()</span>
<a name=line-220></a>        <span class=bp>self</span><span class=o>.</span><span class=n>replacements</span> <span class=o>=</span> <span class=p>{}</span>
<a name=line-221></a>        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>migration</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>disk_migrations</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<a name=line-222></a>            <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>migration</span><span class=p>)</span>
<a name=line-223></a>            <span class=c1># Replacing migrations.</span>
<a name=line-224></a>            <span class=k>if</span> <span class=n>migration</span><span class=o>.</span><span class=n>replaces</span><span class=p>:</span>
<a name=line-225></a>                <span class=bp>self</span><span class=o>.</span><span class=n>replacements</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>migration</span>
<a name=line-226></a>        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>migration</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>disk_migrations</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<a name=line-227></a>            <span class=c1># Internal (same app) dependencies.</span>
<a name=line-228></a>            <span class=bp>self</span><span class=o>.</span><span class=n>add_internal_dependencies</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>migration</span><span class=p>)</span>
<a name=line-229></a>        <span class=c1># Add external dependencies now that the internal ones have been resolved.</span>
<a name=line-230></a>        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>migration</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>disk_migrations</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<a name=line-231></a>            <span class=bp>self</span><span class=o>.</span><span class=n>add_external_dependencies</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>migration</span><span class=p>)</span>
<a name=line-232></a>        <span class=c1># Carry out replacements where possible and if enabled.</span>
<a name=line-233></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>replace_migrations</span><span class=p>:</span>
<a name=line-234></a>            <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>migration</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>replacements</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<a name=line-235></a>                <span class=c1># Get applied status of each of this migration&#39;s replacement</span>
<a name=line-236></a>                <span class=c1># targets.</span>
<a name=line-237></a>                <span class=n>applied_statuses</span> <span class=o>=</span> <span class=p>[(</span><span class=n>target</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>applied_migrations</span><span class=p>)</span> <span class=k>for</span> <span class=n>target</span> <span class=ow>in</span> <span class=n>migration</span><span class=o>.</span><span class=n>replaces</span><span class=p>]</span>
<a name=line-238></a>                <span class=c1># The replacing migration is only marked as applied if all of</span>
<a name=line-239></a>                <span class=c1># its replacement targets are.</span>
<a name=line-240></a>                <span class=k>if</span> <span class=nb>all</span><span class=p>(</span><span class=n>applied_statuses</span><span class=p>):</span>
<a name=line-241></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>applied_migrations</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>migration</span>
<a name=line-242></a>                <span class=k>else</span><span class=p>:</span>
<a name=line-243></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>applied_migrations</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<a name=line-244></a>                <span class=c1># A replacing migration can be used if either all or none of</span>
<a name=line-245></a>                <span class=c1># its replacement targets have been applied.</span>
<a name=line-246></a>                <span class=k>if</span> <span class=nb>all</span><span class=p>(</span><span class=n>applied_statuses</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=ow>not</span> <span class=nb>any</span><span class=p>(</span><span class=n>applied_statuses</span><span class=p>)):</span>
<a name=line-247></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>remove_replaced_nodes</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>migration</span><span class=o>.</span><span class=n>replaces</span><span class=p>)</span>
<a name=line-248></a>                <span class=k>else</span><span class=p>:</span>
<a name=line-249></a>                    <span class=c1># This replacing migration cannot be used because it is</span>
<a name=line-250></a>                    <span class=c1># partially applied. Remove it from the graph and remap</span>
<a name=line-251></a>                    <span class=c1># dependencies to it (#25945).</span>
<a name=line-252></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>remove_replacement_node</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>migration</span><span class=o>.</span><span class=n>replaces</span><span class=p>)</span>
<a name=line-253></a>        <span class=c1># Ensure the graph is consistent.</span>
<a name=line-254></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-255></a>            <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>validate_consistency</span><span class=p>()</span>
<a name=line-256></a>        <span class=k>except</span> <span class=n>NodeNotFoundError</span> <span class=k>as</span> <span class=n>exc</span><span class=p>:</span>
<a name=line-257></a>            <span class=c1># Check if the missing node could have been replaced by any squash</span>
<a name=line-258></a>            <span class=c1># migration but wasn&#39;t because the squash migration was partially</span>
<a name=line-259></a>            <span class=c1># applied before. In that case raise a more understandable exception</span>
<a name=line-260></a>            <span class=c1># (#23556).</span>
<a name=line-261></a>            <span class=c1># Get reverse replacements.</span>
<a name=line-262></a>            <span class=n>reverse_replacements</span> <span class=o>=</span> <span class=p>{}</span>
<a name=line-263></a>            <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>migration</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>replacements</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<a name=line-264></a>                <span class=k>for</span> <span class=n>replaced</span> <span class=ow>in</span> <span class=n>migration</span><span class=o>.</span><span class=n>replaces</span><span class=p>:</span>
<a name=line-265></a>                    <span class=n>reverse_replacements</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=n>replaced</span><span class=p>,</span> <span class=nb>set</span><span class=p>())</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
<a name=line-266></a>            <span class=c1># Try to reraise exception with more detail.</span>
<a name=line-267></a>            <span class=k>if</span> <span class=n>exc</span><span class=o>.</span><span class=n>node</span> <span class=ow>in</span> <span class=n>reverse_replacements</span><span class=p>:</span>
<a name=line-268></a>                <span class=n>candidates</span> <span class=o>=</span> <span class=n>reverse_replacements</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>exc</span><span class=o>.</span><span class=n>node</span><span class=p>,</span> <span class=nb>set</span><span class=p>())</span>
<a name=line-269></a>                <span class=n>is_replaced</span> <span class=o>=</span> <span class=nb>any</span><span class=p>(</span><span class=n>candidate</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>nodes</span> <span class=k>for</span> <span class=n>candidate</span> <span class=ow>in</span> <span class=n>candidates</span><span class=p>)</span>
<a name=line-270></a>                <span class=k>if</span> <span class=ow>not</span> <span class=n>is_replaced</span><span class=p>:</span>
<a name=line-271></a>                    <span class=n>tries</span> <span class=o>=</span> <span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%s</span><span class=s1>.</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>c</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>candidates</span><span class=p>)</span>
<a name=line-272></a>                    <span class=k>raise</span> <span class=n>NodeNotFoundError</span><span class=p>(</span>
<a name=line-273></a>                        <span class=s2>&quot;Migration </span><span class=si>{0}</span><span class=s2> depends on nonexistent node (&#39;</span><span class=si>{1}</span><span class=s2>&#39;, &#39;</span><span class=si>{2}</span><span class=s2>&#39;). &quot;</span>
<a name=line-274></a>                        <span class=s2>&quot;Django tried to replace migration </span><span class=si>{1}</span><span class=s2>.</span><span class=si>{2}</span><span class=s2> with any of [</span><span class=si>{3}</span><span class=s2>] &quot;</span>
<a name=line-275></a>                        <span class=s2>&quot;but wasn&#39;t able to because some of the replaced migrations &quot;</span>
<a name=line-276></a>                        <span class=s2>&quot;are already applied.&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
<a name=line-277></a>                            <span class=n>exc</span><span class=o>.</span><span class=n>origin</span><span class=p>,</span> <span class=n>exc</span><span class=o>.</span><span class=n>node</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>exc</span><span class=o>.</span><span class=n>node</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>tries</span>
<a name=line-278></a>                        <span class=p>),</span>
<a name=line-279></a>                        <span class=n>exc</span><span class=o>.</span><span class=n>node</span>
<a name=line-280></a>                    <span class=p>)</span> <span class=kn>from</span> <span class=nn>exc</span>
<a name=line-281></a>            <span class=k>raise</span>
<a name=line-282></a>        <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>ensure_not_cyclic</span><span class=p>()</span>
<a name=line-283></a>
<a name=line-284></a>    <span class=k>def</span> <span class=nf>check_consistent_history</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>connection</span><span class=p>):</span>
<a name=line-285></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-286></a><span class=sd>        Raise InconsistentMigrationHistory if any applied migrations have</span>
<a name=line-287></a><span class=sd>        unapplied dependencies.</span>
<a name=line-288></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-289></a>        <span class=n>recorder</span> <span class=o>=</span> <span class=n>MigrationRecorder</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span>
<a name=line-290></a>        <span class=n>applied</span> <span class=o>=</span> <span class=n>recorder</span><span class=o>.</span><span class=n>applied_migrations</span><span class=p>()</span>
<a name=line-291></a>        <span class=k>for</span> <span class=n>migration</span> <span class=ow>in</span> <span class=n>applied</span><span class=p>:</span>
<a name=line-292></a>            <span class=c1># If the migration is unknown, skip it.</span>
<a name=line-293></a>            <span class=k>if</span> <span class=n>migration</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>nodes</span><span class=p>:</span>
<a name=line-294></a>                <span class=k>continue</span>
<a name=line-295></a>            <span class=k>for</span> <span class=n>parent</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>node_map</span><span class=p>[</span><span class=n>migration</span><span class=p>]</span><span class=o>.</span><span class=n>parents</span><span class=p>:</span>
<a name=line-296></a>                <span class=k>if</span> <span class=n>parent</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>applied</span><span class=p>:</span>
<a name=line-297></a>                    <span class=c1># Skip unapplied squashed migrations that have all of their</span>
<a name=line-298></a>                    <span class=c1># `replaces` applied.</span>
<a name=line-299></a>                    <span class=k>if</span> <span class=n>parent</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>replacements</span><span class=p>:</span>
<a name=line-300></a>                        <span class=k>if</span> <span class=nb>all</span><span class=p>(</span><span class=n>m</span> <span class=ow>in</span> <span class=n>applied</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>replacements</span><span class=p>[</span><span class=n>parent</span><span class=p>]</span><span class=o>.</span><span class=n>replaces</span><span class=p>):</span>
<a name=line-301></a>                            <span class=k>continue</span>
<a name=line-302></a>                    <span class=k>raise</span> <span class=n>InconsistentMigrationHistory</span><span class=p>(</span>
<a name=line-303></a>                        <span class=s2>&quot;Migration </span><span class=si>{}</span><span class=s2>.</span><span class=si>{}</span><span class=s2> is applied before its dependency &quot;</span>
<a name=line-304></a>                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>.</span><span class=si>{}</span><span class=s2> on database &#39;</span><span class=si>{}</span><span class=s2>&#39;.&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
<a name=line-305></a>                            <span class=n>migration</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>migration</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>parent</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>parent</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
<a name=line-306></a>                            <span class=n>connection</span><span class=o>.</span><span class=n>alias</span><span class=p>,</span>
<a name=line-307></a>                        <span class=p>)</span>
<a name=line-308></a>                    <span class=p>)</span>
<a name=line-309></a>
<a name=line-310></a>    <span class=k>def</span> <span class=nf>detect_conflicts</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-311></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-312></a><span class=sd>        Look through the loaded graph and detect any conflicts - apps</span>
<a name=line-313></a><span class=sd>        with more than one leaf migration. Return a dict of the app labels</span>
<a name=line-314></a><span class=sd>        that conflict with the migration names that conflict.</span>
<a name=line-315></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-316></a>        <span class=n>seen_apps</span> <span class=o>=</span> <span class=p>{}</span>
<a name=line-317></a>        <span class=n>conflicting_apps</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<a name=line-318></a>        <span class=k>for</span> <span class=n>app_label</span><span class=p>,</span> <span class=n>migration_name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>leaf_nodes</span><span class=p>():</span>
<a name=line-319></a>            <span class=k>if</span> <span class=n>app_label</span> <span class=ow>in</span> <span class=n>seen_apps</span><span class=p>:</span>
<a name=line-320></a>                <span class=n>conflicting_apps</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>app_label</span><span class=p>)</span>
<a name=line-321></a>            <span class=n>seen_apps</span><span class=o>.</span><span class=n>setdefault</span><span class=p>(</span><span class=n>app_label</span><span class=p>,</span> <span class=nb>set</span><span class=p>())</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>migration_name</span><span class=p>)</span>
<a name=line-322></a>        <span class=k>return</span> <span class=p>{</span><span class=n>app_label</span><span class=p>:</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>seen_apps</span><span class=p>[</span><span class=n>app_label</span><span class=p>])</span> <span class=k>for</span> <span class=n>app_label</span> <span class=ow>in</span> <span class=n>conflicting_apps</span><span class=p>}</span>
<a name=line-323></a>
<a name=line-324></a>    <span class=k>def</span> <span class=nf>project_state</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>nodes</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>at_end</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
<a name=line-325></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-326></a><span class=sd>        Return a ProjectState object representing the most recent state</span>
<a name=line-327></a><span class=sd>        that the loaded migrations represent.</span>
<a name=line-328></a>
<a name=line-329></a><span class=sd>        See graph.make_state() for the meaning of &quot;nodes&quot; and &quot;at_end&quot;.</span>
<a name=line-330></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-331></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>graph</span><span class=o>.</span><span class=n>make_state</span><span class=p>(</span><span class=n>nodes</span><span class=o>=</span><span class=n>nodes</span><span class=p>,</span> <span class=n>at_end</span><span class=o>=</span><span class=n>at_end</span><span class=p>,</span> <span class=n>real_apps</span><span class=o>=</span><span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>unmigrated_apps</span><span class=p>))</span>
<a name=line-332></a>
<a name=line-333></a>    <span class=k>def</span> <span class=nf>collect_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>plan</span><span class=p>):</span>
<a name=line-334></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-335></a><span class=sd>        Take a migration plan and return a list of collected SQL statements</span>
<a name=line-336></a><span class=sd>        that represent the best-efforts version of that plan.</span>
<a name=line-337></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-338></a>        <span class=n>statements</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-339></a>        <span class=n>state</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-340></a>        <span class=k>for</span> <span class=n>migration</span><span class=p>,</span> <span class=n>backwards</span> <span class=ow>in</span> <span class=n>plan</span><span class=p>:</span>
<a name=line-341></a>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>schema_editor</span><span class=p>(</span><span class=n>collect_sql</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>atomic</span><span class=o>=</span><span class=n>migration</span><span class=o>.</span><span class=n>atomic</span><span class=p>)</span> <span class=k>as</span> <span class=n>schema_editor</span><span class=p>:</span>
<a name=line-342></a>                <span class=k>if</span> <span class=n>state</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-343></a>                    <span class=n>state</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>project_state</span><span class=p>((</span><span class=n>migration</span><span class=o>.</span><span class=n>app_label</span><span class=p>,</span> <span class=n>migration</span><span class=o>.</span><span class=n>name</span><span class=p>),</span> <span class=n>at_end</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<a name=line-344></a>                <span class=k>if</span> <span class=ow>not</span> <span class=n>backwards</span><span class=p>:</span>
<a name=line-345></a>                    <span class=n>state</span> <span class=o>=</span> <span class=n>migration</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>schema_editor</span><span class=p>,</span> <span class=n>collect_sql</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a name=line-346></a>                <span class=k>else</span><span class=p>:</span>
<a name=line-347></a>                    <span class=n>state</span> <span class=o>=</span> <span class=n>migration</span><span class=o>.</span><span class=n>unapply</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>schema_editor</span><span class=p>,</span> <span class=n>collect_sql</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a name=line-348></a>            <span class=n>statements</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>schema_editor</span><span class=o>.</span><span class=n>collected_sql</span><span class=p>)</span>
<a name=line-349></a>        <span class=k>return</span> <span class=n>statements</span>
</pre></div></td></tr></table><p class=footer> Generated by <a href=https://github.com/spirali/nedoc>nedoc</a> v0.9 at 2020-12-29 14:04 </p></div></div></body></html>
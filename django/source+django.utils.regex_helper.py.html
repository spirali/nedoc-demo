<!DOCTYPE html><html><head><meta charset=utf-8><title>django.utils.regex_helper</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./assets/purecss/pure-min.css><link rel=stylesheet href=./assets/purecss/grids-responsive-min.css><link rel=stylesheet href=./assets/style.css><link rel=stylesheet href=./assets/pygments/default.css><link rel=stylesheet href=./assets/jquery/jquery-ui.min.css><script src=./assets/jquery/jquery-3.0.0.min.js></script><script src=./assets/jquery/jquery-ui.min.js></script><script src=nedoc.js></script></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-1-4"><div class=header><h1 class=brand-title>Django</h1> 1.0 </div><div id=sbox><input id=search style="color: black;" placeholder="search ..."></div><div class=tree><ul><li><a href=django.html>&#9662; django</a> </li><li><ul><li><a href=django.__main__.html>&#9656; __main__</a> </li><li><a href=django.apps.html>&#9656; apps</a> </li><li><a href=django.bin.html>&#9656; bin</a> </li><li><a href=django.conf.html>&#9656; conf</a> </li><li><a href=django.contrib.html>&#9656; contrib</a> </li><li><a href=django.core.html>&#9656; core</a> </li><li><a href=django.db.html>&#9656; db</a> </li><li><a href=django.dispatch.html>&#9656; dispatch</a> </li><li><a href=django.forms.html>&#9656; forms</a> </li><li><a href=django.http.html>&#9656; http</a> </li><li><a href=django.middleware.html>&#9656; middleware</a> </li><li><a href=django.shortcuts.html>&#9656; shortcuts</a> </li><li><a href=django.template.html>&#9656; template</a> </li><li><a href=django.templatetags.html>&#9656; templatetags</a> </li><li><a href=django.test.html>&#9656; test</a> </li><li><a href=django.urls.html>&#9656; urls</a> </li><li><a href=django.utils.html>&#9662; utils</a> </li><li><ul><li><a href=django.utils.archive.html>&#9656; archive</a> </li><li><a href=django.utils.asyncio.html>&#9656; asyncio</a> </li><li><a href=django.utils.autoreload.html>&#9656; autoreload</a> </li><li><a href=django.utils.baseconv.html>&#9656; baseconv</a> </li><li><a href=django.utils.cache.html>&#9656; cache</a> </li><li><a href=django.utils.crypto.html>&#9656; crypto</a> </li><li><a href=django.utils.datastructures.html>&#9656; datastructures</a> </li><li><a href=django.utils.dateformat.html>&#9656; dateformat</a> </li><li><a href=django.utils.dateparse.html>&#9656; dateparse</a> </li><li><a href=django.utils.dates.html>&#9656; dates</a> </li><li><a href=django.utils.datetime_safe.html>&#9656; datetime_safe</a> </li><li><a href=django.utils.deconstruct.html>&#9656; deconstruct</a> </li><li><a href=django.utils.decorators.html>&#9656; decorators</a> </li><li><a href=django.utils.deprecation.html>&#9656; deprecation</a> </li><li><a href=django.utils.duration.html>&#9656; duration</a> </li><li><a href=django.utils.encoding.html>&#9656; encoding</a> </li><li><a href=django.utils.feedgenerator.html>&#9656; feedgenerator</a> </li><li><a href=django.utils.formats.html>&#9656; formats</a> </li><li><a href=django.utils.functional.html>&#9656; functional</a> </li><li><a href=django.utils.hashable.html>&#9656; hashable</a> </li><li><a href=django.utils.html.html>&#9656; html</a> </li><li><a href=django.utils.http.html>&#9656; http</a> </li><li><a href=django.utils.inspect.html>&#9656; inspect</a> </li><li><a href=django.utils.ipv6.html>&#9656; ipv6</a> </li><li><a href=django.utils.itercompat.html>&#9656; itercompat</a> </li><li><a href=django.utils.jslex.html>&#9656; jslex</a> </li><li><a href=django.utils.log.html>&#9656; log</a> </li><li><a href=django.utils.lorem_ipsum.html>&#9656; lorem_ipsum</a> </li><li><a href=django.utils.module_loading.html>&#9656; module_loading</a> </li><li><a href=django.utils.numberformat.html>&#9656; numberformat</a> </li><li><div class=select><a href=django.utils.regex_helper.html>&#9662; regex_helper</a> </div></li><li><ul><li><a href=django.utils.regex_helper.Choice.html> <i>class</i> Choice</a> </li><li><a href=django.utils.regex_helper.Group.html> <i>class</i> Group</a> </li><li><a href=django.utils.regex_helper.NonCapture.html> <i>class</i> NonCapture</a> </li></ul></li><li><a href=django.utils.safestring.html>&#9656; safestring</a> </li><li><a href=django.utils.termcolors.html>&#9656; termcolors</a> </li><li><a href=django.utils.text.html>&#9656; text</a> </li><li><a href=django.utils.timesince.html>&#9656; timesince</a> </li><li><a href=django.utils.timezone.html>&#9656; timezone</a> </li><li><a href=django.utils.topological_sort.html>&#9656; topological_sort</a> </li><li><a href=django.utils.translation.html>&#9656; translation</a> </li><li><a href=django.utils.tree.html>&#9656; tree</a> </li><li><a href=django.utils.version.html>&#9656; version</a> </li><li><a href=django.utils.xmlutils.html>&#9656; xmlutils</a> </li></ul></li><li><a href=django.views.html>&#9656; views</a> </li></ul></ul></div></div><div class="content pure-u-1 pure-u-md-3-4"><h1>Source code django/utils/regex_helper.py</h1><div id=path><a class=symbol href=django.html>django</a>.<a class=symbol href=django.utils.html>utils</a>.<a class=symbol href=django.utils.regex_helper.html>regex_helper</a></div><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351</pre></div></td><td class=code><div class=highlight><pre><span></span><a name=line-1></a><span class=sd>&quot;&quot;&quot;</span>
<a name=line-2></a><span class=sd>Functions for reversing a regular expression (used in reverse URL resolving).</span>
<a name=line-3></a><span class=sd>Used internally by Django and not intended for external use.</span>
<a name=line-4></a>
<a name=line-5></a><span class=sd>This is not, and is not intended to be, a complete reg-exp decompiler. It</span>
<a name=line-6></a><span class=sd>should be good enough for a large class of URLS, however.</span>
<a name=line-7></a><span class=sd>&quot;&quot;&quot;</span>
<a name=line-8></a><span class=kn>import</span> <span class=nn>re</span>
<a name=line-9></a>
<a name=line-10></a><span class=kn>from</span> <span class=nn>django.utils.functional</span> <span class=kn>import</span> <span class=n>SimpleLazyObject</span>
<a name=line-11></a>
<a name=line-12></a><span class=c1># Mapping of an escape character to a representative of that class. So, e.g.,</span>
<a name=line-13></a><span class=c1># &quot;\w&quot; is replaced by &quot;x&quot; in a reverse URL. A value of None means to ignore</span>
<a name=line-14></a><span class=c1># this sequence. Any missing key is mapped to itself.</span>
<a name=line-15></a><span class=n>ESCAPE_MAPPINGS</span> <span class=o>=</span> <span class=p>{</span>
<a name=line-16></a>    <span class=s2>&quot;A&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
<a name=line-17></a>    <span class=s2>&quot;b&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
<a name=line-18></a>    <span class=s2>&quot;B&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
<a name=line-19></a>    <span class=s2>&quot;d&quot;</span><span class=p>:</span> <span class=s2>&quot;0&quot;</span><span class=p>,</span>
<a name=line-20></a>    <span class=s2>&quot;D&quot;</span><span class=p>:</span> <span class=s2>&quot;x&quot;</span><span class=p>,</span>
<a name=line-21></a>    <span class=s2>&quot;s&quot;</span><span class=p>:</span> <span class=s2>&quot; &quot;</span><span class=p>,</span>
<a name=line-22></a>    <span class=s2>&quot;S&quot;</span><span class=p>:</span> <span class=s2>&quot;x&quot;</span><span class=p>,</span>
<a name=line-23></a>    <span class=s2>&quot;w&quot;</span><span class=p>:</span> <span class=s2>&quot;x&quot;</span><span class=p>,</span>
<a name=line-24></a>    <span class=s2>&quot;W&quot;</span><span class=p>:</span> <span class=s2>&quot;!&quot;</span><span class=p>,</span>
<a name=line-25></a>    <span class=s2>&quot;Z&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
<a name=line-26></a><span class=p>}</span>
<a name=line-27></a>
<a name=line-28></a>
<a name=line-29></a><span class=k>class</span> <span class=nc>Choice</span><span class=p>(</span><span class=nb>list</span><span class=p>):</span>
<a name=line-30></a>    <span class=sd>&quot;&quot;&quot;Represent multiple possibilities at this point in a pattern string.&quot;&quot;&quot;</span>
<a name=line-31></a>
<a name=line-32></a>
<a name=line-33></a><span class=k>class</span> <span class=nc>Group</span><span class=p>(</span><span class=nb>list</span><span class=p>):</span>
<a name=line-34></a>    <span class=sd>&quot;&quot;&quot;Represent a capturing group in the pattern string.&quot;&quot;&quot;</span>
<a name=line-35></a>
<a name=line-36></a>
<a name=line-37></a><span class=k>class</span> <span class=nc>NonCapture</span><span class=p>(</span><span class=nb>list</span><span class=p>):</span>
<a name=line-38></a>    <span class=sd>&quot;&quot;&quot;Represent a non-capturing group in the pattern string.&quot;&quot;&quot;</span>
<a name=line-39></a>
<a name=line-40></a>
<a name=line-41></a><span class=k>def</span> <span class=nf>normalize</span><span class=p>(</span><span class=n>pattern</span><span class=p>):</span>
<a name=line-42></a>    <span class=sa>r</span><span class=sd>&quot;&quot;&quot;</span>
<a name=line-43></a><span class=sd>    Given a reg-exp pattern, normalize it to an iterable of forms that</span>
<a name=line-44></a><span class=sd>    suffice for reverse matching. This does the following:</span>
<a name=line-45></a>
<a name=line-46></a><span class=sd>    (1) For any repeating sections, keeps the minimum number of occurrences</span>
<a name=line-47></a><span class=sd>        permitted (this means zero for optional groups).</span>
<a name=line-48></a><span class=sd>    (2) If an optional group includes parameters, include one occurrence of</span>
<a name=line-49></a><span class=sd>        that group (along with the zero occurrence case from step (1)).</span>
<a name=line-50></a><span class=sd>    (3) Select the first (essentially an arbitrary) element from any character</span>
<a name=line-51></a><span class=sd>        class. Select an arbitrary character for any unordered class (e.g. &#39;.&#39;</span>
<a name=line-52></a><span class=sd>        or &#39;\w&#39;) in the pattern.</span>
<a name=line-53></a><span class=sd>    (4) Ignore look-ahead and look-behind assertions.</span>
<a name=line-54></a><span class=sd>    (5) Raise an error on any disjunctive (&#39;|&#39;) constructs.</span>
<a name=line-55></a>
<a name=line-56></a><span class=sd>    Django&#39;s URLs for forward resolving are either all positional arguments or</span>
<a name=line-57></a><span class=sd>    all keyword arguments. That is assumed here, as well. Although reverse</span>
<a name=line-58></a><span class=sd>    resolving can be done using positional args when keyword args are</span>
<a name=line-59></a><span class=sd>    specified, the two cannot be mixed in the same reverse() call.</span>
<a name=line-60></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-61></a>    <span class=c1># Do a linear scan to work out the special features of this pattern. The</span>
<a name=line-62></a>    <span class=c1># idea is that we scan once here and collect all the information we need to</span>
<a name=line-63></a>    <span class=c1># make future decisions.</span>
<a name=line-64></a>    <span class=n>result</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-65></a>    <span class=n>non_capturing_groups</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-66></a>    <span class=n>consume_next</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-67></a>    <span class=n>pattern_iter</span> <span class=o>=</span> <span class=n>next_char</span><span class=p>(</span><span class=nb>iter</span><span class=p>(</span><span class=n>pattern</span><span class=p>))</span>
<a name=line-68></a>    <span class=n>num_args</span> <span class=o>=</span> <span class=mi>0</span>
<a name=line-69></a>
<a name=line-70></a>    <span class=c1># A &quot;while&quot; loop is used here because later on we need to be able to peek</span>
<a name=line-71></a>    <span class=c1># at the next character and possibly go around without consuming another</span>
<a name=line-72></a>    <span class=c1># one at the top of the loop.</span>
<a name=line-73></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-74></a>        <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-75></a>    <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
<a name=line-76></a>        <span class=k>return</span> <span class=p>[(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=p>[])]</span>
<a name=line-77></a>
<a name=line-78></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-79></a>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
<a name=line-80></a>            <span class=k>if</span> <span class=n>escaped</span><span class=p>:</span>
<a name=line-81></a>                <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ch</span><span class=p>)</span>
<a name=line-82></a>            <span class=k>elif</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;.&#39;</span><span class=p>:</span>
<a name=line-83></a>                <span class=c1># Replace &quot;any character&quot; with an arbitrary representative.</span>
<a name=line-84></a>                <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;.&quot;</span><span class=p>)</span>
<a name=line-85></a>            <span class=k>elif</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;|&#39;</span><span class=p>:</span>
<a name=line-86></a>                <span class=c1># FIXME: One day we&#39;ll should do this, but not in 1.0.</span>
<a name=line-87></a>                <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>(</span><span class=s1>&#39;Awaiting Implementation&#39;</span><span class=p>)</span>
<a name=line-88></a>            <span class=k>elif</span> <span class=n>ch</span> <span class=o>==</span> <span class=s2>&quot;^&quot;</span><span class=p>:</span>
<a name=line-89></a>                <span class=k>pass</span>
<a name=line-90></a>            <span class=k>elif</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;$&#39;</span><span class=p>:</span>
<a name=line-91></a>                <span class=k>break</span>
<a name=line-92></a>            <span class=k>elif</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;)&#39;</span><span class=p>:</span>
<a name=line-93></a>                <span class=c1># This can only be the end of a non-capturing group, since all</span>
<a name=line-94></a>                <span class=c1># other unescaped parentheses are handled by the grouping</span>
<a name=line-95></a>                <span class=c1># section later (and the full group is handled there).</span>
<a name=line-96></a>                <span class=c1>#</span>
<a name=line-97></a>                <span class=c1># We regroup everything inside the capturing group so that it</span>
<a name=line-98></a>                <span class=c1># can be quantified, if necessary.</span>
<a name=line-99></a>                <span class=n>start</span> <span class=o>=</span> <span class=n>non_capturing_groups</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span>
<a name=line-100></a>                <span class=n>inner</span> <span class=o>=</span> <span class=n>NonCapture</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=n>start</span><span class=p>:])</span>
<a name=line-101></a>                <span class=n>result</span> <span class=o>=</span> <span class=n>result</span><span class=p>[:</span><span class=n>start</span><span class=p>]</span> <span class=o>+</span> <span class=p>[</span><span class=n>inner</span><span class=p>]</span>
<a name=line-102></a>            <span class=k>elif</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;[&#39;</span><span class=p>:</span>
<a name=line-103></a>                <span class=c1># Replace ranges with the first character in the range.</span>
<a name=line-104></a>                <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-105></a>                <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ch</span><span class=p>)</span>
<a name=line-106></a>                <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-107></a>                <span class=k>while</span> <span class=n>escaped</span> <span class=ow>or</span> <span class=n>ch</span> <span class=o>!=</span> <span class=s1>&#39;]&#39;</span><span class=p>:</span>
<a name=line-108></a>                    <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-109></a>            <span class=k>elif</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;(&#39;</span><span class=p>:</span>
<a name=line-110></a>                <span class=c1># Some kind of group.</span>
<a name=line-111></a>                <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-112></a>                <span class=k>if</span> <span class=n>ch</span> <span class=o>!=</span> <span class=s1>&#39;?&#39;</span> <span class=ow>or</span> <span class=n>escaped</span><span class=p>:</span>
<a name=line-113></a>                    <span class=c1># A positional group</span>
<a name=line-114></a>                    <span class=n>name</span> <span class=o>=</span> <span class=s2>&quot;_</span><span class=si>%d</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=n>num_args</span>
<a name=line-115></a>                    <span class=n>num_args</span> <span class=o>+=</span> <span class=mi>1</span>
<a name=line-116></a>                    <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Group</span><span class=p>(((</span><span class=s2>&quot;</span><span class=si>%%</span><span class=s2>(</span><span class=si>%s</span><span class=s2>)s&quot;</span> <span class=o>%</span> <span class=n>name</span><span class=p>),</span> <span class=n>name</span><span class=p>)))</span>
<a name=line-117></a>                    <span class=n>walk_to_end</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-118></a>                <span class=k>else</span><span class=p>:</span>
<a name=line-119></a>                    <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-120></a>                    <span class=k>if</span> <span class=n>ch</span> <span class=ow>in</span> <span class=s1>&#39;!=&lt;&#39;</span><span class=p>:</span>
<a name=line-121></a>                        <span class=c1># All of these are ignorable. Walk to the end of the</span>
<a name=line-122></a>                        <span class=c1># group.</span>
<a name=line-123></a>                        <span class=n>walk_to_end</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-124></a>                    <span class=k>elif</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;:&#39;</span><span class=p>:</span>
<a name=line-125></a>                        <span class=c1># Non-capturing group</span>
<a name=line-126></a>                        <span class=n>non_capturing_groups</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
<a name=line-127></a>                    <span class=k>elif</span> <span class=n>ch</span> <span class=o>!=</span> <span class=s1>&#39;P&#39;</span><span class=p>:</span>
<a name=line-128></a>                        <span class=c1># Anything else, other than a named group, is something</span>
<a name=line-129></a>                        <span class=c1># we cannot reverse.</span>
<a name=line-130></a>                        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Non-reversible reg-exp portion: &#39;(?</span><span class=si>%s</span><span class=s2>&#39;&quot;</span> <span class=o>%</span> <span class=n>ch</span><span class=p>)</span>
<a name=line-131></a>                    <span class=k>else</span><span class=p>:</span>
<a name=line-132></a>                        <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-133></a>                        <span class=k>if</span> <span class=n>ch</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;&lt;&#39;</span><span class=p>,</span> <span class=s1>&#39;=&#39;</span><span class=p>):</span>
<a name=line-134></a>                            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Non-reversible reg-exp portion: &#39;(?P</span><span class=si>%s</span><span class=s2>&#39;&quot;</span> <span class=o>%</span> <span class=n>ch</span><span class=p>)</span>
<a name=line-135></a>                        <span class=c1># We are in a named capturing group. Extra the name and</span>
<a name=line-136></a>                        <span class=c1># then skip to the end.</span>
<a name=line-137></a>                        <span class=k>if</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;&lt;&#39;</span><span class=p>:</span>
<a name=line-138></a>                            <span class=n>terminal_char</span> <span class=o>=</span> <span class=s1>&#39;&gt;&#39;</span>
<a name=line-139></a>                        <span class=c1># We are in a named backreference.</span>
<a name=line-140></a>                        <span class=k>else</span><span class=p>:</span>
<a name=line-141></a>                            <span class=n>terminal_char</span> <span class=o>=</span> <span class=s1>&#39;)&#39;</span>
<a name=line-142></a>                        <span class=n>name</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-143></a>                        <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-144></a>                        <span class=k>while</span> <span class=n>ch</span> <span class=o>!=</span> <span class=n>terminal_char</span><span class=p>:</span>
<a name=line-145></a>                            <span class=n>name</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ch</span><span class=p>)</span>
<a name=line-146></a>                            <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-147></a>                        <span class=n>param</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<a name=line-148></a>                        <span class=c1># Named backreferences have already consumed the</span>
<a name=line-149></a>                        <span class=c1># parenthesis.</span>
<a name=line-150></a>                        <span class=k>if</span> <span class=n>terminal_char</span> <span class=o>!=</span> <span class=s1>&#39;)&#39;</span><span class=p>:</span>
<a name=line-151></a>                            <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Group</span><span class=p>(((</span><span class=s2>&quot;</span><span class=si>%%</span><span class=s2>(</span><span class=si>%s</span><span class=s2>)s&quot;</span> <span class=o>%</span> <span class=n>param</span><span class=p>),</span> <span class=n>param</span><span class=p>)))</span>
<a name=line-152></a>                            <span class=n>walk_to_end</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-153></a>                        <span class=k>else</span><span class=p>:</span>
<a name=line-154></a>                            <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Group</span><span class=p>(((</span><span class=s2>&quot;</span><span class=si>%%</span><span class=s2>(</span><span class=si>%s</span><span class=s2>)s&quot;</span> <span class=o>%</span> <span class=n>param</span><span class=p>),</span> <span class=kc>None</span><span class=p>)))</span>
<a name=line-155></a>            <span class=k>elif</span> <span class=n>ch</span> <span class=ow>in</span> <span class=s2>&quot;*?+{&quot;</span><span class=p>:</span>
<a name=line-156></a>                <span class=c1># Quantifiers affect the previous item in the result list.</span>
<a name=line-157></a>                <span class=n>count</span><span class=p>,</span> <span class=n>ch</span> <span class=o>=</span> <span class=n>get_quantifier</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-158></a>                <span class=k>if</span> <span class=n>ch</span><span class=p>:</span>
<a name=line-159></a>                    <span class=c1># We had to look ahead, but it wasn&#39;t need to compute the</span>
<a name=line-160></a>                    <span class=c1># quantifier, so use this character next time around the</span>
<a name=line-161></a>                    <span class=c1># main loop.</span>
<a name=line-162></a>                    <span class=n>consume_next</span> <span class=o>=</span> <span class=kc>False</span>
<a name=line-163></a>
<a name=line-164></a>                <span class=k>if</span> <span class=n>count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
<a name=line-165></a>                    <span class=k>if</span> <span class=n>contains</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>Group</span><span class=p>):</span>
<a name=line-166></a>                        <span class=c1># If we are quantifying a capturing group (or</span>
<a name=line-167></a>                        <span class=c1># something containing such a group) and the minimum is</span>
<a name=line-168></a>                        <span class=c1># zero, we must also handle the case of one occurrence</span>
<a name=line-169></a>                        <span class=c1># being present. All the quantifiers (except {0,0},</span>
<a name=line-170></a>                        <span class=c1># which we conveniently ignore) that have a 0 minimum</span>
<a name=line-171></a>                        <span class=c1># also allow a single occurrence.</span>
<a name=line-172></a>                        <span class=n>result</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>Choice</span><span class=p>([</span><span class=kc>None</span><span class=p>,</span> <span class=n>result</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]])</span>
<a name=line-173></a>                    <span class=k>else</span><span class=p>:</span>
<a name=line-174></a>                        <span class=n>result</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span>
<a name=line-175></a>                <span class=k>elif</span> <span class=n>count</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
<a name=line-176></a>                    <span class=n>result</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=n>result</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]]</span> <span class=o>*</span> <span class=p>(</span><span class=n>count</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
<a name=line-177></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-178></a>                <span class=c1># Anything else is a literal.</span>
<a name=line-179></a>                <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ch</span><span class=p>)</span>
<a name=line-180></a>
<a name=line-181></a>            <span class=k>if</span> <span class=n>consume_next</span><span class=p>:</span>
<a name=line-182></a>                <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>pattern_iter</span><span class=p>)</span>
<a name=line-183></a>            <span class=n>consume_next</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-184></a>    <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
<a name=line-185></a>        <span class=k>pass</span>
<a name=line-186></a>    <span class=k>except</span> <span class=ne>NotImplementedError</span><span class=p>:</span>
<a name=line-187></a>        <span class=c1># A case of using the disjunctive form. No results for you!</span>
<a name=line-188></a>        <span class=k>return</span> <span class=p>[(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=p>[])]</span>
<a name=line-189></a>
<a name=line-190></a>    <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=o>*</span><span class=n>flatten_result</span><span class=p>(</span><span class=n>result</span><span class=p>)))</span>
<a name=line-191></a>
<a name=line-192></a>
<a name=line-193></a><span class=k>def</span> <span class=nf>next_char</span><span class=p>(</span><span class=n>input_iter</span><span class=p>):</span>
<a name=line-194></a>    <span class=sa>r</span><span class=sd>&quot;&quot;&quot;</span>
<a name=line-195></a><span class=sd>    An iterator that yields the next character from &quot;pattern_iter&quot;, respecting</span>
<a name=line-196></a><span class=sd>    escape sequences. An escaped character is replaced by a representative of</span>
<a name=line-197></a><span class=sd>    its class (e.g. \w -&gt; &quot;x&quot;). If the escaped character is one that is</span>
<a name=line-198></a><span class=sd>    skipped, it is not returned (the next character is returned instead).</span>
<a name=line-199></a>
<a name=line-200></a><span class=sd>    Yield the next character, along with a boolean indicating whether it is a</span>
<a name=line-201></a><span class=sd>    raw (unescaped) character or not.</span>
<a name=line-202></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-203></a>    <span class=k>for</span> <span class=n>ch</span> <span class=ow>in</span> <span class=n>input_iter</span><span class=p>:</span>
<a name=line-204></a>        <span class=k>if</span> <span class=n>ch</span> <span class=o>!=</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>&#39;</span><span class=p>:</span>
<a name=line-205></a>            <span class=k>yield</span> <span class=n>ch</span><span class=p>,</span> <span class=kc>False</span>
<a name=line-206></a>            <span class=k>continue</span>
<a name=line-207></a>        <span class=n>ch</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>input_iter</span><span class=p>)</span>
<a name=line-208></a>        <span class=n>representative</span> <span class=o>=</span> <span class=n>ESCAPE_MAPPINGS</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>ch</span><span class=p>)</span>
<a name=line-209></a>        <span class=k>if</span> <span class=n>representative</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-210></a>            <span class=k>continue</span>
<a name=line-211></a>        <span class=k>yield</span> <span class=n>representative</span><span class=p>,</span> <span class=kc>True</span>
<a name=line-212></a>
<a name=line-213></a>
<a name=line-214></a><span class=k>def</span> <span class=nf>walk_to_end</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>input_iter</span><span class=p>):</span>
<a name=line-215></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-216></a><span class=sd>    The iterator is currently inside a capturing group. Walk to the close of</span>
<a name=line-217></a><span class=sd>    this group, skipping over any nested groups and handling escaped</span>
<a name=line-218></a><span class=sd>    parentheses correctly.</span>
<a name=line-219></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-220></a>    <span class=k>if</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;(&#39;</span><span class=p>:</span>
<a name=line-221></a>        <span class=n>nesting</span> <span class=o>=</span> <span class=mi>1</span>
<a name=line-222></a>    <span class=k>else</span><span class=p>:</span>
<a name=line-223></a>        <span class=n>nesting</span> <span class=o>=</span> <span class=mi>0</span>
<a name=line-224></a>    <span class=k>for</span> <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=ow>in</span> <span class=n>input_iter</span><span class=p>:</span>
<a name=line-225></a>        <span class=k>if</span> <span class=n>escaped</span><span class=p>:</span>
<a name=line-226></a>            <span class=k>continue</span>
<a name=line-227></a>        <span class=k>elif</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;(&#39;</span><span class=p>:</span>
<a name=line-228></a>            <span class=n>nesting</span> <span class=o>+=</span> <span class=mi>1</span>
<a name=line-229></a>        <span class=k>elif</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;)&#39;</span><span class=p>:</span>
<a name=line-230></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>nesting</span><span class=p>:</span>
<a name=line-231></a>                <span class=k>return</span>
<a name=line-232></a>            <span class=n>nesting</span> <span class=o>-=</span> <span class=mi>1</span>
<a name=line-233></a>
<a name=line-234></a>
<a name=line-235></a><span class=k>def</span> <span class=nf>get_quantifier</span><span class=p>(</span><span class=n>ch</span><span class=p>,</span> <span class=n>input_iter</span><span class=p>):</span>
<a name=line-236></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-237></a><span class=sd>    Parse a quantifier from the input, where &quot;ch&quot; is the first character in the</span>
<a name=line-238></a><span class=sd>    quantifier.</span>
<a name=line-239></a>
<a name=line-240></a><span class=sd>    Return the minimum number of occurrences permitted by the quantifier and</span>
<a name=line-241></a><span class=sd>    either None or the next character from the input_iter if the next character</span>
<a name=line-242></a><span class=sd>    is not part of the quantifier.</span>
<a name=line-243></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-244></a>    <span class=k>if</span> <span class=n>ch</span> <span class=ow>in</span> <span class=s1>&#39;*?+&#39;</span><span class=p>:</span>
<a name=line-245></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-246></a>            <span class=n>ch2</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>input_iter</span><span class=p>)</span>
<a name=line-247></a>        <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
<a name=line-248></a>            <span class=n>ch2</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-249></a>        <span class=k>if</span> <span class=n>ch2</span> <span class=o>==</span> <span class=s1>&#39;?&#39;</span><span class=p>:</span>
<a name=line-250></a>            <span class=n>ch2</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-251></a>        <span class=k>if</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;+&#39;</span><span class=p>:</span>
<a name=line-252></a>            <span class=k>return</span> <span class=mi>1</span><span class=p>,</span> <span class=n>ch2</span>
<a name=line-253></a>        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=n>ch2</span>
<a name=line-254></a>
<a name=line-255></a>    <span class=n>quant</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-256></a>    <span class=k>while</span> <span class=n>ch</span> <span class=o>!=</span> <span class=s1>&#39;}&#39;</span><span class=p>:</span>
<a name=line-257></a>        <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>input_iter</span><span class=p>)</span>
<a name=line-258></a>        <span class=n>quant</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ch</span><span class=p>)</span>
<a name=line-259></a>    <span class=n>quant</span> <span class=o>=</span> <span class=n>quant</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
<a name=line-260></a>    <span class=n>values</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>quant</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>)</span>
<a name=line-261></a>
<a name=line-262></a>    <span class=c1># Consume the trailing &#39;?&#39;, if necessary.</span>
<a name=line-263></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-264></a>        <span class=n>ch</span><span class=p>,</span> <span class=n>escaped</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>input_iter</span><span class=p>)</span>
<a name=line-265></a>    <span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
<a name=line-266></a>        <span class=n>ch</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-267></a>    <span class=k>if</span> <span class=n>ch</span> <span class=o>==</span> <span class=s1>&#39;?&#39;</span><span class=p>:</span>
<a name=line-268></a>        <span class=n>ch</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-269></a>    <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=n>ch</span>
<a name=line-270></a>
<a name=line-271></a>
<a name=line-272></a><span class=k>def</span> <span class=nf>contains</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>inst</span><span class=p>):</span>
<a name=line-273></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-274></a><span class=sd>    Return True if the &quot;source&quot; contains an instance of &quot;inst&quot;. False,</span>
<a name=line-275></a><span class=sd>    otherwise.</span>
<a name=line-276></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-277></a>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>inst</span><span class=p>):</span>
<a name=line-278></a>        <span class=k>return</span> <span class=kc>True</span>
<a name=line-279></a>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>NonCapture</span><span class=p>):</span>
<a name=line-280></a>        <span class=k>for</span> <span class=n>elt</span> <span class=ow>in</span> <span class=n>source</span><span class=p>:</span>
<a name=line-281></a>            <span class=k>if</span> <span class=n>contains</span><span class=p>(</span><span class=n>elt</span><span class=p>,</span> <span class=n>inst</span><span class=p>):</span>
<a name=line-282></a>                <span class=k>return</span> <span class=kc>True</span>
<a name=line-283></a>    <span class=k>return</span> <span class=kc>False</span>
<a name=line-284></a>
<a name=line-285></a>
<a name=line-286></a><span class=k>def</span> <span class=nf>flatten_result</span><span class=p>(</span><span class=n>source</span><span class=p>):</span>
<a name=line-287></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-288></a><span class=sd>    Turn the given source sequence into a list of reg-exp possibilities and</span>
<a name=line-289></a><span class=sd>    their arguments. Return a list of strings and a list of argument lists.</span>
<a name=line-290></a><span class=sd>    Each of the two lists will be of the same length.</span>
<a name=line-291></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-292></a>    <span class=k>if</span> <span class=n>source</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-293></a>        <span class=k>return</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>],</span> <span class=p>[[]]</span>
<a name=line-294></a>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>Group</span><span class=p>):</span>
<a name=line-295></a>        <span class=k>if</span> <span class=n>source</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-296></a>            <span class=n>params</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-297></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-298></a>            <span class=n>params</span> <span class=o>=</span> <span class=p>[</span><span class=n>source</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span>
<a name=line-299></a>        <span class=k>return</span> <span class=p>[</span><span class=n>source</span><span class=p>[</span><span class=mi>0</span><span class=p>]],</span> <span class=p>[</span><span class=n>params</span><span class=p>]</span>
<a name=line-300></a>    <span class=n>result</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;&#39;</span><span class=p>]</span>
<a name=line-301></a>    <span class=n>result_args</span> <span class=o>=</span> <span class=p>[[]]</span>
<a name=line-302></a>    <span class=n>pos</span> <span class=o>=</span> <span class=n>last</span> <span class=o>=</span> <span class=mi>0</span>
<a name=line-303></a>    <span class=k>for</span> <span class=n>pos</span><span class=p>,</span> <span class=n>elt</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>source</span><span class=p>):</span>
<a name=line-304></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>elt</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<a name=line-305></a>            <span class=k>continue</span>
<a name=line-306></a>        <span class=n>piece</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>source</span><span class=p>[</span><span class=n>last</span><span class=p>:</span><span class=n>pos</span><span class=p>])</span>
<a name=line-307></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>elt</span><span class=p>,</span> <span class=n>Group</span><span class=p>):</span>
<a name=line-308></a>            <span class=n>piece</span> <span class=o>+=</span> <span class=n>elt</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<a name=line-309></a>            <span class=n>param</span> <span class=o>=</span> <span class=n>elt</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
<a name=line-310></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-311></a>            <span class=n>param</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-312></a>        <span class=n>last</span> <span class=o>=</span> <span class=n>pos</span> <span class=o>+</span> <span class=mi>1</span>
<a name=line-313></a>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>result</span><span class=p>)):</span>
<a name=line-314></a>            <span class=n>result</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>piece</span>
<a name=line-315></a>            <span class=k>if</span> <span class=n>param</span><span class=p>:</span>
<a name=line-316></a>                <span class=n>result_args</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>param</span><span class=p>)</span>
<a name=line-317></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>elt</span><span class=p>,</span> <span class=p>(</span><span class=n>Choice</span><span class=p>,</span> <span class=n>NonCapture</span><span class=p>)):</span>
<a name=line-318></a>            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>elt</span><span class=p>,</span> <span class=n>NonCapture</span><span class=p>):</span>
<a name=line-319></a>                <span class=n>elt</span> <span class=o>=</span> <span class=p>[</span><span class=n>elt</span><span class=p>]</span>
<a name=line-320></a>            <span class=n>inner_result</span><span class=p>,</span> <span class=n>inner_args</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[]</span>
<a name=line-321></a>            <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>elt</span><span class=p>:</span>
<a name=line-322></a>                <span class=n>res</span><span class=p>,</span> <span class=n>args</span> <span class=o>=</span> <span class=n>flatten_result</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
<a name=line-323></a>                <span class=n>inner_result</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
<a name=line-324></a>                <span class=n>inner_args</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>args</span><span class=p>)</span>
<a name=line-325></a>            <span class=n>new_result</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-326></a>            <span class=n>new_args</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-327></a>            <span class=k>for</span> <span class=n>item</span><span class=p>,</span> <span class=n>args</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>result_args</span><span class=p>):</span>
<a name=line-328></a>                <span class=k>for</span> <span class=n>i_item</span><span class=p>,</span> <span class=n>i_args</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>inner_result</span><span class=p>,</span> <span class=n>inner_args</span><span class=p>):</span>
<a name=line-329></a>                    <span class=n>new_result</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span> <span class=o>+</span> <span class=n>i_item</span><span class=p>)</span>
<a name=line-330></a>                    <span class=n>new_args</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>args</span><span class=p>[:]</span> <span class=o>+</span> <span class=n>i_args</span><span class=p>)</span>
<a name=line-331></a>            <span class=n>result</span> <span class=o>=</span> <span class=n>new_result</span>
<a name=line-332></a>            <span class=n>result_args</span> <span class=o>=</span> <span class=n>new_args</span>
<a name=line-333></a>    <span class=k>if</span> <span class=n>pos</span> <span class=o>&gt;=</span> <span class=n>last</span><span class=p>:</span>
<a name=line-334></a>        <span class=n>piece</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>source</span><span class=p>[</span><span class=n>last</span><span class=p>:])</span>
<a name=line-335></a>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>result</span><span class=p>)):</span>
<a name=line-336></a>            <span class=n>result</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>piece</span>
<a name=line-337></a>    <span class=k>return</span> <span class=n>result</span><span class=p>,</span> <span class=n>result_args</span>
<a name=line-338></a>
<a name=line-339></a>
<a name=line-340></a><span class=k>def</span> <span class=nf>_lazy_re_compile</span><span class=p>(</span><span class=n>regex</span><span class=p>,</span> <span class=n>flags</span><span class=o>=</span><span class=mi>0</span><span class=p>):</span>
<a name=line-341></a>    <span class=sd>&quot;&quot;&quot;Lazily compile a regex with flags.&quot;&quot;&quot;</span>
<a name=line-342></a>    <span class=k>def</span> <span class=nf>_compile</span><span class=p>():</span>
<a name=line-343></a>        <span class=c1># Compile the regex if it was not passed pre-compiled.</span>
<a name=line-344></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>regex</span><span class=p>,</span> <span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>)):</span>
<a name=line-345></a>            <span class=k>return</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=n>regex</span><span class=p>,</span> <span class=n>flags</span><span class=p>)</span>
<a name=line-346></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-347></a>            <span class=k>assert</span> <span class=ow>not</span> <span class=n>flags</span><span class=p>,</span> <span class=p>(</span>
<a name=line-348></a>                <span class=s1>&#39;flags must be empty if regex is passed pre-compiled&#39;</span>
<a name=line-349></a>            <span class=p>)</span>
<a name=line-350></a>            <span class=k>return</span> <span class=n>regex</span>
<a name=line-351></a>    <span class=k>return</span> <span class=n>SimpleLazyObject</span><span class=p>(</span><span class=n>_compile</span><span class=p>)</span>
</pre></div></td></tr></table><p class=footer> Generated by <a href=https://github.com/spirali/nedoc>nedoc</a> v0.9 at 2020-12-29 14:05 </p></div></div></body></html>
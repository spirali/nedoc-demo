<!DOCTYPE html><html><head><meta charset=utf-8><title>django.utils.translation.trans_real</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./assets/purecss/pure-min.css><link rel=stylesheet href=./assets/purecss/grids-responsive-min.css><link rel=stylesheet href=./assets/style.css><link rel=stylesheet href=./assets/pygments/default.css><link rel=stylesheet href=./assets/jquery/jquery-ui.min.css><script src=./assets/jquery/jquery-3.0.0.min.js></script><script src=./assets/jquery/jquery-ui.min.js></script><script src=nedoc.js></script></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-1-4"><div class=header><h1 class=brand-title>Django</h1> 1.0 </div><div id=sbox><input id=search style="color: black;" placeholder="search ..."></div><div class=tree><ul><li><a href=django.html>&#9662; django</a> </li><li><ul><li><a href=django.__main__.html>&#9656; __main__</a> </li><li><a href=django.apps.html>&#9656; apps</a> </li><li><a href=django.bin.html>&#9656; bin</a> </li><li><a href=django.conf.html>&#9656; conf</a> </li><li><a href=django.contrib.html>&#9656; contrib</a> </li><li><a href=django.core.html>&#9656; core</a> </li><li><a href=django.db.html>&#9656; db</a> </li><li><a href=django.dispatch.html>&#9656; dispatch</a> </li><li><a href=django.forms.html>&#9656; forms</a> </li><li><a href=django.http.html>&#9656; http</a> </li><li><a href=django.middleware.html>&#9656; middleware</a> </li><li><a href=django.shortcuts.html>&#9656; shortcuts</a> </li><li><a href=django.template.html>&#9656; template</a> </li><li><a href=django.templatetags.html>&#9656; templatetags</a> </li><li><a href=django.test.html>&#9656; test</a> </li><li><a href=django.urls.html>&#9656; urls</a> </li><li><a href=django.utils.html>&#9662; utils</a> </li><li><ul><li><a href=django.utils.archive.html>&#9656; archive</a> </li><li><a href=django.utils.asyncio.html>&#9656; asyncio</a> </li><li><a href=django.utils.autoreload.html>&#9656; autoreload</a> </li><li><a href=django.utils.baseconv.html>&#9656; baseconv</a> </li><li><a href=django.utils.cache.html>&#9656; cache</a> </li><li><a href=django.utils.crypto.html>&#9656; crypto</a> </li><li><a href=django.utils.datastructures.html>&#9656; datastructures</a> </li><li><a href=django.utils.dateformat.html>&#9656; dateformat</a> </li><li><a href=django.utils.dateparse.html>&#9656; dateparse</a> </li><li><a href=django.utils.dates.html>&#9656; dates</a> </li><li><a href=django.utils.datetime_safe.html>&#9656; datetime_safe</a> </li><li><a href=django.utils.deconstruct.html>&#9656; deconstruct</a> </li><li><a href=django.utils.decorators.html>&#9656; decorators</a> </li><li><a href=django.utils.deprecation.html>&#9656; deprecation</a> </li><li><a href=django.utils.duration.html>&#9656; duration</a> </li><li><a href=django.utils.encoding.html>&#9656; encoding</a> </li><li><a href=django.utils.feedgenerator.html>&#9656; feedgenerator</a> </li><li><a href=django.utils.formats.html>&#9656; formats</a> </li><li><a href=django.utils.functional.html>&#9656; functional</a> </li><li><a href=django.utils.hashable.html>&#9656; hashable</a> </li><li><a href=django.utils.html.html>&#9656; html</a> </li><li><a href=django.utils.http.html>&#9656; http</a> </li><li><a href=django.utils.inspect.html>&#9656; inspect</a> </li><li><a href=django.utils.ipv6.html>&#9656; ipv6</a> </li><li><a href=django.utils.itercompat.html>&#9656; itercompat</a> </li><li><a href=django.utils.jslex.html>&#9656; jslex</a> </li><li><a href=django.utils.log.html>&#9656; log</a> </li><li><a href=django.utils.lorem_ipsum.html>&#9656; lorem_ipsum</a> </li><li><a href=django.utils.module_loading.html>&#9656; module_loading</a> </li><li><a href=django.utils.numberformat.html>&#9656; numberformat</a> </li><li><a href=django.utils.regex_helper.html>&#9656; regex_helper</a> </li><li><a href=django.utils.safestring.html>&#9656; safestring</a> </li><li><a href=django.utils.termcolors.html>&#9656; termcolors</a> </li><li><a href=django.utils.text.html>&#9656; text</a> </li><li><a href=django.utils.timesince.html>&#9656; timesince</a> </li><li><a href=django.utils.timezone.html>&#9656; timezone</a> </li><li><a href=django.utils.topological_sort.html>&#9656; topological_sort</a> </li><li><a href=django.utils.translation.html>&#9662; translation</a> </li><li><ul><li><a href=django.utils.translation.reloader.html>&#9656; reloader</a> </li><li><a href=django.utils.translation.template.html>&#9656; template</a> </li><li><a href=django.utils.translation.trans_null.html>&#9656; trans_null</a> </li><li><div class=select><a href=django.utils.translation.trans_real.html>&#9662; trans_real</a> </div></li><li><ul><li><a href=django.utils.translation.trans_real.DjangoTranslation.html> <i>class</i> DjangoTranslation</a> </li><li><a href=django.utils.translation.trans_real.TranslationCatalog.html> <i>class</i> TranslationCatalog</a> </li></ul></li><li><a href=django.utils.translation.Trans.html> <i>class</i> Trans</a> </li><li><a href=django.utils.translation.TranslatorCommentWarning.html> <i>class</i> TranslatorCommentWarning</a> </li><li><a href=django.utils.translation.override.html> <i>class</i> override</a> </li></ul></li><li><a href=django.utils.tree.html>&#9656; tree</a> </li><li><a href=django.utils.version.html>&#9656; version</a> </li><li><a href=django.utils.xmlutils.html>&#9656; xmlutils</a> </li></ul></li><li><a href=django.views.html>&#9656; views</a> </li></ul></ul></div></div><div class="content pure-u-1 pure-u-md-3-4"><h1>Source code django/utils/translation/trans_real.py</h1><div id=path><a class=symbol href=django.html>django</a>.<a class=symbol href=django.utils.html>utils</a>.<a class=symbol href=django.utils.translation.html>translation</a>.<a class=symbol href=django.utils.translation.trans_real.html>trans_real</a></div><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580</pre></div></td><td class=code><div class=highlight><pre><span></span><a name=line-1></a><span class=sd>&quot;&quot;&quot;Translation helper functions.&quot;&quot;&quot;</span>
<a name=line-2></a><span class=kn>import</span> <span class=nn>functools</span>
<a name=line-3></a><span class=kn>import</span> <span class=nn>gettext</span> <span class=k>as</span> <span class=nn>gettext_module</span>
<a name=line-4></a><span class=kn>import</span> <span class=nn>os</span>
<a name=line-5></a><span class=kn>import</span> <span class=nn>re</span>
<a name=line-6></a><span class=kn>import</span> <span class=nn>sys</span>
<a name=line-7></a><span class=kn>import</span> <span class=nn>warnings</span>
<a name=line-8></a>
<a name=line-9></a><span class=kn>from</span> <span class=nn>asgiref.local</span> <span class=kn>import</span> <span class=n>Local</span>
<a name=line-10></a>
<a name=line-11></a><span class=kn>from</span> <span class=nn>django.apps</span> <span class=kn>import</span> <span class=n>apps</span>
<a name=line-12></a><span class=kn>from</span> <span class=nn>django.conf</span> <span class=kn>import</span> <span class=n>settings</span>
<a name=line-13></a><span class=kn>from</span> <span class=nn>django.conf.locale</span> <span class=kn>import</span> <span class=n>LANG_INFO</span>
<a name=line-14></a><span class=kn>from</span> <span class=nn>django.core.exceptions</span> <span class=kn>import</span> <span class=n>AppRegistryNotReady</span>
<a name=line-15></a><span class=kn>from</span> <span class=nn>django.core.signals</span> <span class=kn>import</span> <span class=n>setting_changed</span>
<a name=line-16></a><span class=kn>from</span> <span class=nn>django.dispatch</span> <span class=kn>import</span> <span class=n>receiver</span>
<a name=line-17></a><span class=kn>from</span> <span class=nn>django.utils.regex_helper</span> <span class=kn>import</span> <span class=n>_lazy_re_compile</span>
<a name=line-18></a><span class=kn>from</span> <span class=nn>django.utils.safestring</span> <span class=kn>import</span> <span class=n>SafeData</span><span class=p>,</span> <span class=n>mark_safe</span>
<a name=line-19></a>
<a name=line-20></a><span class=kn>from</span> <span class=nn>.</span> <span class=kn>import</span> <span class=n>to_language</span><span class=p>,</span> <span class=n>to_locale</span>
<a name=line-21></a>
<a name=line-22></a><span class=c1># Translations are cached in a dictionary for every language.</span>
<a name=line-23></a><span class=c1># The active translations are stored by threadid to make them thread local.</span>
<a name=line-24></a><span class=n>_translations</span> <span class=o>=</span> <span class=p>{}</span>
<a name=line-25></a><span class=n>_active</span> <span class=o>=</span> <span class=n>Local</span><span class=p>()</span>
<a name=line-26></a>
<a name=line-27></a><span class=c1># The default translation is based on the settings file.</span>
<a name=line-28></a><span class=n>_default</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-29></a>
<a name=line-30></a><span class=c1># magic gettext number to separate context from message</span>
<a name=line-31></a><span class=n>CONTEXT_SEPARATOR</span> <span class=o>=</span> <span class=s2>&quot;</span><span class=se>\x04</span><span class=s2>&quot;</span>
<a name=line-32></a>
<a name=line-33></a><span class=c1># Format of Accept-Language header values. From RFC 2616, section 14.4 and 3.9</span>
<a name=line-34></a><span class=c1># and RFC 3066, section 2.1</span>
<a name=line-35></a><span class=n>accept_language_re</span> <span class=o>=</span> <span class=n>_lazy_re_compile</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;&#39;&#39;</span>
<a name=line-36></a><span class=s1>        ([A-Za-z]{1,8}(?:-[A-Za-z0-9]{1,8})*|\*)      # &quot;en&quot;, &quot;en-au&quot;, &quot;x-y-z&quot;, &quot;es-419&quot;, &quot;*&quot;</span>
<a name=line-37></a><span class=s1>        (?:\s*;\s*q=(0(?:\.\d{,3})?|1(?:\.0{,3})?))?  # Optional &quot;q=1.00&quot;, &quot;q=0.8&quot;</span>
<a name=line-38></a><span class=s1>        (?:\s*,\s*|$)                                 # Multiple accepts per header.</span>
<a name=line-39></a><span class=s1>        &#39;&#39;&#39;</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>VERBOSE</span><span class=p>)</span>
<a name=line-40></a>
<a name=line-41></a><span class=n>language_code_re</span> <span class=o>=</span> <span class=n>_lazy_re_compile</span><span class=p>(</span>
<a name=line-42></a>    <span class=sa>r</span><span class=s1>&#39;^[a-z]{1,8}(?:-[a-z0-9]{1,8})*(?:@[a-z0-9]{1,20})?$&#39;</span><span class=p>,</span>
<a name=line-43></a>    <span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span>
<a name=line-44></a><span class=p>)</span>
<a name=line-45></a>
<a name=line-46></a><span class=n>language_code_prefix_re</span> <span class=o>=</span> <span class=n>_lazy_re_compile</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;^/(\w+([@-]\w+)?)(/|$)&#39;</span><span class=p>)</span>
<a name=line-47></a>
<a name=line-48></a>
<a name=line-49></a><span class=nd>@receiver</span><span class=p>(</span><span class=n>setting_changed</span><span class=p>)</span>
<a name=line-50></a><span class=k>def</span> <span class=nf>reset_cache</span><span class=p>(</span><span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<a name=line-51></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-52></a><span class=sd>    Reset global state when LANGUAGES setting has been changed, as some</span>
<a name=line-53></a><span class=sd>    languages should no longer be accepted.</span>
<a name=line-54></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-55></a>    <span class=k>if</span> <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;setting&#39;</span><span class=p>]</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>&#39;LANGUAGES&#39;</span><span class=p>,</span> <span class=s1>&#39;LANGUAGE_CODE&#39;</span><span class=p>):</span>
<a name=line-56></a>        <span class=n>check_for_language</span><span class=o>.</span><span class=n>cache_clear</span><span class=p>()</span>
<a name=line-57></a>        <span class=n>get_languages</span><span class=o>.</span><span class=n>cache_clear</span><span class=p>()</span>
<a name=line-58></a>        <span class=n>get_supported_language_variant</span><span class=o>.</span><span class=n>cache_clear</span><span class=p>()</span>
<a name=line-59></a>
<a name=line-60></a>
<a name=line-61></a><span class=k>class</span> <span class=nc>TranslationCatalog</span><span class=p>:</span>
<a name=line-62></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-63></a><span class=sd>    Simulate a dict for DjangoTranslation._catalog so as multiple catalogs</span>
<a name=line-64></a><span class=sd>    with different plural equations are kept separate.</span>
<a name=line-65></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-66></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trans</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-67></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_catalogs</span> <span class=o>=</span> <span class=p>[</span><span class=n>trans</span><span class=o>.</span><span class=n>_catalog</span><span class=o>.</span><span class=n>copy</span><span class=p>()]</span> <span class=k>if</span> <span class=n>trans</span> <span class=k>else</span> <span class=p>[{}]</span>
<a name=line-68></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_plurals</span> <span class=o>=</span> <span class=p>[</span><span class=n>trans</span><span class=o>.</span><span class=n>plural</span><span class=p>]</span> <span class=k>if</span> <span class=n>trans</span> <span class=k>else</span> <span class=p>[</span><span class=k>lambda</span> <span class=n>n</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>n</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)]</span>
<a name=line-69></a>
<a name=line-70></a>    <span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
<a name=line-71></a>        <span class=k>for</span> <span class=n>cat</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_catalogs</span><span class=p>:</span>
<a name=line-72></a>            <span class=k>try</span><span class=p>:</span>
<a name=line-73></a>                <span class=k>return</span> <span class=n>cat</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
<a name=line-74></a>            <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
<a name=line-75></a>                <span class=k>pass</span>
<a name=line-76></a>        <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
<a name=line-77></a>
<a name=line-78></a>    <span class=k>def</span> <span class=fm>__setitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
<a name=line-79></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_catalogs</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
<a name=line-80></a>
<a name=line-81></a>    <span class=k>def</span> <span class=fm>__contains__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
<a name=line-82></a>        <span class=k>return</span> <span class=nb>any</span><span class=p>(</span><span class=n>key</span> <span class=ow>in</span> <span class=n>cat</span> <span class=k>for</span> <span class=n>cat</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_catalogs</span><span class=p>)</span>
<a name=line-83></a>
<a name=line-84></a>    <span class=k>def</span> <span class=nf>items</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-85></a>        <span class=k>for</span> <span class=n>cat</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_catalogs</span><span class=p>:</span>
<a name=line-86></a>            <span class=k>yield from</span> <span class=n>cat</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
<a name=line-87></a>
<a name=line-88></a>    <span class=k>def</span> <span class=nf>keys</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-89></a>        <span class=k>for</span> <span class=n>cat</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_catalogs</span><span class=p>:</span>
<a name=line-90></a>            <span class=k>yield from</span> <span class=n>cat</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span>
<a name=line-91></a>
<a name=line-92></a>    <span class=k>def</span> <span class=nf>update</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trans</span><span class=p>):</span>
<a name=line-93></a>        <span class=c1># Merge if plural function is the same, else prepend.</span>
<a name=line-94></a>        <span class=k>for</span> <span class=n>cat</span><span class=p>,</span> <span class=n>plural</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_catalogs</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_plurals</span><span class=p>):</span>
<a name=line-95></a>            <span class=k>if</span> <span class=n>trans</span><span class=o>.</span><span class=n>plural</span><span class=o>.</span><span class=vm>__code__</span> <span class=o>==</span> <span class=n>plural</span><span class=o>.</span><span class=vm>__code__</span><span class=p>:</span>
<a name=line-96></a>                <span class=n>cat</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>trans</span><span class=o>.</span><span class=n>_catalog</span><span class=p>)</span>
<a name=line-97></a>                <span class=k>break</span>
<a name=line-98></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-99></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_catalogs</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>trans</span><span class=o>.</span><span class=n>_catalog</span><span class=o>.</span><span class=n>copy</span><span class=p>())</span>
<a name=line-100></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_plurals</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>trans</span><span class=o>.</span><span class=n>plural</span><span class=p>)</span>
<a name=line-101></a>
<a name=line-102></a>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-103></a>        <span class=n>missing</span> <span class=o>=</span> <span class=nb>object</span><span class=p>()</span>
<a name=line-104></a>        <span class=k>for</span> <span class=n>cat</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_catalogs</span><span class=p>:</span>
<a name=line-105></a>            <span class=n>result</span> <span class=o>=</span> <span class=n>cat</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>missing</span><span class=p>)</span>
<a name=line-106></a>            <span class=k>if</span> <span class=n>result</span> <span class=ow>is</span> <span class=ow>not</span> <span class=n>missing</span><span class=p>:</span>
<a name=line-107></a>                <span class=k>return</span> <span class=n>result</span>
<a name=line-108></a>        <span class=k>return</span> <span class=n>default</span>
<a name=line-109></a>
<a name=line-110></a>    <span class=k>def</span> <span class=nf>plural</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>msgid</span><span class=p>,</span> <span class=n>num</span><span class=p>):</span>
<a name=line-111></a>        <span class=k>for</span> <span class=n>cat</span><span class=p>,</span> <span class=n>plural</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_catalogs</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_plurals</span><span class=p>):</span>
<a name=line-112></a>            <span class=n>tmsg</span> <span class=o>=</span> <span class=n>cat</span><span class=o>.</span><span class=n>get</span><span class=p>((</span><span class=n>msgid</span><span class=p>,</span> <span class=n>plural</span><span class=p>(</span><span class=n>num</span><span class=p>)))</span>
<a name=line-113></a>            <span class=k>if</span> <span class=n>tmsg</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-114></a>                <span class=k>return</span> <span class=n>tmsg</span>
<a name=line-115></a>        <span class=k>raise</span> <span class=ne>KeyError</span>
<a name=line-116></a>
<a name=line-117></a>
<a name=line-118></a><span class=k>class</span> <span class=nc>DjangoTranslation</span><span class=p>(</span><span class=n>gettext_module</span><span class=o>.</span><span class=n>GNUTranslations</span><span class=p>):</span>
<a name=line-119></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-120></a><span class=sd>    Set up the GNUTranslations context with regard to output charset.</span>
<a name=line-121></a>
<a name=line-122></a><span class=sd>    This translation object will be constructed out of multiple GNUTranslations</span>
<a name=line-123></a><span class=sd>    objects by merging their catalogs. It will construct an object for the</span>
<a name=line-124></a><span class=sd>    requested language and add a fallback to the default language, if it&#39;s</span>
<a name=line-125></a><span class=sd>    different from the requested language.</span>
<a name=line-126></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-127></a>    <span class=n>domain</span> <span class=o>=</span> <span class=s1>&#39;django&#39;</span>
<a name=line-128></a>
<a name=line-129></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>language</span><span class=p>,</span> <span class=n>domain</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>localedirs</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-130></a>        <span class=sd>&quot;&quot;&quot;Create a GNUTranslations() using many locale directories&quot;&quot;&quot;</span>
<a name=line-131></a>        <span class=n>gettext_module</span><span class=o>.</span><span class=n>GNUTranslations</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
<a name=line-132></a>        <span class=k>if</span> <span class=n>domain</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-133></a>            <span class=bp>self</span><span class=o>.</span><span class=n>domain</span> <span class=o>=</span> <span class=n>domain</span>
<a name=line-134></a>
<a name=line-135></a>        <span class=bp>self</span><span class=o>.</span><span class=n>__language</span> <span class=o>=</span> <span class=n>language</span>
<a name=line-136></a>        <span class=bp>self</span><span class=o>.</span><span class=n>__to_language</span> <span class=o>=</span> <span class=n>to_language</span><span class=p>(</span><span class=n>language</span><span class=p>)</span>
<a name=line-137></a>        <span class=bp>self</span><span class=o>.</span><span class=n>__locale</span> <span class=o>=</span> <span class=n>to_locale</span><span class=p>(</span><span class=n>language</span><span class=p>)</span>
<a name=line-138></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_catalog</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-139></a>        <span class=c1># If a language doesn&#39;t have a catalog, use the Germanic default for</span>
<a name=line-140></a>        <span class=c1># pluralization: anything except one is pluralized.</span>
<a name=line-141></a>        <span class=bp>self</span><span class=o>.</span><span class=n>plural</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>n</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>n</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)</span>
<a name=line-142></a>
<a name=line-143></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>domain</span> <span class=o>==</span> <span class=s1>&#39;django&#39;</span><span class=p>:</span>
<a name=line-144></a>            <span class=k>if</span> <span class=n>localedirs</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-145></a>                <span class=c1># A module-level cache is used for caching &#39;django&#39; translations</span>
<a name=line-146></a>                <span class=n>warnings</span><span class=o>.</span><span class=n>warn</span><span class=p>(</span><span class=s2>&quot;localedirs is ignored when domain is &#39;django&#39;.&quot;</span><span class=p>,</span> <span class=ne>RuntimeWarning</span><span class=p>)</span>
<a name=line-147></a>                <span class=n>localedirs</span> <span class=o>=</span> <span class=kc>None</span>
<a name=line-148></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_init_translation_catalog</span><span class=p>()</span>
<a name=line-149></a>
<a name=line-150></a>        <span class=k>if</span> <span class=n>localedirs</span><span class=p>:</span>
<a name=line-151></a>            <span class=k>for</span> <span class=n>localedir</span> <span class=ow>in</span> <span class=n>localedirs</span><span class=p>:</span>
<a name=line-152></a>                <span class=n>translation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_new_gnu_trans</span><span class=p>(</span><span class=n>localedir</span><span class=p>)</span>
<a name=line-153></a>                <span class=bp>self</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=n>translation</span><span class=p>)</span>
<a name=line-154></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-155></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_add_installed_apps_translations</span><span class=p>()</span>
<a name=line-156></a>
<a name=line-157></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_add_local_translations</span><span class=p>()</span>
<a name=line-158></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>__language</span> <span class=o>==</span> <span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>domain</span> <span class=o>==</span> <span class=s1>&#39;django&#39;</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>_catalog</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-159></a>            <span class=c1># default lang should have at least one translation file available.</span>
<a name=line-160></a>            <span class=k>raise</span> <span class=ne>OSError</span><span class=p>(</span><span class=s1>&#39;No translation files found for default language </span><span class=si>%s</span><span class=s1>.&#39;</span> <span class=o>%</span> <span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span><span class=p>)</span>
<a name=line-161></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_add_fallback</span><span class=p>(</span><span class=n>localedirs</span><span class=p>)</span>
<a name=line-162></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_catalog</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-163></a>            <span class=c1># No catalogs found for this language, set an empty catalog.</span>
<a name=line-164></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_catalog</span> <span class=o>=</span> <span class=n>TranslationCatalog</span><span class=p>()</span>
<a name=line-165></a>
<a name=line-166></a>    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-167></a>        <span class=k>return</span> <span class=s2>&quot;&lt;DjangoTranslation lang:</span><span class=si>%s</span><span class=s2>&gt;&quot;</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>__language</span>
<a name=line-168></a>
<a name=line-169></a>    <span class=k>def</span> <span class=nf>_new_gnu_trans</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>localedir</span><span class=p>,</span> <span class=n>use_null_fallback</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
<a name=line-170></a>        <span class=sd>&quot;&quot;&quot;</span>
<a name=line-171></a><span class=sd>        Return a mergeable gettext.GNUTranslations instance.</span>
<a name=line-172></a>
<a name=line-173></a><span class=sd>        A convenience wrapper. By default gettext uses &#39;fallback=False&#39;.</span>
<a name=line-174></a><span class=sd>        Using param `use_null_fallback` to avoid confusion with any other</span>
<a name=line-175></a><span class=sd>        references to &#39;fallback&#39;.</span>
<a name=line-176></a><span class=sd>        &quot;&quot;&quot;</span>
<a name=line-177></a>        <span class=k>return</span> <span class=n>gettext_module</span><span class=o>.</span><span class=n>translation</span><span class=p>(</span>
<a name=line-178></a>            <span class=n>domain</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>domain</span><span class=p>,</span>
<a name=line-179></a>            <span class=n>localedir</span><span class=o>=</span><span class=n>localedir</span><span class=p>,</span>
<a name=line-180></a>            <span class=n>languages</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>__locale</span><span class=p>],</span>
<a name=line-181></a>            <span class=n>fallback</span><span class=o>=</span><span class=n>use_null_fallback</span><span class=p>,</span>
<a name=line-182></a>        <span class=p>)</span>
<a name=line-183></a>
<a name=line-184></a>    <span class=k>def</span> <span class=nf>_init_translation_catalog</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-185></a>        <span class=sd>&quot;&quot;&quot;Create a base catalog using global django translations.&quot;&quot;&quot;</span>
<a name=line-186></a>        <span class=n>settingsfile</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>modules</span><span class=p>[</span><span class=n>settings</span><span class=o>.</span><span class=vm>__module__</span><span class=p>]</span><span class=o>.</span><span class=vm>__file__</span>
<a name=line-187></a>        <span class=n>localedir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>settingsfile</span><span class=p>),</span> <span class=s1>&#39;locale&#39;</span><span class=p>)</span>
<a name=line-188></a>        <span class=n>translation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_new_gnu_trans</span><span class=p>(</span><span class=n>localedir</span><span class=p>)</span>
<a name=line-189></a>        <span class=bp>self</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=n>translation</span><span class=p>)</span>
<a name=line-190></a>
<a name=line-191></a>    <span class=k>def</span> <span class=nf>_add_installed_apps_translations</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-192></a>        <span class=sd>&quot;&quot;&quot;Merge translations from each installed app.&quot;&quot;&quot;</span>
<a name=line-193></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-194></a>            <span class=n>app_configs</span> <span class=o>=</span> <span class=nb>reversed</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>apps</span><span class=o>.</span><span class=n>get_app_configs</span><span class=p>()))</span>
<a name=line-195></a>        <span class=k>except</span> <span class=n>AppRegistryNotReady</span><span class=p>:</span>
<a name=line-196></a>            <span class=k>raise</span> <span class=n>AppRegistryNotReady</span><span class=p>(</span>
<a name=line-197></a>                <span class=s2>&quot;The translation infrastructure cannot be initialized before the &quot;</span>
<a name=line-198></a>                <span class=s2>&quot;apps registry is ready. Check that you don&#39;t make non-lazy &quot;</span>
<a name=line-199></a>                <span class=s2>&quot;gettext calls at import time.&quot;</span><span class=p>)</span>
<a name=line-200></a>        <span class=k>for</span> <span class=n>app_config</span> <span class=ow>in</span> <span class=n>app_configs</span><span class=p>:</span>
<a name=line-201></a>            <span class=n>localedir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>app_config</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;locale&#39;</span><span class=p>)</span>
<a name=line-202></a>            <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>localedir</span><span class=p>):</span>
<a name=line-203></a>                <span class=n>translation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_new_gnu_trans</span><span class=p>(</span><span class=n>localedir</span><span class=p>)</span>
<a name=line-204></a>                <span class=bp>self</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=n>translation</span><span class=p>)</span>
<a name=line-205></a>
<a name=line-206></a>    <span class=k>def</span> <span class=nf>_add_local_translations</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-207></a>        <span class=sd>&quot;&quot;&quot;Merge translations defined in LOCALE_PATHS.&quot;&quot;&quot;</span>
<a name=line-208></a>        <span class=k>for</span> <span class=n>localedir</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>LOCALE_PATHS</span><span class=p>):</span>
<a name=line-209></a>            <span class=n>translation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_new_gnu_trans</span><span class=p>(</span><span class=n>localedir</span><span class=p>)</span>
<a name=line-210></a>            <span class=bp>self</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=n>translation</span><span class=p>)</span>
<a name=line-211></a>
<a name=line-212></a>    <span class=k>def</span> <span class=nf>_add_fallback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>localedirs</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a name=line-213></a>        <span class=sd>&quot;&quot;&quot;Set the GNUTranslations() fallback with the default language.&quot;&quot;&quot;</span>
<a name=line-214></a>        <span class=c1># Don&#39;t set a fallback for the default language or any English variant</span>
<a name=line-215></a>        <span class=c1># (as it&#39;s empty, so it&#39;ll ALWAYS fall back to the default language)</span>
<a name=line-216></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>__language</span> <span class=o>==</span> <span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>__language</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;en&#39;</span><span class=p>):</span>
<a name=line-217></a>            <span class=k>return</span>
<a name=line-218></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>domain</span> <span class=o>==</span> <span class=s1>&#39;django&#39;</span><span class=p>:</span>
<a name=line-219></a>            <span class=c1># Get from cache</span>
<a name=line-220></a>            <span class=n>default_translation</span> <span class=o>=</span> <span class=n>translation</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span><span class=p>)</span>
<a name=line-221></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-222></a>            <span class=n>default_translation</span> <span class=o>=</span> <span class=n>DjangoTranslation</span><span class=p>(</span>
<a name=line-223></a>                <span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span><span class=p>,</span> <span class=n>domain</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>domain</span><span class=p>,</span> <span class=n>localedirs</span><span class=o>=</span><span class=n>localedirs</span>
<a name=line-224></a>            <span class=p>)</span>
<a name=line-225></a>        <span class=bp>self</span><span class=o>.</span><span class=n>add_fallback</span><span class=p>(</span><span class=n>default_translation</span><span class=p>)</span>
<a name=line-226></a>
<a name=line-227></a>    <span class=k>def</span> <span class=nf>merge</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>other</span><span class=p>):</span>
<a name=line-228></a>        <span class=sd>&quot;&quot;&quot;Merge another translation into this catalog.&quot;&quot;&quot;</span>
<a name=line-229></a>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>other</span><span class=p>,</span> <span class=s1>&#39;_catalog&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>):</span>
<a name=line-230></a>            <span class=k>return</span>  <span class=c1># NullTranslations() has no _catalog</span>
<a name=line-231></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_catalog</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-232></a>            <span class=c1># Take plural and _info from first catalog found (generally Django&#39;s).</span>
<a name=line-233></a>            <span class=bp>self</span><span class=o>.</span><span class=n>plural</span> <span class=o>=</span> <span class=n>other</span><span class=o>.</span><span class=n>plural</span>
<a name=line-234></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_info</span> <span class=o>=</span> <span class=n>other</span><span class=o>.</span><span class=n>_info</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
<a name=line-235></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_catalog</span> <span class=o>=</span> <span class=n>TranslationCatalog</span><span class=p>(</span><span class=n>other</span><span class=p>)</span>
<a name=line-236></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-237></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_catalog</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>other</span><span class=p>)</span>
<a name=line-238></a>        <span class=k>if</span> <span class=n>other</span><span class=o>.</span><span class=n>_fallback</span><span class=p>:</span>
<a name=line-239></a>            <span class=bp>self</span><span class=o>.</span><span class=n>add_fallback</span><span class=p>(</span><span class=n>other</span><span class=o>.</span><span class=n>_fallback</span><span class=p>)</span>
<a name=line-240></a>
<a name=line-241></a>    <span class=k>def</span> <span class=nf>language</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-242></a>        <span class=sd>&quot;&quot;&quot;Return the translation language.&quot;&quot;&quot;</span>
<a name=line-243></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>__language</span>
<a name=line-244></a>
<a name=line-245></a>    <span class=k>def</span> <span class=nf>to_language</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a name=line-246></a>        <span class=sd>&quot;&quot;&quot;Return the translation language name.&quot;&quot;&quot;</span>
<a name=line-247></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>__to_language</span>
<a name=line-248></a>
<a name=line-249></a>    <span class=k>def</span> <span class=nf>ngettext</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>msgid1</span><span class=p>,</span> <span class=n>msgid2</span><span class=p>,</span> <span class=n>n</span><span class=p>):</span>
<a name=line-250></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-251></a>            <span class=n>tmsg</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_catalog</span><span class=o>.</span><span class=n>plural</span><span class=p>(</span><span class=n>msgid1</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
<a name=line-252></a>        <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
<a name=line-253></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_fallback</span><span class=p>:</span>
<a name=line-254></a>                <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_fallback</span><span class=o>.</span><span class=n>ngettext</span><span class=p>(</span><span class=n>msgid1</span><span class=p>,</span> <span class=n>msgid2</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
<a name=line-255></a>            <span class=k>if</span> <span class=n>n</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
<a name=line-256></a>                <span class=n>tmsg</span> <span class=o>=</span> <span class=n>msgid1</span>
<a name=line-257></a>            <span class=k>else</span><span class=p>:</span>
<a name=line-258></a>                <span class=n>tmsg</span> <span class=o>=</span> <span class=n>msgid2</span>
<a name=line-259></a>        <span class=k>return</span> <span class=n>tmsg</span>
<a name=line-260></a>
<a name=line-261></a>
<a name=line-262></a><span class=k>def</span> <span class=nf>translation</span><span class=p>(</span><span class=n>language</span><span class=p>):</span>
<a name=line-263></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-264></a><span class=sd>    Return a translation object in the default &#39;django&#39; domain.</span>
<a name=line-265></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-266></a>    <span class=k>global</span> <span class=n>_translations</span>
<a name=line-267></a>    <span class=k>if</span> <span class=n>language</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>_translations</span><span class=p>:</span>
<a name=line-268></a>        <span class=n>_translations</span><span class=p>[</span><span class=n>language</span><span class=p>]</span> <span class=o>=</span> <span class=n>DjangoTranslation</span><span class=p>(</span><span class=n>language</span><span class=p>)</span>
<a name=line-269></a>    <span class=k>return</span> <span class=n>_translations</span><span class=p>[</span><span class=n>language</span><span class=p>]</span>
<a name=line-270></a>
<a name=line-271></a>
<a name=line-272></a><span class=k>def</span> <span class=nf>activate</span><span class=p>(</span><span class=n>language</span><span class=p>):</span>
<a name=line-273></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-274></a><span class=sd>    Fetch the translation object for a given language and install it as the</span>
<a name=line-275></a><span class=sd>    current translation object for the current thread.</span>
<a name=line-276></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-277></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>language</span><span class=p>:</span>
<a name=line-278></a>        <span class=k>return</span>
<a name=line-279></a>    <span class=n>_active</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=n>translation</span><span class=p>(</span><span class=n>language</span><span class=p>)</span>
<a name=line-280></a>
<a name=line-281></a>
<a name=line-282></a><span class=k>def</span> <span class=nf>deactivate</span><span class=p>():</span>
<a name=line-283></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-284></a><span class=sd>    Uninstall the active translation object so that further _() calls resolve</span>
<a name=line-285></a><span class=sd>    to the default translation object.</span>
<a name=line-286></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-287></a>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>_active</span><span class=p>,</span> <span class=s2>&quot;value&quot;</span><span class=p>):</span>
<a name=line-288></a>        <span class=k>del</span> <span class=n>_active</span><span class=o>.</span><span class=n>value</span>
<a name=line-289></a>
<a name=line-290></a>
<a name=line-291></a><span class=k>def</span> <span class=nf>deactivate_all</span><span class=p>():</span>
<a name=line-292></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-293></a><span class=sd>    Make the active translation object a NullTranslations() instance. This is</span>
<a name=line-294></a><span class=sd>    useful when we want delayed translations to appear as the original string</span>
<a name=line-295></a><span class=sd>    for some reason.</span>
<a name=line-296></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-297></a>    <span class=n>_active</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=n>gettext_module</span><span class=o>.</span><span class=n>NullTranslations</span><span class=p>()</span>
<a name=line-298></a>    <span class=n>_active</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>to_language</span> <span class=o>=</span> <span class=k>lambda</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span> <span class=kc>None</span>
<a name=line-299></a>
<a name=line-300></a>
<a name=line-301></a><span class=k>def</span> <span class=nf>get_language</span><span class=p>():</span>
<a name=line-302></a>    <span class=sd>&quot;&quot;&quot;Return the currently selected language.&quot;&quot;&quot;</span>
<a name=line-303></a>    <span class=n>t</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>_active</span><span class=p>,</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<a name=line-304></a>    <span class=k>if</span> <span class=n>t</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-305></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-306></a>            <span class=k>return</span> <span class=n>t</span><span class=o>.</span><span class=n>to_language</span><span class=p>()</span>
<a name=line-307></a>        <span class=k>except</span> <span class=ne>AttributeError</span><span class=p>:</span>
<a name=line-308></a>            <span class=k>pass</span>
<a name=line-309></a>    <span class=c1># If we don&#39;t have a real translation object, assume it&#39;s the default language.</span>
<a name=line-310></a>    <span class=k>return</span> <span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span>
<a name=line-311></a>
<a name=line-312></a>
<a name=line-313></a><span class=k>def</span> <span class=nf>get_language_bidi</span><span class=p>():</span>
<a name=line-314></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-315></a><span class=sd>    Return selected language&#39;s BiDi layout.</span>
<a name=line-316></a>
<a name=line-317></a><span class=sd>    * False = left-to-right layout</span>
<a name=line-318></a><span class=sd>    * True = right-to-left layout</span>
<a name=line-319></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-320></a>    <span class=n>lang</span> <span class=o>=</span> <span class=n>get_language</span><span class=p>()</span>
<a name=line-321></a>    <span class=k>if</span> <span class=n>lang</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-322></a>        <span class=k>return</span> <span class=kc>False</span>
<a name=line-323></a>    <span class=k>else</span><span class=p>:</span>
<a name=line-324></a>        <span class=n>base_lang</span> <span class=o>=</span> <span class=n>get_language</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
<a name=line-325></a>        <span class=k>return</span> <span class=n>base_lang</span> <span class=ow>in</span> <span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGES_BIDI</span>
<a name=line-326></a>
<a name=line-327></a>
<a name=line-328></a><span class=k>def</span> <span class=nf>catalog</span><span class=p>():</span>
<a name=line-329></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-330></a><span class=sd>    Return the current active catalog for further processing.</span>
<a name=line-331></a><span class=sd>    This can be used if you need to modify the catalog or want to access the</span>
<a name=line-332></a><span class=sd>    whole message catalog instead of just translating one string.</span>
<a name=line-333></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-334></a>    <span class=k>global</span> <span class=n>_default</span>
<a name=line-335></a>
<a name=line-336></a>    <span class=n>t</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>_active</span><span class=p>,</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<a name=line-337></a>    <span class=k>if</span> <span class=n>t</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-338></a>        <span class=k>return</span> <span class=n>t</span>
<a name=line-339></a>    <span class=k>if</span> <span class=n>_default</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-340></a>        <span class=n>_default</span> <span class=o>=</span> <span class=n>translation</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span><span class=p>)</span>
<a name=line-341></a>    <span class=k>return</span> <span class=n>_default</span>
<a name=line-342></a>
<a name=line-343></a>
<a name=line-344></a><span class=k>def</span> <span class=nf>gettext</span><span class=p>(</span><span class=n>message</span><span class=p>):</span>
<a name=line-345></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-346></a><span class=sd>    Translate the &#39;message&#39; string. It uses the current thread to find the</span>
<a name=line-347></a><span class=sd>    translation object to use. If no current translation is activated, the</span>
<a name=line-348></a><span class=sd>    message will be run through the default translation object.</span>
<a name=line-349></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-350></a>    <span class=k>global</span> <span class=n>_default</span>
<a name=line-351></a>
<a name=line-352></a>    <span class=n>eol_message</span> <span class=o>=</span> <span class=n>message</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\r\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\r</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<a name=line-353></a>
<a name=line-354></a>    <span class=k>if</span> <span class=n>eol_message</span><span class=p>:</span>
<a name=line-355></a>        <span class=n>_default</span> <span class=o>=</span> <span class=n>_default</span> <span class=ow>or</span> <span class=n>translation</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span><span class=p>)</span>
<a name=line-356></a>        <span class=n>translation_object</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>_active</span><span class=p>,</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span> <span class=n>_default</span><span class=p>)</span>
<a name=line-357></a>
<a name=line-358></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>translation_object</span><span class=o>.</span><span class=n>gettext</span><span class=p>(</span><span class=n>eol_message</span><span class=p>)</span>
<a name=line-359></a>    <span class=k>else</span><span class=p>:</span>
<a name=line-360></a>        <span class=c1># Return an empty value of the corresponding type if an empty message</span>
<a name=line-361></a>        <span class=c1># is given, instead of metadata, which is the default gettext behavior.</span>
<a name=line-362></a>        <span class=n>result</span> <span class=o>=</span> <span class=nb>type</span><span class=p>(</span><span class=n>message</span><span class=p>)(</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
<a name=line-363></a>
<a name=line-364></a>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=n>SafeData</span><span class=p>):</span>
<a name=line-365></a>        <span class=k>return</span> <span class=n>mark_safe</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
<a name=line-366></a>
<a name=line-367></a>    <span class=k>return</span> <span class=n>result</span>
<a name=line-368></a>
<a name=line-369></a>
<a name=line-370></a><span class=k>def</span> <span class=nf>pgettext</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
<a name=line-371></a>    <span class=n>msg_with_ctxt</span> <span class=o>=</span> <span class=s2>&quot;</span><span class=si>%s%s%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>CONTEXT_SEPARATOR</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
<a name=line-372></a>    <span class=n>result</span> <span class=o>=</span> <span class=n>gettext</span><span class=p>(</span><span class=n>msg_with_ctxt</span><span class=p>)</span>
<a name=line-373></a>    <span class=k>if</span> <span class=n>CONTEXT_SEPARATOR</span> <span class=ow>in</span> <span class=n>result</span><span class=p>:</span>
<a name=line-374></a>        <span class=c1># Translation not found</span>
<a name=line-375></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>message</span>
<a name=line-376></a>    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=n>SafeData</span><span class=p>):</span>
<a name=line-377></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>mark_safe</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
<a name=line-378></a>    <span class=k>return</span> <span class=n>result</span>
<a name=line-379></a>
<a name=line-380></a>
<a name=line-381></a><span class=k>def</span> <span class=nf>gettext_noop</span><span class=p>(</span><span class=n>message</span><span class=p>):</span>
<a name=line-382></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-383></a><span class=sd>    Mark strings for translation but don&#39;t translate them now. This can be</span>
<a name=line-384></a><span class=sd>    used to store strings in global variables that should stay in the base</span>
<a name=line-385></a><span class=sd>    language (because they might be used externally) and will be translated</span>
<a name=line-386></a><span class=sd>    later.</span>
<a name=line-387></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-388></a>    <span class=k>return</span> <span class=n>message</span>
<a name=line-389></a>
<a name=line-390></a>
<a name=line-391></a><span class=k>def</span> <span class=nf>do_ntranslate</span><span class=p>(</span><span class=n>singular</span><span class=p>,</span> <span class=n>plural</span><span class=p>,</span> <span class=n>number</span><span class=p>,</span> <span class=n>translation_function</span><span class=p>):</span>
<a name=line-392></a>    <span class=k>global</span> <span class=n>_default</span>
<a name=line-393></a>
<a name=line-394></a>    <span class=n>t</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>_active</span><span class=p>,</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
<a name=line-395></a>    <span class=k>if</span> <span class=n>t</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-396></a>        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>translation_function</span><span class=p>)(</span><span class=n>singular</span><span class=p>,</span> <span class=n>plural</span><span class=p>,</span> <span class=n>number</span><span class=p>)</span>
<a name=line-397></a>    <span class=k>if</span> <span class=n>_default</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-398></a>        <span class=n>_default</span> <span class=o>=</span> <span class=n>translation</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span><span class=p>)</span>
<a name=line-399></a>    <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>_default</span><span class=p>,</span> <span class=n>translation_function</span><span class=p>)(</span><span class=n>singular</span><span class=p>,</span> <span class=n>plural</span><span class=p>,</span> <span class=n>number</span><span class=p>)</span>
<a name=line-400></a>
<a name=line-401></a>
<a name=line-402></a><span class=k>def</span> <span class=nf>ngettext</span><span class=p>(</span><span class=n>singular</span><span class=p>,</span> <span class=n>plural</span><span class=p>,</span> <span class=n>number</span><span class=p>):</span>
<a name=line-403></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-404></a><span class=sd>    Return a string of the translation of either the singular or plural,</span>
<a name=line-405></a><span class=sd>    based on the number.</span>
<a name=line-406></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-407></a>    <span class=k>return</span> <span class=n>do_ntranslate</span><span class=p>(</span><span class=n>singular</span><span class=p>,</span> <span class=n>plural</span><span class=p>,</span> <span class=n>number</span><span class=p>,</span> <span class=s1>&#39;ngettext&#39;</span><span class=p>)</span>
<a name=line-408></a>
<a name=line-409></a>
<a name=line-410></a><span class=k>def</span> <span class=nf>npgettext</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>singular</span><span class=p>,</span> <span class=n>plural</span><span class=p>,</span> <span class=n>number</span><span class=p>):</span>
<a name=line-411></a>    <span class=n>msgs_with_ctxt</span> <span class=o>=</span> <span class=p>(</span><span class=s2>&quot;</span><span class=si>%s%s%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>CONTEXT_SEPARATOR</span><span class=p>,</span> <span class=n>singular</span><span class=p>),</span>
<a name=line-412></a>                      <span class=s2>&quot;</span><span class=si>%s%s%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>CONTEXT_SEPARATOR</span><span class=p>,</span> <span class=n>plural</span><span class=p>),</span>
<a name=line-413></a>                      <span class=n>number</span><span class=p>)</span>
<a name=line-414></a>    <span class=n>result</span> <span class=o>=</span> <span class=n>ngettext</span><span class=p>(</span><span class=o>*</span><span class=n>msgs_with_ctxt</span><span class=p>)</span>
<a name=line-415></a>    <span class=k>if</span> <span class=n>CONTEXT_SEPARATOR</span> <span class=ow>in</span> <span class=n>result</span><span class=p>:</span>
<a name=line-416></a>        <span class=c1># Translation not found</span>
<a name=line-417></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>ngettext</span><span class=p>(</span><span class=n>singular</span><span class=p>,</span> <span class=n>plural</span><span class=p>,</span> <span class=n>number</span><span class=p>)</span>
<a name=line-418></a>    <span class=k>return</span> <span class=n>result</span>
<a name=line-419></a>
<a name=line-420></a>
<a name=line-421></a><span class=k>def</span> <span class=nf>all_locale_paths</span><span class=p>():</span>
<a name=line-422></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-423></a><span class=sd>    Return a list of paths to user-provides languages files.</span>
<a name=line-424></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-425></a>    <span class=n>globalpath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
<a name=line-426></a>        <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>modules</span><span class=p>[</span><span class=n>settings</span><span class=o>.</span><span class=vm>__module__</span><span class=p>]</span><span class=o>.</span><span class=vm>__file__</span><span class=p>),</span> <span class=s1>&#39;locale&#39;</span><span class=p>)</span>
<a name=line-427></a>    <span class=n>app_paths</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-428></a>    <span class=k>for</span> <span class=n>app_config</span> <span class=ow>in</span> <span class=n>apps</span><span class=o>.</span><span class=n>get_app_configs</span><span class=p>():</span>
<a name=line-429></a>        <span class=n>locale_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>app_config</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;locale&#39;</span><span class=p>)</span>
<a name=line-430></a>        <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>locale_path</span><span class=p>):</span>
<a name=line-431></a>            <span class=n>app_paths</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>locale_path</span><span class=p>)</span>
<a name=line-432></a>    <span class=k>return</span> <span class=p>[</span><span class=n>globalpath</span><span class=p>,</span> <span class=o>*</span><span class=n>settings</span><span class=o>.</span><span class=n>LOCALE_PATHS</span><span class=p>,</span> <span class=o>*</span><span class=n>app_paths</span><span class=p>]</span>
<a name=line-433></a>
<a name=line-434></a>
<a name=line-435></a><span class=nd>@functools</span><span class=o>.</span><span class=n>lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
<a name=line-436></a><span class=k>def</span> <span class=nf>check_for_language</span><span class=p>(</span><span class=n>lang_code</span><span class=p>):</span>
<a name=line-437></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-438></a><span class=sd>    Check whether there is a global language file for the given language</span>
<a name=line-439></a><span class=sd>    code. This is used to decide whether a user-provided language is</span>
<a name=line-440></a><span class=sd>    available.</span>
<a name=line-441></a>
<a name=line-442></a><span class=sd>    lru_cache should have a maxsize to prevent from memory exhaustion attacks,</span>
<a name=line-443></a><span class=sd>    as the provided language codes are taken from the HTTP request. See also</span>
<a name=line-444></a><span class=sd>    &lt;https://www.djangoproject.com/weblog/2007/oct/26/security-fix/&gt;.</span>
<a name=line-445></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-446></a>    <span class=c1># First, a quick check to make sure lang_code is well-formed (#21458)</span>
<a name=line-447></a>    <span class=k>if</span> <span class=n>lang_code</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>language_code_re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>lang_code</span><span class=p>):</span>
<a name=line-448></a>        <span class=k>return</span> <span class=kc>False</span>
<a name=line-449></a>    <span class=k>return</span> <span class=nb>any</span><span class=p>(</span>
<a name=line-450></a>        <span class=n>gettext_module</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;django&#39;</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=p>[</span><span class=n>to_locale</span><span class=p>(</span><span class=n>lang_code</span><span class=p>)])</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<a name=line-451></a>        <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>all_locale_paths</span><span class=p>()</span>
<a name=line-452></a>    <span class=p>)</span>
<a name=line-453></a>
<a name=line-454></a>
<a name=line-455></a><span class=nd>@functools</span><span class=o>.</span><span class=n>lru_cache</span><span class=p>()</span>
<a name=line-456></a><span class=k>def</span> <span class=nf>get_languages</span><span class=p>():</span>
<a name=line-457></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-458></a><span class=sd>    Cache of settings.LANGUAGES in a dictionary for easy lookups by key.</span>
<a name=line-459></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-460></a>    <span class=k>return</span> <span class=nb>dict</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGES</span><span class=p>)</span>
<a name=line-461></a>
<a name=line-462></a>
<a name=line-463></a><span class=nd>@functools</span><span class=o>.</span><span class=n>lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
<a name=line-464></a><span class=k>def</span> <span class=nf>get_supported_language_variant</span><span class=p>(</span><span class=n>lang_code</span><span class=p>,</span> <span class=n>strict</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
<a name=line-465></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-466></a><span class=sd>    Return the language code that&#39;s listed in supported languages, possibly</span>
<a name=line-467></a><span class=sd>    selecting a more generic variant. Raise LookupError if nothing is found.</span>
<a name=line-468></a>
<a name=line-469></a><span class=sd>    If `strict` is False (the default), look for a country-specific variant</span>
<a name=line-470></a><span class=sd>    when neither the language code nor its generic variant is found.</span>
<a name=line-471></a>
<a name=line-472></a><span class=sd>    lru_cache should have a maxsize to prevent from memory exhaustion attacks,</span>
<a name=line-473></a><span class=sd>    as the provided language codes are taken from the HTTP request. See also</span>
<a name=line-474></a><span class=sd>    &lt;https://www.djangoproject.com/weblog/2007/oct/26/security-fix/&gt;.</span>
<a name=line-475></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-476></a>    <span class=k>if</span> <span class=n>lang_code</span><span class=p>:</span>
<a name=line-477></a>        <span class=c1># If &#39;fr-ca&#39; is not supported, try special fallback or language-only &#39;fr&#39;.</span>
<a name=line-478></a>        <span class=n>possible_lang_codes</span> <span class=o>=</span> <span class=p>[</span><span class=n>lang_code</span><span class=p>]</span>
<a name=line-479></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-480></a>            <span class=n>possible_lang_codes</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>LANG_INFO</span><span class=p>[</span><span class=n>lang_code</span><span class=p>][</span><span class=s1>&#39;fallback&#39;</span><span class=p>])</span>
<a name=line-481></a>        <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
<a name=line-482></a>            <span class=k>pass</span>
<a name=line-483></a>        <span class=n>generic_lang_code</span> <span class=o>=</span> <span class=n>lang_code</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
<a name=line-484></a>        <span class=n>possible_lang_codes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>generic_lang_code</span><span class=p>)</span>
<a name=line-485></a>        <span class=n>supported_lang_codes</span> <span class=o>=</span> <span class=n>get_languages</span><span class=p>()</span>
<a name=line-486></a>
<a name=line-487></a>        <span class=k>for</span> <span class=n>code</span> <span class=ow>in</span> <span class=n>possible_lang_codes</span><span class=p>:</span>
<a name=line-488></a>            <span class=k>if</span> <span class=n>code</span> <span class=ow>in</span> <span class=n>supported_lang_codes</span> <span class=ow>and</span> <span class=n>check_for_language</span><span class=p>(</span><span class=n>code</span><span class=p>):</span>
<a name=line-489></a>                <span class=k>return</span> <span class=n>code</span>
<a name=line-490></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>strict</span><span class=p>:</span>
<a name=line-491></a>            <span class=c1># if fr-fr is not supported, try fr-ca.</span>
<a name=line-492></a>            <span class=k>for</span> <span class=n>supported_code</span> <span class=ow>in</span> <span class=n>supported_lang_codes</span><span class=p>:</span>
<a name=line-493></a>                <span class=k>if</span> <span class=n>supported_code</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>generic_lang_code</span> <span class=o>+</span> <span class=s1>&#39;-&#39;</span><span class=p>):</span>
<a name=line-494></a>                    <span class=k>return</span> <span class=n>supported_code</span>
<a name=line-495></a>    <span class=k>raise</span> <span class=ne>LookupError</span><span class=p>(</span><span class=n>lang_code</span><span class=p>)</span>
<a name=line-496></a>
<a name=line-497></a>
<a name=line-498></a><span class=k>def</span> <span class=nf>get_language_from_path</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>strict</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
<a name=line-499></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-500></a><span class=sd>    Return the language code if there&#39;s a valid language code found in `path`.</span>
<a name=line-501></a>
<a name=line-502></a><span class=sd>    If `strict` is False (the default), look for a country-specific variant</span>
<a name=line-503></a><span class=sd>    when neither the language code nor its generic variant is found.</span>
<a name=line-504></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-505></a>    <span class=n>regex_match</span> <span class=o>=</span> <span class=n>language_code_prefix_re</span><span class=o>.</span><span class=n>match</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
<a name=line-506></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>regex_match</span><span class=p>:</span>
<a name=line-507></a>        <span class=k>return</span> <span class=kc>None</span>
<a name=line-508></a>    <span class=n>lang_code</span> <span class=o>=</span> <span class=n>regex_match</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
<a name=line-509></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-510></a>        <span class=k>return</span> <span class=n>get_supported_language_variant</span><span class=p>(</span><span class=n>lang_code</span><span class=p>,</span> <span class=n>strict</span><span class=o>=</span><span class=n>strict</span><span class=p>)</span>
<a name=line-511></a>    <span class=k>except</span> <span class=ne>LookupError</span><span class=p>:</span>
<a name=line-512></a>        <span class=k>return</span> <span class=kc>None</span>
<a name=line-513></a>
<a name=line-514></a>
<a name=line-515></a><span class=k>def</span> <span class=nf>get_language_from_request</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>check_path</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
<a name=line-516></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-517></a><span class=sd>    Analyze the request to find what language the user wants the system to</span>
<a name=line-518></a><span class=sd>    show. Only languages listed in settings.LANGUAGES are taken into account.</span>
<a name=line-519></a><span class=sd>    If the user requests a sublanguage where we have a main language, we send</span>
<a name=line-520></a><span class=sd>    out the main language.</span>
<a name=line-521></a>
<a name=line-522></a><span class=sd>    If check_path is True, the URL path prefix will be checked for a language</span>
<a name=line-523></a><span class=sd>    code, otherwise this is skipped for backwards compatibility.</span>
<a name=line-524></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-525></a>    <span class=k>if</span> <span class=n>check_path</span><span class=p>:</span>
<a name=line-526></a>        <span class=n>lang_code</span> <span class=o>=</span> <span class=n>get_language_from_path</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>path_info</span><span class=p>)</span>
<a name=line-527></a>        <span class=k>if</span> <span class=n>lang_code</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-528></a>            <span class=k>return</span> <span class=n>lang_code</span>
<a name=line-529></a>
<a name=line-530></a>    <span class=n>lang_code</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>COOKIES</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_COOKIE_NAME</span><span class=p>)</span>
<a name=line-531></a>    <span class=k>if</span> <span class=n>lang_code</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>lang_code</span> <span class=ow>in</span> <span class=n>get_languages</span><span class=p>()</span> <span class=ow>and</span> <span class=n>check_for_language</span><span class=p>(</span><span class=n>lang_code</span><span class=p>):</span>
<a name=line-532></a>        <span class=k>return</span> <span class=n>lang_code</span>
<a name=line-533></a>
<a name=line-534></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-535></a>        <span class=k>return</span> <span class=n>get_supported_language_variant</span><span class=p>(</span><span class=n>lang_code</span><span class=p>)</span>
<a name=line-536></a>    <span class=k>except</span> <span class=ne>LookupError</span><span class=p>:</span>
<a name=line-537></a>        <span class=k>pass</span>
<a name=line-538></a>
<a name=line-539></a>    <span class=n>accept</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>META</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;HTTP_ACCEPT_LANGUAGE&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<a name=line-540></a>    <span class=k>for</span> <span class=n>accept_lang</span><span class=p>,</span> <span class=n>unused</span> <span class=ow>in</span> <span class=n>parse_accept_lang_header</span><span class=p>(</span><span class=n>accept</span><span class=p>):</span>
<a name=line-541></a>        <span class=k>if</span> <span class=n>accept_lang</span> <span class=o>==</span> <span class=s1>&#39;*&#39;</span><span class=p>:</span>
<a name=line-542></a>            <span class=k>break</span>
<a name=line-543></a>
<a name=line-544></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>language_code_re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>accept_lang</span><span class=p>):</span>
<a name=line-545></a>            <span class=k>continue</span>
<a name=line-546></a>
<a name=line-547></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-548></a>            <span class=k>return</span> <span class=n>get_supported_language_variant</span><span class=p>(</span><span class=n>accept_lang</span><span class=p>)</span>
<a name=line-549></a>        <span class=k>except</span> <span class=ne>LookupError</span><span class=p>:</span>
<a name=line-550></a>            <span class=k>continue</span>
<a name=line-551></a>
<a name=line-552></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-553></a>        <span class=k>return</span> <span class=n>get_supported_language_variant</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span><span class=p>)</span>
<a name=line-554></a>    <span class=k>except</span> <span class=ne>LookupError</span><span class=p>:</span>
<a name=line-555></a>        <span class=k>return</span> <span class=n>settings</span><span class=o>.</span><span class=n>LANGUAGE_CODE</span>
<a name=line-556></a>
<a name=line-557></a>
<a name=line-558></a><span class=nd>@functools</span><span class=o>.</span><span class=n>lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
<a name=line-559></a><span class=k>def</span> <span class=nf>parse_accept_lang_header</span><span class=p>(</span><span class=n>lang_string</span><span class=p>):</span>
<a name=line-560></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-561></a><span class=sd>    Parse the lang_string, which is the body of an HTTP Accept-Language</span>
<a name=line-562></a><span class=sd>    header, and return a tuple of (lang, q-value), ordered by &#39;q&#39; values.</span>
<a name=line-563></a>
<a name=line-564></a><span class=sd>    Return an empty tuple if there are any format errors in lang_string.</span>
<a name=line-565></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-566></a>    <span class=n>result</span> <span class=o>=</span> <span class=p>[]</span>
<a name=line-567></a>    <span class=n>pieces</span> <span class=o>=</span> <span class=n>accept_language_re</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>lang_string</span><span class=o>.</span><span class=n>lower</span><span class=p>())</span>
<a name=line-568></a>    <span class=k>if</span> <span class=n>pieces</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]:</span>
<a name=line-569></a>        <span class=k>return</span> <span class=p>()</span>
<a name=line-570></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>pieces</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>):</span>
<a name=line-571></a>        <span class=n>first</span><span class=p>,</span> <span class=n>lang</span><span class=p>,</span> <span class=n>priority</span> <span class=o>=</span> <span class=n>pieces</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span> <span class=o>+</span> <span class=mi>3</span><span class=p>]</span>
<a name=line-572></a>        <span class=k>if</span> <span class=n>first</span><span class=p>:</span>
<a name=line-573></a>            <span class=k>return</span> <span class=p>()</span>
<a name=line-574></a>        <span class=k>if</span> <span class=n>priority</span><span class=p>:</span>
<a name=line-575></a>            <span class=n>priority</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>priority</span><span class=p>)</span>
<a name=line-576></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-577></a>            <span class=n>priority</span> <span class=o>=</span> <span class=mf>1.0</span>
<a name=line-578></a>        <span class=n>result</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>lang</span><span class=p>,</span> <span class=n>priority</span><span class=p>))</span>
<a name=line-579></a>    <span class=n>result</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>k</span><span class=p>:</span> <span class=n>k</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a name=line-580></a>    <span class=k>return</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</pre></div></td></tr></table><p class=footer> Generated by <a href=https://github.com/spirali/nedoc>nedoc</a> v0.9 at 2020-12-29 14:05 </p></div></div></body></html>
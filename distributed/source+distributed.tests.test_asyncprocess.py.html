<!DOCTYPE html><html><head><meta charset=utf-8><title>distributed.tests.test_asyncprocess</title><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./assets/purecss/pure-min.css><link rel=stylesheet href=./assets/purecss/grids-responsive-min.css><link rel=stylesheet href=./assets/style.css><link rel=stylesheet href=./assets/pygments/default.css><link rel=stylesheet href=./assets/jquery/jquery-ui.min.css><script src=./assets/jquery/jquery-3.0.0.min.js></script><script src=./assets/jquery/jquery-ui.min.js></script><script src=nedoc.js></script></head><body><div id=layout class=pure-g><div class="sidebar pure-u-1 pure-u-md-1-4"><div class=header><h1 class=brand-title>Distributed</h1> 1.0 </div><div id=sbox><input id=search style="color: black;" placeholder="search ..."></div><div class=tree><ul><li><a href=distributed.html>&#9662; distributed</a> </li><li><ul><li><a href=distributed.actor.html>&#9656; actor</a> </li><li><a href=distributed.asyncio.html>&#9656; asyncio</a> </li><li><a href=distributed.batched.html>&#9656; batched</a> </li><li><a href=distributed.bokeh.html>&#9656; bokeh</a> </li><li><a href=distributed.cfexecutor.html>&#9656; cfexecutor</a> </li><li><a href=distributed.cli.html>&#9656; cli</a> </li><li><a href=distributed.client.html>&#9656; client</a> </li><li><a href=distributed.comm.html>&#9656; comm</a> </li><li><a href=distributed.compatibility.html>&#9656; compatibility</a> </li><li><a href=distributed.config.html>&#9656; config</a> </li><li><a href=distributed.core.html>&#9656; core</a> </li><li><a href=distributed.counter.html>&#9656; counter</a> </li><li><a href=distributed.dashboard.html>&#9656; dashboard</a> </li><li><a href=distributed.deploy.html>&#9656; deploy</a> </li><li><a href=distributed.diagnostics.html>&#9656; diagnostics</a> </li><li><a href=distributed.diskutils.html>&#9656; diskutils</a> </li><li><a href=distributed.event.html>&#9656; event</a> </li><li><a href=distributed.http.html>&#9656; http</a> </li><li><a href=distributed.lock.html>&#9656; lock</a> </li><li><a href=distributed.locket.html>&#9656; locket</a> </li><li><a href=distributed.metrics.html>&#9656; metrics</a> </li><li><a href=distributed.nanny.html>&#9656; nanny</a> </li><li><a href=distributed.node.html>&#9656; node</a> </li><li><a href=distributed.preloading.html>&#9656; preloading</a> </li><li><a href=distributed.process.html>&#9656; process</a> </li><li><a href=distributed.proctitle.html>&#9656; proctitle</a> </li><li><a href=distributed.profile.html>&#9656; profile</a> </li><li><a href=distributed.protocol.html>&#9656; protocol</a> </li><li><a href=distributed.publish.html>&#9656; publish</a> </li><li><a href=distributed.pubsub.html>&#9656; pubsub</a> </li><li><a href=distributed.pytest_resourceleaks.html>&#9656; pytest_resourceleaks</a> </li><li><a href=distributed.queues.html>&#9656; queues</a> </li><li><a href=distributed.recreate_exceptions.html>&#9656; recreate_exceptions</a> </li><li><a href=distributed.scheduler.html>&#9656; scheduler</a> </li><li><a href=distributed.security.html>&#9656; security</a> </li><li><a href=distributed.semaphore.html>&#9656; semaphore</a> </li><li><a href=distributed.sizeof.html>&#9656; sizeof</a> </li><li><a href=distributed.stealing.html>&#9656; stealing</a> </li><li><a href=distributed.system.html>&#9656; system</a> </li><li><a href=distributed.system_monitor.html>&#9656; system_monitor</a> </li><li><a href=distributed.tests.html>&#9662; tests</a> </li><li><ul><li><a href=distributed.tests.make_tls_certs.html>&#9656; make_tls_certs</a> </li><li><a href=distributed.tests.test_actor.html>&#9656; test_actor</a> </li><li><a href=distributed.tests.test_as_completed.html>&#9656; test_as_completed</a> </li><li><div class=select><a href=distributed.tests.test_asyncprocess.html>&#9662; test_asyncprocess</a> </div></li><li><a href=distributed.tests.test_batched.html>&#9656; test_batched</a> </li><li><a href=distributed.tests.test_client.html>&#9656; test_client</a> </li><li><a href=distributed.tests.test_client_executor.html>&#9656; test_client_executor</a> </li><li><a href=distributed.tests.test_client_loop.html>&#9656; test_client_loop</a> </li><li><a href=distributed.tests.test_collections.html>&#9656; test_collections</a> </li><li><a href=distributed.tests.test_config.html>&#9656; test_config</a> </li><li><a href=distributed.tests.test_core.html>&#9656; test_core</a> </li><li><a href=distributed.tests.test_counter.html>&#9656; test_counter</a> </li><li><a href=distributed.tests.test_diskutils.html>&#9656; test_diskutils</a> </li><li><a href=distributed.tests.test_events.html>&#9656; test_events</a> </li><li><a href=distributed.tests.test_failed_workers.html>&#9656; test_failed_workers</a> </li><li><a href=distributed.tests.test_ipython.html>&#9656; test_ipython</a> </li><li><a href=distributed.tests.test_locks.html>&#9656; test_locks</a> </li><li><a href=distributed.tests.test_metrics.html>&#9656; test_metrics</a> </li><li><a href=distributed.tests.test_nanny.html>&#9656; test_nanny</a> </li><li><a href=distributed.tests.test_preload.html>&#9656; test_preload</a> </li><li><a href=distributed.tests.test_priorities.html>&#9656; test_priorities</a> </li><li><a href=distributed.tests.test_profile.html>&#9656; test_profile</a> </li><li><a href=distributed.tests.test_publish.html>&#9656; test_publish</a> </li><li><a href=distributed.tests.test_pubsub.html>&#9656; test_pubsub</a> </li><li><a href=distributed.tests.test_queues.html>&#9656; test_queues</a> </li><li><a href=distributed.tests.test_resources.html>&#9656; test_resources</a> </li><li><a href=distributed.tests.test_scheduler.html>&#9656; test_scheduler</a> </li><li><a href=distributed.tests.test_security.html>&#9656; test_security</a> </li><li><a href=distributed.tests.test_semaphore.html>&#9656; test_semaphore</a> </li><li><a href=distributed.tests.test_sizeof.html>&#9656; test_sizeof</a> </li><li><a href=distributed.tests.test_spec.html>&#9656; test_spec</a> </li><li><a href=distributed.tests.test_steal.html>&#9656; test_steal</a> </li><li><a href=distributed.tests.test_stress.html>&#9656; test_stress</a> </li><li><a href=distributed.tests.test_system.html>&#9656; test_system</a> </li><li><a href=distributed.tests.test_system_monitor.html>&#9656; test_system_monitor</a> </li><li><a href=distributed.tests.test_threadpoolexecutor.html>&#9656; test_threadpoolexecutor</a> </li><li><a href=distributed.tests.test_tls_functional.html>&#9656; test_tls_functional</a> </li><li><a href=distributed.tests.test_utils.html>&#9656; test_utils</a> </li><li><a href=distributed.tests.test_utils_comm.html>&#9656; test_utils_comm</a> </li><li><a href=distributed.tests.test_utils_perf.html>&#9656; test_utils_perf</a> </li><li><a href=distributed.tests.test_utils_test.html>&#9656; test_utils_test</a> </li><li><a href=distributed.tests.test_variable.html>&#9656; test_variable</a> </li><li><a href=distributed.tests.test_versions.html>&#9656; test_versions</a> </li><li><a href=distributed.tests.test_worker.html>&#9656; test_worker</a> </li><li><a href=distributed.tests.test_worker_client.html>&#9656; test_worker_client</a> </li></ul></li><li><a href=distributed.threadpoolexecutor.html>&#9656; threadpoolexecutor</a> </li><li><a href=distributed.utils.html>&#9656; utils</a> </li><li><a href=distributed.utils_comm.html>&#9656; utils_comm</a> </li><li><a href=distributed.utils_perf.html>&#9656; utils_perf</a> </li><li><a href=distributed.utils_test.html>&#9656; utils_test</a> </li><li><a href=distributed.variable.html>&#9656; variable</a> </li><li><a href=distributed.versions.html>&#9656; versions</a> </li><li><a href=distributed.worker.html>&#9656; worker</a> </li><li><a href=distributed.worker_client.html>&#9656; worker_client</a> </li></ul></ul></div></div><div class="content pure-u-1 pure-u-md-3-4"><h1>Source code distributed/tests/test_asyncprocess.py</h1><div id=path><a class=symbol href=distributed.html>distributed</a>.<a class=symbol href=distributed.tests.html>tests</a>.<a class=symbol href=distributed.tests.test_asyncprocess.html>test_asyncprocess</a></div><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439</pre></div></td><td class=code><div class=highlight><pre><span></span><a name=line-1></a><span class=kn>import</span> <span class=nn>asyncio</span>
<a name=line-2></a><span class=kn>import</span> <span class=nn>gc</span>
<a name=line-3></a><span class=kn>import</span> <span class=nn>os</span>
<a name=line-4></a><span class=kn>import</span> <span class=nn>signal</span>
<a name=line-5></a><span class=kn>import</span> <span class=nn>sys</span>
<a name=line-6></a><span class=kn>import</span> <span class=nn>threading</span>
<a name=line-7></a><span class=kn>import</span> <span class=nn>weakref</span>
<a name=line-8></a><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>timedelta</span>
<a name=line-9></a><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>
<a name=line-10></a>
<a name=line-11></a><span class=kn>import</span> <span class=nn>pytest</span>
<a name=line-12></a><span class=kn>from</span> <span class=nn>tornado</span> <span class=kn>import</span> <span class=n>gen</span>
<a name=line-13></a><span class=kn>from</span> <span class=nn>tornado.locks</span> <span class=kn>import</span> <span class=n>Event</span>
<a name=line-14></a>
<a name=line-15></a><span class=kn>from</span> <span class=nn>distributed.metrics</span> <span class=kn>import</span> <span class=n>time</span>
<a name=line-16></a><span class=kn>from</span> <span class=nn>distributed.process</span> <span class=kn>import</span> <span class=n>AsyncProcess</span>
<a name=line-17></a><span class=kn>from</span> <span class=nn>distributed.utils</span> <span class=kn>import</span> <span class=n>mp_context</span>
<a name=line-18></a><span class=kn>from</span> <span class=nn>distributed.utils_test</span> <span class=kn>import</span> <span class=n>gen_test</span><span class=p>,</span> <span class=n>pristine_loop</span><span class=p>,</span> <span class=n>nodebug</span>
<a name=line-19></a>
<a name=line-20></a>
<a name=line-21></a><span class=k>def</span> <span class=nf>feed</span><span class=p>(</span><span class=n>in_q</span><span class=p>,</span> <span class=n>out_q</span><span class=p>):</span>
<a name=line-22></a>    <span class=n>obj</span> <span class=o>=</span> <span class=n>in_q</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
<a name=line-23></a>    <span class=n>out_q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>obj</span><span class=p>)</span>
<a name=line-24></a>
<a name=line-25></a>
<a name=line-26></a><span class=k>def</span> <span class=nf>exit</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
<a name=line-27></a>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>())</span>
<a name=line-28></a>
<a name=line-29></a>
<a name=line-30></a><span class=k>def</span> <span class=nf>exit_now</span><span class=p>(</span><span class=n>rc</span><span class=o>=</span><span class=mi>0</span><span class=p>):</span>
<a name=line-31></a>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=n>rc</span><span class=p>)</span>
<a name=line-32></a>
<a name=line-33></a>
<a name=line-34></a><span class=k>def</span> <span class=nf>exit_with_signal</span><span class=p>(</span><span class=n>signum</span><span class=p>):</span>
<a name=line-35></a>    <span class=n>signal</span><span class=o>.</span><span class=n>signal</span><span class=p>(</span><span class=n>signal</span><span class=o>.</span><span class=n>SIGINT</span><span class=p>,</span> <span class=n>signal</span><span class=o>.</span><span class=n>SIG_DFL</span><span class=p>)</span>
<a name=line-36></a>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
<a name=line-37></a>        <span class=n>os</span><span class=o>.</span><span class=n>kill</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getpid</span><span class=p>(),</span> <span class=n>signum</span><span class=p>)</span>
<a name=line-38></a>        <span class=n>sleep</span><span class=p>(</span><span class=mf>0.01</span><span class=p>)</span>
<a name=line-39></a>
<a name=line-40></a>
<a name=line-41></a><span class=k>def</span> <span class=nf>wait</span><span class=p>():</span>
<a name=line-42></a>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
<a name=line-43></a>        <span class=n>sleep</span><span class=p>(</span><span class=mf>0.01</span><span class=p>)</span>
<a name=line-44></a>
<a name=line-45></a>
<a name=line-46></a><span class=k>def</span> <span class=nf>threads_info</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
<a name=line-47></a>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>threading</span><span class=o>.</span><span class=n>enumerate</span><span class=p>()))</span>
<a name=line-48></a>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
<a name=line-49></a>
<a name=line-50></a>
<a name=line-51></a><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>xfail</span><span class=p>(</span><span class=n>reason</span><span class=o>=</span><span class=s2>&quot;Intermittent failure&quot;</span><span class=p>)</span>
<a name=line-52></a><span class=nd>@nodebug</span>
<a name=line-53></a><span class=nd>@gen_test</span><span class=p>()</span>
<a name=line-54></a><span class=k>async</span> <span class=k>def</span> <span class=nf>test_simple</span><span class=p>():</span>
<a name=line-55></a>    <span class=n>to_child</span> <span class=o>=</span> <span class=n>mp_context</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
<a name=line-56></a>    <span class=n>from_child</span> <span class=o>=</span> <span class=n>mp_context</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
<a name=line-57></a>
<a name=line-58></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>feed</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>to_child</span><span class=p>,</span> <span class=n>from_child</span><span class=p>))</span>
<a name=line-59></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-60></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>pid</span> <span class=ow>is</span> <span class=kc>None</span>
<a name=line-61></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=ow>is</span> <span class=kc>None</span>
<a name=line-62></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span>
<a name=line-63></a>    <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-64></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span>
<a name=line-65></a>
<a name=line-66></a>    <span class=n>wr1</span> <span class=o>=</span> <span class=n>weakref</span><span class=o>.</span><span class=n>ref</span><span class=p>(</span><span class=n>proc</span><span class=p>)</span>
<a name=line-67></a>    <span class=n>wr2</span> <span class=o>=</span> <span class=n>weakref</span><span class=o>.</span><span class=n>ref</span><span class=p>(</span><span class=n>proc</span><span class=o>.</span><span class=n>_process</span><span class=p>)</span>
<a name=line-68></a>
<a name=line-69></a>    <span class=c1># join() before start()</span>
<a name=line-70></a>    <span class=k>with</span> <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=ne>AssertionError</span><span class=p>):</span>
<a name=line-71></a>        <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<a name=line-72></a>
<a name=line-73></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-74></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-75></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>pid</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<a name=line-76></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=ow>is</span> <span class=kc>None</span>
<a name=line-77></a>
<a name=line-78></a>    <span class=n>t1</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span>
<a name=line-79></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>0.02</span><span class=p>)</span>
<a name=line-80></a>    <span class=n>dt</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t1</span>
<a name=line-81></a>    <span class=k>assert</span> <span class=mf>0.2</span> <span class=o>&gt;=</span> <span class=n>dt</span> <span class=o>&gt;=</span> <span class=mf>0.01</span>
<a name=line-82></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-83></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>pid</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<a name=line-84></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=ow>is</span> <span class=kc>None</span>
<a name=line-85></a>
<a name=line-86></a>    <span class=c1># setting daemon attribute after start()</span>
<a name=line-87></a>    <span class=k>with</span> <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=ne>AssertionError</span><span class=p>):</span>
<a name=line-88></a>        <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>False</span>
<a name=line-89></a>
<a name=line-90></a>    <span class=n>to_child</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
<a name=line-91></a>    <span class=k>assert</span> <span class=n>from_child</span><span class=o>.</span><span class=n>get</span><span class=p>()</span> <span class=o>==</span> <span class=mi>5</span>
<a name=line-92></a>
<a name=line-93></a>    <span class=c1># child should be stopping now</span>
<a name=line-94></a>    <span class=n>t1</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span>
<a name=line-95></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
<a name=line-96></a>    <span class=n>dt</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t1</span>
<a name=line-97></a>    <span class=k>assert</span> <span class=n>dt</span> <span class=o>&lt;=</span> <span class=mf>1.0</span>
<a name=line-98></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-99></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>pid</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<a name=line-100></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=o>==</span> <span class=mi>0</span>
<a name=line-101></a>
<a name=line-102></a>    <span class=c1># join() again</span>
<a name=line-103></a>    <span class=n>t1</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span>
<a name=line-104></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<a name=line-105></a>    <span class=n>dt</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t1</span>
<a name=line-106></a>    <span class=k>assert</span> <span class=n>dt</span> <span class=o>&lt;=</span> <span class=mf>0.6</span>
<a name=line-107></a>
<a name=line-108></a>    <span class=k>del</span> <span class=n>proc</span>
<a name=line-109></a>    <span class=n>gc</span><span class=o>.</span><span class=n>collect</span><span class=p>()</span>
<a name=line-110></a>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span>
<a name=line-111></a>    <span class=k>while</span> <span class=n>wr1</span><span class=p>()</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>time</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>start</span> <span class=o>+</span> <span class=mi>1</span><span class=p>:</span>
<a name=line-112></a>        <span class=c1># Perhaps the GIL switched before _watch_process() exit,</span>
<a name=line-113></a>        <span class=c1># help it a little</span>
<a name=line-114></a>        <span class=n>sleep</span><span class=p>(</span><span class=mf>0.001</span><span class=p>)</span>
<a name=line-115></a>        <span class=n>gc</span><span class=o>.</span><span class=n>collect</span><span class=p>()</span>
<a name=line-116></a>    <span class=k>if</span> <span class=n>wr1</span><span class=p>()</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-117></a>        <span class=c1># Help diagnosing</span>
<a name=line-118></a>        <span class=kn>from</span> <span class=nn>types</span> <span class=kn>import</span> <span class=n>FrameType</span>
<a name=line-119></a>
<a name=line-120></a>        <span class=n>p</span> <span class=o>=</span> <span class=n>wr1</span><span class=p>()</span>
<a name=line-121></a>        <span class=k>if</span> <span class=n>p</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-122></a>            <span class=n>rc</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>getrefcount</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
<a name=line-123></a>            <span class=n>refs</span> <span class=o>=</span> <span class=n>gc</span><span class=o>.</span><span class=n>get_referrers</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
<a name=line-124></a>            <span class=k>del</span> <span class=n>p</span>
<a name=line-125></a>            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;refs to proc:&quot;</span><span class=p>,</span> <span class=n>rc</span><span class=p>,</span> <span class=n>refs</span><span class=p>)</span>
<a name=line-126></a>            <span class=n>frames</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>refs</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>FrameType</span><span class=p>)]</span>
<a name=line-127></a>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>f</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>frames</span><span class=p>):</span>
<a name=line-128></a>                <span class=nb>print</span><span class=p>(</span>
<a name=line-129></a>                    <span class=s2>&quot;frames #</span><span class=si>%d</span><span class=s2>:&quot;</span> <span class=o>%</span> <span class=n>i</span><span class=p>,</span>
<a name=line-130></a>                    <span class=n>f</span><span class=o>.</span><span class=n>f_code</span><span class=o>.</span><span class=n>co_name</span><span class=p>,</span>
<a name=line-131></a>                    <span class=n>f</span><span class=o>.</span><span class=n>f_code</span><span class=o>.</span><span class=n>co_filename</span><span class=p>,</span>
<a name=line-132></a>                    <span class=nb>sorted</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>f_locals</span><span class=p>),</span>
<a name=line-133></a>                <span class=p>)</span>
<a name=line-134></a>        <span class=n>pytest</span><span class=o>.</span><span class=n>fail</span><span class=p>(</span><span class=s2>&quot;AsyncProcess should have been destroyed&quot;</span><span class=p>)</span>
<a name=line-135></a>    <span class=n>t1</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span>
<a name=line-136></a>    <span class=k>while</span> <span class=n>wr2</span><span class=p>()</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
<a name=line-137></a>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.01</span><span class=p>)</span>
<a name=line-138></a>        <span class=n>gc</span><span class=o>.</span><span class=n>collect</span><span class=p>()</span>
<a name=line-139></a>        <span class=n>dt</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>t1</span>
<a name=line-140></a>        <span class=k>assert</span> <span class=n>dt</span> <span class=o>&lt;</span> <span class=mf>2.0</span>
<a name=line-141></a>
<a name=line-142></a>
<a name=line-143></a><span class=nd>@gen_test</span><span class=p>()</span>
<a name=line-144></a><span class=k>async</span> <span class=k>def</span> <span class=nf>test_exitcode</span><span class=p>():</span>
<a name=line-145></a>    <span class=n>q</span> <span class=o>=</span> <span class=n>mp_context</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
<a name=line-146></a>
<a name=line-147></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>exit</span><span class=p>,</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;q&quot;</span><span class=p>:</span> <span class=n>q</span><span class=p>})</span>
<a name=line-148></a>    <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-149></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-150></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=ow>is</span> <span class=kc>None</span>
<a name=line-151></a>
<a name=line-152></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-153></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-154></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=ow>is</span> <span class=kc>None</span>
<a name=line-155></a>
<a name=line-156></a>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
<a name=line-157></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>3.0</span><span class=p>)</span>
<a name=line-158></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-159></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=o>==</span> <span class=mi>5</span>
<a name=line-160></a>
<a name=line-161></a>
<a name=line-162></a><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>skipif</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&quot;nt&quot;</span><span class=p>,</span> <span class=n>reason</span><span class=o>=</span><span class=s2>&quot;POSIX only&quot;</span><span class=p>)</span>
<a name=line-163></a><span class=nd>@gen_test</span><span class=p>()</span>
<a name=line-164></a><span class=k>async</span> <span class=k>def</span> <span class=nf>test_signal</span><span class=p>():</span>
<a name=line-165></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>exit_with_signal</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>signal</span><span class=o>.</span><span class=n>SIGINT</span><span class=p>,))</span>
<a name=line-166></a>    <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-167></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-168></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=ow>is</span> <span class=kc>None</span>
<a name=line-169></a>
<a name=line-170></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-171></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>3.0</span><span class=p>)</span>
<a name=line-172></a>
<a name=line-173></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-174></a>    <span class=c1># Can be 255 with forkserver, see https://bugs.python.org/issue30589</span>
<a name=line-175></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=ow>in</span> <span class=p>(</span><span class=o>-</span><span class=n>signal</span><span class=o>.</span><span class=n>SIGINT</span><span class=p>,</span> <span class=mi>255</span><span class=p>)</span>
<a name=line-176></a>
<a name=line-177></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>wait</span><span class=p>)</span>
<a name=line-178></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-179></a>    <span class=n>os</span><span class=o>.</span><span class=n>kill</span><span class=p>(</span><span class=n>proc</span><span class=o>.</span><span class=n>pid</span><span class=p>,</span> <span class=n>signal</span><span class=o>.</span><span class=n>SIGTERM</span><span class=p>)</span>
<a name=line-180></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>3.0</span><span class=p>)</span>
<a name=line-181></a>
<a name=line-182></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-183></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=ow>in</span> <span class=p>(</span><span class=o>-</span><span class=n>signal</span><span class=o>.</span><span class=n>SIGTERM</span><span class=p>,</span> <span class=mi>255</span><span class=p>)</span>
<a name=line-184></a>
<a name=line-185></a>
<a name=line-186></a><span class=nd>@gen_test</span><span class=p>()</span>
<a name=line-187></a><span class=k>async</span> <span class=k>def</span> <span class=nf>test_terminate</span><span class=p>():</span>
<a name=line-188></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>wait</span><span class=p>)</span>
<a name=line-189></a>    <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-190></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-191></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>terminate</span><span class=p>()</span>
<a name=line-192></a>
<a name=line-193></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>3.0</span><span class=p>)</span>
<a name=line-194></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-195></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=ow>in</span> <span class=p>(</span><span class=o>-</span><span class=n>signal</span><span class=o>.</span><span class=n>SIGTERM</span><span class=p>,</span> <span class=mi>255</span><span class=p>)</span>
<a name=line-196></a>
<a name=line-197></a>
<a name=line-198></a><span class=nd>@gen_test</span><span class=p>()</span>
<a name=line-199></a><span class=k>async</span> <span class=k>def</span> <span class=nf>test_close</span><span class=p>():</span>
<a name=line-200></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>exit_now</span><span class=p>)</span>
<a name=line-201></a>    <span class=n>proc</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-202></a>    <span class=k>with</span> <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=ne>ValueError</span><span class=p>):</span>
<a name=line-203></a>        <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-204></a>
<a name=line-205></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>exit_now</span><span class=p>)</span>
<a name=line-206></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-207></a>    <span class=n>proc</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-208></a>    <span class=k>with</span> <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=ne>ValueError</span><span class=p>):</span>
<a name=line-209></a>        <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>terminate</span><span class=p>()</span>
<a name=line-210></a>
<a name=line-211></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>exit_now</span><span class=p>)</span>
<a name=line-212></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-213></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<a name=line-214></a>    <span class=n>proc</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-215></a>    <span class=k>with</span> <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=ne>ValueError</span><span class=p>):</span>
<a name=line-216></a>        <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<a name=line-217></a>    <span class=n>proc</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-218></a>
<a name=line-219></a>
<a name=line-220></a><span class=nd>@gen_test</span><span class=p>()</span>
<a name=line-221></a><span class=k>async</span> <span class=k>def</span> <span class=nf>test_exit_callback</span><span class=p>():</span>
<a name=line-222></a>    <span class=n>to_child</span> <span class=o>=</span> <span class=n>mp_context</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
<a name=line-223></a>    <span class=n>from_child</span> <span class=o>=</span> <span class=n>mp_context</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
<a name=line-224></a>    <span class=n>evt</span> <span class=o>=</span> <span class=n>Event</span><span class=p>()</span>
<a name=line-225></a>
<a name=line-226></a>    <span class=c1># FIXME: this breaks if changed to async def...</span>
<a name=line-227></a>    <span class=nd>@gen</span><span class=o>.</span><span class=n>coroutine</span>
<a name=line-228></a>    <span class=k>def</span> <span class=nf>on_stop</span><span class=p>(</span><span class=n>_proc</span><span class=p>):</span>
<a name=line-229></a>        <span class=k>assert</span> <span class=n>_proc</span> <span class=ow>is</span> <span class=n>proc</span>
<a name=line-230></a>        <span class=k>yield</span> <span class=n>gen</span><span class=o>.</span><span class=n>moment</span>
<a name=line-231></a>        <span class=n>evt</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
<a name=line-232></a>
<a name=line-233></a>    <span class=c1># Normal process exit</span>
<a name=line-234></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>feed</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>to_child</span><span class=p>,</span> <span class=n>from_child</span><span class=p>))</span>
<a name=line-235></a>    <span class=n>evt</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
<a name=line-236></a>    <span class=n>proc</span><span class=o>.</span><span class=n>set_exit_callback</span><span class=p>(</span><span class=n>on_stop</span><span class=p>)</span>
<a name=line-237></a>    <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-238></a>
<a name=line-239></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-240></a>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
<a name=line-241></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-242></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>evt</span><span class=o>.</span><span class=n>is_set</span><span class=p>()</span>
<a name=line-243></a>
<a name=line-244></a>    <span class=n>to_child</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>
<a name=line-245></a>    <span class=k>await</span> <span class=n>evt</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>timedelta</span><span class=p>(</span><span class=n>seconds</span><span class=o>=</span><span class=mi>3</span><span class=p>))</span>
<a name=line-246></a>    <span class=k>assert</span> <span class=n>evt</span><span class=o>.</span><span class=n>is_set</span><span class=p>()</span>
<a name=line-247></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-248></a>
<a name=line-249></a>    <span class=c1># Process terminated</span>
<a name=line-250></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>wait</span><span class=p>)</span>
<a name=line-251></a>    <span class=n>evt</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
<a name=line-252></a>    <span class=n>proc</span><span class=o>.</span><span class=n>set_exit_callback</span><span class=p>(</span><span class=n>on_stop</span><span class=p>)</span>
<a name=line-253></a>    <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-254></a>
<a name=line-255></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-256></a>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.05</span><span class=p>)</span>
<a name=line-257></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-258></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>evt</span><span class=o>.</span><span class=n>is_set</span><span class=p>()</span>
<a name=line-259></a>
<a name=line-260></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>terminate</span><span class=p>()</span>
<a name=line-261></a>    <span class=k>await</span> <span class=n>evt</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>timedelta</span><span class=p>(</span><span class=n>seconds</span><span class=o>=</span><span class=mi>3</span><span class=p>))</span>
<a name=line-262></a>    <span class=k>assert</span> <span class=n>evt</span><span class=o>.</span><span class=n>is_set</span><span class=p>()</span>
<a name=line-263></a>
<a name=line-264></a>
<a name=line-265></a><span class=nd>@gen_test</span><span class=p>()</span>
<a name=line-266></a><span class=k>async</span> <span class=k>def</span> <span class=nf>test_child_main_thread</span><span class=p>():</span>
<a name=line-267></a>    <span class=sd>&quot;&quot;&quot;</span>
<a name=line-268></a><span class=sd>    The main thread in the child should be called &quot;MainThread&quot;.</span>
<a name=line-269></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-270></a>    <span class=n>q</span> <span class=o>=</span> <span class=n>mp_context</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
<a name=line-271></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>threads_info</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>q</span><span class=p>,))</span>
<a name=line-272></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-273></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<a name=line-274></a>    <span class=n>n_threads</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
<a name=line-275></a>    <span class=n>main_name</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
<a name=line-276></a>    <span class=k>assert</span> <span class=n>n_threads</span> <span class=o>&lt;=</span> <span class=mi>3</span>
<a name=line-277></a>    <span class=k>assert</span> <span class=n>main_name</span> <span class=o>==</span> <span class=s2>&quot;MainThread&quot;</span>
<a name=line-278></a>    <span class=n>q</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-279></a>    <span class=n>q</span><span class=o>.</span><span class=n>_reader</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-280></a>    <span class=n>q</span><span class=o>.</span><span class=n>_writer</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-281></a>
<a name=line-282></a>
<a name=line-283></a><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>skipif</span><span class=p>(</span>
<a name=line-284></a>    <span class=n>sys</span><span class=o>.</span><span class=n>platform</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;win&quot;</span><span class=p>),</span> <span class=n>reason</span><span class=o>=</span><span class=s2>&quot;num_fds not supported on windows&quot;</span>
<a name=line-285></a><span class=p>)</span>
<a name=line-286></a><span class=nd>@gen_test</span><span class=p>()</span>
<a name=line-287></a><span class=k>async</span> <span class=k>def</span> <span class=nf>test_num_fds</span><span class=p>():</span>
<a name=line-288></a>    <span class=n>psutil</span> <span class=o>=</span> <span class=n>pytest</span><span class=o>.</span><span class=n>importorskip</span><span class=p>(</span><span class=s2>&quot;psutil&quot;</span><span class=p>)</span>
<a name=line-289></a>
<a name=line-290></a>    <span class=c1># Warm up</span>
<a name=line-291></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>exit_now</span><span class=p>)</span>
<a name=line-292></a>    <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-293></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-294></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<a name=line-295></a>
<a name=line-296></a>    <span class=n>p</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>Process</span><span class=p>()</span>
<a name=line-297></a>    <span class=n>before</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>num_fds</span><span class=p>()</span>
<a name=line-298></a>
<a name=line-299></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>exit_now</span><span class=p>)</span>
<a name=line-300></a>    <span class=n>proc</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-301></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-302></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<a name=line-303></a>    <span class=k>assert</span> <span class=ow>not</span> <span class=n>proc</span><span class=o>.</span><span class=n>is_alive</span><span class=p>()</span>
<a name=line-304></a>    <span class=k>assert</span> <span class=n>proc</span><span class=o>.</span><span class=n>exitcode</span> <span class=o>==</span> <span class=mi>0</span>
<a name=line-305></a>
<a name=line-306></a>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span>
<a name=line-307></a>    <span class=k>while</span> <span class=n>p</span><span class=o>.</span><span class=n>num_fds</span><span class=p>()</span> <span class=o>&gt;</span> <span class=n>before</span><span class=p>:</span>
<a name=line-308></a>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
<a name=line-309></a>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;fds:&quot;</span><span class=p>,</span> <span class=n>before</span><span class=p>,</span> <span class=n>p</span><span class=o>.</span><span class=n>num_fds</span><span class=p>())</span>
<a name=line-310></a>        <span class=k>assert</span> <span class=n>time</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>start</span> <span class=o>+</span> <span class=mi>10</span>
<a name=line-311></a>
<a name=line-312></a>
<a name=line-313></a><span class=nd>@gen_test</span><span class=p>()</span>
<a name=line-314></a><span class=k>async</span> <span class=k>def</span> <span class=nf>test_terminate_after_stop</span><span class=p>():</span>
<a name=line-315></a>    <span class=n>proc</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>sleep</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=mi>0</span><span class=p>,))</span>
<a name=line-316></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-317></a>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
<a name=line-318></a>    <span class=k>await</span> <span class=n>proc</span><span class=o>.</span><span class=n>terminate</span><span class=p>()</span>
<a name=line-319></a>
<a name=line-320></a>
<a name=line-321></a><span class=k>def</span> <span class=nf>_worker_process</span><span class=p>(</span><span class=n>worker_ready</span><span class=p>,</span> <span class=n>child_pipe</span><span class=p>):</span>
<a name=line-322></a>    <span class=c1># child_pipe is the write-side of the children_alive pipe held by the</span>
<a name=line-323></a>    <span class=c1># test process. When this _worker_process exits, this file descriptor should</span>
<a name=line-324></a>    <span class=c1># have no references remaining anywhere and be closed by the kernel. The</span>
<a name=line-325></a>    <span class=c1># test will therefore be able to tell that this process has exited by</span>
<a name=line-326></a>    <span class=c1># reading children_alive.</span>
<a name=line-327></a>
<a name=line-328></a>    <span class=c1># Signal to parent process that this process has started and made it this</span>
<a name=line-329></a>    <span class=c1># far. This should cause the parent to exit rapidly after this statement.</span>
<a name=line-330></a>    <span class=n>worker_ready</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
<a name=line-331></a>
<a name=line-332></a>    <span class=c1># The parent exiting should cause this process to os._exit from a monitor</span>
<a name=line-333></a>    <span class=c1># thread. This sleep should never return.</span>
<a name=line-334></a>    <span class=n>shorter_timeout</span> <span class=o>=</span> <span class=mf>2.5</span>  <span class=c1># timeout shorter than that in the spawning test.</span>
<a name=line-335></a>    <span class=n>sleep</span><span class=p>(</span><span class=n>shorter_timeout</span><span class=p>)</span>
<a name=line-336></a>
<a name=line-337></a>    <span class=c1># Unreachable if functioning correctly.</span>
<a name=line-338></a>    <span class=n>child_pipe</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;child should have exited by now&quot;</span><span class=p>)</span>
<a name=line-339></a>
<a name=line-340></a>
<a name=line-341></a><span class=k>def</span> <span class=nf>_parent_process</span><span class=p>(</span><span class=n>child_pipe</span><span class=p>):</span>
<a name=line-342></a>    <span class=sd>&quot;&quot;&quot;Simulate starting an AsyncProcess and then dying.</span>
<a name=line-343></a>
<a name=line-344></a><span class=sd>    The child_alive pipe is held open for as long as the child is alive, and can</span>
<a name=line-345></a><span class=sd>    be used to determine if it exited correctly.&quot;&quot;&quot;</span>
<a name=line-346></a>
<a name=line-347></a>    <span class=k>async</span> <span class=k>def</span> <span class=nf>parent_process_coroutine</span><span class=p>():</span>
<a name=line-348></a>        <span class=n>worker_ready</span> <span class=o>=</span> <span class=n>mp_context</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
<a name=line-349></a>
<a name=line-350></a>        <span class=n>worker</span> <span class=o>=</span> <span class=n>AsyncProcess</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>_worker_process</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>worker_ready</span><span class=p>,</span> <span class=n>child_pipe</span><span class=p>))</span>
<a name=line-351></a>
<a name=line-352></a>        <span class=k>await</span> <span class=n>worker</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-353></a>
<a name=line-354></a>        <span class=c1># Wait for the child process to have started.</span>
<a name=line-355></a>        <span class=n>worker_ready</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>
<a name=line-356></a>
<a name=line-357></a>        <span class=c1># Exit immediately, without doing any process teardown (including atexit</span>
<a name=line-358></a>        <span class=c1># and &#39;finally:&#39; blocks) as if by SIGKILL. This should cause</span>
<a name=line-359></a>        <span class=c1># worker_process to also exit.</span>
<a name=line-360></a>        <span class=n>os</span><span class=o>.</span><span class=n>_exit</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span>
<a name=line-361></a>
<a name=line-362></a>    <span class=k>with</span> <span class=n>pristine_loop</span><span class=p>()</span> <span class=k>as</span> <span class=n>loop</span><span class=p>:</span>
<a name=line-363></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-364></a>            <span class=n>loop</span><span class=o>.</span><span class=n>run_sync</span><span class=p>(</span><span class=n>parent_process_coroutine</span><span class=p>(),</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
<a name=line-365></a>        <span class=k>finally</span><span class=p>:</span>
<a name=line-366></a>            <span class=n>loop</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
<a name=line-367></a>
<a name=line-368></a>            <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&quot;this should be unreachable due to os._exit&quot;</span><span class=p>)</span>
<a name=line-369></a>
<a name=line-370></a>
<a name=line-371></a><span class=k>def</span> <span class=nf>test_asyncprocess_child_teardown_on_parent_exit</span><span class=p>():</span>
<a name=line-372></a>    <span class=sa>r</span><span class=sd>&quot;&quot;&quot;Check that a child process started by AsyncProcess exits if its parent</span>
<a name=line-373></a><span class=sd>    exits.</span>
<a name=line-374></a>
<a name=line-375></a><span class=sd>    The motivation is to ensure that if an AsyncProcess is created and the</span>
<a name=line-376></a><span class=sd>    creator process dies unexpectedly (e.g, via Out-of-memory SIGKILL), the</span>
<a name=line-377></a><span class=sd>    child process and resources held by it should not be leaked.</span>
<a name=line-378></a>
<a name=line-379></a><span class=sd>    The child should monitor its parent and exit promptly if the parent exits.</span>
<a name=line-380></a>
<a name=line-381></a><span class=sd>    [test process] -&gt; [parent using AsyncProcess (dies)] -&gt; [worker process]</span>
<a name=line-382></a><span class=sd>                 \                                          /</span>
<a name=line-383></a><span class=sd>                  \________ &lt;--   child_pipe   &lt;-- ________/</span>
<a name=line-384></a><span class=sd>    &quot;&quot;&quot;</span>
<a name=line-385></a>    <span class=c1># When child_pipe is closed, the children_alive pipe unblocks.</span>
<a name=line-386></a>    <span class=n>children_alive</span><span class=p>,</span> <span class=n>child_pipe</span> <span class=o>=</span> <span class=n>mp_context</span><span class=o>.</span><span class=n>Pipe</span><span class=p>(</span><span class=n>duplex</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<a name=line-387></a>
<a name=line-388></a>    <span class=k>try</span><span class=p>:</span>
<a name=line-389></a>        <span class=n>parent</span> <span class=o>=</span> <span class=n>mp_context</span><span class=o>.</span><span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>_parent_process</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>child_pipe</span><span class=p>,))</span>
<a name=line-390></a>        <span class=n>parent</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<a name=line-391></a>
<a name=line-392></a>        <span class=c1># Close our reference to child_pipe so that the child has the only one.</span>
<a name=line-393></a>        <span class=n>child_pipe</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<a name=line-394></a>
<a name=line-395></a>        <span class=c1># Wait for the parent to exit. By the time join returns, the child</span>
<a name=line-396></a>        <span class=c1># process is orphaned, and should be in the process of exiting by</span>
<a name=line-397></a>        <span class=c1># itself.</span>
<a name=line-398></a>        <span class=n>parent</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
<a name=line-399></a>
<a name=line-400></a>        <span class=c1># By the time we reach here,the parent has exited. The parent only exits</span>
<a name=line-401></a>        <span class=c1># when the child is ready to enter the sleep, so all of the slow things</span>
<a name=line-402></a>        <span class=c1># (process startup, etc) should have happened by now, even on a busy</span>
<a name=line-403></a>        <span class=c1># system. A short timeout should therefore be appropriate.</span>
<a name=line-404></a>        <span class=n>short_timeout</span> <span class=o>=</span> <span class=mf>5.0</span>
<a name=line-405></a>        <span class=c1># Poll is used to allow other tests to proceed after this one in case of</span>
<a name=line-406></a>        <span class=c1># test failure.</span>
<a name=line-407></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-408></a>            <span class=n>readable</span> <span class=o>=</span> <span class=n>children_alive</span><span class=o>.</span><span class=n>poll</span><span class=p>(</span><span class=n>short_timeout</span><span class=p>)</span>
<a name=line-409></a>        <span class=k>except</span> <span class=ne>EnvironmentError</span><span class=p>:</span>
<a name=line-410></a>            <span class=c1># Windows can raise BrokenPipeError. EnvironmentError is caught for</span>
<a name=line-411></a>            <span class=c1># Python2/3 portability.</span>
<a name=line-412></a>            <span class=k>assert</span> <span class=n>sys</span><span class=o>.</span><span class=n>platform</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;win&quot;</span><span class=p>),</span> <span class=s2>&quot;should only raise on windows&quot;</span>
<a name=line-413></a>            <span class=c1># Broken pipe implies closed, which is readable.</span>
<a name=line-414></a>            <span class=n>readable</span> <span class=o>=</span> <span class=kc>True</span>
<a name=line-415></a>
<a name=line-416></a>        <span class=c1># If this assert fires, then something went wrong. Either the child</span>
<a name=line-417></a>        <span class=c1># should write into the pipe, or it should exit and the pipe should be</span>
<a name=line-418></a>        <span class=c1># closed (which makes it become readable).</span>
<a name=line-419></a>        <span class=k>assert</span> <span class=n>readable</span>
<a name=line-420></a>
<a name=line-421></a>        <span class=k>try</span><span class=p>:</span>
<a name=line-422></a>            <span class=c1># This won&#39;t block due to the above &#39;assert readable&#39;.</span>
<a name=line-423></a>            <span class=n>result</span> <span class=o>=</span> <span class=n>children_alive</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>
<a name=line-424></a>        <span class=k>except</span> <span class=ne>EOFError</span><span class=p>:</span>
<a name=line-425></a>            <span class=k>pass</span>  <span class=c1># Test passes.</span>
<a name=line-426></a>        <span class=k>except</span> <span class=ne>EnvironmentError</span><span class=p>:</span>
<a name=line-427></a>            <span class=c1># Windows can raise BrokenPipeError. EnvironmentError is caught for</span>
<a name=line-428></a>            <span class=c1># Python2/3 portability.</span>
<a name=line-429></a>            <span class=k>assert</span> <span class=n>sys</span><span class=o>.</span><span class=n>platform</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;win&quot;</span><span class=p>),</span> <span class=s2>&quot;should only raise on windows&quot;</span>
<a name=line-430></a>            <span class=c1># Test passes.</span>
<a name=line-431></a>        <span class=k>else</span><span class=p>:</span>
<a name=line-432></a>            <span class=c1># Oops, children_alive read something. It should be closed. If</span>
<a name=line-433></a>            <span class=c1># something was read, it&#39;s a message from the child telling us they</span>
<a name=line-434></a>            <span class=c1># are still alive!</span>
<a name=line-435></a>            <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&quot;unreachable: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
<a name=line-436></a>
<a name=line-437></a>    <span class=k>finally</span><span class=p>:</span>
<a name=line-438></a>        <span class=c1># Cleanup.</span>
<a name=line-439></a>        <span class=n>children_alive</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</pre></div></td></tr></table><p class=footer> Generated by <a href=https://github.com/spirali/nedoc>nedoc</a> v0.9 at 2020-12-29 14:05 </p></div></div></body></html>